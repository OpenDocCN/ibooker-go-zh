<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Building a Cloud Native Service"><div class="chapter" id="chapter_5">&#13;
<h1><span class="label">Chapter 5. </span>Building a Cloud Native Service</h1>&#13;
&#13;
<blockquote>&#13;
<p>Life was simple before World War II. After that, we had systems.<sup><a data-type="noteref" id="idm45983635901544-marker" href="ch05.xhtml#idm45983635901544">1</a></sup></p>&#13;
<p data-type="attribution">Grace Hopper, <cite>OCLC Newsletter (1987)</cite></p>&#13;
</blockquote>&#13;
&#13;
<p>In this chapter, our real work finally begins.</p>&#13;
&#13;
<p>We’ll weave together many of the materials discussed throughout <a data-type="xref" href="part02.xhtml#part_2">Part II</a> to create a service that will serve as the jumping-off point for the remainder of the book. As &#13;
<span class="keep-together">we go</span> forward, we’ll iterate on what we begin here, adding layers of functionality &#13;
<span class="keep-together">with each</span> chapter until, at the conclusion, we have ourselves a true cloud native &#13;
<span class="keep-together">application</span>.</p>&#13;
&#13;
<p>Naturally, it won’t be “production ready”—it will be missing important security features, for example—but it will provide a solid foundation for us to build upon.</p>&#13;
&#13;
<p>But what do we build?</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Let’s Build a Service!"><div class="sect1" id="idm45983635894472">&#13;
<h1>Let’s Build a Service!</h1>&#13;
&#13;
<p>Okay. So. We need something to build.</p>&#13;
&#13;
<p>It should be conceptually simple, straightforward enough to implement in its most basic form, but non-trivial and amenable to scaling and distributing. Something that we can iteratively refine over the remainder of the book. I put a lot of thought into this, considering different ideas for what our application would be, but in the end the answer was obvious.</p>&#13;
&#13;
<p>We’ll build ourselves a distributed key-value store.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="What’s a Key-Value Store?"><div class="sect2" id="idm45983635891560">&#13;
<h2>What’s a Key-Value Store?</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="key-value store" id="idm45983635890392"/>A key-value store is a kind of nonrelational database that stores data as a collection of key-value pairs. They’re very different from the better-known relational databases, like Microsoft SQL Server or PostgreSQL, that we know and love.<sup><a data-type="noteref" id="idm45983635889304-marker" href="ch05.xhtml#idm45983635889304">2</a></sup> Where relational databases structure their data among fixed tables with well-defined data types, key-value stores are far simpler, allowing users to associate a unique identifier (the key) with an arbitrary value.</p>&#13;
&#13;
<p>In other words, at its heart, a key-value store is really just a map with a service endpoint, as shown in <a data-type="xref" href="#img_ch05_minimal_kvs">Figure 5-1</a>. They’re the simplest possible database.</p>&#13;
&#13;
<figure><div id="img_ch05_minimal_kvs" class="figure">&#13;
<img src="Images/cngo_0501.png" alt="cngo 0501" width="673" height="152"/>&#13;
<h6><span class="label">Figure 5-1. </span>A key-value store is essentially a map with a service endpoint</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Requirements"><div class="sect1" id="idm45983635884824">&#13;
<h1>Requirements</h1>&#13;
&#13;
<p>By the end of this chapter, we’re going to have built a simple, nondistributed key-value store that can do all of the things that a (monolithic) key-value store should do.</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It must be able to store arbitrary key-value pairs.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must provide service endpoints that allow a user to put, get, and delete key-value pairs.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must be able to persistently store its data in some fashion.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Finally, we’d like the service to be idempotent. But why?</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="What Is Idempotence and Why Does It Matter?"><div class="sect2" id="section_ch05_idempotence">&#13;
<h2>What Is Idempotence and Why Does It Matter?</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="idempotence" id="ch05_term1"/>The concept of <em>idempotence</em> has its origins in algebra, where it describes particular properties of certain mathematical operations. Fortunately, this isn’t a math book. We’re not going to talk about that (except in the sidebar at the end of this section).</p>&#13;
&#13;
<p>In the programming world, an operation (such as a method or service call) is idempotent if calling it once has the same effect as calling it multiple times. For example, the assignment operation <code>x=1</code> is idempotent, because <code>x</code> will always be <code>1</code> no matter how many times you assign it. Similarly, an HTTP <code>PUT</code> method is idempotent because &#13;
<span class="keep-together"><code>PUT</code>-ting</span> a resource in a place multiple times won’t change anything: it won’t get any more <code>PUT</code> the second time.<sup><a data-type="noteref" id="idm45983635871960-marker" href="ch05.xhtml#idm45983635871960">3</a></sup> The operation <code>x+=1</code>, however, is not idempotent, because every time that it’s called, a new state is produced.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="nullipotence" id="idm45983635870504"/>Less discussed, but also important, is the related property of <em>nullipotence</em>, in which a function or operation has no side effect at all. For example, the <code>x=1</code> assignment and an HTTP <code>PUT</code> are idempotent but not nullipotent because they trigger state changes. Assigning a value to itself, such as <code>x=x</code>, is nullipotent because no state has changed as a result of it. Similarly, simply reading data, as with an HTTP <code>GET</code>, usually has no side effects, so it’s also nullipotent.</p>&#13;
&#13;
<p>Of course, that’s all very nice in theory, but why should we care in the real world? Well, as it turns out, designing your service methods to be idempotent provides a number of very real benefits:</p>&#13;
<dl>&#13;
<dt>Idempotent operations are safer</dt>&#13;
<dd>&#13;
<p>What if you make a request to a service, but get no response? You’ll probably try again. But what if it heard you the first time?<sup><a data-type="noteref" id="idm45983635864728-marker" href="ch05.xhtml#idm45983635864728">4</a></sup> If the service method is idempotent, then no harm done. But if it’s not, you could have a problem. This scenario is more common than you think. Networks are unreliable. Responses can be delayed; packets can get dropped.</p>&#13;
</dd>&#13;
<dt>Idempotent operations are often simpler</dt>&#13;
<dd>&#13;
<p>Idempotent operations are more self-contained and easier to implement. Compare, for example, an idempotent <code>PUT</code> method that simply adds a key-value pair into a backing data store, and a similar but nonidempotent <code>CREATE</code> method that returns an error if the data store already contains the key. The <code>PUT</code> logic is simple: receive request, set value. The <code>CREATE</code>, on the other hand, requires additional layers of error checking and handling, and possibly even distributed locking and coordination among any service replicas, making its service harder to scale.</p>&#13;
</dd>&#13;
<dt><a data-type="indexterm" data-primary="declarative methods" id="idm45983635859512"/>Idempotent operations are more declarative</dt>&#13;
<dd>&#13;
<p>Building an idempotent API encourages the designer to focus on end-states, encouraging the production of methods that are more <em>declarative</em>: they allow users to tell a service <em>what needs to be done</em>, instead of telling it <em>how to do it</em>. This may seem to be a fine point, but declarative methods—as opposed to <em>imperative methods</em>—free users from having to deal with low-level constructs, allowing them to focus on their goals and minimizing potential side-effects.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In fact, idempotence provides such an advantage, particularly in a cloud native &#13;
<span class="keep-together">context, that</span> some very smart people have even gone so far as to assert that it’s a <em>synonym</em> for “cloud native.”<sup><a data-type="noteref" id="idm45983635854008-marker" href="ch05.xhtml#idm45983635854008">5</a></sup> I don’t think that I’d go quite that far, but I <em>would</em> say that if your service aims to be cloud native, accepting any less than idempotence is asking for trouble.<a data-type="indexterm" data-primary="idempotence" data-startref="ch05_term1" id="idm45983635852520"/></p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45983635851416">&#13;
<h5>The Mathematical Definition of Idempotence</h5>&#13;
<p>The origin of idempotence is in mathematics, where it describes an operation &#13;
<span class="keep-together">that can</span> be applied multiple times without changing the result beyond the initial &#13;
<span class="keep-together">application</span>.</p>&#13;
&#13;
<p>In purely mathematical terms: a function is idempotent if <math alttext="f left-parenthesis f left-parenthesis x right-parenthesis right-parenthesis equals f left-parenthesis x right-parenthesis">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>(</mo>&#13;
    <mi>f</mi>&#13;
    <mo>(</mo>&#13;
    <mi>x</mi>&#13;
    <mo>)</mo>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>f</mi>&#13;
    <mo>(</mo>&#13;
    <mi>x</mi>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> for all <math alttext="x">&#13;
  <mi>x</mi>&#13;
</math>.</p>&#13;
&#13;
<p>For example, taking the absolute value <math alttext="a b s left-parenthesis x right-parenthesis">&#13;
  <mrow>&#13;
    <mi>a</mi>&#13;
    <mi>b</mi>&#13;
    <mi>s</mi>&#13;
    <mo>(</mo>&#13;
    <mi>x</mi>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> of an integer number <math alttext="x">&#13;
  <mi>x</mi>&#13;
</math> is an idempotent function because <math alttext="a b s left-parenthesis x right-parenthesis equals a b s left-parenthesis a b s left-parenthesis x right-parenthesis right-parenthesis">&#13;
  <mrow>&#13;
    <mi>a</mi>&#13;
    <mi>b</mi>&#13;
    <mi>s</mi>&#13;
    <mo>(</mo>&#13;
    <mi>x</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>a</mi>&#13;
    <mi>b</mi>&#13;
    <mi>s</mi>&#13;
    <mo>(</mo>&#13;
    <mi>a</mi>&#13;
    <mi>b</mi>&#13;
    <mi>s</mi>&#13;
    <mo>(</mo>&#13;
    <mi>x</mi>&#13;
    <mo>)</mo>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> is true for each real number <math alttext="x">&#13;
  <mi>x</mi>&#13;
</math>.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="The Eventual Goal"><div class="sect2" id="idm45983635789400">&#13;
<h2>The Eventual Goal</h2>&#13;
&#13;
<p>These requirements are quite a lot to chew on, but they represent the absolute minimum for our key-value store to be usable. Later on we’ll add some important basic functionality, like support for multiple users and data encryption in transit. More importantly, though, we’ll introduce techniques and technologies that make the &#13;
<span class="keep-together">service</span> more scalable, resilient, and generally capable of surviving and thriving in a cruel, uncertain universe.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Generation 0: The Core Functionality"><div class="sect1" id="section_ch05_generation_0">&#13;
<h1>Generation 0: The Core Functionality</h1>&#13;
&#13;
<p>Okay, let’s get started. First things first. Without worrying about user requests and persistence, let’s first build the core functions, which can be called later from whatever web framework we decide to use.</p>&#13;
<dl>&#13;
<dt>Storing arbitrary key-value pairs</dt>&#13;
<dd>&#13;
<p>For now, we can implement this with a simple map, but what kind? For the sake of simplicity, we’ll limit ourselves to keys and values that are simple strings, though we may choose to allow arbitrary types later. We’ll just use a simple <code>map[string]string</code> as our core data structure.</p>&#13;
</dd>&#13;
<dt>Allow put, get, and delete of key-value pairs</dt>&#13;
<dd>&#13;
<p>In this initial iteration, we’ll create a simple Go API that we can call to perform the basic modification operations. Partitioning the functionality in this way will make it easier to test and easier to update in future iterations.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Your Super Simple API"><div class="sect2" id="section_ch05_our_api">&#13;
<h2>Your Super Simple API</h2>&#13;
&#13;
<p>The first thing that we need to do is to create our map. The heart of our key-value store:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code> <code class="nx">store</code> <code class="p">=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">)</code></pre>&#13;
&#13;
<p>Isn’t it a beauty? So simple. Don’t worry, we’ll make it more complicated later.</p>&#13;
&#13;
<p>The first function that we’ll create is, appropriately, <code>PUT</code>, which will be used to add records to the store. It does exactly what its name suggests: it accepts <code>key</code> and <code>value</code> strings, and puts them into <code>store</code>. <code>PUT</code>’s function signature includes an <code>error</code> return, which we’ll need later:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">Put</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="nx">store</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code> <code class="p">=</code> <code class="nx">value</code>&#13;
&#13;
    <code class="k">return</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Because we’re making the conscious choice to create an idempotent service, <code>Put</code> doesn’t check to see whether an existing key-value pair is being overwritten, so it will happily do so if asked. Multiple executions of <code>Put</code> with the same parameters will have the same result, regardless of any current state.</p>&#13;
&#13;
<p>Now that we’ve established a basic pattern, writing the <code>Get</code> and <code>Delete</code> operations is just a matter of following through:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code> <code class="nx">ErrorNoSuchKey</code> <code class="p">=</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"no such key"</code><code class="p">)</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">Get</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="kt">string</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">value</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">store</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code>&#13;
&#13;
    <code class="k">if</code> <code class="p">!</code><code class="nx">ok</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s">""</code><code class="p">,</code> <code class="nx">ErrorNoSuchKey</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">value</code><code class="p">,</code> <code class="kc">nil</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">Delete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="nb">delete</code><code class="p">(</code><code class="nx">store</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code>&#13;
&#13;
    <code class="k">return</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="sentinel error" id="idm45983635713352"/>But look carefully: see how when <code>Get</code> returns an error, it doesn’t use <code>errors.New</code>? Instead it returns the prebuilt <code>ErrorNoSuchKey</code> error value. But why? This is an example of a <em>sentinel error</em>, which allows the consuming service to determine exactly what type of error it’s receiving and to respond accordingly. For example, it might do something like this:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="k">if</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">Is</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">ErrorNoSuchKey</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code> <code class="nx">http</code><code class="p">.</code><code class="nx">StatusNotFound</code><code class="p">)</code>&#13;
    <code class="k">return</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now that you have your absolute minimal function set (really, really minimal), don’t forget to write tests. We’re not going to do that here, but if you’re feeling anxious to move forward (or lazy—lazy works too) you can grab the code from <a href="https://oreil.ly/ois1B">the GitHub repository created for this book</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Generation 1: The Monolith"><div class="sect1" id="section_ch05_generation_1">&#13;
<h1>Generation 1: The Monolith</h1>&#13;
&#13;
<p>Now that we have a minimally functional key-value API, we can begin building a service around it. We have a few different options for how to do this. We could use something like GraphQL. There are some decent third-party packages out there that we could use, but we don’t have the kind of complex data landscape to necessitate it. We could also use remote procedure call (RPC), which is supported by the standard <code>net/rpc</code> package, or even gRPC, but these require additional overhead for the client, and again our data just isn’t complex enough to warrant it.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="representational state transfer" data-see="REST" id="idm45983635535016"/><a data-type="indexterm" data-primary="REST" id="idm45983635534072"/>That leaves us with representational state transfer (REST). REST isn’t a lot of people’s favorite, but it <em>is</em> simple, and it’s perfectly adequate for our needs.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Building an HTTP Server with net/http"><div class="sect2" id="section_ch05_server_with_nethttp">&#13;
<h2>Building an HTTP Server with net/http</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Go" data-secondary="libraries" id="idm45983635593704"/>Go doesn’t have any web frameworks that are as sophisticated or historied as something like Django or Flask. What it does have, however, is a strong set of standard libraries that are perfectly adequate for 80% of use cases. Even better: they’re designed to be extensible, so there <em>are</em> a number of Go web frameworks that extend them.</p>&#13;
&#13;
<p>For now, let’s take a look at the standard HTTP handler idiom in Go, in the form of a “Hello World” as implemented with <code>net/http</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code> <code class="nx">main</code>&#13;
&#13;
<code class="kn">import</code> <code class="p">(</code>&#13;
    <code class="s">"log"</code>&#13;
    <code class="s">"net/http"</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">helloGoHandler</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">r</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">w</code><code class="p">.</code><code class="nx">Write</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"Hello net/http!\n"</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/"</code><code class="p">,</code> <code class="nx">helloGoHandler</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="kc">nil</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In the previous example, we define a method, <code>helloGoHandler</code>, which satisfies the definition of a <code>http.HandlerFunc</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">HandlerFunc</code> <code class="kd">func</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code></pre>&#13;
&#13;
<p>The <code>http.ResponseWriter</code> and a <code>*http.Request</code> parameters can be used to construct the HTTP response and retrieve the request, respectively. You can use the &#13;
<span class="keep-together"><code>http.HandleFunc</code></span> function to register <code>helloGoHandler</code> as the handler function for any request that matches a given pattern (the root path, in this example).</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="ListenAndServe" id="idm45983635450520"/>Once you’ve registered our handlers, you can call <code>ListenAndServe</code>, which listens on the address <code>addr</code>. It also accepts a second parameter, set to <code>nil</code> in our example.</p>&#13;
&#13;
<p>You’ll notice that <code>ListenAndServe</code> is also wrapped in a <code>log.Fatal</code> call. This is because <code>ListenAndServe</code> always stops the execution flow, only returning in the event of an error. Therefore, it always returns a non-nil <code>error</code>, which we always want &#13;
<span class="keep-together">to log.</span></p>&#13;
&#13;
<p>The previous example is a complete program that can be compiled and run using &#13;
<span class="keep-together"><code>go run</code>:</span></p>&#13;
&#13;
<pre data-type="programlisting">$ go run .</pre>&#13;
&#13;
<p>Congratulations! You’re now running the world’s tiniest web service. Now go ahead and test it with <code>curl</code> or your favorite web browser:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>curl http://localhost:8080&#13;
Hello net/http!</pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45983647413464">&#13;
<h5>ListenAndServe, Handlers, and HTTP Request Multiplexers</h5>&#13;
<p>The <code>http.ListenAndServe</code> function starts an HTTP server with a given address and handler. If the handler is <code>nil</code>, which it usually is when you’re using only the standard <code>net/http</code> library, the <code>DefaultServeMux</code> value is used. But what’s a handler?&#13;
What is <code>DefaultServeMux</code>? <em>What’s a “mux”?</em></p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="handler" id="idm45983635432008"/>A <code>Handler</code> is any type that satisfies the <code>Handler</code> interface by providing a <code>ServeHTTP</code> method, defined in the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">Handler</code> <code class="kd">interface</code> <code class="p">{</code>&#13;
    <code class="nx">ServeHTTP</code><code class="p">(</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="o">*</code><code class="nx">Request</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="multiplexer (mux)" id="idm45983635345736"/><a data-type="indexterm" data-primary="mux (multiplexer)" id="idm45983635345096"/>Most handler implementations, including the default handler, act as a “mux”—short for “multiplexer”—that can direct incoming signals to one of several possible outputs. When a request is received by a service that’s been started by <code>ListenAndServe</code>, it’s the job of a mux to compare the requested URL to the registered patterns and call the handler function associated with the one that matches most closely.</p>&#13;
&#13;
<p><code>DefaultServeMux</code> is a global value of type <code>ServeMux</code>, which implements the default HTTP multiplexer logic.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Building an HTTP Server with gorilla/mux"><div class="sect2" id="section_ch05_building_with_gorilla">&#13;
<h2>Building an HTTP Server with gorilla/mux</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Gorilla" id="idm45983635372088"/>For many web services the <code>net/http</code> and <code>DefaultServeMux</code> will be perfectly sufficient. However, sometimes you’ll need the additional functionality provided by a third-party web toolkit. A popular choice is <a href="https://oreil.ly/15sGK">Gorilla</a>, which, while being relatively new and less fully developed and resource-rich than something like Django or Flask, does build on Go’s standard <code>net/http</code> package to provide some excellent enhancements.</p>&#13;
&#13;
<p>The <code>gorilla/mux</code> package—one of several packages provided as part of the Gorilla web toolkit—provides an HTTP request router and dispatcher that can fully replace <code>DefaultServeMux</code>, Go’s default service handler, to add several very useful enhancements to request routing and handling. We’re not going to make use of these features just yet, but they will come in handy going forward. If you’re curious and/or impatient, however, you can take a look at <a href="https://oreil.ly/qfIph">the <code>gorilla/mux</code> documentation</a> for more &#13;
<span class="keep-together">information</span>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Creating a minimal service"><div class="sect3" id="idm45983635324792">&#13;
<h3>Creating a minimal service</h3>&#13;
&#13;
<p>Once you’ve done so, making use of the minimal <code>gorilla/mux</code> router is a matter of adding an import and one line of code: the initialization of a new router, which can be passed to the <code>handler</code> parameter of <code>ListenAndServe</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code> <code class="nx">main</code>&#13;
&#13;
<code class="kn">import</code> <code class="p">(</code>&#13;
    <code class="s">"log"</code>&#13;
    <code class="s">"net/http"</code>&#13;
&#13;
    <code class="s">"github.com/gorilla/mux"</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">helloMuxHandler</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">r</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">w</code><code class="p">.</code><code class="nx">Write</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"Hello gorilla/mux!\n"</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">r</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">NewRouter</code><code class="p">()</code>&#13;
&#13;
    <code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/"</code><code class="p">,</code> <code class="nx">helloMuxHandler</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="nx">r</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>So you should be able to just run this now with <code>go run</code>, right? Give it a try:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>go run .&#13;
main.go:7:5: cannot find package <code class="s2">"github.com/gorilla/mux"</code> in any of:&#13;
        /go/1.15.8/libexec/src/github.com/gorilla/mux <code class="o">(</code>from <code class="nv">$GOROOT</code><code class="o">)</code>&#13;
        /go/src/github.com/gorilla/mux <code class="o">(</code>from <code class="nv">$GOPATH</code><code class="o">)</code></pre>&#13;
&#13;
<p>It turns out that you can’t (yet). Since you’re now using a third-party package—a package that lives outside the standard library—you’re going to have to use Go &#13;
<span class="keep-together">modules</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Initializing your project with Go modules"><div class="sect3" id="idm45983635225640">&#13;
<h3>Initializing your project with Go modules</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Go" data-secondary="modules" id="idm45983635224040"/>Using a package from outside the standard library requires that you make use of <a href="https://oreil.ly/QJzOi">Go modules</a>, which were introduced in Go 1.12 to replace an essentially nonexistent dependency management system with one that’s explicit and actually quite painless to use. All of the operations that you’ll use for managing your dependencies will use one of a small handful of <code>go mod</code> commands.</p>&#13;
&#13;
<p>The first thing you’re going to have to do is initialize your project. Start by creating a new, empty directory, <code>cd</code> into it, and create (or move) the Go file for your service there. Your directory should now contain only a single Go file.</p>&#13;
&#13;
<p>Next, use the <code>go mod init</code> command to initialize the project. Typically, if a project will be imported by other projects, it’ll have to be initialized with its import path. This is less important for a standalone service like ours, though, so you can be a little more lax about the name you choose. I’ll just use <code>example.com/gorilla</code>; you can use whatever you like:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>go mod init example.com/gorilla&#13;
go: creating new go.mod: module example.com/gorilla</pre>&#13;
&#13;
<p>You’ll now have an (almost) empty module file, <code>go.mod</code>, in your directory:<sup><a data-type="noteref" id="idm45983635173272-marker" href="ch05.xhtml#idm45983635173272">6</a></sup></p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>cat go.mod&#13;
module example.com/gorilla&#13;
&#13;
go 1.15</pre>&#13;
&#13;
<p>Next, we’ll want to add our dependencies, which can be done automatically using &#13;
<span class="keep-together"><code>go mod tidy</code>:</span></p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>go mod tidy&#13;
go: finding module <code class="k">for</code> package github.com/gorilla/mux&#13;
go: found github.com/gorilla/mux in github.com/gorilla/mux v1.8.0</pre>&#13;
&#13;
<p>If you check your <code>go.mod</code> file, you’ll see that the dependency (and a version number) have been added:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>cat go.mod&#13;
module example.com/gorilla&#13;
&#13;
go 1.15&#13;
&#13;
require github.com/gorilla/mux v1.8.0</pre>&#13;
&#13;
<p>Believe it or not, that’s all you need. If your required dependencies change in the future you need only run <code>go mod tidy</code> again to rebuild the file. Now try again to start your service:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>go run .</pre>&#13;
&#13;
<p>Since the service runs in the foreground, your terminal should pause. Calling the endpoint with <code>curl</code> from another terminal or browsing to it with a browser should provide the expected response:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl http://localhost:8080&#13;
Hello gorilla/mux!</pre>&#13;
&#13;
<p>Success! But surely you want your service to do more than print a simple string, right? Of course you do. Read on!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Variables in URI paths"><div class="sect3" id="section_ch05_variables_in_paths">&#13;
<h3>Variables in URI paths</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Gorilla" id="ch05_term4"/>The Gorilla web toolkit provides a wealth of additional functionality over the standard <code>net/http</code> package, but one feature is particularly interesting right now: the ability to create paths with variable segments, which can even optionally contain a regular expression pattern. Using the <code>gorilla/mux</code> package, a programmer can define variables using the format <code>{name}</code> or <code>{name:pattern}</code>, as follows:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">r</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">NewRouter</code><code class="p">()</code>&#13;
<code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/products/{key}"</code><code class="p">,</code> <code class="nx">ProductHandler</code><code class="p">)</code>&#13;
<code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/articles/{category}/"</code><code class="p">,</code> <code class="nx">ArticlesCategoryHandler</code><code class="p">)</code>&#13;
<code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/articles/{category}/{id:[0-9]+}"</code><code class="p">,</code> <code class="nx">ArticleHandler</code><code class="p">)</code></pre>&#13;
&#13;
<p>The <code>mux.Vars</code> function conveniently allows the handler function to retrieve the &#13;
<span class="keep-together">variable</span> names and values as a <code>map[string]string</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">vars</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">Vars</code><code class="p">(</code><code class="nx">request</code><code class="p">)</code>&#13;
<code class="nx">category</code> <code class="o">:=</code> <code class="nx">vars</code><code class="p">[</code><code class="s">"category"</code><code class="p">]</code></pre>&#13;
&#13;
<p>In the next section we’ll use this ability to allow clients to perform operations on &#13;
<span class="keep-together">arbitrary</span> keys.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="So many matchers"><div class="sect3" id="section_ch05_route_matchers">&#13;
<h3>So many matchers</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="matchers" id="idm45983635004984"/>Another feature provided by <code>gorilla/mux</code> is that it allows a variety of <em>matchers</em> to be added to routes that let the programmer add a variety of additional matching request criteria. These include (but aren’t limited to) specific domains or subdomains, path prefixes, schemes, headers, and even custom matching functions of your own &#13;
<span class="keep-together">creation</span>.</p>&#13;
&#13;
<p>Matchers can be applied by calling the appropriate function on the <code>*Route</code> value that’s returned by Gorilla’s <code>HandleFunc</code> implementation. Each matcher function returns the affected <code>*Route</code>, so they can be chained. For example:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">r</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">NewRouter</code><code class="p">()</code>&#13;
&#13;
<code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/products"</code><code class="p">,</code> <code class="nx">ProductsHandler</code><code class="p">).</code>&#13;
    <code class="nx">Host</code><code class="p">(</code><code class="s">"www.example.com"</code><code class="p">).</code>                <code class="c1">// Only match a specific domain</code>&#13;
    <code class="nx">Methods</code><code class="p">(</code><code class="s">"GET"</code><code class="p">,</code> <code class="s">"PUT"</code><code class="p">).</code>                  <code class="c1">// Only match GET+PUT methods</code>&#13;
    <code class="nx">Schemes</code><code class="p">(</code><code class="s">"http"</code><code class="p">)</code>                         <code class="c1">// Only match the http scheme</code></pre>&#13;
&#13;
<p>See <a href="https://oreil.ly/6ztZe">the <code>gorilla/mux</code> documentation</a> for an exhaustive list of available matcher &#13;
<span class="keep-together">functions</span>.<a data-type="indexterm" data-primary="Gorilla" data-startref="ch05_term4" id="idm45983634902776"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Building a RESTful Service"><div class="sect2" id="idm45983634901640">&#13;
<h2>Building a RESTful Service</h2>&#13;
&#13;
<p>Now that you know how to use Go’s standard HTTP library, you can use it to create a RESTful service that a client can interact with to execute call to the API you built in <a data-type="xref" href="#section_ch05_our_api">“Your Super Simple API”</a>. Once you’ve done this you’ll have implemented the absolute minimal viable key-value store.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Your RESTful methods"><div class="sect3" id="idm45983634898872">&#13;
<h3>Your RESTful methods</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="RESTful" id="idm45983634897464"/>We’re going to do our best to follow RESTful conventions, so our API will consider every key-value pair to be a distinct resource with a distinct URI that can be operated upon using the various HTTP methods. Each of our three basic operations—Put, Get, and Delete—will be requested using a different HTTP method that we summarize in <a data-type="xref" href="#table_ch05_restful_methods">Table 5-1</a>.</p>&#13;
&#13;
<p>The URI for your key-value pair resources will have the form <code>/v1/key/{key}</code>, where <code>{key}</code> is the unique key string. The <code>v1</code> segment indicates the API version. This convention is often used to manage API changes, and while this practice is by no means required or universal, it can be helpful for managing the impact of future changes that could break existing client integrations.</p>&#13;
<table id="table_ch05_restful_methods" class="pagebreak-before less_space">&#13;
<caption><span class="label">Table 5-1. </span>Your RESTful methods</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Functionality</th>&#13;
<th>Method</th>&#13;
<th>Possible Statuses</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><strong>Put a key-value pair into the store</strong></p></td>&#13;
<td><p><code>PUT</code></p></td>&#13;
<td><p><code>201 (Created)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><strong>Read a key-value pair from the store</strong></p></td>&#13;
<td><p><code>GET</code></p></td>&#13;
<td><p><code>200 (OK), 404 (Not Found)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><strong>Delete a key-value pair</strong></p></td>&#13;
<td><p><code>DELETE</code></p></td>&#13;
<td><p><code>200 (OK)</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>In <a data-type="xref" href="#section_ch05_variables_in_paths">“Variables in URI paths”</a>, we discussed how to use the <code>gorilla/mux</code> package to register paths that contain variable segments, which will allow you to define a single variable path that handles <em>all</em> keys, mercifully freeing you from having to register every key independently. Then, in <a data-type="xref" href="#section_ch05_route_matchers">“So many matchers”</a>, we discussed how to use route matchers to direct requests to specific handler functions based on various nonpath criteria, which you can use to create a separate handler function for each of the five HTTP methods that you’ll be supporting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Implementing the create function"><div class="sect3" id="idm45983634877704">&#13;
<h3>Implementing the create function</h3>&#13;
&#13;
<p>Okay, you now have everything you need to get started! So, let’s go ahead and implement the handler function for the creation of key-value pairs. This function has to be sure to satisfy several requirements:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It must only match <code>PUT</code> requests for <code>/v1/key/{key}</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must call the <code>Put</code> method from <a data-type="xref" href="#section_ch05_our_api">“Your Super Simple API”</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must respond with a <code>201 (Created)</code> when a key-value pair is created.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must respond to unexpected errors with a <code>500 (Internal Server Error)</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>All of the previous requirements are implemented in the <code>keyValuePutHandler</code> function. Note how the key’s value is retrieved from the request body:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="c1">// keyValuePutHandler expects to be called with a PUT request for</code>&#13;
<code class="c1">// the "/v1/key/{key}" resource.</code>&#13;
<code class="kd">func</code> <code class="nx">keyValuePutHandler</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">r</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">vars</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">Vars</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code>                     <code class="c1">// Retrieve "key" from the request</code>&#13;
    <code class="nx">key</code> <code class="o">:=</code> <code class="nx">vars</code><code class="p">[</code><code class="s">"key"</code><code class="p">]</code>&#13;
&#13;
    <code class="nx">value</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">io</code><code class="p">.</code><code class="nx">ReadAll</code><code class="p">(</code><code class="nx">r</code><code class="p">.</code><code class="nx">Body</code><code class="p">)</code>        <code class="c1">// The request body has our value</code>&#13;
    <code class="k">defer</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Body</code><code class="p">.</code><code class="nx">Close</code><code class="p">()</code>&#13;
&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>                         <code class="c1">// If we have an error, report it</code>&#13;
        <code class="nx">http</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code>&#13;
            <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code>&#13;
            <code class="nx">http</code><code class="p">.</code><code class="nx">StatusInternalServerError</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">err</code> <code class="p">=</code> <code class="nx">Put</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nb">string</code><code class="p">(</code><code class="nx">value</code><code class="p">))</code>           <code class="c1">// Store the value as a string</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>                         <code class="c1">// If we have an error, report it</code>&#13;
        <code class="nx">http</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code>&#13;
            <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code>&#13;
            <code class="nx">http</code><code class="p">.</code><code class="nx">StatusInternalServerError</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">w</code><code class="p">.</code><code class="nx">WriteHeader</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusCreated</code><code class="p">)</code>       <code class="c1">// All good! Return StatusCreated</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now that you have your “key-value create” handler function, you can register it with your Gorilla request router for the desired path and method:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">r</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">NewRouter</code><code class="p">()</code>&#13;
&#13;
    <code class="c1">// Register keyValuePutHandler as the handler function for PUT</code>&#13;
    <code class="c1">// requests matching "/v1/{key}"</code>&#13;
    <code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/v1/{key}"</code><code class="p">,</code> <code class="nx">keyValuePutHandler</code><code class="p">).</code><code class="nx">Methods</code><code class="p">(</code><code class="s">"PUT"</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="nx">r</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now that you have your service put together, you can run it using <code>go run .</code> from the project root. Do that now, and send it some requests to see how it responds.</p>&#13;
&#13;
<p>First, use our old friend <code>curl</code> to send a <code>PUT</code> containing a short snippet of text &#13;
<span class="keep-together">to the</span> <code>/v1/key-a</code> endpoint to create a key named <code>key-a</code> with a value of <code>Hello,</code> &#13;
<span class="keep-together"><code>key-value store!</code>:</span></p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, key-value store!' -v http://localhost:8080/v1/key-a</pre>&#13;
&#13;
<p>Executing this command provides the following output. The complete output was quite wordy, so I’ve selected the relevant bits for readability:</p>&#13;
&#13;
<pre data-type="programlisting">&gt; PUT /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 201 Created</pre>&#13;
&#13;
<p>The first portion, prefixed with a greater-than symbol (<code>&gt;</code>), shows some details about the request. The last portion, prefixed with a less-than symbol (<code>&lt;</code>), gives details about the server response.</p>&#13;
&#13;
<p>In this output you can see that you did in fact transmit a <code>PUT</code> to the <code>/v1/key-a</code> endpoint, and that the server responded with a <code>201 Created</code>—as expected.</p>&#13;
&#13;
<p>What if you hit the <code>/v1/key-a</code> endpoint with an unsupported <code>GET</code> method? Assuming that the matcher function is working correctly, you should receive an error message:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X GET -v http://localhost:8080/v1/key-a&#13;
&gt; GET /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 405 Method Not Allowed</pre>&#13;
&#13;
<p>Indeed, the server responds with a <code>405 Method Not Allowed</code> error. Everything seems to be working correctly.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Implementing the read function"><div class="sect3" id="section_ch05_implementing_read_function">&#13;
<h3>Implementing the read function</h3>&#13;
&#13;
<p>Now that your service has a fully functioning <code>Put</code> method, it sure would be nice if you could read your data back! For our next trick, we’re going to implement the <code>Get</code> functionality, which has the following requirements:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It must only match <code>GET</code> requests for <code>/v1/key/{key}</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must call the <code>Get</code> method from <a data-type="xref" href="#section_ch05_our_api">“Your Super Simple API”</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must respond with a <code>404 (Not Found)</code> when a requested key doesn’t exist.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must respond with the requested value and a status <code>200</code> if the key exists.</p>&#13;
</li>&#13;
<li>&#13;
<p>It must respond to unexpected errors with a <code>500 (Internal Server Error)</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>All of the previous requirements are implemented in the <code>keyValueGetHandler</code> function. Note how the value is written to <code>w</code>—the handler function’s <code>http.ResponseWriter</code> parameter—after it’s retrieved from the key-value API:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">keyValueGetHandler</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">r</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">vars</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">Vars</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code>                     <code class="c1">// Retrieve "key" from the request</code>&#13;
    <code class="nx">key</code> <code class="o">:=</code> <code class="nx">vars</code><code class="p">[</code><code class="s">"key"</code><code class="p">]</code>&#13;
&#13;
    <code class="nx">value</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">Get</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code>                  <code class="c1">// Get value for key</code>&#13;
    <code class="k">if</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">Is</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">ErrorNoSuchKey</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nx">http</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code> <code class="nx">http</code><code class="p">.</code><code class="nx">StatusNotFound</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">http</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code> <code class="nx">http</code><code class="p">.</code><code class="nx">StatusInternalServerError</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">w</code><code class="p">.</code><code class="nx">Write</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="nx">value</code><code class="p">))</code>                  <code class="c1">// Write the value to the response</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>And now that you have the “get” handler function, you can register it with the request router alongside the “put” handler:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">r</code> <code class="o">:=</code> <code class="nx">mux</code><code class="p">.</code><code class="nx">NewRouter</code><code class="p">()</code>&#13;
&#13;
    <code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/v1/{key}"</code><code class="p">,</code> <code class="nx">keyValuePutHandler</code><code class="p">).</code><code class="nx">Methods</code><code class="p">(</code><code class="s">"PUT"</code><code class="p">)</code>&#13;
    <code class="nx">r</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/v1/{key}"</code><code class="p">,</code> <code class="nx">keyValueGetHandler</code><code class="p">).</code><code class="nx">Methods</code><code class="p">(</code><code class="s">"GET"</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="nx">r</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now let’s fire up your newly improved service and see if it works:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, key-value store!' -v http://localhost:8080/v1/key-a&#13;
&gt; PUT /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 201 Created&#13;
&#13;
$ curl -v http://localhost:8080/v1/key-a&#13;
&gt; GET /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 200 OK&#13;
Hello, key-value store!</pre>&#13;
&#13;
<p>It works! Now that you can get your values back, you’re able to test for idempotence as well. Let’s repeat the requests and make sure that you get the same results:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, key-value store!' -v http://localhost:8080/v1/key-a&#13;
&gt; PUT /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 201 Created&#13;
&#13;
$ curl -v http://localhost:8080/v1/key-a&#13;
&gt; GET /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 200 OK&#13;
Hello, key-value store!</pre>&#13;
&#13;
<p>You do! But what if you want to overwrite the key with a new value? Will the subsequent <code>GET</code> have the new value? You can test that by changing the value sent by your <code>curl</code> slightly to be <code>Hello, again, key-value store!</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, again, key-value store!' \&#13;
    -v http://localhost:8080/v1/key-a&#13;
&gt; PUT /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 201 Created&#13;
&#13;
$ curl -v http://localhost:8080/v1/key-a&#13;
&gt; GET /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 200 OK&#13;
Hello, again, key-value store!</pre>&#13;
&#13;
<p>As expected, the <code>GET</code> responds back with a <code>200</code> status and your new value.</p>&#13;
&#13;
<p>Finally, to complete your method set you’ll just need to create a handler for the <code>DELETE</code> method. I’ll leave that as an exercise, though. Enjoy!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Making Your Data Structure Concurrency-Safe"><div class="sect2" id="section_ch05_concurrency_safe">&#13;
<h2>Making Your Data Structure Concurrency-Safe</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Go" data-secondary="maps" id="ch05_term7"/><a data-type="indexterm" data-primary="maps" id="ch05_term8"/><a data-type="indexterm" data-primary="concurrency" data-secondary="safe" id="ch05_term6"/>Maps in Go are not atomic and are not safe for concurrent use. Unfortunately, you now have a service designed to handle concurrent requests that’s wrapped around exactly such a map.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="mutex" id="idm45983634454136"/>So what do you do? Well, typically when a programmer has a data structure that needs to be read from and written to by concurrently executing goroutines, they’ll use something like a mutex—also known as a lock—to act as a synchronization mechanism. By using a mutex in this way, you can ensure that exactly one process has exclusive access to a particular resource.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="structs" data-seealso="anonymous struct" id="idm45983634452664"/><a data-type="indexterm" data-primary="anonymous struct" id="idm45983634451464"/>Fortunately, you don’t need to implement this yourself:<sup><a data-type="noteref" id="idm45983634450664-marker" href="ch05.xhtml#idm45983634450664">7</a></sup> Go’s <code>sync</code> package provides exactly what you need in the form of <code>sync.RWMutex</code>. The following statement uses the magic of composition to create an <em>anonymous struct</em> that contains your map and an embedded <code>sync.RWMutex</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code> <code class="nx">myMap</code> <code class="p">=</code> <code class="kd">struct</code><code class="p">{</code>&#13;
    <code class="nx">sync</code><code class="p">.</code><code class="nx">RWMutex</code>&#13;
    <code class="nx">m</code> <code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code>&#13;
<code class="p">}{</code><code class="nx">m</code><code class="p">:</code> <code class="nb">make</code><code class="p">(</code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">)}</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="locks" data-seealso="read locks, write locks" id="idm45983634446584"/>The <code>myMap</code> struct has all of the methods from the embedded <code>sync.RWMutex</code>, allowing you to use the <code>Lock</code> method to take the write lock when you want to write to the <code>myMap</code> map:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">myMap</code><code class="p">.</code><code class="nx">Lock</code><code class="p">()</code>                                <code class="c1">// Take a write lock</code>&#13;
<code class="nx">myMap</code><code class="p">.</code><code class="nx">m</code><code class="p">[</code><code class="s">"some_key"</code><code class="p">]</code> <code class="p">=</code> <code class="s">"some_value"</code>&#13;
<code class="nx">myMap</code><code class="p">.</code><code class="nx">Unlock</code><code class="p">()</code>                              <code class="c1">// Release the write lock</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="read locks" id="ch05_term9"/><a data-type="indexterm" data-primary="write locks" id="idm45983634312456"/>If another process has either a read or write lock, then <code>Lock</code> will block until that lock is released.</p>&#13;
&#13;
<p>Similarly, to read from the map, you use the <code>RLock</code> method to take the read lock:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">myMap</code><code class="p">.</code><code class="nx">RLock</code><code class="p">()</code>                               <code class="c1">// Take a read lock</code>&#13;
<code class="nx">value</code> <code class="o">:=</code> <code class="nx">myMap</code><code class="p">.</code><code class="nx">m</code><code class="p">[</code><code class="s">"some_key"</code><code class="p">]</code>&#13;
<code class="nx">myMap</code><code class="p">.</code><code class="nx">RUnlock</code><code class="p">()</code>                             <code class="c1">// Release the read lock</code>&#13;
&#13;
<code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"some_key:"</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code></pre>&#13;
&#13;
<p>Read locks are less restrictive than write locks in that any number of processes can simultaneously take read locks. However, <code>RLock</code> will block until any open write locks are released.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Integrating a read-write mutex into your application"><div class="sect3" id="idm45983634259080">&#13;
<h3>Integrating a read-write mutex into your application</h3>&#13;
&#13;
<p>Now that you know how to use a <code>sync.RWMutex</code> to implement a basic read-write mutex, you can go back and work it into the code you created for <a data-type="xref" href="#section_ch05_our_api">“Your Super Simple API”</a>.</p>&#13;
&#13;
<p>First, you’ll want to refactor the <code>store</code> map.<sup><a data-type="noteref" id="idm45983634224808-marker" href="ch05.xhtml#idm45983634224808">8</a></sup> You can construct it like <code>myMap</code>, i.e., as an anonymous struct that contains the map and an embedded <code>sync.RWMutex</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code> <code class="nx">store</code> <code class="p">=</code> <code class="kd">struct</code><code class="p">{</code>&#13;
    <code class="nx">sync</code><code class="p">.</code><code class="nx">RWMutex</code>&#13;
    <code class="nx">m</code> <code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code>&#13;
<code class="p">}{</code><code class="nx">m</code><code class="p">:</code> <code class="nb">make</code><code class="p">(</code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">)}</code></pre>&#13;
&#13;
<p>Now that you have your <code>store</code> struct, you can update the <code>Get</code> and <code>Put</code> functions to establish the appropriate locks. Because <code>Get</code> only needs to <em>read</em> the <code>store</code> map, it’ll use <code>RLock</code> to take a read lock only. <code>Put</code>, on the other hand, needs to <em>modify</em> the map, so it’ll need to use <code>Lock</code> to take a write lock:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">Get</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="kt">string</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">store</code><code class="p">.</code><code class="nx">RLock</code><code class="p">()</code>&#13;
    <code class="nx">value</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">store</code><code class="p">.</code><code class="nx">m</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code>&#13;
    <code class="nx">store</code><code class="p">.</code><code class="nx">RUnlock</code><code class="p">()</code>&#13;
&#13;
    <code class="k">if</code> <code class="p">!</code><code class="nx">ok</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s">""</code><code class="p">,</code> <code class="nx">ErrorNoSuchKey</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">value</code><code class="p">,</code> <code class="kc">nil</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">Put</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="nx">store</code><code class="p">.</code><code class="nx">Lock</code><code class="p">()</code>&#13;
    <code class="nx">store</code><code class="p">.</code><code class="nx">m</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code> <code class="p">=</code> <code class="nx">value</code>&#13;
    <code class="nx">store</code><code class="p">.</code><code class="nx">Unlock</code><code class="p">()</code>&#13;
&#13;
    <code class="k">return</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The pattern here is clear: if a function needs to modify the map (<code>Put</code>, <code>Delete</code>), it’ll use <code>Lock</code> to take a write lock. If it only needs to read existing data (<code>Get</code>), it’ll use <code>RLock</code> to take a read lock. We leave the creation of the <code>Delete</code> function as an exercise for the reader.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Don’t forget to release your locks, and make sure you’re releasing the correct lock type!<a data-type="indexterm" data-primary="concurrency" data-secondary="safe" data-startref="ch05_term6" id="idm45983634042520"/><a data-type="indexterm" data-primary="Go" data-secondary="maps" data-startref="ch05_term7" id="idm45983634041272"/><a data-type="indexterm" data-primary="maps" data-startref="ch05_term8" id="idm45983634040056"/><a data-type="indexterm" data-primary="read locks" data-startref="ch05_term9" id="idm45983634039112"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Generation 2: Persisting Resource State"><div class="sect1" id="idm45983634459192">&#13;
<h1>Generation 2: Persisting Resource State</h1>&#13;
&#13;
<p>One of the stickiest challenges with distributed cloud native applications is how to handle state.</p>&#13;
&#13;
<p>There are various techniques for distributing the state of application resources between multiple service instances, but for now we’re just going to concern ourselves with the minimum viable product and consider two ways of maintaining the state of our application:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In <a data-type="xref" href="#section_ch05_state_transaction_log">“Storing State in a Transaction Log File”</a>, you’ll use a file-based <em>transaction log</em> to maintain a record of every time a resource is modified. If a service crashes, is restarted, or otherwise finds itself in an inconsistent state, a transaction log allows a service to reconstruct original state simply by replaying the transactions.<a data-type="indexterm" data-primary="transaction log" id="ch05_term10"/></p>&#13;
</li>&#13;
<li>&#13;
<p>In <a data-type="xref" href="#section_ch05_state_database">“Storing State in an External Database”</a>, you’ll use an external database instead of a file to store a transaction log. It might seem redundant to use a database given the nature of the application you’re building, but externalizing data into another service designed specifically for that purpose is a common means of sharing state between service replicas and providing resilience.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You may be wondering why you’re using a transaction log strategy to record the events when you could just use the database to store the values themselves. This makes sense when you intend to store your data in memory most of the time, only accessing your persistence mechanism in the background and at startup time.</p>&#13;
&#13;
<p>This also affords you another opportunity: given that you’re creating two different implementations of a similar functionality—a transaction log written both to a file and to a database—you can describe your functionality with an interface that both implementations can satisfy. This could come in quite handy, especially if you want to be able to choose the implementation according to your needs.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_ch05_statelessness">&#13;
<h5>Application State Versus Resource State</h5>&#13;
<p><a data-type="indexterm" data-primary="stateless" id="idm45983634026424"/><a data-type="indexterm" data-primary="state" data-seealso="application state, resource state" id="idm45983634025720"/>The term “stateless” is used a lot in the context of cloud native architecture, and state is often regarded as a Very Bad Thing. But what is state, exactly, and why is it so bad? Does an application have to be completely devoid of any kind of state to be “cloud native”? The answer is… well, it’s complicated.</p>&#13;
&#13;
<p>First, it’s important to draw a distinction between <em>application state</em> and <em>resource state</em>. These are very different things, but they’re easily confused.</p>&#13;
<dl>&#13;
<dt><a data-type="indexterm" data-primary="application state" id="idm45983634022488"/>Application state</dt>&#13;
<dd>&#13;
<p>Server-side data about the application or how it’s being used by a client. A common example is client session tracking, such as to associate them with their access credentials or some other application context.</p>&#13;
</dd>&#13;
<dt><a data-type="indexterm" data-primary="resource state" id="idm45983634020280"/>Resource state</dt>&#13;
<dd>&#13;
<p>The current state of a resource within a service at any point of time. It’s the same for every client, and has nothing to do with the interaction between client and server.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="indexterm" data-primary="server affinity" id="idm45983634017976"/>Any state introduces technical challenges, but application state is particularly problematic because it forces services to depend on <em>server affinity</em>—sending each of a user’s requests to the same server where their session was initiated—resulting in a more complex application and making it hard to destroy or replace service replicas.</p>&#13;
&#13;
<p>State and statelessness will be discussed in quite a bit more detail in <a data-type="xref" href="ch07.xhtml#section_ch07_state_and_statelessness">“State and Statelessness”</a>.</p>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="What’s a Transaction Log?"><div class="sect2" id="section_ch05_whats_a_transaction_log">&#13;
<h2>What’s a Transaction Log?</h2>&#13;
&#13;
<p>In its simplest form, a <em>transaction log</em> is just a log file that maintains a history of mutating changes executed by the data store. If a service crashes, is restarted, or otherwise finds itself in an inconsistent state, a transaction log makes it possible to replay the transactions to reconstruct the service’s functional state.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="resilience" data-secondary="reliability and" id="idm45983634012344"/>Transaction logs are commonly used by database management systems to provide a degree of data resilience against crashes or hardware failures. However, while this technique can get quite sophisticated, we’ll be keeping ours pretty straightforward.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Your transaction log format"><div class="sect3" id="section_ch05_log_format">&#13;
<h3>Your transaction log format</h3>&#13;
&#13;
<p>Before we get to the code, let’s decide what the transaction log should contain.</p>&#13;
&#13;
<p>We’ll assume that your transaction log will be read only when your service is restarted or otherwise needs to recover its state, and that it’ll be read from top to bottom, sequentially replaying each event. It follows that your transaction log will consist of an ordered list of mutating events. For speed and simplicity, a transaction log is also generally append-only, so when a record is deleted from your key-value store, for example, a <code>delete</code> is recorded in the log.</p>&#13;
&#13;
<p>Given everything we’ve discussed so far, each recorded transaction event will need to include the following attributes:</p>&#13;
<dl>&#13;
<dt><a data-type="indexterm" data-primary="sequence number" id="idm45983634006280"/>Sequence number</dt>&#13;
<dd>&#13;
<p>A unique record ID, in monotonically increasing order.</p>&#13;
</dd>&#13;
<dt>Event type</dt>&#13;
<dd>&#13;
<p>A descriptor of the type of action taken; this can be <code>PUT</code> or <code>DELETE</code>.</p>&#13;
</dd>&#13;
<dt><a data-type="indexterm" data-primary="key" id="idm45983634002024"/>Key</dt>&#13;
<dd>&#13;
<p>A string containing the key affected by this transaction.</p>&#13;
</dd>&#13;
<dt><a data-type="indexterm" data-primary="value" id="idm45983634000040"/>Value</dt>&#13;
<dd>&#13;
<p>If the event is a <code>PUT</code>, the value of the transaction.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Nice and simple. Hopefully we can keep it that way.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Your transaction logger interface"><div class="sect3" id="section_ch05_eventlogger_interface">&#13;
<h3>Your transaction logger interface</h3>&#13;
&#13;
<p>The first thing we’re going to do is define a <code>TransactionLogger</code> interface. For now, we’re only going to define two methods: <code>WritePut</code> and <code>WriteDelete</code>, which will be used to write <code>PUT</code> and <code>DELETE</code> events, respectively, to a transaction log:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">TransactionLogger</code> <code class="kd">interface</code> <code class="p">{</code>&#13;
    <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>You’ll no doubt want to add other methods later, but we’ll cross that bridge when we come to it. For now, let’s focus on the first implementation and add additional methods to the interface as we come across them.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Storing State in a Transaction Log File"><div class="sect2" id="section_ch05_state_transaction_log">&#13;
<h2>Storing State in a Transaction Log File</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="append-only log file" id="idm45983633947240"/>The first approach we’ll take is to use the most basic (and most common) form of transaction log, which is just an append-only log file that maintains a history of mutating changes executed by the data store. This file-based implementation has some tempting pros, but some pretty significant cons as well:</p>&#13;
&#13;
<p>Pros:</p>&#13;
<dl>&#13;
<dt>No downstream dependency</dt>&#13;
<dd>&#13;
<p>There’s no dependency on an external service that could fail or that we can lose access to.</p>&#13;
</dd>&#13;
<dt>Technically straightforward</dt>&#13;
<dd>&#13;
<p>The logic isn’t especially sophisticated. We can be up and running quickly.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Cons:</p>&#13;
<dl>&#13;
<dt>Harder to scale</dt>&#13;
<dd>&#13;
<p>You’ll need some additional way to distribute your state between nodes when you want to scale.</p>&#13;
</dd>&#13;
<dt>Uncontrolled growth</dt>&#13;
<dd>&#13;
<p>These logs have to be stored on disk, so you can’t let them grow forever. You’ll need some way of compacting them.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Prototyping your transaction logger"><div class="sect3" id="idm45983633938664">&#13;
<h3>Prototyping your transaction logger</h3>&#13;
&#13;
<p>Before we get to the code, let’s make some design decisions. First, for simplicity, the log will be written in plain text; a binary, compressed format might be more time- and space-efficient, but we can always optimize later. Second, each entry will be written on its own line; this will make it much easier to read the data later.</p>&#13;
&#13;
<p>Finally, each transaction will include the four fields listed in <a data-type="xref" href="#section_ch05_log_format">“Your transaction log format”</a>, delimited by tabs. Once again, these are:</p>&#13;
<dl>&#13;
<dt>Sequence number</dt>&#13;
<dd>&#13;
<p>A unique record ID, in monotonically increasing order.</p>&#13;
</dd>&#13;
<dt>Event type</dt>&#13;
<dd>&#13;
<p>A descriptor of the type of action taken; this can be <code>PUT</code> or <code>DELETE</code>.</p>&#13;
</dd>&#13;
<dt>Key</dt>&#13;
<dd>&#13;
<p>A string containing the key affected by this transaction.</p>&#13;
</dd>&#13;
<dt>Value</dt>&#13;
<dd>&#13;
<p>If the event is a <code>PUT</code>, the value of the transaction.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="indexterm" data-primary="WritePut method" id="ch05_term12"/><a data-type="indexterm" data-primary="WriteDelete method" id="ch05_term13"/>Now that we’ve established these fundamentals, let’s go ahead and define a type, &#13;
<span class="keep-together"><code>FileTransactionLogger</code></span>, which will implicitly implement the <code>TransactionLogger</code> interface described in <a data-type="xref" href="#section_ch05_eventlogger_interface">“Your transaction logger interface”</a> by defining <code>WritePut</code> and <code>WriteDelete</code> methods for writing <code>PUT</code> and <code>DELETE</code> events, respectively, to the transaction log:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">FileTransactionLogger</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Something, something, fields</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Something, something, logic</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Something, something, logic</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Clearly these methods are a little light on detail, but we’ll flesh them out soon!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Defining the event type"><div class="sect3" id="idm45983633820216">&#13;
<h3>Defining the event type</h3>&#13;
&#13;
<p>Thinking ahead, we probably want the <code>WritePut</code> and <code>WriteDelete</code> methods to operate asynchronously. You could implement that using some kind of <code>events</code> channel that some concurrent goroutine could read from and perform the log writes. That sounds like a nice idea, but if you’re going to do that you’ll need some kind of internal representation of an “event.”</p>&#13;
&#13;
<p>That shouldn’t give you too much trouble. Incorporating all of the fields that we listed in <a data-type="xref" href="#section_ch05_log_format">“Your transaction log format”</a> gives something like the <code>Event</code> struct, in the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">Event</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">Sequence</code>  <code class="kt">uint64</code>                <code class="c1">// A unique record ID</code>&#13;
    <code class="nx">EventType</code> <code class="nx">EventType</code>             <code class="c1">// The action taken</code>&#13;
    <code class="nx">Key</code>       <code class="kt">string</code>                <code class="c1">// The key affected by this transaction</code>&#13;
    <code class="nx">Value</code>     <code class="kt">string</code>                <code class="c1">// The value of a PUT the transaction</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Seems straightforward, right? <code>Sequence</code> is the sequence number, and <code>Key</code> and <code>Value</code> are self-explanatory. But…what’s an <code>EventType</code>? Well, it’s whatever we say it is, and we’re going to say that it’s a constant that we can use to refer to the different types of events, which we’ve already established will include one each for <code>PUT</code> and <code>DELETE</code> events.</p>&#13;
&#13;
<p>One way to do this might be to just assign some constant <code>byte</code> values, like this:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">EventDelete</code> <code class="kt">byte</code> <code class="p">=</code> <code class="mi">1</code>&#13;
    <code class="nx">EventPut</code>    <code class="kt">byte</code> <code class="p">=</code> <code class="mi">2</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="iota" id="ch05_term11"/>Sure, this would work, but Go actually provides a better (and more idiomatic) way: <code>iota</code>. <code>iota</code> is a predefined value that can be used in a <code>constant</code> declaration to construct a series of related constant values.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_ch05_iota">&#13;
<h5>Declaring Constants with Iota</h5>&#13;
<p>When used in a <code>constant</code> declaration, <code>iota</code> represents successive untyped integer constants that can be used to construct a set of related constants. Its value restarts at zero in each <code>constant</code> declaration and increments with each constant assignment (whether or not the <code>iota</code> identifier is actually referenced).</p>&#13;
&#13;
<p>An <code>iota</code> can also be operated upon. We demonstrate this in the following by using in multiplication, left binary shift, and division operations:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">a</code> <code class="p">=</code> <code class="mi">42</code> <code class="o">*</code> <code class="kc">iota</code>           <code class="c1">// iota == 0; a == 0</code>&#13;
    <code class="nx">b</code> <code class="p">=</code> <code class="mi">1</code> <code class="o">&lt;&lt;</code> <code class="kc">iota</code>           <code class="c1">// iota == 1; b == 2</code>&#13;
    <code class="nx">c</code> <code class="p">=</code> <code class="mi">3</code>                   <code class="c1">// iota == 2; c == 3 (iota increments anyway!)</code>&#13;
    <code class="nx">d</code> <code class="p">=</code> <code class="kc">iota</code> <code class="o">/</code> <code class="mi">2</code>            <code class="c1">// iota == 3; d == 1</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>Because <code>iota</code> is itself an untyped number, you can use it to make typed assignments without explicit type casts. You can even assign <code>iota</code> to a <code>float64</code> value:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">u</code>         <code class="p">=</code> <code class="kc">iota</code> <code class="o">*</code> <code class="mi">42</code>   <code class="c1">// iota == 0; u == 0 (untyped integer constant)</code>&#13;
    <code class="nx">v</code> <code class="kt">float64</code> <code class="p">=</code> <code class="kc">iota</code> <code class="o">*</code> <code class="mi">42</code>   <code class="c1">// iota == 1; v == 42.0 (float64 constant)</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>The <code>iota</code> keyword allows implicit repetition, which makes it trivial to create arbitrarily long sets of related constants, like we do in the following with the numbers of bytes in various digital units:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">ByteSize</code> <code class="kt">uint64</code>&#13;
&#13;
<code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">_</code>           <code class="p">=</code> <code class="kc">iota</code>                  <code class="c1">// iota == 0; ignore the zero value</code>&#13;
    <code class="nx">KB</code> <code class="nx">ByteSize</code> <code class="p">=</code> <code class="mi">1</code> <code class="o">&lt;&lt;</code> <code class="p">(</code><code class="mi">10</code> <code class="o">*</code> <code class="kc">iota</code><code class="p">)</code>      <code class="c1">// iota == 1; KB == 2^10</code>&#13;
    <code class="nx">MB</code>                                  <code class="c1">// iota == 2; MB == 2^20</code>&#13;
    <code class="nx">GB</code>                                  <code class="c1">// iota == 3; GB == 2^30</code>&#13;
    <code class="nx">TB</code>                                  <code class="c1">// iota == 4; TB == 2^40</code>&#13;
    <code class="nx">PB</code>                                  <code class="c1">// iota == 5; PB == 2^50</code>&#13;
<code class="p">)</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Using the <code>iota</code> technique, you don’t have to manually assign values to constants. Instead, you can do something like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">EventType</code> <code class="kt">byte</code>&#13;
&#13;
<code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">_</code>                     <code class="p">=</code> <code class="kc">iota</code>         <code class="c1">// iota == 0; ignore the zero value</code>&#13;
    <code class="nx">EventDelete</code> <code class="nx">EventType</code> <code class="p">=</code> <code class="kc">iota</code>         <code class="c1">// iota == 1</code>&#13;
    <code class="nx">EventPut</code>                             <code class="c1">// iota == 2; implicitly repeat</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>This might not be a big deal when you only have two constants like we have here, but it can come in handy when you have a number of related constants and don’t want to be bothered manually keeping track of which value is assigned to what.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you’re using <code>iota</code> as enumerations in serializations (as we are here), take care to only <em>append</em> to the list, and don’t reorder or insert values in the middle, or you won’t be able to deserialize later.<a data-type="indexterm" data-primary="iota" data-startref="ch05_term11" id="idm45983633529384"/></p>&#13;
</div>&#13;
&#13;
<p>We now have an idea of what the <code>TransactionLogger</code> will look like, as well as the two primary write methods. We’ve also defined a struct that describes a single event, and created a new <code>EventType</code> type and used <code>iota</code> to define its legal values. Now we’re finally ready to get started.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Implementing your FileTransactionLogger"><div class="sect3" id="section_ch05_implementing_filetransactionlogger">&#13;
<h3>Implementing your FileTransactionLogger</h3>&#13;
&#13;
<p>We’ve made some progress. We know we want a <code>TransactionLogger</code> implementation with methods for writing events, and we’ve created a description of an event in code. But what about the <code>FileTransactionLogger</code> itself?</p>&#13;
&#13;
<p>The service will want to keep track of the physical location of the transaction log, so it makes sense to have an <code>os.File</code> attribute representing that. It’ll also need to remember the last sequence number that was assigned so it can correctly set each event’s sequence number; that can be kept as an unsigned 64-bit integer attribute. That’s great, but how will the <code>FileTransactionLogger</code> actually write the events?</p>&#13;
&#13;
<p>One possible approach would be to keep an <code>io.Writer</code> that the <code>WritePut</code> and <code>WriteDelete</code> methods can operate on directly, but that would be a single-threaded approach, so unless you explicitly execute them in goroutines, you may find yourself spending more time in I/O than you’d like. Alternatively, you could create a buffer from a slice of <code>Event</code> values that are processed by a separate goroutine. Definitely warmer, but too complicated.<a data-type="indexterm" data-primary="WritePut method" data-startref="ch05_term12" id="idm45983633573048"/><a data-type="indexterm" data-primary="WriteDelete method" data-startref="ch05_term13" id="idm45983633572072"/></p>&#13;
&#13;
<p>After all, why go through all of that work when we can just use standard buffered channels? Taking our own advice, we end up with a <code>FileTransactionLogger</code> and <code>Write</code> methods that look like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">FileTransactionLogger</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">events</code>       <code class="kd">chan</code><code class="o">&lt;-</code> <code class="nx">Event</code>       <code class="c1">// Write-only channel for sending events</code>&#13;
    <code class="nx">errors</code>       <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code>       <code class="c1">// Read-only channel for receiving errors</code>&#13;
    <code class="nx">lastSequence</code> <code class="kt">uint64</code>             <code class="c1">// The last used event sequence number</code>&#13;
    <code class="nx">file</code>         <code class="o">*</code><code class="nx">os</code><code class="p">.</code><code class="nx">File</code>           <code class="c1">// The location of the transaction log</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="o">&lt;-</code> <code class="nx">Event</code><code class="p">{</code><code class="nx">EventType</code><code class="p">:</code> <code class="nx">EventPut</code><code class="p">,</code> <code class="nx">Key</code><code class="p">:</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">Value</code><code class="p">:</code> <code class="nx">value</code><code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="o">&lt;-</code> <code class="nx">Event</code><code class="p">{</code><code class="nx">EventType</code><code class="p">:</code> <code class="nx">EventDelete</code><code class="p">,</code> <code class="nx">Key</code><code class="p">:</code> <code class="nx">key</code><code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">Err</code><code class="p">()</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">l</code><code class="p">.</code><code class="nx">errors</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>You now have your <code>FileTransactionLogger</code>, which has a <code>uint64</code> value that’s used to track the last-used event sequence number, a write-only channel that receives <code>Event</code> values, and <code>WritePut</code> and <code>WriteDelete</code> methods that send <code>Event</code> values into that channel.</p>&#13;
&#13;
<p>But it looks like there might be a part left over: there’s an <code>Err</code> method there that returns a receive-only error channel. There’s a good reason for that. We’ve already mentioned that writes to the transaction log will be done concurrently by a goroutine that receives events from the <code>events</code> channel. While that makes for a more efficient write, it also means that <code>WritePut</code> and <code>WriteDelete</code> can’t simply return an <code>error</code> when they encounter a problem, so we provide a dedicated error channel to communicate errors instead.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Creating a new FileTransactionLogger"><div class="sect3" id="idm45983633411464">&#13;
<h3>Creating a new FileTransactionLogger</h3>&#13;
&#13;
<p>If you’ve followed along so far you may have noticed that none of the attributes in the <code>FileTransactionLogger</code> have been initialized. If you don’t fix this issue, it’s going &#13;
<span class="keep-together">to cause</span> some problems. Go doesn’t have constructors, though, so to solve this you &#13;
<span class="keep-together">need to define</span> a construction function, which you’ll call, for lack of a better name,<sup><a data-type="noteref" id="idm45983633408024-marker" href="ch05.xhtml#idm45983633408024">9</a></sup> &#13;
<span class="keep-together"><code>NewFileTransactionLogger</code>:</span></p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">NewFileTransactionLogger</code><code class="p">(</code><code class="nx">filename</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="nx">TransactionLogger</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">file</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">os</code><code class="p">.</code><code class="nx">OpenFile</code><code class="p">(</code><code class="nx">filename</code><code class="p">,</code> <code class="nx">os</code><code class="p">.</code><code class="nx">O_RDWR</code><code class="p">|</code><code class="nx">os</code><code class="p">.</code><code class="nx">O_APPEND</code><code class="p">|</code><code class="nx">os</code><code class="p">.</code><code class="nx">O_CREATE</code><code class="p">,</code> <code class="mo">0755</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"cannot open transaction log file: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="o">&amp;</code><code class="nx">FileTransactionLogger</code><code class="p">{</code><code class="nx">file</code><code class="p">:</code> <code class="nx">file</code><code class="p">},</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>See how <code>NewFileTransactionLogger</code> returns a pointer type, but its return list specifies the decidedly nonpointy <code>TransactionLogger</code> interface type?</p>&#13;
&#13;
<p>The reason for this is tricksy: while Go allows pointer types to implement an interface, it doesn’t allow pointers to interface types.</p>&#13;
</div>&#13;
&#13;
<p><code>NewFileTransactionLogger</code> calls the <code>os.OpenFile</code> function to open the file specified by the <code>filename</code> parameter. You’ll notice it accepts several flags that have been binary <code>OR</code>-ed together to set its behavior:</p>&#13;
<dl>&#13;
<dt><code>os.O_RDWR</code></dt>&#13;
<dd>&#13;
<p>Opens the file in read/write mode.</p>&#13;
</dd>&#13;
<dt><code>os.O_APPEND</code></dt>&#13;
<dd>&#13;
<p>Any writes to this file will append, not overwrite.</p>&#13;
</dd>&#13;
<dt><code>os.O_CREATE</code></dt>&#13;
<dd>&#13;
<p>If the file doesn’t exist, creates it.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>There are quite a few of these flags besides the three we use here. Take a look at <a href="https://pkg.go.dev/os">the <code>os</code> package documentation</a> for a full listing.</p>&#13;
&#13;
<p>We now have a construction function that ensures that the transaction log file is &#13;
<span class="keep-together">correctly</span> created. But what about the channels? We <em>could</em> create the channels and spawn a goroutine with &#13;
<span class="keep-together"><code>NewFileTransactionLogger</code></span>, but that feels like we’d be adding too much mysterious functionality. Instead, we’ll create a <code>Run</code> method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Appending entries to the transaction log"><div class="sect3" id="section_ch05_appending_entries">&#13;
<h3>Appending entries to the transaction log</h3>&#13;
&#13;
<p>As of yet, there’s nothing reading from the <code>events</code> channel, which is less than ideal. What’s worse, the channels aren’t even initialized. Let’s change this by creating a <code>Run</code> method, shown in the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">Run</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">events</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="mi">16</code><code class="p">)</code>              <code class="c1">// Make an events channel</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="p">=</code> <code class="nx">events</code>&#13;
&#13;
    <code class="nx">errors</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>               <code class="c1">// Make an errors channel</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">errors</code> <code class="p">=</code> <code class="nx">errors</code>&#13;
&#13;
    <code class="k">go</code> <code class="kd">func</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">for</code> <code class="nx">e</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">events</code> <code class="p">{</code>                 <code class="c1">// Retrieve the next Event</code>&#13;
&#13;
            <code class="nx">l</code><code class="p">.</code><code class="nx">lastSequence</code><code class="o">++</code>                    <code class="c1">// Increment sequence number</code>&#13;
&#13;
            <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Fprintf</code><code class="p">(</code>              <code class="c1">// Write the event to the log</code>&#13;
                <code class="nx">l</code><code class="p">.</code><code class="nx">file</code><code class="p">,</code>&#13;
                <code class="s">"%d\t%d\t%s\t%s\n"</code><code class="p">,</code>&#13;
                <code class="nx">l</code><code class="p">.</code><code class="nx">lastSequence</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">EventType</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code>&#13;
&#13;
            <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
                <code class="nx">errors</code> <code class="o">&lt;-</code> <code class="nx">err</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}()</code>&#13;
<code class="p">}</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This implementation is incredibly basic. It won’t even correctly handle entries with whitespace or multiple lines!</p>&#13;
</div>&#13;
&#13;
<p>The <code>Run</code> function does several important things.</p>&#13;
&#13;
<p>First, it creates a buffered <code>events</code> channel. Using a buffered channel in our <code>TransactionLogger</code> means that calls to <code>WritePut</code> and <code>WriteDelete</code> won’t block as long as the buffer isn’t full. This lets the consuming service handle short bursts of events without being slowed by disk I/O. If the buffer does fill up, then the write methods will block until the log writing goroutine catches up.</p>&#13;
&#13;
<p>Second, it creates an <code>errors</code> channel, which is also buffered, that we’ll use to signal any errors that arise in the goroutine that’s responsible for concurrently writing events to the transaction log. The buffer value of <code>1</code> allows us to send an error in a nonblocking manner.</p>&#13;
&#13;
<p>Finally, it starts a goroutine that retrieves <code>Event</code> values from our <code>events</code> channel and uses the <code>fmt.Fprintf</code> function to write them to the transaction log. If <code>fmt.Fprintf</code> returns an <code>error</code>, the goroutine sends the error to the <code>errors</code> channel and halts.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Using a bufio.Scanner to play back file transaction logs"><div class="sect3" id="section_ch05_scanner_playback">&#13;
<h3>Using a bufio.Scanner to play back file transaction logs</h3>&#13;
&#13;
<p>Even the best transaction log is useless if it’s never read.<sup><a data-type="noteref" id="idm45983633120568-marker" href="ch05.xhtml#idm45983633120568">10</a></sup> But how do we do that?</p>&#13;
&#13;
<p>You’ll need to read the log from the beginning and parse each line; <code>io.ReadString</code> and <code>fmt.Sscanf</code> let you do this with minimal fuss.</p>&#13;
&#13;
<p>Channels, our dependable friends, will let your service stream the results to a consumer as it retrieves them. This might be starting to feel routine, but stop for a second to appreciate it. In most other languages the path of least resistance here would be to read in the entire file, stash it in an array, and finally loop over that array to replay the events. Go’s convenient concurrency primitives make it almost trivially easy to stream the data to the consumer in a much more space- and memory-efficient way.</p>&#13;
&#13;
<p>The <code>ReadEvents</code> method<sup><a data-type="noteref" id="idm45983633116792-marker" href="ch05.xhtml#idm45983633116792">11</a></sup> demonstrates this:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">FileTransactionLogger</code><code class="p">)</code> <code class="nx">ReadEvents</code><code class="p">()</code> <code class="p">(</code><code class="o">&lt;-</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">scanner</code> <code class="o">:=</code> <code class="nx">bufio</code><code class="p">.</code><code class="nx">NewScanner</code><code class="p">(</code><code class="nx">l</code><code class="p">.</code><code class="nx">file</code><code class="p">)</code>     <code class="c1">// Create a Scanner for l.file</code>&#13;
    <code class="nx">outEvent</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">)</code>            <code class="c1">// An unbuffered Event channel</code>&#13;
    <code class="nx">outError</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>         <code class="c1">// A buffered error channel</code>&#13;
&#13;
    <code class="k">go</code> <code class="kd">func</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="kd">var</code> <code class="nx">e</code> <code class="nx">Event</code>&#13;
&#13;
        <code class="k">defer</code> <code class="nb">close</code><code class="p">(</code><code class="nx">outEvent</code><code class="p">)</code>               <code class="c1">// Close the channels when the</code>&#13;
        <code class="k">defer</code> <code class="nb">close</code><code class="p">(</code><code class="nx">outError</code><code class="p">)</code>               <code class="c1">// goroutine ends</code>&#13;
&#13;
        <code class="k">for</code> <code class="nx">scanner</code><code class="p">.</code><code class="nx">Scan</code><code class="p">()</code> <code class="p">{</code>&#13;
            <code class="nx">line</code> <code class="o">:=</code> <code class="nx">scanner</code><code class="p">.</code><code class="nx">Text</code><code class="p">()</code>&#13;
&#13;
            <code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sscanf</code><code class="p">(</code><code class="nx">line</code><code class="p">,</code> <code class="s">"%d\t%d\t%s\t%s"</code><code class="p">,</code>&#13;
                <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Sequence</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">EventType</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Value</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
&#13;
                <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"input parse error: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="c1">// Sanity check! Are the sequence numbers in increasing order?</code>&#13;
            <code class="k">if</code> <code class="nx">l</code><code class="p">.</code><code class="nx">lastSequence</code> <code class="o">&gt;=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Sequence</code> <code class="p">{</code>&#13;
                <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"transaction numbers out of sequence"</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="nx">l</code><code class="p">.</code><code class="nx">lastSequence</code> <code class="p">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Sequence</code>     <code class="c1">// Update last used sequence #</code>&#13;
&#13;
            <code class="nx">outEvent</code> <code class="o">&lt;-</code> <code class="nx">e</code>                   <code class="c1">// Send the event along</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">scanner</code><code class="p">.</code><code class="nx">Err</code><code class="p">();</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"transaction log read failure: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}()</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">outEvent</code><code class="p">,</code> <code class="nx">outError</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>ReadEvents</code> method can really be said to be two functions in one: the outer function initializes the file reader, and creates and returns the event and error channels. The inner function runs concurrently to ingest the file contents line by line and send the results to the channels.</p>&#13;
&#13;
<p>Interestingly, the <code>file</code> attribute of <code>TransactionLogger</code> is of type <code>*os.File</code>, which has a <code>Read</code> method that satisfies the <code>io.Reader</code> interface. <code>Read</code> is fairly low-level, but, if you wanted to, you could actually use it to retrieve the data. The <code>bufio</code> package, however, gives us a better way: the <code>Scanner</code> interface, which provides a convenient means for reading newline-delimited lines of text. We can get a new <code>Scanner</code> value by passing an <code>io.Reader</code>—an <code>os.File</code> in this case—to <code>bufio.NewScanner</code>.</p>&#13;
&#13;
<p>Each call to the <code>scanner.Scan</code> method advances it to the next line, returning <code>false</code> if there aren’t any lines left. A subsequent call to <code>scanner.Text</code> returns the line.</p>&#13;
&#13;
<p>Note the <code>defer</code> statements in the inner anonymous goroutine. These ensure that the output channels are always closed. Because <code>defer</code> is scoped to the function they’re declared in, these get called at the end of the goroutine, not <code>ReadEvents</code>.</p>&#13;
&#13;
<p>You may recall from <a data-type="xref" href="ch03.xhtml#sidebar_ch03_printf">“Formatting I/O in Go”</a> that the <code>fmt.Sscanf</code> function provides a simple (but sometimes simplistic) means of parsing simple strings. Like the other methods in the <code>fmt</code> package, the expected format is specified using a format string with various “verbs” embedded: two digits (<code>%d</code>) and two strings (<code>%s</code>), separated by tab characters (<code>\t</code>). Conveniently, <code>fmt.Sscanf</code> lets you pass in pointers to the target values for each verb, which it can update directly.<sup><a data-type="noteref" id="idm45983632869720-marker" href="ch05.xhtml#idm45983632869720">12</a></sup></p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><a data-type="indexterm" data-primary="Go" data-secondary="formatting" id="idm45983632868440"/><a data-type="indexterm" data-primary="C (language)" id="idm45983632867240"/><a data-type="indexterm" data-primary="C++" id="idm45983632866568"/><a data-type="indexterm" data-primary="Java" id="idm45983632865896"/><a data-type="indexterm" data-primary="Perl" id="idm45983632865224"/><a data-type="indexterm" data-primary="PHP" id="idm45983632864552"/><a data-type="indexterm" data-primary="Ruby" id="idm45983632863880"/><a data-type="indexterm" data-primary="Scala" id="idm45983632863208"/>Go’s format strings have a long history dating back to C’s <code>printf</code> and <code>scanf</code>, but they’ve been adopted by many other languages over the years, including C++, Java, Perl, PHP, Ruby, and Scala. You may already be familiar with them, but if you’re not, take a break now to look at <a href="https://pkg.go.dev/fmt">the <code>fmt</code> package documentation</a>.</p>&#13;
</div>&#13;
&#13;
<p>At the end of each loop the last-used sequence number is updated to the value that was just read, and the event is sent on its merry way. A minor point: note how the same <code>Event</code> value is reused on each iteration rather than creating a new one. This is possible because the <code>outEvent</code> channel is sending struct values, not <em>pointers</em> to struct values, so it already provides copies of whatever value we send into it.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Scan method" id="idm45983632857928"/>Finally, the function checks for <code>Scanner</code> errors. The <code>Scan</code> method returns only a single boolean value, which is really convenient for looping. Instead, when it encounters an error, <code>Scan</code> returns <code>false</code> and exposes the error via the <code>Err</code> method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Your transaction logger interface (redux)"><div class="sect3" id="section_ch05_logger_redux">&#13;
<h3>Your transaction logger interface (redux)</h3>&#13;
&#13;
<p>Now that you’ve implemented a fully functional <code>FileTransactionLogger</code>, it’s time &#13;
<span class="keep-together">to look</span> back and see which of the new methods we can use to incorporate into the &#13;
<span class="keep-together"><code>TransactionLogger</code></span> interface. It actually looks like there are quite few we might &#13;
<span class="keep-together">like to</span> keep in any implementation, leaving us with the following final form for the &#13;
<span class="keep-together"><code>TransactionLogger</code></span> interface:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">TransactionLogger</code> <code class="kd">interface</code> <code class="p">{</code>&#13;
    <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="nx">Err</code><code class="p">()</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code>&#13;
&#13;
    <code class="nx">ReadEvents</code><code class="p">()</code> <code class="p">(</code><code class="o">&lt;-</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">Run</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now that that’s settled, you can finally start integrating the transaction log into your key-value service.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Initializing the FileTransactionLogger in your web service"><div class="sect3" id="idm45983632854616">&#13;
<h3>Initializing the FileTransactionLogger in your web service</h3>&#13;
&#13;
<p>The <code>FileTransactionLogger</code> is now complete! All that’s left to do now is to integrate it with your web service. The first step of this is to add a new function that can create a new <code>TransactionLogger</code> value, read in and replay any existing events, and call <code>Run</code>.</p>&#13;
&#13;
<p>First, let’s add a <code>TransactionLogger</code> reference to our <code>service.go</code>. You can call it &#13;
<span class="keep-together"><code>logger</code></span> because naming is hard:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code> <code class="nx">logger</code> <code class="nx">TransactionLogger</code></pre>&#13;
&#13;
<p>Now that you have that detail out of the way, you can define your initialization method, which can look like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">initializeTransactionLog</code><code class="p">()</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="kd">var</code> <code class="nx">err</code> <code class="kt">error</code>&#13;
&#13;
    <code class="nx">logger</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">NewFileTransactionLogger</code><code class="p">(</code><code class="s">"transaction.log"</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to create event logger: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">events</code><code class="p">,</code> <code class="nx">errors</code> <code class="o">:=</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">ReadEvents</code><code class="p">()</code>&#13;
    <code class="nx">e</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">Event</code><code class="p">{},</code> <code class="kc">true</code>&#13;
&#13;
    <code class="k">for</code> <code class="nx">ok</code> <code class="o">&amp;&amp;</code> <code class="nx">err</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">select</code> <code class="p">{</code>&#13;
        <code class="k">case</code> <code class="nx">err</code><code class="p">,</code> <code class="nx">ok</code> <code class="p">=</code> <code class="o">&lt;-</code><code class="nx">errors</code><code class="p">:</code>                <code class="c1">// Retrieve any errors</code>&#13;
        <code class="k">case</code> <code class="nx">e</code><code class="p">,</code> <code class="nx">ok</code> <code class="p">=</code> <code class="o">&lt;-</code><code class="nx">events</code><code class="p">:</code>&#13;
            <code class="k">switch</code> <code class="nx">e</code><code class="p">.</code><code class="nx">EventType</code> <code class="p">{</code>&#13;
            <code class="k">case</code> <code class="nx">EventDelete</code><code class="p">:</code>                   <code class="c1">// Got a DELETE event!</code>&#13;
                <code class="nx">err</code> <code class="p">=</code> <code class="nx">Delete</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">)</code>&#13;
            <code class="k">case</code> <code class="nx">EventPut</code><code class="p">:</code>                      <code class="c1">// Got a PUT event!</code>&#13;
                <code class="nx">err</code> <code class="p">=</code> <code class="nx">Put</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">logger</code><code class="p">.</code><code class="nx">Run</code><code class="p">()</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">err</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This function starts as you’d expect: it calls <code>NewFileTransactionLogger</code> and assigns it to <code>logger</code>.</p>&#13;
&#13;
<p>The next part is more interesting: it calls <code>logger.ReadEvents</code>, and replays the results based on the <code>Event</code> values received from it. This is done by looping over a <code>select</code> with cases for both the <code>events</code> and <code>errors</code> channels. Note how the cases in the <code>select</code> use the format <code>case foo, ok = &lt;-ch</code>. The <code>bool</code> returned by a channel read in this way will be <code>false</code> if the channel in question has been closed, setting the value of <code>ok</code> and terminating the <code>for</code> loop.</p>&#13;
&#13;
<p>If we get an <code>Event</code> value from the <code>events</code> channel, we call either <code>Delete</code> or <code>Put</code> as appropriate; if we get an error from the <code>errors</code> channel, <code>err</code> will be set to a non-<code>nil</code> value and the <code>for</code> loop will be terminated.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Integrating FileTransactionLogger with your web service"><div class="sect3" id="idm45983632518808">&#13;
<h3>Integrating FileTransactionLogger with your web service</h3>&#13;
&#13;
<p>Now that the initialization logic is put together, all that’s left to do to complete the integration of the <code>TransactionLogger</code> is add exactly three function calls into the web service. This is fairly straightforward, so we won’t walk through it here. But, briefly, you’ll need to add the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>initializeTransactionLog</code> to the <code>main</code> method</p>&#13;
</li>&#13;
<li>&#13;
<p><code>logger.WriteDelete</code> to <code>keyValueDeleteHandler</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>logger.WritePut</code> to <code>keyValuePutHandler</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We’ll leave the actual integration as an exercise for the reader.<sup><a data-type="noteref" id="idm45983632511416-marker" href="ch05.xhtml#idm45983632511416">13</a></sup></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Future improvements"><div class="sect3" id="idm45983632510600">&#13;
<h3>Future improvements</h3>&#13;
&#13;
<p>We may have completed a minimal viable implementation of our transaction logger, but it still has plenty of issues and opportunities for improvement, such as:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>There aren’t any tests.</p>&#13;
</li>&#13;
<li>&#13;
<p>There’s no <code>Close</code> method to gracefully close the file.</p>&#13;
</li>&#13;
<li>&#13;
<p>The service can close with events still in the write buffer: events can get lost.</p>&#13;
</li>&#13;
<li>&#13;
<p>Keys and values aren’t encoded in the transaction log: multiple lines or whitespace will fail to parse correctly.</p>&#13;
</li>&#13;
<li>&#13;
<p>The sizes of keys and values are unbound: huge keys or values can be added, filling the disk.</p>&#13;
</li>&#13;
<li>&#13;
<p>The transaction log is written in plain text: it will take up more disk space than it probably needs to.</p>&#13;
</li>&#13;
<li>&#13;
<p>The log retains records of deleted values forever: it will grow indefinitely.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>All of these would be impediments in production. I encourage you to take the time to consider—or even implement—solutions to one or more of these points.<a data-type="indexterm" data-primary="transaction log" data-startref="ch05_term10" id="idm45983632501096"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Storing State in an External Database"><div class="sect2" id="section_ch05_state_database">&#13;
<h2>Storing State in an External Database</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Go" data-secondary="libraries" id="idm45983632498168"/><a data-type="indexterm" data-primary="SQL databases" id="ch05_term16"/>Databases, and data, are at the core of many, if not most, business and web applications, so it makes perfect sense that Go includes a standard interface for SQL (or SQL-like) databases <a href="https://oreil.ly/NosgK">in its core libraries</a>.</p>&#13;
&#13;
<p>But does it make sense to use a SQL database to back our key-value store? After all, isn’t it redundant for our data store to just depend on another data store? Yes, certainly. But externalizing a service’s data into another service designed specifically for that purpose—a database—is a common pattern that allows state to be shared between service replicas and provides data resilience. Besides, the point is to show how you might interact with a database, not to design the perfect application.</p>&#13;
&#13;
<p>In this section, you’ll be implementing a transaction log backed by an external database and satisfying the <code>TransactionLogger</code> interface, just as you did in <a data-type="xref" href="#section_ch05_state_transaction_log">“Storing State in a Transaction Log File”</a>. This would certainly work, and even have some benefits as mentioned previously, but it comes with some tradeoffs:</p>&#13;
&#13;
<p>Pros:</p>&#13;
<dl>&#13;
<dt>Externalizes application state</dt>&#13;
<dd>&#13;
<p>Less need to worry about distributed state and closer to “cloud native.”</p>&#13;
</dd>&#13;
<dt>Easier to scale</dt>&#13;
<dd>&#13;
<p>Not having to share data between replicas makes scaling out <em>easier</em> (but not <em>easy</em>).</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Cons:</p>&#13;
<dl>&#13;
<dt>Introduces a bottleneck</dt>&#13;
<dd>&#13;
<p>What if you had to scale way up? What if all replicas had to read from the database at once?</p>&#13;
</dd>&#13;
<dt>Introduces an upstream dependency</dt>&#13;
<dd>&#13;
<p>Creates a dependency on another resource that might fail.</p>&#13;
</dd>&#13;
<dt>Requires initialization</dt>&#13;
<dd>&#13;
<p>What if the <code>Transactions</code> table doesn’t exist?</p>&#13;
</dd>&#13;
<dt>Increases complexity</dt>&#13;
<dd>&#13;
<p>Yet another thing to manage and configure.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Working with databases in Go"><div class="sect3" id="idm45983632480872">&#13;
<h3>Working with databases in Go</h3>&#13;
&#13;
<p>Databases, particularly SQL and SQL-like databases, are everywhere. You can try to avoid them, but if you’re building applications with some kind of data component, you will at some point have to interact with one.</p>&#13;
&#13;
<p>Fortunately for us, the creators of the Go standard library provided <a href="https://oreil.ly/YKPZ6">the <code>database/sql</code> package</a>, which provides an idiomatic and lightweight interface around SQL (and SQL-like) databases. In this section we’ll briefly demonstrate how to use this package, and point out some of the gotchas along the way.</p>&#13;
&#13;
<p>Among the most ubiquitous members of the <code>database/sql</code> package is <code>sql.DB</code>: Go’s primary database abstraction and entry point for creating statements and transactions, executing queries, and fetching results. While it doesn’t, as its name might suggest, map to any particular concept of a database or schema, it does do quite a lot of things for you, including, but not limited to, negotiating connections with your database and managing a database connection pool.</p>&#13;
&#13;
<p>We’ll get into how you create your <code>sql.DB</code> in a bit. But first, we have to talk about database drivers.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Importing a database driver"><div class="sect3" id="idm45983632474616">&#13;
<h3>Importing a database driver</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="database driver" id="idm45983632473128"/>While the <code>sql.DB</code> type provides a common interface for interacting with a SQL database, it depends on database drivers to implement the specifics for particular database types. At the time of this writing there are 45 drivers listed <a href="https://oreil.ly/QDQIe">in the Go repository</a>.</p>&#13;
&#13;
<p>In the following section we’ll be working with a Postgres database, so we’ll use the third-party <a href="https://oreil.ly/hYW8r"><code>lib/pq</code> Postgres driver implementation</a>.</p>&#13;
&#13;
<p>To load a database driver, anonymously import the driver package by aliasing its package qualifier to <code>_</code>. This triggers any initializers the package might have while also informing the compiler that you have no intention of directly using it:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kn">import</code> <code class="p">(</code>&#13;
    <code class="s">"database/sql"</code>&#13;
    <code class="nx">_</code> <code class="s">"github.com/lib/pq"</code>       <code class="c1">// Anonymously import the driver package</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>Now that you’ve done this, you’re finally ready to create your <code>sql.DB</code> value and access the database.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Implementing your PostgresTransactionLogger"><div class="sect3" id="section_ch05_implementing_postgrestransactionlogger">&#13;
<h3>Implementing your PostgresTransactionLogger</h3>&#13;
&#13;
<p>Previously, we presented the <code>TransactionLogger</code> interface, which provides a standard definition for a generic transaction log. You might recall that it defined methods for starting the logger, as well as reading and writing events to the log, as detailed here:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">TransactionLogger</code> <code class="kd">interface</code> <code class="p">{</code>&#13;
    <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="nx">Err</code><code class="p">()</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code>&#13;
&#13;
    <code class="nx">ReadEvents</code><code class="p">()</code> <code class="p">(</code><code class="o">&lt;-</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">Run</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Our goal now is to create a database-backed implementation of <code>TransactionLogger</code>. Fortunately, much of our work is already done for us. Looking back at <a data-type="xref" href="#section_ch05_implementing_filetransactionlogger">“Implementing your FileTransactionLogger”</a> for guidance, it looks like we can create a <code>PostgresTransactionLogger</code> using very similar logic.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="WritePut method" id="idm45983632365448"/><a data-type="indexterm" data-primary="WriteDelete method" id="idm45983632364808"/>Starting with the <code>WritePut</code>, <code>WriteDelete</code>, and <code>Err</code> methods, you can do something like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">PostgresTransactionLogger</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">events</code>       <code class="kd">chan</code><code class="o">&lt;-</code> <code class="nx">Event</code>       <code class="c1">// Write-only channel for sending events</code>&#13;
    <code class="nx">errors</code>       <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code>       <code class="c1">// Read-only channel for receiving errors</code>&#13;
    <code class="nx">db</code>           <code class="o">*</code><code class="nx">sql</code><code class="p">.</code><code class="nx">DB</code>            <code class="c1">// The database access interface</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">PostgresTransactionLogger</code><code class="p">)</code> <code class="nx">WritePut</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="o">&lt;-</code> <code class="nx">Event</code><code class="p">{</code><code class="nx">EventType</code><code class="p">:</code> <code class="nx">EventPut</code><code class="p">,</code> <code class="nx">Key</code><code class="p">:</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">Value</code><code class="p">:</code> <code class="nx">value</code><code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">PostgresTransactionLogger</code><code class="p">)</code> <code class="nx">WriteDelete</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="o">&lt;-</code> <code class="nx">Event</code><code class="p">{</code><code class="nx">EventType</code><code class="p">:</code> <code class="nx">EventDelete</code><code class="p">,</code> <code class="nx">Key</code><code class="p">:</code> <code class="nx">key</code><code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">PostgresTransactionLogger</code><code class="p">)</code> <code class="nx">Err</code><code class="p">()</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">l</code><code class="p">.</code><code class="nx">errors</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If you compare this to the <code>FileTransactionLogger</code> it’s clear that the code is nearly identical. All we’ve really changed is:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Renaming (obviously) the type to <code>PostgresTransactionLogger</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Swapping the <code>*os.File</code> for a <code>*sql.DB</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Removing <code>lastSequence</code>; you can let the database handle the sequencing</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Creating a new PostgresTransactionLogger"><div class="sect3" id="idm45983632202888">&#13;
<h3>Creating a new PostgresTransactionLogger</h3>&#13;
&#13;
<p>That’s all well and good, but we still haven’t talked about how we create the <code>sql.DB</code>. I know how you must feel. The suspense is definitely killing me, too.</p>&#13;
&#13;
<p>Much like we did in the <code>NewFileTransactionLogger</code> function, we’re going to create a construction function for our <code>PostgresTransactionLogger</code>, which we’ll call (quite predictably) <code>NewPostgresTransactionLogger</code>. However, instead of opening a file like <code>NewFileTransactionLogger</code>, it’ll establish a connection with the database, returning an <code>error</code> if it fails.</p>&#13;
&#13;
<p>There’s a little bit of a wrinkle, though. Namely, that the setup for a Postgres connection takes a lot of parameters. At the bare minimum we need to know the host where the database lives, the name of the database, and the user name and password. One way to deal with this would be to create a function like the following, which simply accepts a bunch of string parameters:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">NewPostgresTransactionLogger</code><code class="p">(</code><code class="nx">host</code><code class="p">,</code> <code class="nx">dbName</code><code class="p">,</code> <code class="nx">user</code><code class="p">,</code> <code class="nx">password</code> <code class="kt">string</code><code class="p">)</code>&#13;
    <code class="p">(</code><code class="nx">TransactionLogger</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code> <code class="o">...</code> <code class="p">}</code></pre>&#13;
&#13;
<p>This approach is pretty ugly, though. Plus, what if you wanted an additional parameter? Do you chunk it onto the end of the parameter list, breaking any code that’s already using this function? Maybe worse, the parameter order isn’t clear without looking at the documentation.</p>&#13;
&#13;
<p>There has to be a better way. So, instead of this potential horror show, you can create a small helper struct:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code> <code class="nx">PostgresDBParams</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">dbName</code>   <code class="kt">string</code>&#13;
    <code class="nx">host</code>     <code class="kt">string</code>&#13;
    <code class="nx">user</code>     <code class="kt">string</code>&#13;
    <code class="nx">password</code> <code class="kt">string</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Unlike the big-bag-of-strings approach, this struct is small, readable, and easily extended. To use it, you can create a <code>PostgresDBParams</code> variable and pass it to your construction function. Here’s what that looks like:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">logger</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">NewPostgresTransactionLogger</code><code class="p">(</code><code class="nx">PostgresDBParams</code><code class="p">{</code>&#13;
    <code class="nx">host</code><code class="p">:</code>     <code class="s">"localhost"</code><code class="p">,</code>&#13;
    <code class="nx">dbName</code><code class="p">:</code>   <code class="s">"kvs"</code><code class="p">,</code>&#13;
    <code class="nx">user</code><code class="p">:</code>     <code class="s">"test"</code><code class="p">,</code>&#13;
    <code class="nx">password</code><code class="p">:</code> <code class="s">"hunter2"</code>&#13;
<code class="p">})</code></pre>&#13;
&#13;
<p>The new construction function looks something like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">NewPostgresTransactionLogger</code><code class="p">(</code><code class="nx">config</code> <code class="nx">PostgresDBParams</code><code class="p">)</code> <code class="p">(</code><code class="nx">TransactionLogger</code><code class="p">,</code>&#13;
    <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
&#13;
    <code class="nx">connStr</code> <code class="o">:=</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"host=%s dbname=%s user=%s password=%s"</code><code class="p">,</code>&#13;
        <code class="nx">config</code><code class="p">.</code><code class="nx">host</code><code class="p">,</code> <code class="nx">config</code><code class="p">.</code><code class="nx">dbName</code><code class="p">,</code> <code class="nx">config</code><code class="p">.</code><code class="nx">user</code><code class="p">,</code> <code class="nx">config</code><code class="p">.</code><code class="nx">password</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">db</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">sql</code><code class="p">.</code><code class="nx">Open</code><code class="p">(</code><code class="s">"postgres"</code><code class="p">,</code> <code class="nx">connStr</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to open db: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">err</code> <code class="p">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">Ping</code><code class="p">()</code>                 <code class="c1">// Test the database connection</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to open db connection: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">logger</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">PostgresTransactionLogger</code><code class="p">{</code><code class="nx">db</code><code class="p">:</code> <code class="nx">db</code><code class="p">}</code>&#13;
&#13;
    <code class="nx">exists</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">verifyTableExists</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to verify table exists: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">if</code> <code class="p">!</code><code class="nx">exists</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">createTable</code><code class="p">();</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to create table: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">logger</code><code class="p">,</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This does quite a few things, but fundamentally it is not very different from &#13;
<span class="keep-together"><code>NewFileTransactionLogger</code>.</span></p>&#13;
&#13;
<p>The first thing it does is to use <code>sql.Open</code> to retrieve a <code>*sql.DB</code> value. You’ll note that the connection string passed to <code>sql.Open</code> contains several parameters; the <code>lib/pq</code> package supports many more than the ones listed here. See <a href="https://oreil.ly/uIgyN">the package documentation</a> for a complete listing.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="database driver" id="idm45983631841752"/>Many drivers, including <code>lib/pq</code>, don’t actually create a connection to the database immediately, so it uses <code>db.Ping</code> to force the driver to establish and test a connection.</p>&#13;
&#13;
<p>Finally, it creates the <code>PostgresTransactionLogger</code> and uses that to verify that &#13;
<span class="keep-together">the <code>transactions</code></span> table exists, creating it if necessary. Without this step, the &#13;
<span class="keep-together"><code>PostgresTransactionLogger</code></span> will essentially assume that the table already exists, and will fail if it doesn’t.</p>&#13;
&#13;
<p>You may have noticed that the <code>verifyTableExists</code> and <code>createTable</code> methods aren’t implemented here. This is entirely intentional. As an exercise, you’re encouraged to dive into <a href="https://oreil.ly/xuFlE">the <code>database/sql</code> docs</a> and think about how you might go about doing that. If you’d prefer not to, you can find an implementation in <a href="https://oreil.ly/1MEIr">the GitHub repository</a> that comes with this book.</p>&#13;
&#13;
<p>You now have a construction function that establishes a connection to the database and returns a newly created <code>TransactionLogger</code>. But, once again, you need to get things started. For that, you need to implement the <code>Run</code> method that will create the <code>events</code> and <code>errors</code> channels and spawn the event ingestion goroutine.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Using db.Exec to execute a SQL INSERT"><div class="sect3" id="idm45983632202264">&#13;
<h3>Using db.Exec to execute a SQL INSERT</h3>&#13;
&#13;
<p>For the <code>FileTransactionLogger</code>, you implemented a <code>Run</code> method that initialized the channels and created the go function responsible for writing to the transaction log.</p>&#13;
&#13;
<p>The <code>PostgresTransactionLogger</code> is very similar. However, instead of appending a line to a file, the new logger uses <code>db.Exec</code> to execute an SQL <code>INSERT</code> to accomplish the same result:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">PostgresTransactionLogger</code><code class="p">)</code> <code class="nx">Run</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">events</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="mi">16</code><code class="p">)</code>              <code class="c1">// Make an events channel</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">events</code> <code class="p">=</code> <code class="nx">events</code>&#13;
&#13;
    <code class="nx">errors</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>               <code class="c1">// Make an errors channel</code>&#13;
    <code class="nx">l</code><code class="p">.</code><code class="nx">errors</code> <code class="p">=</code> <code class="nx">errors</code>&#13;
&#13;
    <code class="k">go</code> <code class="kd">func</code><code class="p">()</code> <code class="p">{</code>                                 <code class="c1">// The INSERT query</code>&#13;
        <code class="nx">query</code> <code class="o">:=</code> <code class="s">`INSERT INTO transactions</code>&#13;
<code class="s">            (event_type, key, value)</code>&#13;
<code class="s">            VALUES ($1, $2, $3)`</code>&#13;
&#13;
        <code class="k">for</code> <code class="nx">e</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">events</code> <code class="p">{</code>                 <code class="c1">// Retrieve the next Event</code>&#13;
&#13;
            <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">l</code><code class="p">.</code><code class="nx">db</code><code class="p">.</code><code class="nx">Exec</code><code class="p">(</code>                <code class="c1">// Execute the INSERT query</code>&#13;
                <code class="nx">query</code><code class="p">,</code>&#13;
                <code class="nx">e</code><code class="p">.</code><code class="nx">EventType</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">,</code> <code class="nx">e</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code>&#13;
&#13;
            <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
                <code class="nx">errors</code> <code class="o">&lt;-</code> <code class="nx">err</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This implementation of the <code>Run</code> method does almost exactly what its <code>FileTransactionLogger</code> equivalent does: it creates the buffered <code>events</code> and <code>errors</code> channels, and it starts a goroutine that retrieves <code>Event</code> values from our <code>events</code> channel and writes them to the transaction log.</p>&#13;
&#13;
<p>Unlike the <code>FileTransactionLogger</code>, which appends to a file, this goroutine uses <code>db.Exec</code> to execute a SQL query that appends a row to the <code>transactions</code> table. The numbered arguments (<code>$1, $2, $3</code>) in the query are placeholder query parameters, which must be satisfied when the <code>db.Exec</code> function is called.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Using db.Query to play back postgres transaction logs"><div class="sect3" id="idm45983631670456">&#13;
<h3>Using db.Query to play back postgres transaction logs</h3>&#13;
&#13;
<p>In <a data-type="xref" href="#section_ch05_scanner_playback">“Using a bufio.Scanner to play back file transaction logs”</a>, you used a <code>bufio.Scanner</code> to read previously written transaction log entries.</p>&#13;
&#13;
<p>The Postgres implementation won’t be <em>quite</em> as straightforward, but the principle is the same: you point at the top of your data source and read until you hit the bottom:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="p">(</code><code class="nx">l</code> <code class="o">*</code><code class="nx">PostgresTransactionLogger</code><code class="p">)</code> <code class="nx">ReadEvents</code><code class="p">()</code> <code class="p">(</code><code class="o">&lt;-</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">,</code> <code class="o">&lt;-</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">outEvent</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="nx">Event</code><code class="p">)</code>                <code class="c1">// An unbuffered events channel</code>&#13;
    <code class="nx">outError</code> <code class="o">:=</code> <code class="nb">make</code><code class="p">(</code><code class="kd">chan</code> <code class="kt">error</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>             <code class="c1">// A buffered errors channel</code>&#13;
&#13;
    <code class="k">go</code> <code class="kd">func</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">defer</code> <code class="nb">close</code><code class="p">(</code><code class="nx">outEvent</code><code class="p">)</code>                   <code class="c1">// Close the channels when the</code>&#13;
        <code class="k">defer</code> <code class="nb">close</code><code class="p">(</code><code class="nx">outError</code><code class="p">)</code>                   <code class="c1">// goroutine ends</code>&#13;
&#13;
        <code class="nx">query</code> <code class="o">:=</code> <code class="s">`SELECT sequence, event_type, key, value FROM transactions</code>&#13;
<code class="s">                  ORDER BY sequence`</code>&#13;
&#13;
        <code class="nx">rows</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">Query</code><code class="p">(</code><code class="nx">query</code><code class="p">)</code>            <code class="c1">// Run query; get result set</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"sql query error: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">defer</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">Close</code><code class="p">()</code>                      <code class="c1">// This is important!</code>&#13;
&#13;
        <code class="nx">e</code> <code class="o">:=</code> <code class="nx">Event</code><code class="p">{}</code>                            <code class="c1">// Create an empty Event</code>&#13;
&#13;
        <code class="k">for</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">Next</code><code class="p">()</code> <code class="p">{</code>                       <code class="c1">// Iterate over the rows</code>&#13;
&#13;
            <code class="nx">err</code> <code class="p">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">Scan</code><code class="p">(</code>                    <code class="c1">// Read the values from the</code>&#13;
                <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Sequence</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">EventType</code><code class="p">,</code>      <code class="c1">// row into the Event.</code>&#13;
                <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Key</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">e</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code>&#13;
&#13;
            <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
                <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"error reading row: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="nx">outEvent</code> <code class="o">&lt;-</code> <code class="nx">e</code>                       <code class="c1">// Send e to the channel</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="nx">err</code> <code class="p">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">Err</code><code class="p">()</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">outError</code> <code class="o">&lt;-</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"transaction log read failure: %w"</code><code class="p">,</code> <code class="nx">err</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}()</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">outEvent</code><code class="p">,</code> <code class="nx">outError</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>All of the interesting (or at least new) bits are happening in the goroutine. Let’s break them down:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>query</code> is a string that contains the SQL query. The query in this code requests four columns: <code>sequence</code>, <code>event_type</code>, <code>key</code>, and <code>value</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>db.Query</code> sends <code>query</code> to the database, and returns values of type <code>*sql.Rows</code> and <code>error</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>We defer a call to <code>rows.Close</code>. Failing to do so can lead to connection leakage!</p>&#13;
</li>&#13;
<li>&#13;
<p><code>rows.Next</code> lets us iterate over the rows; it returns <code>false</code> if there are no more rows or if there’s an error.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>rows.Scan</code> copies the columns in the current row into the values we pointed at in the call.</p>&#13;
</li>&#13;
<li>&#13;
<p>We send event <code>e</code> to the output channel.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>Err</code> returns the error, if any, that may have caused <code>rows.Next</code> to return <code>false</code>.<a data-type="indexterm" data-primary="SQL databases" data-startref="ch05_term16" id="idm45983631450776"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Initializing the PostgresTransactionLogger in your web service"><div class="sect3" id="idm45983631449512">&#13;
<h3>Initializing the PostgresTransactionLogger in your web service</h3>&#13;
&#13;
<p>The <code>PostgresTransactionLogger</code> is pretty much complete. Now let’s go ahead and integrate it into the web service.</p>&#13;
&#13;
<p>Fortunately, since we already had the <code>FileTransactionLogger</code> in place, we only need to change one line:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">logger</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">NewFileTransactionLogger</code><code class="p">(</code><code class="s">"transaction.log"</code><code class="p">)</code></pre>&#13;
&#13;
<p>which becomes…</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">logger</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">NewPostgresTransactionLogger</code><code class="p">(</code><code class="s">"localhost"</code><code class="p">)</code></pre>&#13;
&#13;
<p>Yup. That’s it. Really.</p>&#13;
&#13;
<p>Because this represents a complete implementation of the <code>TransactionLogger</code> &#13;
<span class="keep-together">interface</span>, everything else stays exactly the same. You can interact with the &#13;
<span class="keep-together"><code>PostgresTransactionLogger</code></span> using exactly the same methods as before.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Future improvements"><div class="sect3" id="idm45983631436072">&#13;
<h3>Future improvements</h3>&#13;
&#13;
<p>As with the <code>FileTransactionLogger</code>, the <code>PostgresTransactionLogger</code> represents a minimal viable implementation of a transaction logger and has lots of room for improvement. Some of the areas for improvement include, but are certainly not &#13;
<span class="keep-together">limited</span> to:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>We assume that the database and table exist, and we’ll get errors if they don’t.</p>&#13;
</li>&#13;
<li>&#13;
<p>The connection string is hard-coded. Even the password.</p>&#13;
</li>&#13;
<li>&#13;
<p>There’s still no <code>Close</code> method to clean up open connections.</p>&#13;
</li>&#13;
<li>&#13;
<p>The service can close with events still in the write buffer: events can get lost.</p>&#13;
</li>&#13;
<li>&#13;
<p>The log retains records of deleted values forever: it will grow indefinitely.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>All of these would be (major) impediments in production. I encourage you to take the time to consider—or even implement—solutions to one or more of these points.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Generation 3: Implementing Transport Layer Security"><div class="sect1" id="idm45983634037576">&#13;
<h1>Generation 3: Implementing Transport Layer Security</h1>&#13;
&#13;
<p><a data-type="indexterm" data-primary="transport layer security" data-see="TLS" id="idm45983631393976"/><a data-type="indexterm" data-primary="TLS" id="ch05_term18"/>Security. Love it or hate it, the simple fact is that security is a critical feature of <em>any</em> application, cloud native or otherwise. Sadly, security is often treated as an afterthought, with potentially catastrophic consequences.</p>&#13;
&#13;
<p>There are rich tools and established security best practices for traditional environments, but this is less true of cloud native applications, which tend to take the form of several small, often ephemeral, microservices. While this architecture provides significant flexibility and scalability benefits, it also creates a distinct opportunity for would-be attackers: every communication between services is transmitted across a network, opening it up to eavesdropping and manipulation.</p>&#13;
&#13;
<p>The subject of security can take up an entire book of its own,<sup><a data-type="noteref" id="idm45983631389976-marker" href="ch05.xhtml#idm45983631389976">14</a></sup> so we’ll focus on one common technique: encryption. Encrypting data “in transit” (or “on the wire”) is commonly used to guard against eavesdropping and message manipulation, and any language worth its salt—including, and especially, Go—will make it relatively low-lift to implement.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Transport Layer Security"><div class="sect2" id="idm45983631388840">&#13;
<h2>Transport Layer Security</h2>&#13;
&#13;
<p>Transport Layer Security (TLS) is a cryptographic protocol that’s designed to provide communications security over a computer network. Its use is ubiquitous and widespread, being applicable to virtually any Internet communications. You’re most likely familiar with it (and perhaps using it right now) in the form of HTTPS—also known as HTTP over TLS—which uses TLS to encrypt exchanges over HTTP.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="public-key cryptography" id="idm45983631368280"/><a data-type="indexterm" data-primary="key pair" id="idm45983631367416"/><a data-type="indexterm" data-primary="public key" id="idm45983631366744"/><a data-type="indexterm" data-primary="private key" id="idm45983631366072"/>TLS encrypts messages using <em>public-key cryptography</em>, in which both parties possess their own <em>key pair</em>, which includes a <em>public key</em> that’s freely given out, and a <em>private key</em> that’s known only to its owner, illustrated in <a data-type="xref" href="#img_ch05_key_exchange">Figure 5-2</a>. Anybody can use a public key to encrypt a message, but it can only be decrypted with the corresponding private key. Using this protocol, two parties that wish to communicate privately can exchange their public keys, which can then be used to secure all subsequent communications in a way that can only be read by the owner of the intended recipient, who holds the corresponding private key.<sup><a data-type="noteref" id="idm45983631362184-marker" href="ch05.xhtml#idm45983631362184">15</a></sup></p>&#13;
&#13;
<figure><div id="img_ch05_key_exchange" class="figure">&#13;
<img src="Images/cngo_0502.png" alt="cngo 0502" width="904" height="307"/>&#13;
<h6><span class="label">Figure 5-2. </span>One half of a public key exchange</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Certificates, certificate authorities, and trust"><div class="sect3" id="section_ch05_trust">&#13;
<h3>Certificates, certificate authorities, and trust</h3>&#13;
&#13;
<p>If TLS had a motto, it would be “trust but verify.” Actually, scratch the trust part. Verify everything.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="digital certificate" id="idm45983631357352"/>It’s not enough for a service to simply provide a public key.<sup><a data-type="noteref" id="idm45983631356520-marker" href="ch05.xhtml#idm45983631356520">16</a></sup> Instead, every public key is associated with a <em>digital certificate</em>, an electronic document used to prove the key’s ownership. A certificate shows that the owner of the public key is, in fact, the named subject (owner) of the certificate, and describes how the key may be used. This allows the recipient to compare the certificate against various “trusts” to decide whether it will accept it as valid.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="certificate authority" id="idm45983631354712"/>First, the certificate must be digitally signed and authenticated by a <em>certificate authority</em>, a trusted entity that issues digital certificates.</p>&#13;
&#13;
<p>Second, the subject of the certificate has to match the domain name of the service the client is trying to connect to. Among other things, this helps to ensure that the certificates you’re receiving are valid and haven’t been swapped out by a man-in-the-middle.</p>&#13;
&#13;
<p>Only then will your conversation proceed.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Web browsers or other tools will usually allow you to choose to proceed if a certificate can’t be validated. If you’re using self-signed certificates for development, for example, that might make sense. But generally speaking, heed the warnings.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Private Key and Certificate Files"><div class="sect2" id="idm45983631350712">&#13;
<h2>Private Key and Certificate Files</h2>&#13;
&#13;
<p>TLS (and its predecessor, SSL) has been around long enough<sup><a data-type="noteref" id="idm45983631349192-marker" href="ch05.xhtml#idm45983631349192">17</a></sup> that you’d think that we’d have settled on a single key container format, but you’d be wrong. Web searches for “key file format” will return a virtual zoo of file extensions: <em>.csr</em>, <em>.key</em>, <em>.pkcs12</em>, <em>.der</em>, and <em>.pem</em> just to name a few.</p>&#13;
&#13;
<p>Of these, however, <em>.pem</em> seems to be the most common. It also happens to be the format that’s most easily supported by Go’s <code>net/http</code> package, so that’s what we’ll &#13;
<span class="keep-together">be using.</span></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Privacy enhanced mail (PEM) file format"><div class="sect3" id="idm45983631343944">&#13;
<h3>Privacy enhanced mail (PEM) file format</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="privacy enhanced mail" data-see="PEM" id="idm45983631342488"/><a data-type="indexterm" data-primary="PEM" id="ch05_term19"/>Privacy enhanced mail (PEM) is a common certificate container format, usually stored in <em>.pem</em> files, but <em>.cer</em> or <em>.crt</em> (for certificates) and <em>.key</em> (for public or private keys) are common too. Conveniently, PEM is also base64 encoded and therefore viewable in a text editor, and even safe to paste into (for example) the body of an email message.<sup><a data-type="noteref" id="idm45983631338264-marker" href="ch05.xhtml#idm45983631338264">18</a></sup></p>&#13;
&#13;
<p class="pagebreak-before less_space">Often, <em>.pem</em> files will come in a pair, representing a complete key pair:</p>&#13;
<dl>&#13;
<dt><em>cert.pem</em></dt>&#13;
<dd>&#13;
<p>The server certificate (including the CA-signed public key).</p>&#13;
</dd>&#13;
<dt><em>key.pem</em></dt>&#13;
<dd>&#13;
<p>A private key, not to be shared.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Going forward, we’ll assume that your keys are in this configuration. If you don’t yet have any keys and need to generate some for development purposes, instructions are available in multiple places online. If you already have a key file in some other format, converting it is beyond the scope of this book. However, the Internet is a magical place, and there are plenty of tutorials online for converting between common key formats.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Securing Your Web Service with HTTPS"><div class="sect2" id="idm45983631332056">&#13;
<h2>Securing Your Web Service with HTTPS</h2>&#13;
&#13;
<p>So, now that we’ve established that security should be taken seriously, and that communication via TLS is a bare-minimum first step towards securing our communications, how do we go about doing that?</p>&#13;
&#13;
<p>One way might be to put a reverse proxy in front of our service that can handle HTTPS requests and forward them to our key-value service as HTTP, but unless the two are co-located on the same server, we’re still sending unencrypted messages over a network. Plus, the additional service adds some architectural complexity that we might prefer to avoid. Perhaps we can have our key-value service serve HTTPS?</p>&#13;
&#13;
<p>Actually, we can. Going all the way back to <a data-type="xref" href="#section_ch05_server_with_nethttp">“Building an HTTP Server with net/http”</a>, you might recall that the <code>net/http</code> package contains a function, <code>ListenAndServe</code>, which, in its most basic form, looks something like the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">HandleFunc</code><code class="p">(</code><code class="s">"/"</code><code class="p">,</code> <code class="nx">helloGoHandler</code><code class="p">)</code>            <code class="c1">// Add a root path handler</code>&#13;
&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="kc">nil</code><code class="p">)</code>               <code class="c1">// Start the HTTP server</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p><a data-type="indexterm" data-primary="ListenAndServe" id="idm45983631324152"/>In this example, we call <code>HandleFunc</code> to add a handler function for the root path, followed by <code>ListenAndServe</code> to start the service listening and serving. For the sake of simplicity, we ignore any errors returned by <code>ListenAndServe</code>.</p>&#13;
&#13;
<p>There aren’t a lot of moving parts here, which is kind of nice. In keeping with that philosophy, the designers of <code>net/http</code> kindly provided a TLS-enabled variant of the <code>ListenAndServe</code> function that we’re familiar with:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code> <code class="nx">ListenAndServeTLS</code><code class="p">(</code><code class="nx">addr</code><code class="p">,</code> <code class="nx">certFile</code><code class="p">,</code> <code class="nx">keyFile</code> <code class="kt">string</code><code class="p">,</code> <code class="nx">handler</code> <code class="nx">Handler</code><code class="p">)</code> <code class="kt">error</code></pre>&#13;
&#13;
<p>As you can see, <code>ListenAndServeTLS</code> looks and feels almost exactly like <code>ListenAndServe</code> except that it has two extra parameters: <code>certFile</code> and <code>keyFile</code>. If you happen to have certificate and private key PEM files, then service HTTPS-encrypted connections is just a matter of passing the names of those files to <code>ListenAndServeTLS</code>:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="go"><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServeTLS</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code> <code class="s">"cert.pem"</code><code class="p">,</code> <code class="s">"key.pem"</code><code class="p">,</code> <code class="kc">nil</code><code class="p">)</code></pre>&#13;
&#13;
<p>This sure looks super convenient, but does it work? Let’s fire up our service (using self-signed certificates) and find out.<a data-type="indexterm" data-primary="PEM" data-startref="ch05_term19" id="idm45983631160984"/></p>&#13;
&#13;
<p>Dusting off our old friend <code>curl</code>, let’s try inserting a key/value pair. Note that we use the <code>https</code> scheme in our URL instead of <code>http</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, key-value store!' -v https://localhost:8080/v1/key-a&#13;
* SSL certificate problem: self signed certificate&#13;
curl: (60) SSL certificate problem: self signed certificate</pre>&#13;
&#13;
<p>Well, that didn’t go as planned. As we mentioned in <a data-type="xref" href="#section_ch05_trust">“Certificates, certificate authorities, and trust”</a>, TLS expects any certificates to be signed by a certificate authority. It doesn’t like self-signed certificates.</p>&#13;
&#13;
<p>Fortunately, we can turn this safety check off in <code>curl</code> with the appropriately named &#13;
<span class="keep-together"><code>--insecure</code></span> flag:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl -X PUT -d 'Hello, key-value store!' --insecure -v \&#13;
    https://localhost:8080/v1/key-a&#13;
* SSL certificate verify result: self signed certificate (18), continuing anyway.&#13;
&gt; PUT /v1/key-a HTTP/2&#13;
&lt; HTTP/2 201</pre>&#13;
&#13;
<p>We got a sternly worded warning, but it worked!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Transport Layer Summary"><div class="sect2" id="idm45983631331432">&#13;
<h2>Transport Layer Summary</h2>&#13;
&#13;
<p>We’ve covered quite a lot in just a few pages. The topic of security is vast, and there’s no way we’re going to do it justice, but we were able to at least introduce TLS, and how it can serve as one relatively low-cost, high-return component of a larger security strategy.</p>&#13;
&#13;
<p>We were also able to demonstrate how to implement TLS in an Go <code>net/http</code> web service, and saw how—as long as we have valid certificates—to secure a service’s communications without a great deal of effort.<a data-type="indexterm" data-primary="TLS" data-startref="ch05_term18" id="idm45983631133384"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" data-pdf-bookmark="Containerizing Your Key-Value Store"><div class="sect1" id="section_ch05_containerizing">&#13;
<h1>Containerizing Your Key-Value Store</h1>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Docker" id="idm45983631130376"/><a data-type="indexterm" data-primary="containers" id="ch05_term20"/>A <em>container</em> is a lightweight operating-system-level virtualization<sup><a data-type="noteref" id="idm45983631128184-marker" href="ch05.xhtml#idm45983631128184">19</a></sup> abstraction that provides processes with a degree of isolation, both from their host and from other containers. The concept of the container has been around since at least 2000, but it was the introduction of Docker in 2013 that made containers accessible to the masses and brought containerization into the mainstream.</p>&#13;
&#13;
<p>Importantly, containers are not virtual machines:<sup><a data-type="noteref" id="idm45983631126600-marker" href="ch05.xhtml#idm45983631126600">20</a></sup> they don’t use hypervisors, and they share the host’s kernel rather than carrying their own guest operating system. Instead, their isolation is provided by a clever application of several Linux kernel features, including <code>chroot</code>, cgroups, and kernel namespaces. In fact, it can be reasonably argued that containers are nothing more than a convenient abstraction, and that there’s actually no such thing as a container.</p>&#13;
&#13;
<p>Even though they’re not virtual machines,<sup><a data-type="noteref" id="idm45983631124536-marker" href="ch05.xhtml#idm45983631124536">21</a></sup> containers do provide some virtual-machine-like benefits. The most obvious of which is that they allow an application, its dependencies, and much of its environment to be packaged within a single distributable artifact—a container image—that can be executed on any suitable host.</p>&#13;
&#13;
<p>The benefits don’t stop there, however. In case you need them, here’s a few more:</p>&#13;
<dl>&#13;
<dt>Agility</dt>&#13;
<dd>&#13;
<p>Unlike virtual machines that are saddled with an entire operating system and a colossal memory footprint, containers boast image sizes in the megabyte range and startup times that measure in milliseconds. This is particularly true of Go applications, whose binaries have few, if any, dependencies.</p>&#13;
</dd>&#13;
<dt>Isolation</dt>&#13;
<dd>&#13;
<p>This was hinted at previously, but bears repeating. Containers virtualize CPU, memory, storage, and network resources at the operating-system-level, providing developers with a sandboxed view of the OS that is logically isolated from other applications.</p>&#13;
</dd>&#13;
<dt>Standardization and productivity</dt>&#13;
<dd>&#13;
<p>Containers let you package an application alongside its dependencies, such as specific versions of language runtimes and libraries, as a single distributable binary, making your deployments reproducible, predictable, and versionable.</p>&#13;
</dd>&#13;
<dt><a data-type="indexterm" data-primary="Kubernetes" data-secondary="features of" id="idm45983631095032"/>Orchestration</dt>&#13;
<dd>&#13;
<p>Sophisticated container orchestration systems like Kubernetes provide a huge number of benefits. By containerizing your application(s) you’re taking the first step towards being able to take advantage of them.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>There are just four (very) motivating arguments.<sup><a data-type="noteref" id="idm45983631092424-marker" href="ch05.xhtml#idm45983631092424">22</a></sup> In other words, containerization is super, super useful.</p>&#13;
&#13;
<p>For this book, we’ll be using Docker to build our container images. Alternative build tools exist, but Docker is the most common containerization tool in use today, and the syntax for its build file—termed a <em>Dockerfile</em>—lets you use familiar shell scripting commands and utilities.</p>&#13;
&#13;
<p>That being said, this isn’t a book about Docker or containerization, so our discussion will mostly be limited to the bare basics of using Docker with Go. If you’re interested in learning more, I suggest picking up a copy of <a href="https://oreil.ly/rqGoI" class="orm:hideurl"><em>Docker: Up &amp; Running: Shipping Reliable Containers in Production</em></a> by Sean P. Kane and Karl Matthias (O’Reilly).<a data-type="indexterm" data-primary="containers" data-startref="ch05_term20" id="idm45983631088872"/></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Docker (Absolute) Basics"><div class="sect2" id="idm45983631087832">&#13;
<h2>Docker (Absolute) Basics</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="container image" id="idm45983631086296"/><a data-type="indexterm" data-primary="Docker" id="ch05_term21"/>Before we continue, it’s important to draw a distinction between container images and the containers themselves. A <em>container image</em> is essentially an executable binary that contains your application runtime and its dependencies. When an image is run, the resulting process is the <em>container</em>. An image can be run many times to create multiple (essentially) identical containers.</p>&#13;
&#13;
<p>Over the next few pages we’ll create a simple Dockerfile and build and execute an image. If you haven’t already, please take a moment and <a href="https://oreil.ly/yYwKL">install the Docker Community Edition (CE)</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="The Dockerfile"><div class="sect3" id="idm45983631082040">&#13;
<h3>The Dockerfile</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Dockerfile" id="ch05_term22"/>Dockerfiles are essentially build files that describe the steps required to build an image. A very minimal—but complete—example is demonstrated in the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="dockerfile"><code class="c"># The parent image. At build time, this image will be pulled and</code>&#13;
<code class="c"># subsequent instructions run against it.</code>&#13;
<code class="k">FROM</code><code class="s"> ubuntu:20.04</code>&#13;
&#13;
<code class="c"># Update apt cache and install nginx without an approval prompt.</code>&#13;
<code class="k">RUN</code> apt-get update <code class="o">&amp;&amp;</code> apt-get install --yes nginx&#13;
&#13;
<code class="c"># Tell Docker this image's containers will use port 80.</code>&#13;
<code class="k">EXPOSE</code><code class="s"> 80</code>&#13;
&#13;
<code class="c"># Run Nginx in the foreground. This is important: without a</code>&#13;
<code class="c"># foreground process the container will automatically stop.</code>&#13;
<code class="k">CMD</code><code class="s"> ["nginx", "-g", "daemon off;"]</code></pre>&#13;
&#13;
<p>As you can see, this Dockerfile includes four different commands:</p>&#13;
<dl>&#13;
<dt><code>FROM</code></dt>&#13;
<dd>&#13;
<p>Specifies a <em>base image</em> that this build will extend, and will typically be a common Linux distribution, such as <code>ubuntu</code> or <code>alpine</code>. At build time this image is pulled and run, and the subsequent commands applied to it.</p>&#13;
</dd>&#13;
<dt><code>RUN</code></dt>&#13;
<dd>&#13;
<p>Will execute any commands on top of the current image. The result will be used for the next step in the Dockerfile.</p>&#13;
</dd>&#13;
<dt><code>EXPOSE</code></dt>&#13;
<dd>&#13;
<p>Tells Docker which port(s) the container will use. See <a data-type="xref" href="#sidebar_ch05_expose_vs_publish">“What’s the Difference Between Exposing and Publishing Ports?”</a> for more information on exposing ports.</p>&#13;
</dd>&#13;
<dt><code>CMD</code></dt>&#13;
<dd>&#13;
<p>The command to execute when the container is executed. There can only be one <code>CMD</code> in a Dockerfile.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>These are four of the most common Dockerfile instructions of many available. For a complete listing see the <a href="https://oreil.ly/8LGdP">official Dockerfile reference</a>.</p>&#13;
&#13;
<p>As you may have inferred, the previous example starts with an existing Linux distribution image (Ubuntu 20.04) and installs Nginx, which is executed when the container is started.</p>&#13;
&#13;
<p>By convention, the file name of a Dockerfile is <em>Dockerfile</em>. Go ahead and create a new file named <em>Dockerfile</em> and paste the previous example into it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Building your container image"><div class="sect3" id="idm45983631041032">&#13;
<h3>Building your container image</h3>&#13;
&#13;
<p>Now that you have a simple Dockerfile, you can build it! Make sure that you’re in the same directory as your Dockerfile and enter the following:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>docker build --tag my-nginx .</pre>&#13;
&#13;
<p>This will instruct Docker to begin the build process. If everything works correctly (and why wouldn’t it?) you’ll see the output as Docker downloads the parent image, and runs the <code>apt</code> commands. This will probably take a minute or two the first time you run it.</p>&#13;
&#13;
<p>At the end, you’ll see a line that looks something like the following: <code>Successfully tagged my-nginx:latest</code>.</p>&#13;
&#13;
<p>If you do, you can use the <code>docker images</code> command to verify that your image is now present. You should see something like the following:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker images&#13;
REPOSITORY      TAG         IMAGE ID           CREATED               SIZE&#13;
my-nginx        latest      64ea3e21a388       29 seconds ago        159MB&#13;
ubuntu          20.04       f63181f19b2f       3 weeks ago           72.9MB</pre>&#13;
&#13;
<p>If all has gone as planned, you’ll see at least two images listed: our parent image <code>ubuntu:20.04</code>, and your own <code>my-nginx:latest</code> image. Next step: running the service container!</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45983631032744">&#13;
<h5>What Does latest Mean?</h5>&#13;
<p>Note the name of the image. What’s <code>latest</code>? That’s a simple question with a complicated answer. Docker images have two name components: a <code>repository</code> and a <code>tag</code>.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Docker Hub" id="idm45983631029464"/><a data-type="indexterm" data-primary="repository name component" id="idm45983631028760"/>The repository name component can include the domain name of a host where the image is stored (or will be stored). For example, the repository name for an image hosted by FooCorp may be named something like <code>docker.foo.com/ubuntu</code>. If no repository URL is evident, then the image is either 100% local (like the image we just built) or lives in <a href="https://hub.docker.com">the Docker Hub</a>.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="tag component" id="idm45983631008296"/>The <code>tag</code> component is intended as a unique label for a particular version of an image, and often takes the form of a version number. The <code>latest</code> tag is a default tag name that’s added by many <code>docker</code> operations if no tag is specified.</p>&#13;
&#13;
<p>Using <code>latest</code> in production is generally considered a bad practice, however, because its contents can change—sometimes significantly—with unfortunate consequences.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Running your container image"><div class="sect3" id="idm45983631005016">&#13;
<h3>Running your container image</h3>&#13;
&#13;
<p>Now that you’ve built your image, you can run it. For that, you’ll use the <code>docker run</code> command:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker run --detach --publish 8080:80 --name nginx my-nginx&#13;
61bb4d01017236f6261ede5749b421e4f65d43cb67e8e7aa8439dc0f06afe0f3</pre>&#13;
&#13;
<p>This instructs Docker to run a container using your <code>my-nginx</code> image. The <code>--detach</code> flag will cause the container to be run in the background. Using <code>--publish 8080:80</code> instructs Docker to publish port 8080 on the host bridged to port 80 in the container, so any connections to <code>localhost:8080</code> will be forwarded to the container’s port 80. Finally, the <code>--name nginx</code> flag specifies a name for the container; without this, a randomly generated name will be assigned instead.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="container ID" id="idm45983630999032"/>You’ll notice that running this command presents us with a very cryptic line containing 65 very cryptic hexadecimal characters. This is the <em>container ID</em>, which can be used to refer to the container in lieu of its name.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_ch05_expose_vs_publish">&#13;
<h5>What’s the Difference Between Exposing and Publishing Ports?</h5>&#13;
<p>The difference between “exposing” and “publishing” container ports can be confusing, but there’s actually an important distinction:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Exposing</em> ports <a data-type="indexterm" data-primary="exposing ports" id="idm45983630977928"/>is a way of clearly documenting—both to users and to Docker—which ports a container uses. It does not map or open any ports on the host. Ports can be exposed using the <code>EXPOSE</code> keyword in the Dockerfile or the &#13;
<span class="keep-together"><code>--expose</code></span> flag to <code>docker run</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Publishing</em> ports <a data-type="indexterm" data-primary="publishing ports" id="idm45983630973816"/>tells Docker which ports to open on the container’s network interface. Ports can be published using the <code>--publish</code> or <code>--publish-all</code> flag to <code>docker run</code>, which create firewall rules that map a container port to a port on &#13;
<span class="keep-together">the host.</span></p>&#13;
</li>&#13;
</ul>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Running your container image"><div class="sect3" id="idm45983630970600">&#13;
<h3>Running your container image</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="container image" id="idm45983630969192"/>To verify that your container is running and is doing what you expect, you can use the <code>docker ps</code> command to list all running containers. This should look something like the following:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker ps&#13;
CONTAINER ID    IMAGE       STATUS          PORTS                   NAMES&#13;
4cce9201f484    my-nginx    Up 4 minutes    0.0.0.0:8080-&gt;80/tcp    nginx</pre>&#13;
&#13;
<p>The preceding output has been edited for brevity (you may notice that it’s missing the <code>COMMAND</code> and <code>CREATED</code> columns). Your output should include seven columns:</p>&#13;
<dl>&#13;
<dt><code>CONTAINER ID</code></dt>&#13;
<dd>&#13;
<p>The first 12 characters of the container ID. You’ll notice it matches the output of your <code>docker run</code>.</p>&#13;
</dd>&#13;
<dt><code>IMAGE</code></dt>&#13;
<dd>&#13;
<p>The name (and tag, if specified) of this container’s source image. No tag implies <code>latest</code>.</p>&#13;
</dd>&#13;
<dt><code>COMMAND</code> (not shown)</dt>&#13;
<dd>&#13;
<p>The command running inside the container. Unless overridden in the <code>docker run</code> this will be the same as the <code>CMD</code> instruction in the Dockerfile. In our case this will be <code>nginx -g 'daemon off;'</code>.</p>&#13;
</dd>&#13;
<dt><code>CREATED</code> (not shown)</dt>&#13;
<dd>&#13;
<p>How long ago the container was created.</p>&#13;
</dd>&#13;
<dt><code>STATUS</code></dt>&#13;
<dd>&#13;
<p>The current state of the container (<code>up</code>, <code>exited</code>, <code>restarting</code>, etc) and how long it’s been in that state. If the state changed, then the time will differ from <code>CREATED</code>.</p>&#13;
</dd>&#13;
<dt><code>PORTS</code></dt>&#13;
<dd>&#13;
<p>Lists all exposed and published ports (see <a data-type="xref" href="#sidebar_ch05_expose_vs_publish">“What’s the Difference Between Exposing and Publishing Ports?”</a>). In our case, we’ve published <code>0.0.0.0:8080</code> on the host and mapped it to <code>80</code> on the container, so that all requests to host port 8080 are forwarded to container port 80.</p>&#13;
</dd>&#13;
<dt><code>NAMES</code></dt>&#13;
<dd>&#13;
<p>The name of the container. Docker will randomly set this if it’s not explicitly defined. Two containers with the same name, regardless of state, cannot exist on the same host at the same time. To reuse a name, you’ll first have to <code>delete</code> the unwanted container.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Issuing a request to a published container port"><div class="sect3" id="idm45983630964968">&#13;
<h3>Issuing a request to a published container port</h3>&#13;
&#13;
<p>If you’ve gotten this far, then your <code>docker ps</code> output should show a container named <code>nginx</code> that appears to have port 8080 published and forwarding to the container’s port 80. If so, then you’re ready to send a request to your running container. But which port should you query?</p>&#13;
&#13;
<p>Well, the Nginx container is listening on port 80. Can you reach that? Actually, no. That port won’t be accessible because it wasn’t published to any network interface during the <code>docker run</code>. Any attempt to connect to an unpublished container port is doomed to failure:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl localhost:80&#13;
curl: (7) Failed to connect to localhost port 80: Connection refused</pre>&#13;
&#13;
<p>You haven’t published to port 80, but you <em>have</em> published port 8080 and forwarded it to the container’s port 80. You can verify this with our old friend <code>curl</code> or by browsing to <code>localhost:8080</code>. If everything is working correctly you’ll be greeted with the familiar Nginx “Welcome” page illustrated in <a data-type="xref" href="#img_ch05_nginx_welcome">Figure 5-3</a>.</p>&#13;
&#13;
<figure><div id="img_ch05_nginx_welcome" class="figure">&#13;
<img src="Images/cngo_0503.png" alt="cngo 0503" width="1095" height="623"/>&#13;
<h6><span class="label">Figure 5-3. </span>Welcome to nginx!</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Running multiple containers"><div class="sect3" id="idm45983630938424">&#13;
<h3>Running multiple containers</h3>&#13;
&#13;
<p><a data-type="indexterm" data-primary="containers" data-seealso="multiple containers" id="idm45983630936984"/><a data-type="indexterm" data-primary="multiple containers" id="idm45983630936008"/>One of the “killer features” of containerization is this: because all of the containers on a host are isolated from one another, it’s possible to run quite a lot of them—even ones that contain different technologies and stacks—on the same host, with each listening on a different published port. For example, if you wanted to run an <code>httpd</code> container alongside your already-running <code>my-nginx</code> container, you could do exactly that.</p>&#13;
&#13;
<p>“But,” you might say, “both of those containers expose port 80! Won’t they collide?”</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="exposing ports" id="idm45983630933192"/><a data-type="indexterm" data-primary="publishing ports" id="idm45983630932488"/>Great question, to which the answer is, happily, no. In fact, you can actually have as many containers as you want that <em>expose</em> the same port—even multiple instances of the same image—as long as they don’t attempt to <em>publish</em> the same port on the same network interface.</p>&#13;
&#13;
<p>For example, if you want to run the stock <code>httpd</code> image, you can run it by using the <code>docker run</code> command again, as long as you take care to publish to a different port (8081, in this case):</p>&#13;
&#13;
<pre data-type="programlisting">$ docker run --detach --publish 8081:80 --name httpd httpd</pre>&#13;
&#13;
<p>If all goes as planned, this will spawn a new container listening on the host at port 8081. Go ahead: use <code>docker ps</code> and <code>curl</code> to test:</p>&#13;
&#13;
<pre data-type="programlisting">$ curl localhost:8081&#13;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Stopping and deleting your containers"><div class="sect3" id="idm45983630926072">&#13;
<h3>Stopping and deleting your containers</h3>&#13;
&#13;
<p>Now you’ve successfully run your container, you’ll probably need to stop and delete it at some point, particularly if you want to rerun a new container using the same name.</p>&#13;
&#13;
<p>To stop a running container, you can use the <code>docker stop</code> command, passing it either the container name or the first few characters of its container ID (how many characters doesn’t matter, as long they can be used to uniquely identify the desired container). Using the container ID to stop our <code>nginx</code> container looks like this:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>docker stop 4cce      <code class="c"># "docker stop nginx" will work too</code>&#13;
4cce</pre>&#13;
&#13;
<p>The output of a successful <code>docker stop</code> is just the name or ID that we passed into &#13;
<span class="keep-together">the command.</span> You can verify that your container has actually been stopped using &#13;
<span class="keep-together"><code>docker ps --all</code></span>, which will show <em>all</em> containers, not just the running ones:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker ps&#13;
CONTAINER ID    IMAGE       STATUS                      PORTS    NAMES&#13;
4cce9201f484    my-nginx    Exited (0) 3 minutes ago             nginx</pre>&#13;
&#13;
<p>If you ran the <code>httpd</code> container, it will also be displayed with a status of <code>Up</code>. You will probably want to stop it as well.</p>&#13;
&#13;
<p>As you can see, the status of our <code>nginx</code> container has changed to <code>Exited</code>, followed by its exit code—an exit status of 0 indicates that we were able to execute a graceful shutdown—and how long ago the container entered its current status.</p>&#13;
&#13;
<p>Now that you’ve stopped your container you can freely delete it.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>You can’t delete a running container or an image that’s used by a running container.</p>&#13;
</div>&#13;
&#13;
<p>To do this, you use the <code>docker rm</code> (or the newer <code>docker container rm</code>) command to remove your container, again passing it either the container name or the first few characters of the ID of the container you want to delete:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>docker rm 4cce            <code class="c"># "docker rm nginx" will work too</code>&#13;
4cce</pre>&#13;
&#13;
<p>As before, the output name or ID indicates success. If you were to go ahead and run &#13;
<span class="keep-together"><code>docker ps --all</code></span> again, you shouldn’t see the container listed anymore.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Building Your Key-Value Store Container"><div class="sect2" id="section_ch05_building_our_kv_store_container">&#13;
<h2>Building Your Key-Value Store Container</h2>&#13;
&#13;
<p>Now that you have the basics down, you can start applying them to containerizing our key-value service.</p>&#13;
&#13;
<p>Fortunately, Go’s ability to compile into statically linked binaries makes it especially well suited for containerization. While most other languages have to be built into a parent image that contains the language runtime, like the 486MB <code>openjdk:15</code> for Java or the 885MB <code>python:3.9</code> for Python,<sup><a data-type="noteref" id="idm45983630908216-marker" href="ch05.xhtml#idm45983630908216">23</a></sup> Go binaries need no runtime at all. They can be placed into a “scratch” image: an image, with no parent at all.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Iteration 1: adding your binary to a FROM scratch image"><div class="sect3" id="idm45983630907240">&#13;
<h3>Iteration 1: adding your binary to a FROM scratch image</h3>&#13;
&#13;
<p>To do this, you’ll need a Dockerfile. The following example is a pretty typical example of a Dockerfile for a containerized Go binary:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="dockerfile"><code class="c"># We use a "scratch" image, which contains no distribution files. The</code>&#13;
<code class="c"># resulting image and containers will have only the service binary.</code>&#13;
<code class="k">FROM</code><code class="s"> scratch</code>&#13;
&#13;
<code class="c"># Copy the existing binary from the host.</code>&#13;
COPY kvs .&#13;
&#13;
<code class="c"># Copy in your PEM files.</code>&#13;
COPY *.pem .&#13;
&#13;
<code class="c"># Tell Docker we'll be using port 8080.</code>&#13;
<code class="k">EXPOSE</code><code class="s"> 8080</code>&#13;
&#13;
<code class="c"># Tell Docker to execute this command on a `docker run`.</code>&#13;
<code class="k">CMD</code><code class="s"> ["/kvs"]</code></pre>&#13;
&#13;
<p>This Dockerfile is fairly similar to the previous one, except that instead of using <code>apt</code> to install an application from a repository, it uses <code>COPY</code> to retrieve a compiled binary from the filesystem it’s being built on. In this case, it assumes the presence of a binary named <code>kvs</code>. For this to work, we’ll need to build the binary first.</p>&#13;
&#13;
<p>In order for your binary to be usable inside a container, it has to meet a few criteria:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It has to be compiled (or cross-compiled) for Linux.</p>&#13;
</li>&#13;
<li>&#13;
<p>It has to be statically linked.</p>&#13;
</li>&#13;
<li>&#13;
<p>It has to be named <code>kvs</code> (because that’s what the Dockerfile is expecting).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We can do all of these things in one command, as follows:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="bash"><code class="nv">$ CGO_ENABLED</code><code class="o">=</code><code class="m">0</code> <code class="nv">GOOS</code><code class="o">=</code>linux go build -a -o kvs</pre>&#13;
&#13;
<p>Let’s walk through what this does:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>CGO_ENABLED=0</code> tells the compiler to disable <code>cgo</code> and statically link any C bindings. We won’t go into what this is, other than that it enforces static linking, but I encourage you to look at <a href="https://oreil.ly/XUI8H">the <code>cgo</code> documentation</a> if you’re curious.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>GOOS=linux</code> instructs the compiler to generate a Linux binary, cross-compiling if necessary.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>-a</code> forces the compiler to rebuild any packages that are already up to date.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>-o kvs</code> specifies that the binary will be named <code>kvs</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Linux binaries" id="idm45983630827832"/>Executing the command should yield a statically linked Linux binary. This can be verified using the <code>file</code> command:</p>&#13;
&#13;
<pre data-type="programlisting">$ file kvs&#13;
kvs: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked,&#13;
not stripped</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Linux binaries will run in a Linux container, even one running in Docker for MacOS or Windows, but won’t run on MacOS or Windows otherwise.</p>&#13;
</div>&#13;
&#13;
<p>Great! Now let’s build the container image, and see what comes out:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker build --tag kvs .&#13;
...output omitted.&#13;
&#13;
$ docker images&#13;
REPOSITORY     TAG        IMAGE ID           CREATED               SIZE&#13;
kvs            latest     7b1fb6fa93e3       About a minute ago    6.88MB&#13;
node           15         ebcfbb59a4bd      7 days ago             936MB&#13;
python         3.9        2a93c239d591      8 days ago             885MB&#13;
openjdk        15         7666c92f41b0      2 weeks ago            486MB</pre>&#13;
&#13;
<p>Less than 7MB! That’s roughly two orders of magnitude smaller than the relatively massive images for other languages’ runtimes. This can come in quite handy when you’re operating at scale and have to pull your image onto a couple hundred nodes a few times a day.</p>&#13;
&#13;
<p>But does it run? Let’s find out:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker run --detach --publish 8080:8080 kvs&#13;
4a05617539125f7f28357d3310759c2ef388f456b07ea0763350a78da661afd3&#13;
&#13;
$ curl -X PUT -d 'Hello, key-value store!' -v http://localhost:8080/v1/key-a&#13;
&gt; PUT /v1/key-a HTTP/1.1&#13;
&lt; HTTP/1.1 201 Created&#13;
&#13;
$ curl http://localhost:8080/v1/key-a&#13;
Hello, key-value store!</pre>&#13;
&#13;
<p>Looks like it works!</p>&#13;
&#13;
<p>So now you have a nice, simple Dockerfile that builds an image using a precompiled binary. Unfortunately, that means that you have to make sure that you (or your CI system) rebuilds the binary fresh for each Docker build. That’s not <em>too</em> terrible, but it does mean that you need to have Go installed on your build workers. Again, not terrible, but we can certainly do better.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect3" data-pdf-bookmark="Iteration 2: using a multi-stage build"><div class="sect3" id="idm45983630906456">&#13;
<h3>Iteration 2: using a multi-stage build</h3>&#13;
&#13;
<p>In the last section, you created a simple Dockerfile that would take an existing Linux binary and wrap it in a bare-bones “scratch” image. But what if you could perform the <em>entire</em> image build—Go compilation and all—in Docker?</p>&#13;
&#13;
<p>One approach might be to use the <code>golang</code> image as our parent image. If you did that, your Dockerfile could compile your Go code and run the resulting binary at deploy time. This could build on hosts that don’t have the Go compiler installed, but the resulting image would be saddled with an additional 862MB (the size of the <code>golang:1.16</code> image) of entirely unnecessary build machinery.</p>&#13;
&#13;
<p>Another approach might be to use two Dockerfiles: one for building the binary, and another that containerizes the output of the first build. This is a lot closer to where you want to be, but it requires two distinct Dockerfiles that need be sequentially built or managed by a separate script.</p>&#13;
&#13;
<p>A better way became available with the introduction of multistage Docker builds, which allow multiple distinct builds—even with entirely different base images—to be chained together so that artifacts from one stage can be selectively copied into another, leaving behind everything you don’t want in the final image. To use this approach, you define a build with two stages: a “build” stage that generates the Go binary, and an “image” stage that uses that binary to produce the final image.</p>&#13;
&#13;
<p>To do this, you use multiple <code>FROM</code> statements in our Dockerfile, each defining the start of a new stage. Each stage can be arbitrarily named. For example, you might name your build stage <code>build</code>, as follows:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="dockerfile"><code class="k">FROM</code><code class="s"> golang:1.16 as build</code></pre>&#13;
&#13;
<p>Once you have stages with names, you can use the <code>COPY</code> instruction in your Dockerfile to copy any artifact <em>from any previous stage</em>. Your final stage might have an instruction like the following, which copies the file <code>/src/kvs</code> from the <code>build</code> stage to the current working directory:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="dockerfile">COPY --from<code class="o">=</code>build /src/kvs .</pre>&#13;
&#13;
<p>Putting these things together yields a complete, two-stage Dockerfile:</p>&#13;
&#13;
<pre data-type="programlisting" data-code-language="dockerfile"><code class="c"># Stage 1: Compile the binary in a containerized Golang environment</code>&#13;
<code class="c">#</code>&#13;
<code class="k">FROM</code><code class="s"> golang:1.16 as build</code>&#13;
&#13;
<code class="c"># Copy the source files from the host</code>&#13;
COPY . /src&#13;
&#13;
<code class="c"># Set the working directory to the same place we copied the code</code>&#13;
<code class="k">WORKDIR</code><code class="s"> /src</code>&#13;
&#13;
<code class="c"># Build the binary!</code>&#13;
<code class="k">RUN</code> <code class="nv">CGO_ENABLED</code><code class="o">=</code><code class="m">0</code> <code class="nv">GOOS</code><code class="o">=</code>linux go build -o kvs&#13;
&#13;
&#13;
<code class="c"># Stage 2: Build the Key-Value Store image proper</code>&#13;
<code class="c">#</code>&#13;
<code class="c"># Use a "scratch" image, which contains no distribution files</code>&#13;
<code class="k">FROM</code><code class="s"> scratch</code>&#13;
&#13;
<code class="c"># Copy the binary from the build container</code>&#13;
COPY --from<code class="o">=</code>build /src/kvs .&#13;
&#13;
<code class="c"># If you're using TLS, copy the .pem files too</code>&#13;
COPY --from<code class="o">=</code>build /src/*.pem .&#13;
&#13;
<code class="c"># Tell Docker we'll be using port 8080</code>&#13;
<code class="k">EXPOSE</code><code class="s"> 8080</code>&#13;
&#13;
<code class="c"># Tell Docker to execute this command on a "docker run"</code>&#13;
<code class="k">CMD</code><code class="s"> ["/kvs"]</code></pre>&#13;
&#13;
<p>Now that you have your complete Dockerfile, you can build it in precisely the same way as before. We’ll tag it as <code>multipart</code> this time, though, so that you can compare the two images:</p>&#13;
&#13;
<pre data-type="programlisting">$ docker build --tag kvs:multipart .&#13;
...output omitted.&#13;
&#13;
$ docker images&#13;
REPOSITORY     TAG           IMAGE ID           CREATED               SIZE&#13;
kvs            latest        7b1fb6fa93e3       2 hours ago           6.88MB&#13;
kvs            multipart     b83b9e479ae7       4 minutes ago         6.56MB</pre>&#13;
&#13;
<p>This is encouraging! You now have a single Dockerfile that can compile your Go code—regardless of whether or not the Go compiler is even installed on the build worker—and that drops the resulting statically linked executable binary into a &#13;
<span class="keep-together"><code>FROM scratch</code> base</span> to produce a very, very small image containing nothing except your key-value store service.</p>&#13;
&#13;
<p>You don’t need to stop there, though. If you wanted to, you could add other stages as well, such as a <code>test</code> stage that runs any unit tests prior to the build step. We won’t go through that exercise now, however, since it’s more of the same thing, but I encourage you to try it for yourself.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect2" data-pdf-bookmark="Externalizing Container Data"><div class="sect2" id="idm45983630793208">&#13;
<h2>Externalizing Container Data</h2>&#13;
&#13;
<p><a data-type="indexterm" data-primary="containers" id="idm45983630676424"/>Containers are intended to be ephemeral, and any container should be designed and run with the understanding that it can (and will) be destroyed and recreated at any time, taking all of its data with it. To be clear, this is a feature, and is very intentional, but sometimes you might <em>want</em> your data to outlive your containers.</p>&#13;
&#13;
<p><a data-type="indexterm" data-primary="Kubernetes" data-secondary="features of" id="idm45983630674616"/>For example, the ability to mount externally managed files directly into the filesystem of an otherwise general-purpose container can decouple configurations from images so you don’t have to rebuild them whenever just to change their settings. This is a very powerful strategy, and is probably the most common use-case for container data externalization. So common in fact that Kubernetes even provides a resource type—<code>ConfigMap</code>—dedicated to it.</p>&#13;
&#13;
<p>Similarly, you might want data generated in a container to exist beyond the lifetime of the container. Storing data on the host can be an excellent strategy for warming caches, for example. It’s important to keep in mind, however, one of the realities of cloud native infrastructure: nothing is permanent, not even servers. Don’t store anything on the host that you don’t mind possibly losing forever.</p>&#13;
&#13;
<p>Fortunately, while “pure” Docker limits you to externalizing data directly onto local disk,<sup><a data-type="noteref" id="idm45983630671304-marker" href="ch05.xhtml#idm45983630671304">24</a></sup> container orchestration systems like Kubernetes provides <a href="https://oreil.ly/vBXfA">various abstractions</a> that allows data to survive the loss of a host.</p>&#13;
&#13;
<p>Unfortunately, this is supposed to be a book about Go, so we really can’t cover Kubernetes in detail here. But if you haven’t already, I strongly encourage you to take a long look at the <a href="https://oreil.ly/wxImg">excellent Kubernetes documentation</a>, and equally excellent <a href="https://oreil.ly/e6rve" class="orm:hideurl"><em>Kubernetes: Up and Running</em></a> by Brendan Burns, Joe Beda, and Kelsey Hightower (O’Reilly).<a data-type="indexterm" data-primary="Docker" data-startref="ch05_term21" id="idm45983630667320"/><a data-type="indexterm" data-primary="Dockerfile" data-startref="ch05_term22" id="idm45983630666408"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="Summary"><div class="sect1" id="idm45983631131560">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>This was a long chapter, and we touched on a lot of different topics. Consider how much we’ve accomplished!</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Starting from first principles, we designed and implemented a simple monolithic key-value store, using <code>net/http</code> and <code>gorilla/mux</code> to build a RESTful service around functionality provided by a small, independent, and easily testable &#13;
<span class="keep-together">Go library.</span></p>&#13;
</li>&#13;
<li>&#13;
<p>We leveraged Go’s powerful interface capabilities to produce two completely different transaction logger implementations, one based on local files and using <code>os.File</code> and the <code>fmt</code> and <code>bufio</code> packages; the other backed by a Postgres database and using the <code>database/sql</code> and <code>github.com/lib/pq</code> Postgres driver &#13;
<span class="keep-together">packages</span>.</p>&#13;
</li>&#13;
<li>&#13;
<p>We discussed the importance of security in general, covered some of the basics of TLS as one part of a larger security strategy, and implemented HTTPS in &#13;
<span class="keep-together">our service</span>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Finally, we covered containerization, one of the core cloud native technologies, including how to build images and how to run and manage containers. We even containerized not only our application, but we even containerized its build &#13;
<span class="keep-together">process</span>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Going forward, we’ll be extending on our key-value service in various ways when we introduce new concepts, so stay tuned. Things are about to get even more interesting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45983635901544"><sup><a href="ch05.xhtml#idm45983635901544-marker">1</a></sup> Schieber, Philip. “The Wit and Wisdom of Grace Hopper.” <em>OCLC Newsletter</em>, March/April, 1987, No. 167.</p><p data-type="footnote" id="idm45983635889304"><sup><a href="ch05.xhtml#idm45983635889304-marker">2</a></sup> For some definition of “love.”</p><p data-type="footnote" id="idm45983635871960"><sup><a href="ch05.xhtml#idm45983635871960-marker">3</a></sup> If it does, something is very wrong.</p><p data-type="footnote" id="idm45983635864728"><sup><a href="ch05.xhtml#idm45983635864728-marker">4</a></sup> Or, like my son, was only <em>pretending</em> not to hear you.</p><p data-type="footnote" id="idm45983635854008"><sup><a href="ch05.xhtml#idm45983635854008-marker">5</a></sup> “Cloud native is not a synonym for microservices… if cloud native has to be a synonym for anything, it would be idempotent, which definitely needs a synonym.” —Holly Cummins (Cloud Native London 2018).</p><p data-type="footnote" id="idm45983635173272"><sup><a href="ch05.xhtml#idm45983635173272-marker">6</a></sup> Isn’t this exciting?</p><p data-type="footnote" id="idm45983634450664"><sup><a href="ch05.xhtml#idm45983634450664-marker">7</a></sup> It’s a good thing too. Mutexes can be pretty tedious to implement correctly!</p><p data-type="footnote" id="idm45983634224808"><sup><a href="ch05.xhtml#idm45983634224808-marker">8</a></sup> Didn’t I tell you that we’d make it more complicated?</p><p data-type="footnote" id="idm45983633408024"><sup><a href="ch05.xhtml#idm45983633408024-marker">9</a></sup> That’s a lie. There are probably lots of better names.</p><p data-type="footnote" id="idm45983633120568"><sup><a href="ch05.xhtml#idm45983633120568-marker">10</a></sup> What makes a transaction log “good” anyway?</p><p data-type="footnote" id="idm45983633116792"><sup><a href="ch05.xhtml#idm45983633116792-marker">11</a></sup> Naming is hard.</p><p data-type="footnote" id="idm45983632869720"><sup><a href="ch05.xhtml#idm45983632869720-marker">12</a></sup> After all this time, I still think that’s pretty neat.</p><p data-type="footnote" id="idm45983632511416"><sup><a href="ch05.xhtml#idm45983632511416-marker">13</a></sup> You’re welcome.</p><p data-type="footnote" id="idm45983631389976"><sup><a href="ch05.xhtml#idm45983631389976-marker">14</a></sup> Ideally written by somebody who knows more than I do about security.</p><p data-type="footnote" id="idm45983631362184"><sup><a href="ch05.xhtml#idm45983631362184-marker">15</a></sup> This is a gross over-simplification, but it’ll do for our purposes. I encourage you to learn more about this and correct me, though.</p><p data-type="footnote" id="idm45983631356520"><sup><a href="ch05.xhtml#idm45983631356520-marker">16</a></sup> You don’t know where that key has been.</p><p data-type="footnote" id="idm45983631349192"><sup><a href="ch05.xhtml#idm45983631349192-marker">17</a></sup> SSL 2.0 was released in 1995 and TLS 1.0 was released in 1999. Interestingly, SSL 1.0 had some pretty profound security flaws and was never publicly released.</p><p data-type="footnote" id="idm45983631338264"><sup><a href="ch05.xhtml#idm45983631338264-marker">18</a></sup> Public keys only, please.</p><p data-type="footnote" id="idm45983631128184"><sup><a href="ch05.xhtml#idm45983631128184-marker">19</a></sup> Containers are not virtual machines. They virtualize the operating system instead of hardware.</p><p data-type="footnote" id="idm45983631126600"><sup><a href="ch05.xhtml#idm45983631126600-marker">20</a></sup> Repetition intended. This is an important point.</p><p data-type="footnote" id="idm45983631124536"><sup><a href="ch05.xhtml#idm45983631124536-marker">21</a></sup> Yup. I said it. Again.</p><p data-type="footnote" id="idm45983631092424"><sup><a href="ch05.xhtml#idm45983631092424-marker">22</a></sup> The initial draft had several more, but this chapter is already pretty lengthy.</p><p data-type="footnote" id="idm45983630908216"><sup><a href="ch05.xhtml#idm45983630908216-marker">23</a></sup> To be fair, these images are “only” 240MB and 337MB compressed, respectively.</p><p data-type="footnote" id="idm45983630671304"><sup><a href="ch05.xhtml#idm45983630671304-marker">24</a></sup> I’m intentionally ignoring solutions like Amazon’s Elastic Block Store, which can help, but have issues of their own.</p></div></div></section></div></body></html>