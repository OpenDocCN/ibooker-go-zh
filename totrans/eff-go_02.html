<html><head></head><body><section data-pdf-bookmark="Chapter 2. Efficient Introduction to Go" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch-go">&#13;
<h1><span class="label">Chapter 2. </span>Efficient Introduction to Go</h1>&#13;
&#13;
<blockquote><p>Go is efficient, scalable, and productive. Some programmers find it fun to work in; others find it unimaginative, even boring. ... Those are not contradictory positions. Go was designed to address the problems faced in software development at Google, which led to a language that is not a breakthrough research language but is nonetheless an excellent tool for engineering large software projects.</p>&#13;
<p data-type="attribution">Rob Pike, <a href="https://oreil.ly/3EItq">“Go at Google: Language Design in the Service of Software <span class="keep-together">Engineering”</span></a></p></blockquote>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="overview" data-type="indexterm" id="ix_ch02-asciidoc0"/>I <a data-primary="Pike, Rob" data-secondary="on Go" data-type="indexterm" id="idm45606843250432"/>am a huge fan of the Go programming language. The number of things developers around the world have been able to achieve with Go is impressive. For a few years in a row, Go has been on the list of <a href="https://oreil.ly/la9bx">top five languages people love or want to learn</a>. It is used in many businesses, including bigger tech companies like Apple, American Express, Cloudflare, Dell, Google, Netflix, Red Hat, Twitch, and <a href="https://oreil.ly/DSM73">others</a>. Of course, as with everything, nothing is perfect. I would probably change, remove, or add a few things to Go, but if you would wake me in the middle of the night and ask me to quickly write reliable backend code, I would write it in Go. CLI? In Go. Quick, reliable script? In Go as well. The first language to learn as a junior programmer? Go. Code for IoT, robots, and microprocessors? The answer is also Go.<sup><a data-type="noteref" href="ch02.html#idm45606843247856" id="idm45606843247856-marker">1</a></sup> Infrastructure configuration? As of 2022, I don’t think there is a better tool for robust templating than Go.<sup><a data-type="noteref" href="ch02.html#idm45606843245632" id="idm45606843245632-marker">2</a></sup></p>&#13;
&#13;
<p>Don’t get me wrong, there are languages with specialized capabilities or ecosystems that are superior to Go. For example, think about graphical user interfaces (GUIs), advanced rendering parts of the game industry, or code running in browsers.<sup><a data-type="noteref" href="ch02.html#idm45606843243616" id="idm45606843243616-marker">3</a></sup> However, once you realize the many advantages of the Go language, it is pretty painful to jump back to others.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch01.html#ch-efficiency-matters">Chapter 1</a>, we spent some time establishing an efficiency awareness for our software. As a result, we learned that our goal is to write efficient code with the least development effort and cost. This chapter will explain why the Go programming language can be a solid option to achieve this balance between performance and other software qualities.</p>&#13;
&#13;
<p>We will start with <a data-type="xref" href="#ch-go-intro">“Basics You Should Know About Go”</a>, then continue with <a data-type="xref" href="#ch-go-adv">“Advanced Language Elements”</a>. Both sections list the short but essential facts everyone should know about Go, something I wish I had known when I started my journey with Go in 2014. These sections will cover much more than just basic information about efficiency and can be used as an introduction to Go. However, if you are entirely new to the language, I would still recommend reading those sections, then checking other resources mentioned in the summary, perhaps writing your first program in Go, and then getting back to this book. On the other hand, if you consider yourself a more advanced user or expert, I suggest not skipping this chapter. I explain a few lesser-known facts about Go that you might find interesting or controversial (it’s OK, everyone can have their own opinions!).</p>&#13;
&#13;
<p>Last but not least, we will finish by answering the tricky question about the overall Go efficiency capabilities in <a data-type="xref" href="#ch-go-fast">“Is Go “Fast”?”</a>, as compared to other languages.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basics You Should Know About Go" data-type="sect1"><div class="sect1" id="ch-go-intro">&#13;
<h1>Basics You Should Know About Go</h1>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="basics" data-type="indexterm" id="ix_ch02-asciidoc1"/>Go is an open source project maintained by Google within a distributed team called the “Go team.” The project consists of the programming language specification, compilator, tooling, documentation, and standard libraries.</p>&#13;
&#13;
<p>Let’s go through some facts and best practices to understand Go basics and its characteristics in fast-forward mode. While some advice here might feel opinionated, this is based on my experience working with Go since 2014—a background full of incidents, past mistakes, and lessons learned the hard way. I’m sharing them here so you don’t need to make those errors.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Imperative, Compiled, and Statically Typed Language" data-type="sect2"><div class="sect2" id="idm45606843232960">&#13;
<h2>Imperative, Compiled, and Statically Typed Language</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="language: imperative, compiled, statically typed" data-type="indexterm" id="idm45606843231552"/>The central part of the Go project is the general-purpose language with the same name, primarily designed for systems programming. As you will notice in <a data-type="xref" href="#code-basic">Example 2-1</a>, Go is an imperative language, so we have (some) control over how things are executed. In addition, it’s statically typed and compiled, which means that the compiler can perform many optimizations and checks before the program runs. These characteristics alone are an excellent start to make Go suitable for reliable and efficient programs.</p>&#13;
<div data-type="example" id="code-basic">&#13;
<h5><span class="label">Example 2-1. </span>Simple program printing “Hello World” and exiting</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>&#13;
&#13;
<code class="kn">import</code><code class="w"> </code><code class="s">"fmt"</code><code class="w"/>&#13;
&#13;
<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">   </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Hello World!"</code><code class="p">)</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre></div>&#13;
&#13;
<p>Both project and language are called “Go,” yet sometimes you can refer to them as “Golang.”</p>&#13;
<div data-type="tip"><h1>Go Versus Golang</h1>&#13;
<p><a data-primary="Go (generally)" data-secondary="Golang versus" data-type="indexterm" id="idm45606843200160"/><a data-primary="Golang" data-secondary="Go versus" data-type="indexterm" id="idm45606843199216"/>As a rule of thumb, we should always use the “Go” name everywhere, unless it’s clashing with the English word <em>go</em> or an ancient game called “Go.” “Golang” came from the domain choice (<a class="bare" href="https://golang.org"><em class="hyperlink">https://golang.org</em></a>) since “go” was unavailable to its authors. So use “Golang” when searching for resources about this programming language on the web.</p>&#13;
</div>&#13;
&#13;
<p>Go also has its mascot, called the <a href="https://oreil.ly/SbxVX">“Go gopher”</a>. We see this cute gopher in various forms, situations, and combinations, such as conference talks, blog posts, or project logos. Sometimes Go developers are called “gophers” too!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Designed to Improve Serious Codebases" data-type="sect2"><div class="sect2" id="idm45606843194208">&#13;
<h2>Designed to Improve Serious Codebases</h2>&#13;
&#13;
<p><a data-primary="Golang" data-secondary="design to improve serious codebases" data-type="indexterm" id="ix_ch02-asciidoc2"/>It all started when three experienced programmers from Google sketched the idea of the Go language around 2007:</p>&#13;
<dl>&#13;
<dt>Rob Pike</dt>&#13;
<dd>&#13;
<p><a data-primary="Pike, Rob" data-secondary="on Go origins" data-type="indexterm" id="idm45606843189824"/>Cocreator of UTF-8 and the Plan 9 operating system. Coauthor of many programming languages before Go, such as Limbo for writing distributed systems and Newsqueak for writing concurrent applications in graphical user interfaces. Both were inspired by Hoare’s Communicating Sequential Processes (CSP).<sup><a data-type="noteref" href="ch02.html#idm45606843188400" id="idm45606843188400-marker">4</a></sup></p>&#13;
</dd>&#13;
</dl>&#13;
<dl>&#13;
<dt>Robert Griesemer</dt>&#13;
<dd>&#13;
<p><a data-primary="Griesemer, Robert" data-secondary="Go origins" data-type="indexterm" id="idm45606843185760"/><a data-primary="Wirth, Niklaus" data-secondary="and Go origins" data-secondary-sortas="Go origins" data-type="indexterm" id="idm45606843184784"/>Among other work, Griesemer developed the <a href="https://oreil.ly/gYKMj">Sawzall language</a> and did a doctorate with Niklaus Wirth. The same Niklaus wrote “A Plea for Lean Software” quoted in <a data-type="xref" href="ch01.html#ch-eff-s-hardware-slower">“Software gets slower more rapidly than hardware becomes faster”</a>.</p>&#13;
</dd>&#13;
</dl>&#13;
<dl>&#13;
<dt>Ken Thompson</dt>&#13;
<dd>&#13;
<p><a data-primary="Thompson, Ken, and Go origins" data-type="indexterm" id="idm45606843180224"/>One of the original authors of the first Unix system. Sole creator of the <code>grep</code> command-line utility. Ken cocreated UTF-8 and Plan 9 with Rob Pike. He wrote a couple of languages, too, e.g., the Bon and B programming languages.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>These three aimed to create a new programming language that was meant to improve mainstream programming, led by C++, Java, and Python at that point. After a year, it became a full-time project, with <a data-primary="Cox, Russ" data-secondary="and Go team" data-secondary-sortas="Go team" data-type="indexterm" id="idm45606843149632"/><a data-primary="Taylor, Ian, and Go team" data-type="indexterm" id="idm45606843148384"/>Ian Taylor and Russ Cox joining in 2008 what was <a href="https://oreil.ly/Nnj6N">later referenced as the Go team</a>. The Go team announced the public Go project in 2009, with version 1.0 released in March 2012.</p>&#13;
&#13;
<p>The main frustrations<sup><a data-type="noteref" href="ch02.html#idm45606843146464" id="idm45606843146464-marker">5</a></sup> related to C++ mentioned in the design of Go were:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Complexity, many ways of doing the same thing, too many features</p>&#13;
</li>&#13;
<li>&#13;
<p>Ultralong compilation times, especially for bigger codebases</p>&#13;
</li>&#13;
<li>&#13;
<p>Cost of updates and refactors in large projects</p>&#13;
</li>&#13;
<li>&#13;
<p>Not easy to use and memory model prone to errors</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These elements are why Go was born, from the frustration of existing solutions and the ambition to allow more by doing less. The guiding principles were to make a language that does not trade safety for less repetition, yet allows simpler code. It does not sacrifice execution efficiency for faster compilation or interpreting, yet ensures that build times are quick enough. <a href="https://oreil.ly/qxuUS">Go tries to compile as fast as possible, e.g., thanks to explicit imports</a>. Especially with caching enabled by default, only changed code is compiled, so build times are rarely longer than a minute.</p>&#13;
<div class="tip2" data-type="tip"><h1>You Can Treat Go Code as Script!</h1>&#13;
<p><a data-primary="script (using Go code)" data-type="indexterm" id="idm45606843138464"/>While technically Go is a compiled language, you can run it like you would run JavaScript, Shell, or Python. It’s as simple as invoking <code>go run &lt;executable package&gt; &lt;flags&gt;</code>. It works great because the compilation is ultrafast. You can treat it like a scripting language while maintaining the advantages of compilation.</p>&#13;
</div>&#13;
&#13;
<p>In terms of syntax, Go was meant to be simple, light on keywords, and familiar. Syntax is based on C with type derivation (automatic type detection, like <code>auto</code> in &#13;
<span class="keep-together">C++),</span> and no forward declarations, no header files. Concepts are kept orthogonal, which allows easier combination and reasoning about them. Orthogonality for elements means that, for example, we can add methods to any type or data definition (adding methods is separate from creating types). Interfaces are orthogonal to types too.<a data-startref="ix_ch02-asciidoc2" data-type="indexterm" id="idm45606843135232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Governed by Google, Yet Open Source" data-type="sect2"><div class="sect2" id="idm45606843134272">&#13;
<h2>Governed by Google, Yet Open Source</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="open source/governed by Google" data-type="indexterm" id="idm45606843133088"/><a data-primary="Google, Go governance and" data-type="indexterm" id="idm45606843132048"/><a data-primary="open source versus Go" data-type="indexterm" id="idm45606843131360"/>Since announcing Go, all development has been done in <a href="https://oreil.ly/ZeKm6">open source</a>, with public mailing lists and bug trackers. Changes go to the public, authoritative source code, held under the <a href="https://oreil.ly/XBDEK">BSD style license</a>. The Go team reviews all contributions. The process is the same if the change or idea is coming from Google or not. The project road maps and proposals are developed in public too.</p>&#13;
&#13;
<p>Unfortunately, the sad truth is that there are many open source projects, but some projects are less open than others. Google is still the only company stewarding Go and has the last decisive control over it. Even if anyone can modify, use, and contribute, projects coordinated by a single vendor risk selfish and damaging decisions like relicensing or blocking certain features. While there were some controversial cases where the Go team decision surprised the community,<sup><a data-type="noteref" href="ch02.html#idm45606843127920" id="idm45606843127920-marker">6</a></sup> overall the project is very reasonably well governed. Countless changes came from outside of Google, and the Go 2.0 draft proposal process has been well respected and community driven. In the end, I believe consistent decision-making and stewarding from the Go team bring many benefits too. Conflicts and different views are inevitable, and having one consistent overview, even if not perfect, might be better than no decision or many ways of doing the same thing.</p>&#13;
&#13;
<p class="less_space pagebreak-before">So far, this project setup has proven to work well for adoption and language stability. For our software efficiency goals, such alignment couldn’t be better too. We have a big company invested in ensuring each release doesn’t bring any performance regressions. Some internal Google software depends on Go, e.g., <a href="https://oreil.ly/vjyOc">Google Cloud Platform</a>. And many people rely on the Google Cloud Platform to be reliable. On the other hand, we have a vast Go community that gives feedback, finds bugs, and contributes ideas and optimizations. And if that’s not enough, we have open source code, allowing us, mere mortal developers, to dive into the actual Go libraries, runtime (see <a data-type="xref" href="#ch-go-runtime">“Go Runtime”</a>), etc., to understand the performance characteristics of the particular code.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Simplicity, Safety, and Readability Are Paramount" data-type="sect2"><div class="sect2" id="idm45606843124000">&#13;
<h2>Simplicity, Safety, and Readability Are Paramount</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="simplicity, safety, and readability" data-type="indexterm" id="idm45606843122448"/><a data-primary="Griesemer, Robert" data-secondary="Go origins" data-type="indexterm" id="idm45606843121312"/>Robert Griesemer <a href="https://oreil.ly/s3ZZ5">mentioned in GopherCon 2015</a> that first of all, they knew when they first started building Go what things NOT to do. The main guiding principle was simplicity, safety, and readability. In other words, Go follows the pattern of “less is more.” This is a potent idiom that spans many areas. <a data-primary="idiomatic coding style" data-type="indexterm" id="idm45606843119552"/>In Go, there is only one <em>idiomatic</em> coding style,<sup><a data-type="noteref" href="ch02.html#idm45606843118368" id="idm45606843118368-marker">7</a></sup> and a tool called <code>gofmt</code> ensures most of it. In particular, code formatting (next to naming) is an element that is rarely settled among programmers. We spend time arguing about it and tuning it to our specific needs and beliefs. Thanks to a single style enforced by tooling, we save enormous time. As one of the <a href="https://oreil.ly/ua2G8">Go proverbs</a> goes, “Gofmt’s style is no one’s favorite, yet gofmt is everyone’s favorite.” Overall, the Go authors planned the language to be minimal so that there is essentially one way to write a particular construct. This takes away a lot of decision-making when you are writing a program. There is one way of handling errors, one way of writing objects, one way of running things concurrently, etc.</p>&#13;
&#13;
<p>A huge number of features might be “missing” from Go, yet <a href="https://oreil.ly/CPkvV">one could say it is more expressive than C or C++</a>. Such minimalism allows for maintaining the simplicity and readability of the Go code, which improves software reliability, safety, and overall higher velocity toward application goals.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Is My Code Idiomatic?</h1>&#13;
<p>The word <em>idiomatic</em> is heavily overused in the Go community. Usually, it means Go patterns that are “often” used. Since Go adoption has grown a lot, people have improved the initial “idiomatic” style in many creative ways. Nowadays, it’s not always clear what’s idiomatic and what’s not.</p>&#13;
&#13;
<p>It’s like the “This is the way” saying from the <em>Mandalorian</em> series. It makes us feel more confident when we say, “This code is idiomatic.” So the conclusion is to use this word with care and <a href="https://oreil.ly/dAAKz">avoid it unless you can elaborate the reasoning why some pattern is better</a>.</p>&#13;
</div>&#13;
&#13;
<p>Interestingly, the “less is more” idiom can help our efficiency efforts for this book’s purpose. As we learned in <a data-type="xref" href="ch01.html#ch-efficiency-matters">Chapter 1</a>, if you do less work at runtime, it usually means faster, lean execution and less complex code. In this book, we will try to maintain this aspect while improving our code performance.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Packaging and Modules" data-type="sect2"><div class="sect2" id="idm45606843107744">&#13;
<h2>Packaging and Modules</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="packaging and modules" data-type="indexterm" id="idm45606843106336"/><a data-primary="modules, Go source code and" data-type="indexterm" id="idm45606843105136"/><a data-primary="packages" data-secondary="Go source code and" data-type="indexterm" id="idm45606843104496"/>The Go source code is organized into directories representing either packages or modules. A package is a collection of source files (with the <em>.go</em> suffix) in the same directory. The package name is specified with the <code>package</code> statement at the top of each source file, as seen in <a data-type="xref" href="#code-basic">Example 2-1</a>. All files in the same directory must the same package name<sup><a data-type="noteref" href="ch02.html#idm45606843101632" id="idm45606843101632-marker">8</a></sup> (the package name can be different from the directory name). Multiple packages can be part of a single Go module. A module is a directory with a <em>go.mod</em> file that states all dependent modules with their versions required to build the Go application. This file is then used by the dependency management tool <a href="https://oreil.ly/z5GqG">Go  Modules</a>. Each source file in a module can import packages from the same or external modules. Some packages can also be “executable.” For example, if a package is called <code>main</code> and has <code>func main()</code> in some file, we can execute it. Sometimes such a package is placed in the cmd directory for easier discovery. Note that you cannot import the executable package. You can only build or run it.</p>&#13;
&#13;
<p>Within the package, you can decide what functions, types, interfaces, and methods are exported to package users and which are accessible only in the package scope. This is important because exporting the minimal amount of API possible for readability, reusability, and reliability is better. Go does not have any <code>private</code> or <code>public</code> keywords for this. Instead, it takes a slightly new approach. As <a data-type="xref" href="#code-export">Example 2-2</a> shows, if the construct name starts with an uppercase letter, any code outside the package can use it. If the element name begins with a lowercase letter, it’s private. It’s worth noting that this pattern works for all constructs equally, e.g., functions, types, interfaces, variables, etc. (orthogonality).</p>&#13;
<div data-type="example" id="code-export">&#13;
<h5><span class="label">Example 2-2. </span>Construct accessibility control using naming case</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">const</code><code class="w"> </code><code class="nx">privateConst</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="mi">1</code><code class="w">&#13;
</code><code class="kd">const</code><code class="w"> </code><code class="nx">PublicConst</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="mi">2</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">var</code><code class="w"> </code><code class="nx">privateVar</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="kd">var</code><code class="w"> </code><code class="nx">PublicVar</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">privateFunc</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">PublicFunc</code><code class="p">(</code><code class="p">)</code><code class="w">  </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">privateStruct</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">privateField</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">PublicField</code><code class="w">  </code><code class="kt">int</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO1-1" id="co_efficient_introduction_to_go_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">privateStruct</code><code class="p">)</code><code class="w"> </code><code class="nx">privateMethod</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">privateStruct</code><code class="p">)</code><code class="w"> </code><code class="nx">PublicMethod</code><code class="p">(</code><code class="p">)</code><code class="w">  </code><code class="p">{</code><code class="p">}</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO1-1" id="co_efficient_introduction_to_go_CO1-2"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">PublicStruct</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">privateField</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">PublicField</code><code class="w">  </code><code class="kt">int</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">PublicStruct</code><code class="p">)</code><code class="w"> </code><code class="nx">privateMethod</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">PublicStruct</code><code class="p">)</code><code class="w"> </code><code class="nx">PublicMethod</code><code class="p">(</code><code class="p">)</code><code class="w">  </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">privateInterface</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">privateMethod</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">PublicMethod</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO1-1" id="co_efficient_introduction_to_go_CO1-3"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">PublicInterface</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">privateMethod</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">PublicMethod</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO1-1" id="callout_efficient_introduction_to_go_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Careful readers might notice tricky cases of exported fields or methods on private type or <code>interface</code>. Can someone outside the package use them if the <code>struct</code> or <code>interface</code> is private? This is quite rarely used, but the answer is yes, you can return a private <code>interface</code> or type in a public function, e.g., <code>func New() &#13;
<span class="keep-together">privateStruct</span> { return privateStruct{}}</code>. Despite the <code>privateStruct</code> being private, all its public fields and methods are accessible to package users.</p></dd>&#13;
</dl></div>&#13;
<div data-type="note" epub:type="note"><h1>Internal Packages</h1>&#13;
<p><a data-primary="internal packages" data-type="indexterm" id="idm45606842914480"/><a data-primary="packages" data-secondary="internal directory and" data-type="indexterm" id="idm45606842913776"/>You can name and structure your code directories as you want to form packages, but one directory name is reserved for special meaning.&#13;
If you want to ensure that only the given package can import other packages, you can create a package subdirectory named internal. Any package under the internal directory can’t be imported by any package other than the ancestor (and other packages in internal).</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dependencies Transparency by Default" data-type="sect2"><div class="sect2" id="ch-go-deps">&#13;
<h2>Dependencies Transparency by Default</h2>&#13;
&#13;
<p><a data-primary="dependencies, transparency of" data-type="indexterm" id="ix_ch02-asciidoc3"/><a data-primary="Go (generally)" data-secondary="dependencies as transparent by default" data-type="indexterm" id="ix_ch02-asciidoc4"/>In my experience, it is common to import precompiled libraries, such as in C++, C#, or Java, and use exported functions and classes defined in some header files. However, importing compiled code has some benefits:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It relieves engineers from making an effort to compile particular code, i.e., find and download correct versions of dependencies, special compilation tooling, or extra resources.</p>&#13;
</li>&#13;
<li>&#13;
<p>It might be easier to sell such a prebuilt library without exposing the source code and worrying about the client copying the business value-providing code.<sup><a data-type="noteref" href="ch02.html#idm45606842831664" id="idm45606842831664-marker">9</a></sup></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In principle, this is meant to work well. Developers of the library maintain specific programmatic contracts (APIs), and users of such libraries do not need to worry about implementation complexities.</p>&#13;
&#13;
<p>Unfortunately, in practice, this is rarely that perfect. Implementation can be broken or inefficient, the interfaces can mislead, and documentation can be missing. In such cases, access to the source code is invaluable, allowing us to more deeply understand implementation. We can find issues based on specific source code, not by guessing. We can even propose a fix to the library or fork the package and use it immediately. We can extract the required pieces and use them to build something else.</p>&#13;
&#13;
<p>Go assumes this imperfection by requiring each library’s parts (in Go: module’s packages) to be explicitly imported using a package URI called “import path.” Such import is also strictly controlled, i.e., unused imports or cyclic dependencies cause a compilation error. Let’s see different ways to declare these imports in <a data-type="xref" href="#code-imports">Example 2-3</a>.</p>&#13;
<div data-type="example" id="code-imports">&#13;
<h5><span class="label">Example 2-3. </span>Portion of <code>import</code> statements from <code>github.com/prometheus/​prome⁠theus</code> module, &#13;
<span class="plain">main.go</span> file</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"context"</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO2-1" id="co_efficient_introduction_to_go_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
   </code><code class="s">"net/http"</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">_</code><code class="w"> </code><code class="s">"net/http/pprof"</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO2-2" id="co_efficient_introduction_to_go_CO2-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
&#13;
   </code><code class="s">"github.com/oklog/run"</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO2-3" id="co_efficient_introduction_to_go_CO2-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
   </code><code class="s">"github.com/prometheus/common/version"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"go.uber.org/atomic"</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/config"</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO2-4" id="co_efficient_introduction_to_go_CO2-4"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
   </code><code class="nx">promruntime</code><code class="w"> </code><code class="s">"github.com/prometheus/prometheus/pkg/runtime"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/scrape"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/storage"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/storage/remote"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/tsdb"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/util/strutil"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/prometheus/prometheus/web"</code><code class="w">&#13;
</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO2-1" id="callout_efficient_introduction_to_go_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>If the import declaration does not have a domain with a path structure, it means the package from the “standard”<sup><a data-type="noteref" href="ch02.html#idm45606842772304" id="idm45606842772304-marker">10</a></sup> library is imported. This particular import allows us to use code from the <code>$(go env GOROOT)/src/context/</code> directory with <code>context</code> reference, e.g., <code>context.Background()</code>.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO2-2" id="callout_efficient_introduction_to_go_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The package can be imported explicitly without any identifier. We don’t want to reference any construct from this package, but we want to have some global variables initialized. In this case, the <code>pprof</code> package will add debugging endpoints to the global HTTP server router. While allowed, in practice we should avoid reusing global, modifiable variables.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO2-3" id="callout_efficient_introduction_to_go_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Nonstandard packages can be imported using an import path in the form of an internet domain name and an optional path to the package in a certain module. For example, the Go tooling integrates well with <code>https://github.com</code>, so if you host your Go code in a Git repository, it will find a specified package. In this case, it’s the <code>https://github.com/oklog/run</code> Git repository with the <code>run</code> package in the <code>github.com/oklog/run</code> module.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO2-4" id="callout_efficient_introduction_to_go_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>If the package is taken from the current module (in this case, our module is &#13;
<span class="keep-together"><code>github.com/prometheus/prometheus</code>),</span> packages will be resolved from your local directory. In our example, <code>&lt;module root&gt;/config</code>.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This model focuses on open and clearly defined dependencies. It works exceptionally well with the open source distribution model, where the community can collaborate on robust packages in the public Git repositories. Of course, a module or package can also be hidden using standard version control authentication protocols. Furthermore, the official tooling <a href="https://oreil.ly/EnkBT">does not support distributing packages in binary form</a>, so the dependency source is highly encouraged to be present for compilation purposes.</p>&#13;
&#13;
<p>The challenges of software dependency are not easy to solve. Go learned from the mistakes of C++ and others, and takes a careful approach to avoid long compilation times, and an effect commonly called “dependency hell.”<a data-primary="Pike, Rob" data-secondary="on dependencies" data-type="indexterm" id="idm45606842716032"/></p>&#13;
<blockquote><p>Through the design of the standard library, great effort was spent on controlling dependencies. It can be better to copy a little code than to pull in a big library for one function. (A test in the system build complains if new core dependencies arise.) Dependency hygiene trumps code reuse. One example of this in practice is that the (low-level) net package has its own integer-to-decimal conversion routine to avoid depending on the bigger and dependency-heavy formatted I/O package. Another is that the string conversion package strconv has a private implementation of the definition of “printable” characters rather than pull in the large Unicode character class tables; that strconv honors the Unicode standard is verified by the package’s tests.</p>&#13;
<p data-type="attribution">Rob Pike, <a href="https://oreil.ly/wqKGT">“Go at Google: Language Design in the Service of Software <span class="keep-together">Engineering”</span></a></p></blockquote>&#13;
&#13;
<p>Again, with efficiency in mind, potential minimalism in dependencies and transparency brings enormous value. Fewer unknowns means we can quickly detect main bottlenecks and focus on the most significant value optimizations first. We don’t need to work around it if we notice potential room for optimization in our dependency. Instead, we are usually welcome to contribute the fix directly to the upstream, which helps both sides!<a data-startref="ix_ch02-asciidoc4" data-type="indexterm" id="idm45606842712288"/><a data-startref="ix_ch02-asciidoc3" data-type="indexterm" id="idm45606842711616"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Consistent Tooling" data-type="sect2"><div class="sect2" id="ch-go-tooling">&#13;
<h2>Consistent Tooling</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="consistent tooling" data-type="indexterm" id="idm45606842709008"/><a data-primary="tooling, consistency of" data-type="indexterm" id="idm45606842708032"/>From the beginning, Go had a powerful and consistent set of tools as part of its command-line interface tool, called <code>go</code>. Let’s enumerate a few utilities:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>go bug</code> opens a new browser tab with the correct place where you can file an official bug report (Go repository on GitHub).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go build -o &lt;output path&gt; &lt;packages&gt;</code> builds given Go packages.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go env</code> shows all Go-related environment variables currently set in your terminal session.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go fmt &lt;file, packages or directories&gt;</code> formats given artifacts to the desired style, cleans whitespaces, fixes wrong indentations, etc. Note that the source code does not need to be even valid and compilable Go code. You can also install an extended official formatter.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/6fDcy"><code>goimports</code></a> also cleans and formats your <code>import</code> &#13;
<span class="keep-together">statements.</span></p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="tip">&#13;
<p>For the best experience, set your programming IDE to run &#13;
<span class="keep-together"><code>goimports -w $FILE</code></span> on every file to not worry about the manual indentation anymore!</p>&#13;
</div>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>go get &lt;package@version&gt;</code> allows you to install the desired dependency with the expected version. Use the <code>@latest</code> suffix to get the latest version of <code>@none</code> to uninstall the dependency.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go help &lt;command/topic&gt;</code> prints documentation about the command or given topic. For example, <code>go help environment</code> tells you all about the possible environment variables Go uses.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go install &lt;package&gt;</code> is similar to <code>go get</code> and installs the binary if the given package is “executable.”</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go list</code> lists Go packages and modules. It allows flexible output formatting using Go templates (explained later), e.g., <code>go list -mod=readonly -m -f '{{ if and (not .Indirect) (not .Main)}}{{.Path}}{{end}}' all</code> lists all direct nonexecutable dependent modules.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go mod</code> allows managing dependent modules.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go test</code> allows running unit tests, fuzz tests, and benchmarks. We will discuss the latter in detail in <a data-type="xref" href="ch08.html#ch-benchmarking">Chapter 8</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>go tool</code> hosts a dozen more advanced CLI tools. We will especially take a close look at <code>go tool pprof</code> in <a data-type="xref" href="ch09.html#ch-obs-pprof">“pprof Format”</a> for performance &#13;
<span class="keep-together">optimizations.</span></p>&#13;
</li>&#13;
<li>&#13;
<p><code>go vet</code> runs basic static analysis checks.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In most cases, the Go CLI is all you need for effective Go programming.<sup><a data-type="noteref" href="ch02.html#idm45606842681408" id="idm45606842681408-marker">11</a></sup></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Single Way of Handling Errors" data-type="sect2"><div class="sect2" id="ch-go-errs">&#13;
<h2>Single Way of Handling Errors</h2>&#13;
&#13;
<p><a data-primary="error handling" data-secondary="Go’s approach to" data-type="indexterm" id="ix_ch02-asciidoc5"/><a data-primary="Go (generally)" data-secondary="error handling" data-type="indexterm" id="ix_ch02-asciidoc6"/>Errors are an inevitable part of every running software. Especially in distributed systems, they are expected by design, with advanced research and algorithms for handling different types of failures.<sup><a data-type="noteref" href="ch02.html#idm45606842674272" id="idm45606842674272-marker">12</a></sup> Despite the need for errors, most programming languages do not recommend or enforce a particular way of failure handling. For example, in C++ you see programmers using all means possible to return an error from a function:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Exceptions</p>&#13;
</li>&#13;
<li>&#13;
<p>Integer return codes (if the returned value is nonzero, it means error)</p>&#13;
</li>&#13;
<li>&#13;
<p>Implicit status codes<sup><a data-type="noteref" href="ch02.html#idm45606842670048" id="idm45606842670048-marker">13</a></sup></p>&#13;
</li>&#13;
<li>&#13;
<p>Other sentinel values (if the returned value is <code>null</code>, then it’s an error)</p>&#13;
</li>&#13;
<li>&#13;
<p>Returning potential error by argument</p>&#13;
</li>&#13;
<li>&#13;
<p>Custom error classes</p>&#13;
</li>&#13;
<li>&#13;
<p>Monads<sup><a data-type="noteref" href="ch02.html#idm45606842664160" id="idm45606842664160-marker">14</a></sup></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Each option has its pros and cons, but just the fact that there are so many ways of handling errors can cause severe issues. It causes surprises by potentially hiding that some statements can return an error, introduces complexity and, as a result, makes our software unreliable.</p>&#13;
&#13;
<p>Undoubtedly, the intention for so many options was good. It gives a developer choices. Maybe the software you create is noncritical, or is the first iteration, so you want to make a “happy path” crystal clear. In such cases, masking some “bad paths” sounds like a good short-term idea, right? Unfortunately, as with many shortcuts, it poses numerous dangers. Software complexity and demand for functionalities cause the code to never go out of the “first iteration,” and noncritical code quickly becomes a dependency for something critical. This is one of the most important causes of unreliability or hard-to-debug software.</p>&#13;
&#13;
<p>Go takes a unique path by treating the error as a first-citizen language feature. It assumes we want to write reliable software, making error handling explicit, easy, and uniform across libraries and interfaces. Let’s see some examples in <a data-type="xref" href="#code-errors">Example 2-4</a>.</p>&#13;
<div data-type="example" id="code-errors">&#13;
<h5><span class="label">Example 2-4. </span>Multiple function signatures with different return arguments</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code class="w"> </code><code class="nx">noErrCanHappen</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO3-1" id="co_efficient_introduction_to_go_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
   </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">return</code><code class="w"> </code><code class="mi">204</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">doOrErr</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO3-2" id="co_efficient_introduction_to_go_CO3-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
   </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">if</code><code class="w"> </code><code class="nx">shouldFail</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"ups, XYZ failed"</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">intOrErr</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO3-3" id="co_efficient_introduction_to_go_CO3-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
   </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">if</code><code class="w"> </code><code class="nx">shouldFail</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"ups, XYZ2 failed"</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">return</code><code class="w"> </code><code class="nx">noErrCanHappen</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO3-1" id="callout_efficient_introduction_to_go_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The critical aspect here is that functions and methods define the error flow as part of their signature. In this case, the <code>noErrCanHappen</code> function states that there is no way any error can happen during its invocation.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO3-2" id="callout_efficient_introduction_to_go_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>By looking at the <code>doOrErr</code> function signature, we know some errors can happen. We don’t know what type of error yet; we only know it is implementing a built-in <code>error</code> interface. We also know that there was no error if the error is nil.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO3-3" id="callout_efficient_introduction_to_go_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The fact that Go functions can return multiple arguments is leveraged when calculating some result in a “happy path.” If the error can happen, it should be the last return argument (always). From the caller side, we should only touch the result if the error is nil.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p><a data-primary="panics (exception mechanism)" data-type="indexterm" id="idm45606839309712"/>It’s worth noting that Go has an exception mechanism called <code>panics</code>, which are recoverable using the <code>recover()</code> built-in function. While useful or necessary for certain cases (e.g., initialization), you should never use <code>panics</code> for conventional error handling in your production code in practice. They are less efficient, hide failures, and overall surprise the programmers. Having errors as part of invocation allows the compilator and programmer to be prepared for error cases in the normal execution path. <a data-type="xref" href="#code-handling">Example 2-5</a> shows how we can handle errors if they occur in our function execution path.</p>&#13;
<div data-type="example" id="code-handling">&#13;
<h5><span class="label">Example 2-5. </span>Checking and handling errors</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">import</code><code class="w"> </code><code class="s">"github.com/efficientgo/core/errors"</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO4-1" id="co_efficient_introduction_to_go_CO4-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">ret</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">noErrCanHappen</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">nestedDoOrErr</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO4-2" id="co_efficient_introduction_to_go_CO4-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
      </code><code class="c1">// handle error</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">ret2</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">intOrErr</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="c1">// handle error</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">nestedDoOrErr</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">doOrErr</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">Wrap</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"do"</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO4-3" id="co_efficient_introduction_to_go_CO4-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
   </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO4-1" id="callout_efficient_introduction_to_go_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Notice that we did not import the built-in <code>errors</code> package, but instead used the open source drop-in replacement <code>github.com/efficientgo/core/errors</code>. <code>core</code> module. This is my recommended replacement for the <code>errors</code> package and the popular, but archived, <code>github.com/pkg/errors</code>. It allows a bit more advanced logic, like wrapping errors you will see in step three.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO4-2" id="callout_efficient_introduction_to_go_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>To tell if an error happened, we need to check if the <code>err</code> variable is nil or not. Then, if an error occurs, we can follow with error handling. Usually, it means logging it, exiting the program, incrementing metrics, or even explicitly ignoring it.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO4-3" id="callout_efficient_introduction_to_go_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Sometimes, it’s appropriate to delegate error handling to the caller. For example, if the function can fail from many errors, consider wrapping it with a <code>errors.Wrap</code> function to add a short context of what is wrong. For example, with <code>github.com/efficientgo/core/errors</code>, we will have context and stack trace, which will be rendered if <code>%+v</code> is used later.</p></dd>&#13;
</dl></div>&#13;
<div data-type="note" epub:type="note"><h1>How to Wrap Errors?</h1>&#13;
<p><a data-primary="error handling" data-secondary="wrapping errors" data-type="indexterm" id="idm45606839060960"/>Notice that I recommended <code>errors.Wrap</code> (or <code>errors.Wrapf</code>) instead of the built-in way of wrapping errors. Go defines the <code>%w</code> identifier for the <code>fmt.Errors</code> type of function that allows passing an error. Currently, I would not recommend <code>%w</code> because it’s not type safe and as explicit as <code>Wrap</code>, causing nontrivial bugs in the past.</p>&#13;
</div>&#13;
&#13;
<p>The one way of defining errors and handling them is one of Go’s best features. Interestingly, it is one of the language disadvantages due to verbosity and certain boilerplate involved. It sometimes might feel repetitive, but tools allow you to mitigate the boilerplate.</p>&#13;
<div data-type="tip">&#13;
<p>Some Go IDEs define code templates. For example, in JetBrain’s GoLand product, typing <strong><code>err</code></strong> and pressing the Tab key will generate a valid <code>if err != nil</code> statement. You can also collapse or expand error handling blocks for readability.</p>&#13;
</div>&#13;
&#13;
<p>Another common complaint is that writing Go can feel very “pessimistic,” because the errors that may never occur are visible in plain sight. The programmer has to decide what to do with them at every step, which takes mental energy and time. Yet, in my experience it’s worth the work and makes programs much more predictable and easier to debug.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Never Ignore Errors!</h1>&#13;
<p><a data-primary="error handling" data-secondary="importance of not ignoring" data-type="indexterm" id="idm45606839053008"/>Due to the verbosity of error handling, it’s tempting to skip &#13;
<span class="keep-together"><code>err != nil</code></span> checks. Consider not doing it unless you know a function will never return an error (and in future versions!). If you don’t know what to do with the error, consider passing it to the caller by default. If you must ignore the error, consider doing it explicitly with the <code>_ =</code> syntax. Also, always use linters, which will warn you about some portion of unchecked errors.</p>&#13;
</div>&#13;
&#13;
<p>Are there any implications of the error handling for general Go code runtime efficiency? Yes! Unfortunately, it’s much more significant than developers usually anticipate. In my experience, error paths are frequently an order of magnitude slower and more expensive to execute than happy paths. One of the reasons is we tend not to ignore error flows during our monitoring or benchmarking steps (mentioned in <a data-type="xref" href="ch03.html#ch-conq-eff-flow">“Efficiency-Aware Development Flow”</a>).</p>&#13;
&#13;
<p>Another common reason is that the construction of errors often involves heavy string manipulation for creating human-readable messages. As a result, it can be costly, especially with lengthy debugging tags, which are touched on later in this book. Understanding these implications and ensuring consistent and efficient error handling are essential in any software, and we will take a detailed look at that in the following chapters.<a data-startref="ix_ch02-asciidoc6" data-type="indexterm" id="idm45606839048864"/><a data-startref="ix_ch02-asciidoc5" data-type="indexterm" id="idm45606839048256"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strong Ecosystem" data-type="sect2"><div class="sect2" id="idm45606842678432">&#13;
<h2>Strong Ecosystem</h2>&#13;
&#13;
<p><a data-primary="ecosystem, Go" data-type="indexterm" id="idm45606839046400"/><a data-primary="Go (generally)" data-secondary="ecosystem" data-type="indexterm" id="idm45606839045792"/>A commonly stated strong point of Go is that its ecosystem is exceptionally mature for such a “young” language. While items listed in this section are not mandatory for solid programming dialects, they improve the whole development experience. This is also why the Go community is so large and still growing.</p>&#13;
&#13;
<p>First, Go allows the programmer to focus on business logic without necessarily reimplementing or importing third-party libraries for basic functionalities like YAML decoding or cryptographic hashing algorithms. Go standard libraries are high quality, robust, ultra-backward compatible, and rich in features. They are well benchmarked, have solid APIs, and have good documentation. As a result, you can achieve most things without importing external packages. For example, running an HTTP server is dead simple, as visualized in <a data-type="xref" href="#code-basicserver">Example 2-6</a>.</p>&#13;
<div data-type="example" id="code-basicserver">&#13;
<h5><span class="label">Example 2-6. </span>Minimal code for serving HTTP requests<sup><a data-type="noteref" href="ch02.html#idm45606839042576" id="idm45606839042576-marker">15</a></sup></h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>&#13;
&#13;
<code class="kn">import</code><code class="w">  </code><code class="s">"net/http"</code><code class="w"/>&#13;
&#13;
<code class="kd">func</code><code class="w"> </code><code class="nx">handle</code><code class="p">(</code><code class="nx">w</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code><code class="w"> </code><code class="nx">_</code><code class="w"> </code><code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">   </code><code class="nx">w</code><code class="p">.</code><code class="nx">Write</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"It kind of works!"</code><code class="p">))</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">   </code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8080"</code><code class="p">,</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="nx">handle</code><code class="p">))</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre></div>&#13;
&#13;
<p>In most cases, the efficiency of standard libraries is good enough or even better than third-party alternatives. For example, especially lower-level elements of packages, <code>net/http</code> for HTTP client and server code, or <code>crypto</code>, <code>math</code>, and <code>sort</code> parts (and more!), have a good amount of optimizations to serve most of the use cases. This allows developers to build more complex code on top while not worrying about the basics like <code>sorting</code> performance. Yet that’s not always the case. Some libraries are meant for specific usage, and misusing them may result in significant resource waste. We will look at all the things you need to be aware of in <a data-type="xref" href="ch11.html#ch-opt2">Chapter 11</a>.</p>&#13;
&#13;
<p><a data-primary="Go Playground" data-type="indexterm" id="idm45606839003904"/>Another highlight of the mature ecosystem is a basic, official in-browser Go editor called <a href="https://oreil.ly/9Os3y">Go Playground</a>. It’s a fantastic tool if you want to test something out quickly or share an interactive code example. It’s also straightforward to extend, so the community often publishes variations of the Go Playground to try and share previously experimental language features like <a href="https://oreil.ly/f0qpm">generics</a> (which are now part of the primary language and explained in <a data-type="xref" href="#ch-go-generics">“Generics”</a>).</p>&#13;
&#13;
<p><a data-primary="Go templates" data-type="indexterm" id="idm45606838940560"/>Last but not least, the Go project defines its templating language, called <a href="https://oreil.ly/FdEZ8">Go templates</a>. In some way, it’s similar to Python’s <a href="https://oreil.ly/U6Em1">Jinja2 language</a>. While it sounds like a side feature of Go, it’s beneficial in any dynamic text or HTML generation. It is also often used in popular tools like <a href="https://helm.sh">Helm</a> or <a href="https://gohugo.io">Hugo</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unused Import or Variable Causes Build Error" data-type="sect2"><div class="sect2" id="idm45606838937152">&#13;
<h2>Unused Import or Variable Causes Build Error</h2>&#13;
&#13;
<p><a data-primary="build errors due to unused import/variable" data-type="indexterm" id="idm45606838935904"/><a data-primary="errors due to unused import/variable" data-type="indexterm" id="idm45606838935296"/><a data-primary="Go (generally)" data-secondary="unused import/variable as cause of build error" data-type="indexterm" id="idm45606838934688"/><a data-primary="import statement" data-type="indexterm" id="idm45606838933840"/><a data-primary="variables" data-secondary="build errors from unused variable" data-type="indexterm" id="idm45606838933232"/>The compilation will fail if you define a variable in Go but never read any value from it or don’t pass it to another function. Similarly, it will fail if you added a package to the <code>import</code> statement but don’t use that package in your file.</p>&#13;
&#13;
<p>I see that Go developers have gotten used to this feature and love it, but it is surprising for newcomers. Failing on unused constructs can be frustrating if you want to play with the language quickly, e.g., create some variable without using it for debugging purposes.</p>&#13;
&#13;
<p>There are, however, ways to handle these cases explicitly! You can see a few examples of dealing with these usage checks in <a data-type="xref" href="#code-unused">Example 2-7</a>.</p>&#13;
<div data-type="example" id="code-unused">&#13;
<h5><span class="label">Example 2-7. </span>Various examples of unused and used variables</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">use</code><code class="p">(</code><code class="nx">_</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">   </code><code class="kd">var</code><code class="w"> </code><code class="nx">a</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="c1">// error: a declared but not used </code><a class="co" href="#callout_efficient_introduction_to_go_CO5-1" id="co_efficient_introduction_to_go_CO5-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">b</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="c1">// error: b declared but not used </code><a class="co" href="#callout_efficient_introduction_to_go_CO5-1" id="co_efficient_introduction_to_go_CO5-2"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">   </code><code class="kd">var</code><code class="w"> </code><code class="nx">c</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">c</code><code class="w"> </code><code class="c1">// error: d declared but not used </code><a class="co" href="#callout_efficient_introduction_to_go_CO5-1" id="co_efficient_introduction_to_go_CO5-3"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">e</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">1</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">use</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO5-2" id="co_efficient_introduction_to_go_CO5-4"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
&#13;
   </code><code class="nx">f</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">1</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">_</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">f</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO5-3" id="co_efficient_introduction_to_go_CO5-5"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO5-1" id="callout_efficient_introduction_to_go_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Variables <code>a</code>, <code>b</code>, and  <code>c</code> are not used, so they cause a compilation error.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO5-4" id="callout_efficient_introduction_to_go_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Variable <code>e</code> is used.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO5-5" id="callout_efficient_introduction_to_go_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Variable <code>f</code> is technically used for an explicit no identifier (<code>_</code>). Such an approach is useful if you explicitly want to tell the reader (and compiler) that you want to ignore the value.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Similarly, unused imports will fail the compilation process, so tools like <code>goimports</code> (mentioned in <a data-type="xref" href="#ch-go-tooling">“Consistent Tooling”</a>) automatically remove unused ones. Failing on unused variables and imports effectively ensures that code stays clear and relevant. Note that only internal function variables are checked. Elements like unused <code>struct</code> fields, methods, or types are not checked.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unit Testing and Table Tests" data-type="sect2"><div class="sect2" id="idm45606838783984">&#13;
<h2>Unit Testing and Table Tests</h2>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="unit testing/table tests" data-type="indexterm" id="idm45606838782736"/><a data-primary="table tests" data-type="indexterm" id="idm45606838781664"/><a data-primary="testing" data-secondary="unit testing/table tests" data-type="indexterm" id="idm45606838781056"/><a data-primary="unit testing" data-type="indexterm" id="idm45606838780208"/>Tests are a mandatory part of every application, small or big. In Go, tests are a natural part of the development process—easy to write, and focused on simplicity and readability. If we want to talk about efficient code, we need to have solid testing in place, allowing us to iterate over the program without worrying about regressions. Add a file with the <em>_test.go</em> suffix to introduce a unit test to your code within a package. You can write any Go code within that file, which won’t be reachable from the production code. There are, however, four types of functions you can add that will be invoked for different testing parts. A certain signature distinguishes these types, notably function name prefixes: <code>Test</code>, <code>Fuzz</code>, <code>Example</code>, or <code>Benchmark</code>, and specific arguments.</p>&#13;
&#13;
<p>Let’s walk through the unit test type in <a data-type="xref" href="#code-test">Example 2-8</a>. To make it more interesting, it’s a table test. Examples and benchmarks are explained in <a data-type="xref" href="#ch-go-godoc">“Code Documentation as a First Citizen”</a> and <a data-type="xref" href="ch08.html#ch-obs-micro">“Microbenchmarks”</a>.</p>&#13;
<div data-type="example" id="code-test">&#13;
<h5><span class="label">Example 2-8. </span>Example unit table test</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">max</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"math"</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"testing"</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">   </code><code class="s">"github.com/efficientgo/core/testutil"</code><code class="w">&#13;
</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">TestMax</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO6-1" id="co_efficient_introduction_to_go_CO6-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
   </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">tcase</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO6-2" id="co_efficient_introduction_to_go_CO6-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
      </code><code class="nx">a</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="w">     </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">      </code><code class="nx">expected</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">      </code><code class="p">{</code><code class="nx">a</code><code class="p">:</code><code class="w"> </code><code class="nx">math</code><code class="p">.</code><code class="nx">MinInt64</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">:</code><code class="w"> </code><code class="nx">math</code><code class="p">.</code><code class="nx">MaxInt64</code><code class="p">,</code><code class="w"> </code><code class="nx">expected</code><code class="p">:</code><code class="w"> </code><code class="nx">math</code><code class="p">.</code><code class="nx">MaxInt64</code><code class="p">}</code><code class="p">,</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">      </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="s">""</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO6-3" id="co_efficient_introduction_to_go_CO6-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
         </code><code class="nx">testutil</code><code class="p">.</code><code class="nx">Equals</code><code class="p">(</code><code class="nx">t</code><code class="p">,</code><code class="w"> </code><code class="nx">tcase</code><code class="p">.</code><code class="nx">expected</code><code class="p">,</code><code class="w"> </code><code class="nx">max</code><code class="p">(</code><code class="nx">tcase</code><code class="p">.</code><code class="nx">a</code><code class="p">,</code><code class="w"> </code><code class="nx">tcase</code><code class="p">.</code><code class="nx">b</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO6-4" id="co_efficient_introduction_to_go_CO6-4"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
      </code><code class="p">}</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">   </code><code class="p">}</code><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO6-1" id="callout_efficient_introduction_to_go_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>If the function inside the <em>_test.go</em> file is named with the <code>Test</code> word and takes exactly <code>t *testing.T</code>, it is considered a “unit test.” You can run them through the <code>go test</code> command.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO6-2" id="callout_efficient_introduction_to_go_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Usually, we want to test a specific function using multiple test cases (often edge cases) that define different input and expected output. This is where I would suggest using table tests. First, define your input and output, then run the same function in an easy-to-read loop.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO6-3" id="callout_efficient_introduction_to_go_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Optionally, you can invoke <code>t.Run</code>, which allows you to specify a subtest. Defining those on dynamic test cases like table tests is a good practice. It will enable you to navigate to the failing case quickly.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO6-4" id="callout_efficient_introduction_to_go_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The Go <code>testing.T</code> type gives useful methods like <code>Fail</code> or <code>Fatal</code> to abort and fail the unit test, or <code>Error</code> to continue running and check other potential errors. In our example, I propose using a simple helper called <code>testutil.Equals</code> from our <a href="https://oreil.ly/yAit9">open source core library</a>, giving you a nice diff.<sup><a data-type="noteref" href="ch02.html#idm45606838437664" id="idm45606838437664-marker">16</a></sup></p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Write tests often. It might surprise you, but writing unit tests for critical parts up front will help you implement desired features much faster. This is why I recommend following some reasonable form of test-driven development, covered in <a data-type="xref" href="ch03.html#ch-conq-eff-flow">“Efficiency-Aware Development Flow”</a>.<a data-startref="ix_ch02-asciidoc1" data-type="indexterm" id="idm45606838434768"/></p>&#13;
&#13;
<p>This information should give you a good overview of the language goals, strengths, and features before moving to more advanced features.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Advanced Language Elements" data-type="sect1"><div class="sect1" id="ch-go-adv">&#13;
<h1>Advanced Language Elements</h1>&#13;
&#13;
<p><a data-primary="Go advanced features" data-type="indexterm" id="ix_ch02-asciidoc7"/><a data-primary="Go (generally)" data-secondary="advanced language elements" data-type="indexterm" id="ix_ch02-asciidoc8"/>Let’s now discuss the more advanced features of Go. Similar to the basics mentioned in the previous section, it’s crucial to overview core language capabilities before discussing efficiency improvements.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Code Documentation as a First Citizen" data-type="sect2"><div class="sect2" id="ch-go-godoc">&#13;
<h2>Code Documentation as a First Citizen</h2>&#13;
&#13;
<p><a data-primary="Go advanced features" data-secondary="code documentation as first citizen" data-type="indexterm" id="ix_ch02-asciidoc9"/><a data-primary="documentation, as first citizen" data-type="indexterm" id="ix_ch02-asciidoc10"/><a data-primary="Go (generally)" data-secondary="code documentation as first citizen" data-type="indexterm" id="ix_ch02-asciidoc11"/><a data-primary="godoc tool" data-type="indexterm" id="ix_ch02-asciidoc12"/>Every project, at some point, needs solid API documentation. For library-type projects, the programmatic APIs are the main entry point. Robust interfaces with good descriptions allow developers to hide complexity, bring value, and avoid surprises. A code interface overview is essential for applications, too, allowing anyone to understand the codebase quickly. Reusing an application’s Go packages in other projects is also not uncommon.</p>&#13;
&#13;
<p>Instead of relying on the community to create many potentially fragmented and incompatible solutions, the Go project developed a tool called <a href="https://oreil.ly/TQXxv"><code>godoc</code></a> from the start. It behaves similarly to Python’s <a href="https://oreil.ly/UdkzS">Docstring</a> and Java’s <a href="https://oreil.ly/wlWGT">Javadoc</a>. <code>godoc</code> generates a consistent documentation HTML website directly from the code and its comments.</p>&#13;
&#13;
<p>The amazing part is that you don’t have many special conventions that would directly make the code comments less readable from the source code. To use this tool effectively, you need to remember five things. Let’s go through them using Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#code-godoc">2-9</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#code-godoc2">2-10</a>. The resulting HTML page, when <a href="https://oreil.ly/EYJlx"><code>godoc</code> is invoked</a>, can be seen in <a data-type="xref" href="#img-godoc">Figure 2-1</a>.</p>&#13;
<div data-type="example" id="code-godoc">&#13;
<h5><span class="label">Example 2-9. </span>Example snippet of block.go file with <code>godoc</code> compatible documentation</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Package block contains common functionality for interacting with TSDB blocks</code><code class="w">&#13;
</code><code class="c1">// in the context of Thanos.</code><code class="w">&#13;
</code><code class="kn">package</code><code class="w"> </code><code class="nx">block</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO7-1" id="co_efficient_introduction_to_go_CO7-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
&#13;
</code><code class="kn">import</code><code class="w"> </code><code class="o">...</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">const</code><code class="w"> </code><code class="p">(</code><code class="w">&#13;
</code><code class="w">   </code><code class="c1">// MetaFilename is the known JSON filename for meta information.  </code><a class="co" href="#callout_efficient_introduction_to_go_CO7-2" id="co_efficient_introduction_to_go_CO7-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">   </code><code class="nx">MetaFilename</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s">"meta.json"</code><code class="w">&#13;
</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="c1">// Download the downloads directory...  </code><a class="co" href="#callout_efficient_introduction_to_go_CO7-2" id="co_efficient_introduction_to_go_CO7-3"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="c1">// BUG(bwplotka): No known bugs, but if there was one, it would be outlined here. </code><a class="co" href="#callout_efficient_introduction_to_go_CO7-3" id="co_efficient_introduction_to_go_CO7-4"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">Download</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">id</code><code class="w"> </code><code class="nx">ulid</code><code class="p">.</code><code class="nx">ULID</code><code class="p">,</code><code class="w"> </code><code class="nx">dst</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="c1">// cleanUp cleans the partially uploaded files. </code><a class="co" href="#callout_efficient_introduction_to_go_CO7-4" id="co_efficient_introduction_to_go_CO7-5"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">cleanUp</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">id</code><code class="w"> </code><code class="nx">ulid</code><code class="p">.</code><code class="nx">ULID</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="c1">// ...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO7-1" id="callout_efficient_introduction_to_go_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Rule 1: The optional package-level description must be placed on top of the <code>package</code> entry with no intervening blank line and start with the <code>Package &lt;name&gt;</code> prefix. If any source files have these entries, <code>godoc</code> will collect them all. If you have many files, the convention is to have the <em>doc.go</em> file with just the package-level documentation, package statement, and no other code.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO7-2" id="callout_efficient_introduction_to_go_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Rule 2: Any public construct should have a full sentence commentary, starting with the name of the construct (it’s important!), right before its definition.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO7-4" id="callout_efficient_introduction_to_go_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Rule 3: Known bugs can be mentioned with <code>// BUG(who)</code> statements.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO7-5" id="callout_efficient_introduction_to_go_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Private constructs can have comments, but they will never be exposed in the documentation since they are private. Be consistent and start them with a construct name, too, for readability.</p></dd>&#13;
</dl></div>&#13;
<div data-type="example" id="code-godoc2">&#13;
<h5><span class="label">Example 2-10. </span>Example snippet of block_test.go file with <code>godoc</code> compatible documentation</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nx">block_test</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kn">import</code><code class="w"> </code><code class="o">...</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">ExampleDownload</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO8-1" id="co_efficient_introduction_to_go_CO8-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
    </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="w">    </code><code class="c1">// Output: ... </code><a class="co" href="#callout_efficient_introduction_to_go_CO8-2" id="co_efficient_introduction_to_go_CO8-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO8-1" id="callout_efficient_introduction_to_go_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Rule 4: If you write a function named <code>Example&lt;ConstructName&gt;</code> in the test file, e.g., <code>block_test.go</code>, the <code>godoc</code> will generate an interactive code block with the desired examples. Note that the package name must have a <em>_test</em> suffix, too, representing a local testing package that tests the package without access to private fields. Since examples are part of the unit test, they will be actively run and &#13;
<span class="keep-together">compiled.</span></p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO8-2" id="callout_efficient_introduction_to_go_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Rule 5: If the example has the last comment starting with <code>// Output:</code>, the string after it will be asserted with the standard output after the example, allowing the example to stay reliable.</p></dd>&#13;
</dl></div>&#13;
&#13;
<figure><div class="figure" id="img-godoc">&#13;
<img alt="efgo 0201" src="assets/efgo_0201.png"/>&#13;
<h6><span class="label">Figure 2-1. </span><code>godoc</code> output of Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#code-godoc">2-9</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#code-godoc2">2-10</a></h6>&#13;
</div></figure>&#13;
&#13;
<p>I highly recommend sticking to those five simple rules. Not only because you can manually run <code>godoc</code> and generate your documentation web page, but the additional benefit is that these rules make your Go code comments structured and consistent. Everyone knows how to read them and where to find them.</p>&#13;
<div data-type="tip">&#13;
<p>I recommend using complete English sentences in all comments, even if the will not appear in <code>godoc</code>. It will help you keep your code commentary self-explanatory and explicit. After all, comments are for humans to read.</p>&#13;
</div>&#13;
&#13;
<p>Furthermore, the Go team maintains a <a href="https://pkg.go.dev">public documentation website</a> that scrapes all requested public repositories for free. Thus, if your public code repository is compatible with <code>godoc</code>, it will be rendered correctly, and users can read the autogenerated documentation for every module or package version.<a data-startref="ix_ch02-asciidoc12" data-type="indexterm" id="idm45606838202416"/><a data-startref="ix_ch02-asciidoc11" data-type="indexterm" id="idm45606838201712"/><a data-startref="ix_ch02-asciidoc10" data-type="indexterm" id="idm45606838201040"/><a data-startref="ix_ch02-asciidoc9" data-type="indexterm" id="idm45606838200368"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Backward Compatibility and Portability" data-type="sect2"><div class="sect2" id="idm45606838428864">&#13;
<h2>Backward Compatibility and Portability</h2>&#13;
&#13;
<p><a data-primary="Go advanced features" data-secondary="backward compatibility and portability" data-type="indexterm" id="idm45606838198448"/><a data-primary="backward compatibility" data-type="indexterm" id="idm45606838197472"/><a data-primary="Go (generally)" data-secondary="backward compatibility and portability" data-type="indexterm" id="idm45606838196800"/>Go has a strong take on backward compatibility guarantees. This means that core APIs, libraries, and language specifications should never break old code created for <a href="https://oreil.ly/YOKfu">Go 1.0</a>. This was proven to be well executed. There is a lot of trust in upgrading Go to the latest minor or patch versions. Upgrades are, in most cases, smooth and without significant bugs and surprises.</p>&#13;
&#13;
<p>Regarding efficiency compatibility, it’s hard to discuss any guarantees. There is (usually) no guarantee that the function that does two memory allocations now will not use hundreds in the next version of the Go project and any library. There have been surprises between versions in  efficiency and speed characteristics. The community is working hard on improving the compilation and language runtime (more in <a data-type="xref" href="#ch-go-runtime">“Go Runtime”</a> and <a data-type="xref" href="ch04.html#ch-hardware">Chapter 4</a>). Since the hardware and operating systems are also developed, the Go team is experimenting with different optimizations and features to allow everyone to execute more efficiently. Of course, we don’t speak about major performance regression here, as that is usually noticed and fixed in the release candidate period. Yet if we want our software to be deliberately fast and efficient, we need to be more vigilant and aware of the changes Go introduces.</p>&#13;
&#13;
<p>Source code is compiled into binary code that is targeted to each platform. Yet Go tooling allows cross-platform compilation, so you can build binaries to almost all architectures and operating systems.</p>&#13;
<div data-type="tip">&#13;
<p>When you execute the Go binary, which was compiled for a different operating system (OS) or architecture, it can return cryptic error messages. For example, a common error is an Exec format error when you try running binary for Darwin (macOS) on Linux. You must recompile the code source for the correct architecture and OS if you see this.</p>&#13;
</div>&#13;
&#13;
<p>Regarding portability, we can’t skip mentioning the Go runtime and its &#13;
<span class="keep-together">characteristics.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Go Runtime" data-type="sect2"><div class="sect2" id="ch-go-runtime">&#13;
<h2>Go Runtime</h2>&#13;
&#13;
<p><a data-primary="Go advanced features" data-secondary="Go runtime" data-type="indexterm" id="idm45606838188048"/><a data-primary="Go (generally)" data-secondary="Go runtime" data-type="indexterm" id="idm45606838186848"/>Many languages decided to solve portability across different hardware and operating systems by using virtual machines. Typical examples are <a href="https://oreil.ly/fhOmL">Java Virtual Machine (JVM)</a> for Java bytecode compatible languages (e.g., Java or Scala), and <a href="https://oreil.ly/StGbU">Common Language Runtime (CLR)</a> for .NET code, e.g., C#. Such a virtual machine allows for building languages without worrying about complex memory management logic (allocation and releasing), differences between hardware and operating systems, etc. JVM or CLR interprets the intermediate bytecode and transfers program instructions to the host. Unfortunately, while making it easier to create a programming language, they also introduce some overhead and many unknowns.<sup><a data-type="noteref" href="ch02.html#idm45606838184304" id="idm45606838184304-marker">17</a></sup> To mitigate the overhead, virtual machines often use complex optimizations like <a href="https://oreil.ly/XXARz">just-in-time (JIT) compilation</a> to process chunks of specific virtual machine bytecode to machine code on the fly.</p>&#13;
&#13;
<p>Go does not need any  “virtual machine.” Our code and used libraries compile fully to machine code during compilation time. Thanks to standard library support of large operating systems and hardware, our code, if compiled against particular architecture, will run there with no issues.</p>&#13;
&#13;
<p>Yet something is running in the background (concurrently) when our program starts. It’s the <a href="https://oreil.ly/mywcZ">Go runtime</a> logic that, among other minor features of Go, is responsible for memory and concurrency management.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Object-Oriented Programming" data-type="sect2"><div class="sect2" id="idm45606838180592">&#13;
<h2>Object-Oriented Programming</h2>&#13;
&#13;
<p><a data-primary="Go advanced features" data-secondary="object-oriented programming" data-type="indexterm" id="ix_ch02-asciidoc13"/><a data-primary="Go (generally)" data-secondary="object-oriented programming" data-type="indexterm" id="ix_ch02-asciidoc14"/><a data-primary="object-oriented programming (OOP)" data-type="indexterm" id="ix_ch02-asciidoc15"/><a data-primary="OOP (object-oriented programming)" data-type="indexterm" id="ix_ch02-asciidoc16"/>Undoubtedly, object-oriented programming (OOP) got enormous traction over the last decades. It was invented around 1967 by Alan Kay, and it’s still the most popular paradigm in programming.<sup><a data-type="noteref" href="ch02.html#idm45606838174512" id="idm45606838174512-marker">18</a></sup> OOP allows us to leverage advanced concepts like <a href="https://oreil.ly/8hA0u">encapsulation, abstraction, polymorphisms, and inheritance</a>. In principle, it allows us to think about code as some objects with attributes (in Go fields) and behaviors (methods) telling each other what to do. Most OOP examples talk about high-level abstractions like an animal that exposes the <code>Walk()</code> method or a car that allows to <code>Ride()</code>, but in practice, objects are usually less abstract yet still helpful, encapsulated, and described by a class. There are no classes in Go, but there are <code>struct</code> types equivalents. <a data-type="xref" href="#code-oop">Example 2-11</a> shows how we can write OOP code in Go to compact multiple block objects into one.</p>&#13;
<div data-type="example" id="code-oop">&#13;
<h5><span class="label">Example 2-11. </span>Example of the OOP in Go with <code>Group</code> that can behave like <code>Block</code></h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code class="w"> </code><code class="nx">Block</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-1" id="co_efficient_introduction_to_go_CO9-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
    </code><code class="nx">id</code><code class="w">         </code><code class="nx">uuid</code><code class="p">.</code><code class="nx">UUID</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">start</code><code class="p">,</code><code class="w"> </code><code class="nx">end</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Time</code><code class="w">&#13;
</code><code class="w">    </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="nx">Block</code><code class="p">)</code><code class="w"> </code><code class="nx">Duration</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-1" id="co_efficient_introduction_to_go_CO9-2"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
    </code><code class="k">return</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">end</code><code class="p">.</code><code class="nx">Sub</code><code class="p">(</code><code class="nx">b</code><code class="p">.</code><code class="nx">start</code><code class="p">)</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">Group</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">Block</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-2" id="co_efficient_introduction_to_go_CO9-3"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
&#13;
    </code><code class="nx">children</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">uuid</code><code class="p">.</code><code class="nx">UUID</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">g</code><code class="w"> </code><code class="o">*</code><code class="nx">Group</code><code class="p">)</code><code class="w"> </code><code class="nx">Merge</code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="nx">Block</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-3" id="co_efficient_introduction_to_go_CO9-4"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
    </code><code class="k">if</code><code class="w"> </code><code class="nx">g</code><code class="p">.</code><code class="nx">end</code><code class="p">.</code><code class="nx">IsZero</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nx">g</code><code class="p">.</code><code class="nx">end</code><code class="p">.</code><code class="nx">Before</code><code class="p">(</code><code class="nx">b</code><code class="p">.</code><code class="nx">end</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">        </code><code class="nx">g</code><code class="p">.</code><code class="nx">end</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">end</code><code class="w">&#13;
</code><code class="w">    </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">g</code><code class="p">.</code><code class="nx">start</code><code class="p">.</code><code class="nx">IsZero</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nx">g</code><code class="p">.</code><code class="nx">start</code><code class="p">.</code><code class="nx">After</code><code class="p">(</code><code class="nx">b</code><code class="p">.</code><code class="nx">start</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">        </code><code class="nx">g</code><code class="p">.</code><code class="nx">start</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">start</code><code class="w">&#13;
</code><code class="w">    </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">g</code><code class="p">.</code><code class="nx">children</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nb">append</code><code class="p">(</code><code class="nx">g</code><code class="p">.</code><code class="nx">children</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">Compact</code><code class="p">(</code><code class="nx">blocks</code><code class="w"> </code><code class="o">...</code><code class="nx">Block</code><code class="p">)</code><code class="w"> </code><code class="nx">Block</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Sort</code><code class="p">(</code><code class="nx">sortable</code><code class="p">(</code><code class="nx">blocks</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-4" id="co_efficient_introduction_to_go_CO9-5"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
&#13;
    </code><code class="nx">g</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">Group</code><code class="p">{</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">g</code><code class="p">.</code><code class="nx">id</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">uuid</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">blocks</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">        </code><code class="nx">g</code><code class="p">.</code><code class="nx">Merge</code><code class="p">(</code><code class="nx">b</code><code class="p">)</code><code class="w">&#13;
</code><code class="w">    </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">g</code><code class="p">.</code><code class="nx">Block</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO9-5" id="co_efficient_introduction_to_go_CO9-6"><img alt="5" src="assets/5.png"/></a><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO9-1" id="callout_efficient_introduction_to_go_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><a data-primary="structures, as class equivalent" data-type="indexterm" id="idm45606837846128"/>In Go, there is no separation between structures and classes, like in C++. In Go, on top of basic types like <code>integer</code>, <code>string</code>, etc., there is a <code>struct</code> type that can have methods (behaviors) and fields (attributes). We can use structures as a <code>class</code> equivalent to <em>encapsulate</em> more complex logic under a more straightforward interface. For example, the <code>Duration()</code> method on <code>Block</code> tells us the duration of the time range covered by the block.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO9-3" id="callout_efficient_introduction_to_go_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>If we add some struct, e.g., <code>Block</code>, into another struct, e.g., <code>Group</code>, without any name, such a <code>Block</code> <code>struct</code> is considered embedded instead of being a field. <a data-primary="inheritance" data-type="indexterm" id="idm45606837874288"/>Embedding allows Go developers to get the most valuable part of <em>inheritance</em>, borrowing the embedded structure fields and methods. In this case, <code>Group</code> will have <code>Block</code>’s fields and <code>Duration</code> method. This way, we can reuse a significant amount of code in our production codebases.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO9-4" id="callout_efficient_introduction_to_go_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p><a data-primary="methods, Go" data-type="indexterm" id="idm45606837869520"/><a data-primary="pointer receiver" data-type="indexterm" id="idm45606837868624"/><a data-primary="value receiver" data-type="indexterm" id="idm45606837867952"/>There are two types of methods you can define in Go: using the “value receiver” (e.g., as in the <code>Duration()</code> method) or using the “pointer receiver” (with <code>*</code>). The so-called receiver is the variable after <code>func</code>, which represents the type we are adding a method to, in our case <code>Group</code>. We will mention this in <a data-type="xref" href="ch05.html#ch-hw-allocations">“Values, Pointers, and Memory Blocks”</a>, but the rule regarding which one to use is straightforward:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use the value receiver (no <code>func (g Group) SomeMethod()</code>) if your method does not modify the <code>Group</code> state. For the value receiver, every time we invoke it, the <code>g</code> will create a local copy of the <code>Group</code> object. It is equivalent to <code>func SomeMethod(g Group)</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use the pointer receiver (e.g., <code>func (g *Group) SomeMethod()</code>) if your method is meant to modify the local receiver state or if any other method does that. It is equivalent to <code>func SomeMethod(g *Group)</code>. In our example, if the <code>Group.Merge()</code> method would be a value receiver, we will not persist <code>g.childen</code> changes or potentially inject <code>g.start</code> and <code>g.end</code> values. Additionally, for consistency, it’s always recommended to have a type with all pointer receiver methods if at least one requires a pointer.</p>&#13;
</li>&#13;
</ul></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO9-5" id="callout_efficient_introduction_to_go_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>To compact multiple blocks together, our algorithm requires a sorted list of blocks. We can use the standard library <a href="https://oreil.ly/N6ZWS"><code>sort.Sort</code></a>, which expects the <code>sort.Interface</code> interface. The <code>[]Block</code> slice does not implement this interface, so we convert it to our temporary <code>sortable</code> type, explained in <a data-type="xref" href="#code-oop-sortable">Example 2-13</a>.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO9-6" id="callout_efficient_introduction_to_go_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>This is the only missing element for true inheritance. Go does not allow casting specific types into another type unless it’s an alias or strict single-struct embedding (shown in <a data-type="xref" href="#code-oop-sortable">Example 2-13</a>). After that, you can only cast the interface into some type. That’s why we need to specify embedded <code>struct</code> and <code>Block</code> explicitly. As a result, Go is often considered a language that does not support full &#13;
<span class="keep-together">inheritance.</span></p></dd>&#13;
</dl></div>&#13;
&#13;
<p>What does <a data-type="xref" href="#code-oop">Example 2-11</a> give us? First, the <code>Group</code> type can reuse <code>Block</code> functionality, and if done correctly, we can use <code>Group</code> as any other <code>Block</code>.</p>&#13;
<div data-type="tip"><h1>Embedding Multiple Types</h1>&#13;
<p><a data-primary="types, embedding multiple" data-type="indexterm" id="idm45606837768912"/>You can embed as many unique structures as you want within one <code>struct</code>.</p>&#13;
&#13;
<p>There is no priority for these—the compilation will fail if the compilator can’t tell which method to use because two embedded types have the same <code>SomeMethod()</code> method. In such cases, use the type name to explicitly tell the compilator what should be used.</p>&#13;
</div>&#13;
&#13;
<p>As mentioned in <a data-type="xref" href="#code-oop">Example 2-11</a>, Go also allows defining interfaces that tell what methods <code>struct</code> has to implement to match it. Note that there is no need to mark a specific <code>struct</code> explicitly that implements a particular interface, as in other languages like Java. It’s enough just to implement the required methods. Let’s see an example of sorting interface exposed by the standard library in <a data-type="xref" href="#code-oop-sort">Example 2-12</a>.</p>&#13;
<div data-type="example" id="code-oop-sort">&#13;
<h5><span class="label">Example 2-12. </span>Sorting interface from the standard <code>sort</code> Go library</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// A type, typically a collection, that satisfies sort.Interface can be</code><code class="w"/>&#13;
<code class="c1">// sorted by the routines in this package. The methods require that the</code><code class="w"/>&#13;
<code class="c1">// elements of the collection be enumerated by an integer index.</code><code class="w"/>&#13;
<code class="kd">type</code><code class="w"> </code><code class="nx">Interface</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Len is the number of elements in the collection.</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Len</code><code class="p">()</code><code class="w"> </code><code class="kt">int</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Less reports whether the element with</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// index i should sort before the element with index j.</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Less</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">bool</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Swap swaps the elements with indexes i and j.</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Swap</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre></div>&#13;
&#13;
<p>To use our type in the <code>sort.Sort</code> function, it has to implement all <code>sort.Interface</code> methods. <a data-type="xref" href="#code-oop-sortable">Example 2-13</a> shows how <code>sortable</code> type does it.</p>&#13;
<div data-type="example" id="code-oop-sortable">&#13;
<h5><span class="label">Example 2-13. </span>Example of the type that can be sorted using <code>sort.Slice</code></h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code class="w"> </code><code class="nx">sortable</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">Block</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO10-1" id="co_efficient_introduction_to_go_CO10-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">sortable</code><code class="p">)</code><code class="w"> </code><code class="nx">Len</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w">           </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">sortable</code><code class="p">)</code><code class="w"> </code><code class="nx">Less</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">bool</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">.</code><code class="nx">start</code><code class="p">.</code><code class="nx">Before</code><code class="p">(</code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="p">.</code><code class="nx">start</code><code class="p">)</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO10-2" id="co_efficient_introduction_to_go_CO10-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">sortable</code><code class="p">)</code><code class="w"> </code><code class="nx">Swap</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w">      </code><code class="p">{</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">var</code><code class="w"> </code><code class="nx">_</code><code class="w"> </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Interface</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">sortable</code><code class="p">{</code><code class="p">}</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO10-3" id="co_efficient_introduction_to_go_CO10-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO10-1" id="callout_efficient_introduction_to_go_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>We can embed another type (e.g., a slice of <code>Block</code> elements) as the only thing in our <code>sortable</code> struct. This allows easy (but explicit) casting between <code>[]Block</code> and <code>sortable</code>, as we used in the <code>Compact</code> method in <a data-type="xref" href="#code-oop">Example 2-11</a>.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO10-2" id="callout_efficient_introduction_to_go_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>We can sort by increasing the <code>start</code> time using the <a href="https://oreil.ly/GQ2Ru"><code>time.Time.Before(...)</code></a> method.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO10-3" id="callout_efficient_introduction_to_go_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>We can assert our <code>sortable</code> type implements <code>sort.Interface</code> using this single-line statement, which fails compilation otherwise. I recommend using such statements whenever you want to ensure your type stays compatible with a particular interface in the future!</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>To sum up, <code>struct</code> methods, fields, and interfaces are an excellent yet simple way of writing both procedural composable and object-oriented code. In my experience, eventually it satisfies both low-level and high-level programming needs during our software development. While Go does not support all inheritance aspects (type to type casting), it provides enough to satisfy almost all OOP cases.<a data-startref="ix_ch02-asciidoc16" data-type="indexterm" id="idm45606837478064"/><a data-startref="ix_ch02-asciidoc15" data-type="indexterm" id="idm45606837477392"/><a data-startref="ix_ch02-asciidoc14" data-type="indexterm" id="idm45606837476720"/><a data-startref="ix_ch02-asciidoc13" data-type="indexterm" id="idm45606837476048"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generics" data-type="sect2"><div class="sect2" id="ch-go-generics">&#13;
<h2>Generics</h2>&#13;
&#13;
<p><a data-primary="Go advanced features" data-secondary="generics" data-type="indexterm" id="ix_ch02-asciidoc17"/><a data-primary="generics" data-secondary="about" data-type="indexterm" id="ix_ch02-asciidoc18"/><a data-primary="Go (generally)" data-secondary="generics" data-type="indexterm" id="ix_ch02-asciidoc19"/><a data-primary="parametric polymorphism (generics)" data-type="indexterm" id="ix_ch02-asciidoc20"/>Since version 1.18, Go supports <a href="https://oreil.ly/qYyuQ">generics</a>, one of the community’s most desired features. Generics, also called <a href="https://oreil.ly/UIUAg">parametric polymorphism</a>, allow type-safe implementations of the functionalities we want to reuse across different types.</p>&#13;
&#13;
<p>The demand for generics in Go started quite big discussions in the Go team and community because of two main problems:</p>&#13;
<dl>&#13;
<dt>Two ways of doing the same thing</dt>&#13;
<dd>&#13;
<p>From the beginning, Go already supported type-safe reusable code via interfaces. You could see that in the preceding OOP example—the <a href="https://oreil.ly/X2NxR"><code>sort.Sort</code></a> can be reusable by all types that implement a <code>sort.Interface</code> presented in <a data-type="xref" href="#code-oop-sort">Example 2-12</a>. We can sort our custom <code>Block</code> type by implementing those methods in <a data-type="xref" href="#code-oop-sortable">Example 2-13</a>. Adding generics means we have <a href="https://oreil.ly/dL8uE">two ways of doing a thing</a> in many cases.</p>&#13;
&#13;
<p>However, <code>interfaces</code> can be more troublesome for users of our code and slow at times due to <a href="https://oreil.ly/8tSVf">some runtime overhead</a>.</p>&#13;
</dd>&#13;
<dt>Overhead</dt>&#13;
<dd>&#13;
<p>Implementing generics can have many negative consequences for the language. Depending on the implementation, it can impact different things. For example:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>We can just skip implementing them like in C, which slows programmers.</p>&#13;
</li>&#13;
<li>&#13;
<p>We can use <a href="https://oreil.ly/B062N">monomorphization</a>, which essentially copies the code for each type that will be used. This impacts compile time and binary size.</p>&#13;
</li>&#13;
<li>&#13;
<p>We can use boxing like in Java, which is quite similar to the Go interface implementation. In this case, we impact execution time or memory usage.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
<blockquote><p>The generic dilemma is this: do you want slow programmers, slow compilers and bloated binaries, or slow execution times?</p>&#13;
<p data-type="attribution">Russ Cox, <a href="https://oreil.ly/WjjV4">“The Generic Dilemma”</a></p></blockquote>&#13;
&#13;
<p><a data-primary="Cox, Russ" data-secondary="on generics" data-secondary-sortas="generics" data-type="indexterm" id="idm45606837451984"/>After many proposals and debates, the final (extremely detailed!) <a href="https://oreil.ly/k9cCR">design</a> was accepted. Initially, I was very skeptical, but the accepted generic use turned out to be clear and reasonable. So far, the community also didn’t jump ahead and abuse these mechanics as was feared. We tend to see generics used very rarely—only when needed, as it makes the code more complex to maintain.</p>&#13;
&#13;
<p>For example, we could write a generic sort for all basic types like <code>int</code>, <code>float64</code>, or even <code>strings</code>, as presented in <a data-type="xref" href="#code-generics">Example 2-14</a>.</p>&#13;
<div data-type="example" id="code-generics">&#13;
<h5><span class="label">Example 2-14. </span>Example implementation of the generic sort for basic types</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// import "golang.org/x/exp/constraints" </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-1" id="co_efficient_introduction_to_go_CO11-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">genericSortableBasic</code><code class="p">[</code><code class="nx">T</code><code class="w"> </code><code class="nx">constraints</code><code class="p">.</code><code class="nx">Ordered</code><code class="p">]</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">T</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-1" id="co_efficient_introduction_to_go_CO11-2"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortableBasic</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Len</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w">           </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortableBasic</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Less</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">bool</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-2" id="co_efficient_introduction_to_go_CO11-3"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortableBasic</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Swap</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w">      </code><code class="p">{</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">genericSortBasic</code><code class="p">[</code><code class="nx">T</code><code class="w"> </code><code class="nx">constraints</code><code class="p">.</code><code class="nx">Ordered</code><code class="p">]</code><code class="p">(</code><code class="nx">slice</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-3" id="co_efficient_introduction_to_go_CO11-4"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
    </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Sort</code><code class="p">(</code><code class="nx">genericSortableBasic</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">(</code><code class="nx">slice</code><code class="p">)</code><code class="p">)</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">Example</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">toSort</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kt">int</code><code class="p">{</code><code class="o">-</code><code class="mi">20</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">10</code><code class="p">,</code><code class="w"> </code><code class="mi">20</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Ints</code><code class="p">(</code><code class="nx">toSort</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-4" id="co_efficient_introduction_to_go_CO11-5"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
&#13;
   </code><code class="nx">toSort2</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kt">int</code><code class="p">{</code><code class="o">-</code><code class="mi">20</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">10</code><code class="p">,</code><code class="w"> </code><code class="mi">20</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">   </code><code class="nx">genericSortBasic</code><code class="p">[</code><code class="kt">int</code><code class="p">]</code><code class="p">(</code><code class="nx">toSort2</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO11-4" id="co_efficient_introduction_to_go_CO11-6"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
    </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO11-1" id="callout_efficient_introduction_to_go_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Thanks to generics (also called type parameters), we can implement a single type that will implement <code>sort.Interface</code> (see <a data-type="xref" href="#code-oop-sortable">Example 2-13</a>) for all basic types. We can provide custom constraints that look mostly like interfaces to limit the types that can be used as a type parameter. Here we use a type that represents <code>Integer | Float | ~string</code> constraints, so any type that supports comparison operators. We can put any other interface, like <code>any</code> to match all types. We can also use a special <code>comparable</code> keyword that will allow us to use the object of <code>T comparable</code> as a <code>map</code> key.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO11-3" id="callout_efficient_introduction_to_go_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Any element of <code>s</code> slice is now expected to be of type <code>T</code> with <code>Ordered</code> constraints, so the compiler will allow us to compare them for <code>Less</code> functionality.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO11-4" id="callout_efficient_introduction_to_go_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>We can now implement a sort function for any basic type that will leverage <code>sort.Sort</code> implementation.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO11-5" id="callout_efficient_introduction_to_go_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>We don’t need to implement type-specific functions like <code>sort.Ints</code>. We can do <code>genericSortBasic[&lt;type&gt;]([]&lt;type&gt;)</code> as long as the slice is of the types that can be ordered!</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This is great, but it only works for basic types. Unfortunately, we cannot override operators like <code>&lt;</code> in Go (yet), so to implement generic sort for more complex types, we have to do a bit more work. For example, we could design our sort to expect each type to implement the <code>func &lt;typeA&gt; Compare(&lt;typeA&gt;) int</code> method.<sup><a data-type="noteref" href="ch02.html#idm45606837116448" id="idm45606837116448-marker">19</a></sup> If we add this method to the <code>Block</code> in <a data-type="xref" href="#code-oop">Example 2-11</a>, we can sort it easily, as presented in <a data-type="xref" href="#code-generics2">Example 2-15</a>.</p>&#13;
<div data-type="example" id="code-generics2">&#13;
<h5><span class="label">Example 2-15. </span>Example implementation of the generic sort for certain types of objects</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code class="w"> </code><code class="nx">Comparable</code><code class="p">[</code><code class="nx">T</code><code class="w"> </code><code class="kt">any</code><code class="p">]</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-1" id="co_efficient_introduction_to_go_CO12-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
    </code><code class="nx">Compare</code><code class="p">(</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">type</code><code class="w"> </code><code class="nx">genericSortable</code><code class="p">[</code><code class="nx">T</code><code class="w"> </code><code class="nx">Comparable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">]</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">T</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-2" id="co_efficient_introduction_to_go_CO12-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Len</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w">           </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Less</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">bool</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="k">return</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">.</code><code class="nx">Compare</code><code class="p">(</code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="p">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-2" id="co_efficient_introduction_to_go_CO12-3"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">s</code><code class="w"> </code><code class="nx">genericSortable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><code class="nx">Swap</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">j</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w">      </code><code class="p">{</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">j</code><code class="p">]</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">genericSort</code><code class="p">[</code><code class="nx">T</code><code class="w"> </code><code class="nx">Comparable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">]</code><code class="p">(</code><code class="nx">slice</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Sort</code><code class="p">(</code><code class="nx">genericSortable</code><code class="p">[</code><code class="nx">T</code><code class="p">]</code><code class="p">(</code><code class="nx">slice</code><code class="p">)</code><code class="p">)</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="nx">Block</code><code class="p">)</code><code class="w"> </code><code class="nx">Compare</code><code class="p">(</code><code class="nx">other</code><code class="w"> </code><code class="nx">Block</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-3" id="co_efficient_introduction_to_go_CO12-4"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
    </code><code class="c1">// ...</code><code class="w">&#13;
</code><code class="p">}</code><code class="w">&#13;
</code><code class="w">&#13;
</code><code class="kd">func</code><code class="w"> </code><code class="nx">Example</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">toSort</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">Block</code><code class="p">{</code><code class="w"> </code><code class="cm">/* ... */</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">sort</code><code class="p">.</code><code class="nx">Sort</code><code class="p">(</code><code class="nx">sortable</code><code class="p">(</code><code class="nx">toSort</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-4" id="co_efficient_introduction_to_go_CO12-5"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
&#13;
    </code><code class="nx">toSort2</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="nx">Block</code><code class="p">{</code><code class="w"> </code><code class="cm">/* ... */</code><code class="w"> </code><code class="p">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="nx">genericSort</code><code class="p">[</code><code class="nx">Block</code><code class="p">]</code><code class="p">(</code><code class="nx">toSort2</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_efficient_introduction_to_go_CO12-4" id="co_efficient_introduction_to_go_CO12-6"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO12-1" id="callout_efficient_introduction_to_go_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Let’s design our constraint. We expect every type to have a <code>Compare</code> method that accepts the same type. Because constraints and interfaces can also have type parameters, we can implement such requirements.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO12-2" id="callout_efficient_introduction_to_go_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>We can now provide a type that implements a <code>sort.Interface</code> interface for such kinds of objects. Notice the nested <code>T</code> in <code>Comparable[T]</code>, as our interface also is generic!</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO12-4" id="callout_efficient_introduction_to_go_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Now we can implement <code>Compare</code> for our <code>Block</code> type.</p></dd>&#13;
<dt><a class="co" href="#co_efficient_introduction_to_go_CO12-5" id="callout_efficient_introduction_to_go_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Thanks to this, we don’t need to implement a <code>sortable</code> type for every custom type we want to sort. As long as the type has the <code>Compare</code> method, we can use <code>genericSort</code>!</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The accepted design shows advantages in cases where the user interface alone would be cumbersome. But what about the generics dilemma problem? The design allows any <a href="https://oreil.ly/rZBtz">implementation</a>, so what trade-off was chosen at the end? We won’t go into the details in this book, but Go uses the <a href="https://oreil.ly/poLls">dictionaries and stenciling</a> algorithm, which is between monomorphization and boxing.<sup><a data-type="noteref" href="ch02.html#idm45606836849296" id="idm45606836849296-marker">20</a></sup></p>&#13;
<div data-type="warning" epub:type="warning"><h1>Generic Code Will Be Faster?</h1>&#13;
<p><a data-primary="generics" data-secondary="speed/efficiency issues" data-type="indexterm" id="idm45606836846656"/>The specific implementation of generics in Go (which can change over time) means that the generic implementation, in theory, should be faster than interfaces but slower than implementing certain functionality for a specific type by hand. In practice, however, the potential difference is, in most cases, negligible, so use the most readable and easy-to-maintain option first.</p>&#13;
&#13;
<p>In my experience, the difference might matter in the efficiency-critical code, but the results do not always follow the theory. For example, sometimes <a href="https://oreil.ly/9cEIb">generic implementation is faster</a>, and sometimes <a href="https://oreil.ly/tiOhS">using interfaces might be more efficient</a>. Conclusion? Always perform benchmarks (<a data-type="xref" href="ch08.html#ch-benchmarking">Chapter 8</a>) to be sure!</p>&#13;
</div>&#13;
&#13;
<p>To sum up, these facts are what I found crucial when teaching others programming in Go, based on my own experience with the language. Moreover, it will be helpful when diving deeper into the runtime performance of Go later in this book.</p>&#13;
&#13;
<p>However, if you have never programmed in Go before, it’s worth going through other materials like the <a href="https://oreil.ly/J3HE3">tour of Go</a> before jumping to the subsequent sections and chapters of this book. Make sure you try writing your own basic Go program, write a unit test, and use loops, switches, and concurrency mechanisms like channels and routines. Learn common types and standard library abstraction. As a person coming to a new language, you need to produce a program returning valid results before ensuring that it executes quickly and efficiently<a data-startref="ix_ch02-asciidoc20" data-type="indexterm" id="idm45606836840960"/><a data-startref="ix_ch02-asciidoc19" data-type="indexterm" id="idm45606836741040"/><a data-startref="ix_ch02-asciidoc18" data-type="indexterm" id="idm45606836740432"/><a data-startref="ix_ch02-asciidoc17" data-type="indexterm" id="idm45606836739824"/>.<a data-startref="ix_ch02-asciidoc8" data-type="indexterm" id="idm45606836739088"/><a data-startref="ix_ch02-asciidoc7" data-type="indexterm" id="idm45606836738480"/></p>&#13;
&#13;
<p>We learned about some basic and advanced characteristics of Go, so it’s time to unwrap the efficiency aspects of the language. How easy is it to write good enough or high-performance code in Go?</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Is Go “Fast”?" data-type="sect1"><div class="sect1" id="ch-go-fast">&#13;
<h1>Is Go “Fast”?</h1>&#13;
&#13;
<p class="fix_tracking"><a data-primary="Go (generally)" data-secondary="speed issues" data-type="indexterm" id="idm45606836735440"/><a data-primary="speed" data-secondary="Go (generally)" data-type="indexterm" id="idm45606836734592"/>Recently, many companies have rewritten their products (e.g., from Ruby, Python, and Java) to Go.<sup><a data-type="noteref" href="ch02.html#idm45606836733504" id="idm45606836733504-marker">21</a></sup> Two repeatedly stated reasons for moving to Go or starting a new project in Go were readability and excellent performance. Readability comes from simplicity and consistency (e.g., single way of error handling as you remember from <a data-type="xref" href="#ch-go-errs">“Single Way of Handling Errors”</a>), and it’s where Go excels, but what about performance? Is Go fast compared to other languages like Python, Java, or C++?</p>&#13;
&#13;
<p class="fix_tracking2">In my opinion, this question is badly formed. Given time and room for complexities, any language can be as fast as your machine and operating system allow. That’s because, in the end, the code we write is compiled into machine code that uses the exact CPU instructions. Also, most languages allow delegating execution to other processes, e.g., written in optimized Assembly. Unfortunately, sometimes all we use to decide if a language is “fast” are raw, semi-optimized short program benchmarks that compare execution time and memory usage across languages. While it tells us something, it effectively does not show practical aspects, e.g., how complex the programming for efficiency was.<sup><a data-type="noteref" href="ch02.html#idm45606836729648" id="idm45606836729648-marker">22</a></sup></p>&#13;
&#13;
<p>Instead, we should look at a programming language in terms of how hard and practical it is to write efficient code (not just fast), and how much readability and reliability such a process sacrifices. I believe the Go language has a superior balance between those elements while keeping it fast and trivial to write basic, functional code.</p>&#13;
&#13;
<p>One of the reasons for being able to write efficient code more easily is the hermetic compilation stage, the relatively small amount of unknowns in the Go runtime (see <a data-type="xref" href="#ch-go-runtime">“Go Runtime”</a>), the easy-to-use concurrency framework, and the maturity of the debugging, benchmarking, and profiling tools (discussed in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.html#ch-benchmarking">8</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.html#ch-observability3">9</a>). Those Go characteristics did not appear from thin air. Not many know, but Go was designed on the shoulders of giants: C, Pascal, and CSP.<a data-primary="Griesemer, Robert" data-secondary="Algol 60 development" data-type="indexterm" id="idm45606836724304"/></p>&#13;
<blockquote><p>In 1960, language experts from America and Europe teamed up to create Algol 60. In 1970, the Algol tree split into the C and the Pascal branch.&#13;
~40 years later, the two branches join again in Go.</p><p data-type="attribution">Robert Griesemer, <a href="https://oreil.ly/a4V1e">“The Evolution of Go”</a></p></blockquote>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="genealogy" data-type="indexterm" id="idm45606836721696"/>As we can see in <a data-type="xref" href="#img-go-roots">Figure 2-2</a>, many of the names mentioned in <a data-type="xref" href="ch01.html#ch-efficiency-matters">Chapter 1</a> are grandfathers of Go. The great concurrency language CSP created by Sir Hoare, Pascal declarations and packages created by Wirth, and C basic syntax all contributed to how Go looks today.</p>&#13;
&#13;
<figure><div class="figure" id="img-go-roots">&#13;
<img alt="efgo 0202" src="assets/efgo_0202.png"/>&#13;
<h6><span class="label">Figure 2-2. </span>Go genealogy</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="Go (generally)" data-secondary="memory usage problems" data-type="indexterm" id="idm45606836717248"/>But not everything can be perfect. In terms of efficiency, Go has its own Achilles’ heel. As you will learn in <a data-type="xref" href="ch05.html#ch-hw-go-mem">“Go Memory Management”</a>, memory usage can sometimes be hard to control. Allocations in our program can be surprising (especially for new users), and the garbage collections automatic memory release process has some overhead and eventual behavior. Especially for data-intensive applications, it takes effort to ensure memory or CPU efficiency, similar to machines with strictly limited RAM capacities (e.g., IoT).</p>&#13;
&#13;
<p>Yet the decision to automate this process is highly beneficial, allowing the programmer to not worry about memory cleanup, which has proven to be even worse and sometimes catastrophic (e.g., deallocating memory twice). An excellent example of alternative mechanisms that other languages use is Rust. It implements a unique memory ownership model that replaces automatic global garbage collection. Unfortunately, while more efficient, it turns out that writing code in Rust is much more complicated than in Go. That’s why we see higher adoption of Go. This reflects the Go team’s ease-of-use trade-off in this element.</p>&#13;
&#13;
<p>Fortunately, there are ways to mitigate the negative performance consequences of the garbage collection mechanism in Go and keep our software lean and efficient. We will go through those in the following chapters.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45606836736768">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>In my opinion, Go is an incredibly elegant and consistent language. Moreover, it offers many modern and innovative features that make programming more effective and reliable. Plus, the code is readable and maintainable by design.</p>&#13;
&#13;
<p>This is a critical foundation for the efficiency improvements we will discuss later in this book. Like any other feature, optimizations always add complexity, so it’s easier to modify simple code than to complicate already complex code. Simplicity, safety, and readability are paramount, even for efficient code. Make sure you know how to achieve that without thinking about efficiency first!</p>&#13;
&#13;
<p>Many resources go into more details for elements I could spend only a subchapter on. If you are interested to learn more, there is nothing better than practice. If you need more experience with Go before we jump into optimizations, here is a short list of excellent resources:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/9auky">“Effective Go”</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/uS51g">“How to Write Go Code”</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/LpGBN">“A Tour of Go”</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/VnFms">“Practical Go Lessons”</a> by Maximilien Andile, available for free in the digital &#13;
<span class="keep-together">version</span></p>&#13;
</li>&#13;
<li>&#13;
<p>Contributing to any open source project in Go, for example, through the <a href="https://oreil.ly/Y3D2Q">CNCF mentoring initiatives</a> we offer four or more times a year</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="fix_tracking">The true power of the Go optimizations, benchmarking, and efficiency practices comes when used in practice, in everyday programming. Therefore, I want to empower you to marry efficiency with other good techniques around reliability or abstractions for practical use. While fully tailored logic sometimes has to be built for a critical path (as you will see in <a data-type="xref" href="ch10.html#ch-opt">Chapter 10</a>), the basic, often good enough, efficiency comes from understanding simple rules and language capabilities. That’s why I focused on giving you a better overview of Go and its features in this chapter.<a data-startref="ix_ch02-asciidoc0" data-type="indexterm" id="idm45606836702112"/> With this knowledge, we can now move to <a data-type="xref" href="ch03.html#ch-efficiency">Chapter 3</a>, where we will learn how to start the journey to improve the efficiency and overall performance of our program’s execution when we need to.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45606843247856"><sup><a href="ch02.html#idm45606843247856-marker">1</a></sup> New frameworks on tools for writing Go on small devices are emerging, e.g., <a href="https://gobot.io">GoBot</a> and <a href="https://tinygo.org">TinyGo</a>.</p><p data-type="footnote" id="idm45606843245632"><sup><a href="ch02.html#idm45606843245632-marker">2</a></sup> It’s a controversial topic. There is quite a battle in the infrastructure industry for the superior language for configuration as code. For example, among HCL, Terraform, Go templates (Helm), Jsonnet, Starlark, and Cue. In 2018, we even open sourced a tool for writing configuration in Go, called <a href="https://oreil.ly/FNjYD">“mimic”</a>. Arguably, the loudest arguments against writing configuration in Go are that it feels too much like “programming” and requires programming skills from system administrators.</p><p data-type="footnote" id="idm45606843243616"><sup><a href="ch02.html#idm45606843243616-marker">3</a></sup> WebAssembly is meant to change this, though, but <a href="https://oreil.ly/rZqtp">not soon</a>.</p><p data-type="footnote" id="idm45606843188400"><sup><a href="ch02.html#idm45606843188400-marker">4</a></sup> CSP is a formal language that allows describing interactions in concurrent systems. Introduced by C.A.R. Hoare in <em>Communications of the ACM</em> (1978), it was an inspiration for the Go language concurrency system.</p><p data-type="footnote" id="idm45606843146464"><sup><a href="ch02.html#idm45606843146464-marker">5</a></sup> Similar frustrations triggered another part of Google to create yet another language—<a href="https://oreil.ly/ijFPA">Carbon</a> in 2022. Carbon looks very promising, but it has different goals than Go. It is, by design, more efficiency aware and focused on familiarity with C++ concepts and interoperability. So let’s see how adoption will catch up for Carbon!</p><p data-type="footnote" id="idm45606843127920"><sup><a href="ch02.html#idm45606843127920-marker">6</a></sup> One notable example is <a href="https://oreil.ly/3gB9m">the controversy behind dependency management work</a>.</p><p data-type="footnote" id="idm45606843118368"><sup><a href="ch02.html#idm45606843118368-marker">7</a></sup> Of course, there are some inconsistencies here and there; that’s why the community created more <a href="https://oreil.ly/RKUme">strict formatters</a>, <a href="https://oreil.ly/VnQSC">linters</a>, or <a href="https://oreil.ly/ETWSq">style guides</a>. Yet the standard tools are good enough to feel comfortable in every Go  <span class="keep-together">codebase.</span></p><p data-type="footnote" id="idm45606843101632"><sup><a href="ch02.html#idm45606843101632-marker">8</a></sup> There is one exception: unit test files that have to end with <em>_test.go</em>. These files can have either the same package name or the <code>&lt;package_name&gt;_test</code> name allowing to mimic external users of the package.</p><p data-type="footnote" id="idm45606842831664"><sup><a href="ch02.html#idm45606842831664-marker">9</a></sup> In practice, you can quickly obtain the C++ or Go code (even when obfuscated) from the compiled binary anyway, especially if you don’t strip the binary from the debugging symbols.</p><p data-type="footnote" id="idm45606842772304"><sup><a href="ch02.html#idm45606842772304-marker">10</a></sup> Standard library means packages that are shipped together with the Go language tooling and runtime code. Usually, only mature and core functionalities are provided, as Go has strong compatibility guarantees. Go also maintains an experimental <a href="https://oreil.ly/KBTwn"><code>golang.org/x/exp</code></a> module that contains useful code that must be proven to graduate to the standard library.</p><p data-type="footnote" id="idm45606842681408"><sup><a href="ch02.html#idm45606842681408-marker">11</a></sup> While Go is improving every day, sometimes you can add more advanced tools like <a href="https://oreil.ly/pS9MI"><code>goimports</code></a> or <a href="https://oreil.ly/mkjO2"><code>bingo</code></a> to improve the development experience further. In some areas, Go can’t be opinionated and is limited by stability guarantees.</p><p data-type="footnote" id="idm45606842674272"><sup><a href="ch02.html#idm45606842674272-marker">12</a></sup> <a href="https://oreil.ly/HyBdB">The CAP Theorem</a> mentions an excellent example of treating failures seriously. It states that you can only choose two from three system characteristics: consistency, availability, and partition. As soon as you distribute your system, you must deal with network partition (communication failure). As an error-handling mechanism, you can either design your system to wait (lose availability) or operate on partial data (lose consistency).</p><p data-type="footnote" id="idm45606842670048"><sup><a href="ch02.html#idm45606842670048-marker">13</a></sup> <a href="https://oreil.ly/Tij9n"><code>bash</code> has many methods for error handling</a>, but the default one is implicit. The programmer can optionally print or check <code>${?}</code> that holds the exit code of the last command executed before any given line. An exit code of 0 means the command is executed without any issues.</p><p data-type="footnote" id="idm45606842664160"><sup><a href="ch02.html#idm45606842664160-marker">14</a></sup> In principle, a monad is an object that holds some value optionally, for example, some object <code>Option&lt;Type&gt;</code> with methods <code>Get()</code> and <code>IsEmpty()</code>. Furthermore, an “error monad” is an <code>Option</code> object that holds an error if the value is not set (sometimes referred to as <code>Result&lt;Type&gt;</code>).</p><p data-type="footnote" id="idm45606839042576"><sup><a href="ch02.html#idm45606839042576-marker">15</a></sup> Such code is not recommended for production, but the only things that would need to change are avoiding using global variables and checking all errors.</p><p data-type="footnote" id="idm45606838437664"><sup><a href="ch02.html#idm45606838437664-marker">16</a></sup> This assertion pattern is also typical in other third-party libraries like the popular <a href="https://oreil.ly/I47fD"><code>testify</code> package</a>. However, I am not a fan of the <code>testify</code> package, because there are too many ways of doing the same thing.</p><p data-type="footnote" id="idm45606838184304"><sup><a href="ch02.html#idm45606838184304-marker">17</a></sup> Since programs, e.g., in Java, compile to Java bytecode, many things happen before the code is translated to actual machine-understandable code. The complexity of this process is too great to be understood by a mere mortal, so <a href="https://oreil.ly/baNvh">machine learning “AI” tools were created</a> to auto-tune JVM.</p><p data-type="footnote" id="idm45606838174512"><sup><a href="ch02.html#idm45606838174512-marker">18</a></sup> <a href="https://oreil.ly/WrtCH">A survey in 2020</a> shows that among the top 10 used programming languages, 2 mandates object-oriented programming (Java, C#), 6 encourage it, and 2 do not implement OOP. I personally almost always favor object-oriented programming for algorithms that have to hold some context larger than three variables between data structures or functions.</p><p data-type="footnote" id="idm45606837116448"><sup><a href="ch02.html#idm45606837116448-marker">19</a></sup> I prefer <a href="https://oreil.ly/Et9CE">functions to methods</a>, as they’re easier to use in most cases.</p><p data-type="footnote" id="idm45606836849296"><sup><a href="ch02.html#idm45606836849296-marker">20</a></sup> The summary was well explained on the <a href="https://oreil.ly/ksqO0"><em>PlanetScale</em> blog post</a>.</p><p data-type="footnote" id="idm45606836733504"><sup><a href="ch02.html#idm45606836733504-marker">21</a></sup> To name a few public changes, we’ve seen the <a href="https://oreil.ly/H3WsC">Salesforce case</a>, <a href="https://oreil.ly/iazde">AppsFlyer</a>, and <a href="https://oreil.ly/NSJLD">Stream</a>.</p><p data-type="footnote" id="idm45606836729648"><sup><a href="ch02.html#idm45606836729648-marker">22</a></sup> For example, when we look at some <a href="https://oreil.ly/s7qTj">benchmarks</a>, we see Go as sometimes faster, sometimes slower than Java. Yet if we look at CPU loads, every time Go or Java is faster, it’s simply faster because, for example, the implementation allowed fewer CPU cycles to be wasted on memory access. You can achieve that in any programming language. The question is, how hard was it to achieve this? We don’t usually measure how much time we spend to optimize code in each particular language, how easy it is to read or extend such code after optimizations, etc. Only those metrics might tell us which programming language is “faster.”</p></div></div></section></body></html>