<html><head></head><body><section data-pdf-bookmark="Chapter 8. The gRPC Ecosystem" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_08">&#13;
<h1><span class="label">Chapter 8. </span>The gRPC Ecosystem</h1>&#13;
&#13;
&#13;
<p><a data-primary="ecosystem" data-type="indexterm" id="ix_ch08-asciidoc0"/>In this chapter, we’ll explore some of the projects that are not part of the core gRPC implementation but could be quite useful in building and running gRPC applications for a real-world use case. <a data-primary="gRPC Ecosystem parent project" data-seealso="ecosystem" data-type="indexterm" id="idm46536629882136"/>These projects are part of the gRPC Ecosystem parent project, and none of the technologies mentioned here are mandatory to run gRPC applications. If you have a similar requirement that a given project offers, explore and evaluate those technologies.</p>&#13;
&#13;
<p>Let’s begin our discussion with the gRPC gateway.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC Gateway" data-type="sect1"><div class="sect1" id="ch_08_sec_01">&#13;
<h1>gRPC Gateway</h1>&#13;
&#13;
<p>The <a data-primary="ecosystem" data-secondary="gRPC gateway" data-type="indexterm" id="ix_ch08-asciidoc1"/><a data-primary="gRPC gateway" data-type="indexterm" id="ix_ch08-asciidoc2"/><a data-primary="reverse proxy service" data-type="indexterm" id="ix_ch08-asciidoc3"/>gRPC gateway plug-in enables the protocol buffer compiler to read the gRPC service definition and generate a reverse proxy server, which translates a RESTful JSON API into gRPC. This is specifically written for Go, to support invoking gRPC service from both gRPC and HTTP client applications. <a data-type="xref" href="#grpc_gateway">Figure 8-1</a>illustrates how it provides the ability to invoke gRPC service in both gRPC and RESTful ways.</p>&#13;
&#13;
<p>As shown in the figure, we have a <code>ProductInfo</code> service contract and using the contract we build a gRPC service called <code>ProductInfoService</code>. Earlier we built a gRPC client to talk with this gRPC service. But here, instead of building a gRPC client we will build a reverse proxy service, which exposes RESTful API for each remote method in the gRPC service and accepts HTTP requests from REST clients. Once it receives an HTTP request, it translates the request into a gRPC message and calls the remote method in the backend service. The response message from the backend server again converts back to an HTTP response and replies to the client.</p>&#13;
&#13;
<figure><div class="figure" id="grpc_gateway">&#13;
<img alt="gRPC gateway" src="assets/grpc_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>gRPC gateway</h6>&#13;
</div></figure>&#13;
&#13;
<p>To generate a reverse proxy service for the service definition, we first need to map the gRPC methods to the HTTP resources by updating the service definition. Let’s get the same <code>ProductInfo</code> service definition we created, to add mapping entries. <a data-type="xref" href="#EX8-1">Example 8-1</a> shows the updated protocol buffer definition.</p>&#13;
<div data-type="example" id="EX8-1">&#13;
<h5><span class="label">Example 8-1. </span>Updates protocol buffer definition of ProductInfo service</h5>&#13;
&#13;
<pre data-code-language="proto" data-type="programlisting"><code class="na">syntax</code><code> </code><code class="o">=</code><code> </code><code class="s">"proto3"</code><code class="p">;</code><code>&#13;
</code><code>&#13;
</code><code class="k">import</code><code> </code><code class="s">"google/protobuf/wrappers.proto"</code><code class="p">;</code><code>&#13;
</code><code class="k">import</code><code> </code><code class="s">"google/api/annotations.proto"</code><code class="p">;</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO1-1" id="co_the_grpc_ecosystem_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="kn">package</code><code> </code><code class="nn">ecommerce</code><code class="p">;</code><code>&#13;
</code><code>&#13;
</code><code class="kd">service</code><code> </code><code class="n">ProductInfo</code><code> </code><code class="p">{</code><code>&#13;
</code><code>   </code><code class="k">rpc</code><code> </code><code class="n">addProduct</code><code class="p">(</code><code class="n">Product</code><code class="p">)</code><code> </code><code class="k">returns</code><code> </code><code class="p">(</code><code class="n">google.protobuf.StringValue</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>       </code><code class="k">option</code><code> </code><code class="p">(</code><code class="n">google.api.http</code><code class="p">)</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO1-2" id="co_the_grpc_ecosystem_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>           </code><code class="n">post</code><code class="o">:</code><code> </code><code class="s">"/v1/product"</code><code>&#13;
</code><code>           </code><code class="n">body</code><code class="o">:</code><code> </code><code class="s">"*"</code><code>&#13;
</code><code>       </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code>   </code><code class="p">}</code><code>&#13;
</code><code>   </code><code class="k">rpc</code><code> </code><code class="n">getProduct</code><code class="p">(</code><code class="n">google.protobuf.StringValue</code><code class="p">)</code><code> </code><code class="k">returns</code><code> </code><code class="p">(</code><code class="n">Product</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="k">option</code><code> </code><code class="p">(</code><code class="n">google.api.http</code><code class="p">)</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO1-3" id="co_the_grpc_ecosystem_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>            </code><code class="n">get</code><code class="o">:</code><code class="s">"/v1/product/{value}"</code><code>&#13;
</code><code>        </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code>   </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">message</code><code> </code><code class="nc">Product</code><code> </code><code class="p">{</code><code>&#13;
</code><code>   </code><code class="kt">string</code><code> </code><code class="na">id</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>&#13;
</code><code>   </code><code class="kt">string</code><code> </code><code class="na">name</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code class="p">;</code><code>&#13;
</code><code>   </code><code class="kt">string</code><code> </code><code class="na">description</code><code> </code><code class="o">=</code><code> </code><code class="mi">3</code><code class="p">;</code><code>&#13;
</code><code>   </code><code class="kt">float</code><code> </code><code class="na">price</code><code> </code><code class="o">=</code><code> </code><code class="mi">4</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO1-1" id="callout_the_grpc_ecosystem_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Import the <em>google/api/annotations.proto</em> proto file to add annotation support to the protocol definition.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO1-2" id="callout_the_grpc_ecosystem_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Add gRPC/HTTP mapping to the <code>addProduct</code> method. Specify the URL path template (<code>/v1/product</code>), the HTTP method (“post”), and what the message body looks like. <code>*</code> is used in the body mapping to define that every field not bound by the path template should be mapped to the request body.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO1-3" id="callout_the_grpc_ecosystem_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Add gRPC/HTTP mapping to the <code>getProduct</code> method. Here it is a GET method with the URL path template as <code>/v1/product/{value}</code> and the <code>ProductID</code> passed as the path parameter.</p></dd>&#13;
</dl>&#13;
&#13;
<p>There are additional rules we need to know when we are mapping gRPC methods to HTTP resources. A few important rules are listed next. You can refer to the <a href="https://oreil.ly/iYyZC">Google API Documentation</a> for more details about HTTP to gRPC mapping:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Each mapping needs to specify a URL path template and an HTTP method.</p>&#13;
</li>&#13;
<li>&#13;
<p>The path template can contain one or more fields in the gRPC request message. But those fields should be nonrepeated fields with primitive types.</p>&#13;
</li>&#13;
<li>&#13;
<p>Any fields in the request message that are not in the path template automatically become HTTP query parameters if there is no HTTP request body.</p>&#13;
</li>&#13;
<li>&#13;
<p>Fields that are mapped to URL query parameters should be either a primitive type or a repeated primitive type or a nonrepeated message type.</p>&#13;
</li>&#13;
<li>&#13;
<p>For a repeated field type in query parameters, the parameter can be repeated in the URL as <code>...?param=A&amp;param=B</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>For a message type in query parameters, each field of the message is mapped to a separate parameter, such as <code>...?foo.a=A&amp;foo.b=B&amp;foo.c=C</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Once we write the service definition, we need to compile it using the protocol buffer compiler and generate a source code of reverse proxy service. Let’s talk about how to generate code and implement the server in the Go language.</p>&#13;
&#13;
<p>Before we can compile the service definition, we need to get a few dependent packages. Use the following command to download the packages:</p>&#13;
&#13;
<pre data-type="programlisting">go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway&#13;
go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger&#13;
go get -u github.com/golang/protobuf/protoc-gen-go</pre>&#13;
&#13;
<p>After downloading the packages, execute the following command to compile the service definition (<em>product_info.proto</em>) and to generate the stub:</p>&#13;
&#13;
<pre data-type="programlisting">protoc -I/usr/local/include -I. \&#13;
-I$GOPATH/src \&#13;
-I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \&#13;
--go_out=plugins=grpc:. \&#13;
product_info.proto</pre>&#13;
&#13;
<p>Once we execute the command, it will generate a stub (<em>product_info.pb.go</em>) in the same location. Apart from the generated stub, we also need to create a reverse proxy service to support RESTful client invocation. This reverse proxy service can be generated by the gateway plug-in supported in the Go compiler.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The gRPC gateway is only supported in Go, which means we cannot compile and generate a reverse proxy service for the gRPC gateway in other languages.</p>&#13;
</div>&#13;
&#13;
<p>Let’s generate a reverse proxy service from service definition by executing the following command:</p>&#13;
&#13;
<pre data-type="programlisting">protoc -I/usr/local/include -I. \&#13;
-I$GOPATH/src \&#13;
-I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \&#13;
--grpc-gateway_out=logtostderr=true:. \&#13;
product_info.proto</pre>&#13;
&#13;
<p>Once we execute the command, it will generate a reverse proxy service (<em>product_info.pb.gw.go</em>) in the same location.</p>&#13;
&#13;
<p>Let’s create the listener endpoint for the HTTP server and run the reverse proxy service we just created. <a data-type="xref" href="#EX8-2">Example 8-2</a> illustrates how to create a new server instance and register the service to listen to the inbound HTTP requests.</p>&#13;
<div data-type="example" id="EX8-2">&#13;
<h5><span class="label">Example 8-2. </span>HTTP reverse proxy in Go language</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"context"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net/http"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="s">"github.com/grpc-ecosystem/grpc-gateway/runtime"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">gw</code><code> </code><code class="s">"github.com/grpc-up-and-running/samples/ch08/grpc-gateway/go/gw"</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO2-1" id="co_the_grpc_ecosystem_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">grpcServerEndpoint</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO2-2" id="co_the_grpc_ecosystem_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">ctx</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">cancel</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithCancel</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">mux</code><code> </code><code class="o">:=</code><code> </code><code class="nx">runtime</code><code class="p">.</code><code class="nx">NewServeMux</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">gw</code><code class="p">.</code><code class="nx">RegisterProductInfoHandlerFromEndpoint</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">mux</code><code class="p">,</code><code>&#13;
</code><code>      </code><code class="nx">grpcServerEndpoint</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="p">)</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO2-3" id="co_the_grpc_ecosystem_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Fail to register gRPC gateway service endpoint: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">":8081"</code><code class="p">,</code><code> </code><code class="nx">mux</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO2-4" id="co_the_grpc_ecosystem_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Could not setup HTTP endpoint: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO2-1" id="callout_the_grpc_ecosystem_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Import the package to where the generated reverse-proxy code exists.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO2-2" id="callout_the_grpc_ecosystem_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Specify the gRPC server endpoint URL. Make sure the backend gRPC server is running properly in the mentioned endpoint. Here we used the same gRPC service created in <a data-type="xref" href="ch02.html#ch_02">Chapter 2</a>.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO2-3" id="callout_the_grpc_ecosystem_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Register the gRPC server endpoint with the proxy handler. At runtime, the request multiplexer matches HTTP requests to patterns and invokes the corresponding handler.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO2-4" id="callout_the_grpc_ecosystem_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Start listening to the HTTP requests on the port (8081).</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we build an HTTP reverse-proxy server, we can test it by running both the gRPC server and the HTTP server. In this case, the gRPC server is listening on port 50051 and the HTTP server is listening on port 8081.</p>&#13;
&#13;
<p>Let’s make a few HTTP requests from curl and observe the behavior:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Add a new product to the <code>ProductInfo</code> service.</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>curl -X POST http://localhost:8081/v1/product&#13;
        -d <code class="s1">'{"name": "Apple", "description": "iphone7", "price": 699}'</code>&#13;
&#13;
<code class="s2">"38e13578-d91e-11e9"</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Get the existing product using <code>ProductID</code>:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>curl http://localhost:8081/v1/product/38e13578-d91e-11e9&#13;
&#13;
<code class="o">{</code><code class="s2">"id"</code>:<code class="s2">"38e13578-d91e-11e9"</code>,<code class="s2">"name"</code>:<code class="s2">"Apple"</code>,<code class="s2">"description"</code>:<code class="s2">"iphone7"</code>,&#13;
<code class="s2">"price"</code>:699<code class="o">}</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Added to the reverse proxy service, the gRPC gateway also supports generating the swagger definition of the reverse proxy service by executing the following command:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">protoc -I/usr/local/include -I. <code class="se">\</code>&#13;
  -I<code class="nv">$GOPATH</code>/src <code class="se">\</code>&#13;
  -I<code class="nv">$GOPATH</code>/src/github.com/grpc-ecosystem/grpc-gateway/<code class="se">\</code>&#13;
  third_party/googleapis <code class="se">\</code>&#13;
  --swagger_out<code class="o">=</code><code class="nv">logtostderr</code><code class="o">=</code><code class="nb">true</code>:. <code class="se">\</code>&#13;
  product_info.proto</pre>&#13;
</li>&#13;
<li>&#13;
<p>Once we execute the command, it generates a swagger definition for the reverse proxy service (<em>product_info.swagger.json</em>) in the same location. For our <code>ProductInfo</code> service, generated swagger definition looks like this:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
 <code class="nt">"swagger"</code><code class="p">:</code> <code class="s2">"2.0"</code><code class="p">,</code>&#13;
 <code class="nt">"info"</code><code class="p">:</code> <code class="p">{</code>&#13;
   <code class="nt">"title"</code><code class="p">:</code> <code class="s2">"product_info.proto"</code><code class="p">,</code>&#13;
   <code class="nt">"version"</code><code class="p">:</code> <code class="s2">"version not set"</code>&#13;
 <code class="p">},</code>&#13;
 <code class="nt">"schemes"</code><code class="p">:</code> <code class="p">[</code>&#13;
   <code class="s2">"http"</code><code class="p">,</code>&#13;
   <code class="s2">"https"</code>&#13;
 <code class="p">],</code>&#13;
 <code class="nt">"consumes"</code><code class="p">:</code> <code class="p">[</code>&#13;
   <code class="s2">"application/json"</code>&#13;
 <code class="p">],</code>&#13;
 <code class="nt">"produces"</code><code class="p">:</code> <code class="p">[</code>&#13;
   <code class="s2">"application/json"</code>&#13;
 <code class="p">],</code>&#13;
 <code class="nt">"paths"</code><code class="p">:</code> <code class="p">{</code>&#13;
   <code class="nt">"/v1/product"</code><code class="p">:</code> <code class="p">{</code>&#13;
     <code class="nt">"post"</code><code class="p">:</code> <code class="p">{</code>&#13;
       <code class="nt">"operationId"</code><code class="p">:</code> <code class="s2">"addProduct"</code><code class="p">,</code>&#13;
       <code class="nt">"responses"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"200"</code><code class="p">:</code> <code class="p">{</code>&#13;
           <code class="nt">"description"</code><code class="p">:</code> <code class="s2">"A successful response."</code><code class="p">,</code>&#13;
           <code class="nt">"schema"</code><code class="p">:</code> <code class="p">{</code>&#13;
             <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"string"</code>&#13;
           <code class="p">}</code>&#13;
         <code class="p">}</code>&#13;
       <code class="p">},</code>&#13;
       <code class="nt">"parameters"</code><code class="p">:</code> <code class="p">[</code>&#13;
         <code class="p">{</code>&#13;
           <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"body"</code><code class="p">,</code>&#13;
           <code class="nt">"in"</code><code class="p">:</code> <code class="s2">"body"</code><code class="p">,</code>&#13;
           <code class="nt">"required"</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
           <code class="nt">"schema"</code><code class="p">:</code> <code class="p">{</code>&#13;
             <code class="nt">"$ref"</code><code class="p">:</code> <code class="s2">"#/definitions/ecommerceProduct"</code>&#13;
           <code class="p">}</code>&#13;
         <code class="p">}</code>&#13;
       <code class="p">],</code>&#13;
       <code class="nt">"tags"</code><code class="p">:</code> <code class="p">[</code>&#13;
         <code class="s2">"ProductInfo"</code>&#13;
       <code class="p">]</code>&#13;
     <code class="p">}</code>&#13;
   <code class="p">},</code>&#13;
   <code class="nt">"/v1/product/{value}"</code><code class="p">:</code> <code class="p">{</code>&#13;
     <code class="nt">"get"</code><code class="p">:</code> <code class="p">{</code>&#13;
       <code class="nt">"operationId"</code><code class="p">:</code> <code class="s2">"getProduct"</code><code class="p">,</code>&#13;
       <code class="nt">"responses"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"200"</code><code class="p">:</code> <code class="p">{</code>&#13;
           <code class="nt">"description"</code><code class="p">:</code> <code class="s2">"A successful response."</code><code class="p">,</code>&#13;
           <code class="nt">"schema"</code><code class="p">:</code> <code class="p">{</code>&#13;
             <code class="nt">"$ref"</code><code class="p">:</code> <code class="s2">"#/definitions/ecommerceProduct"</code>&#13;
           <code class="p">}</code>&#13;
         <code class="p">}</code>&#13;
       <code class="p">},</code>&#13;
       <code class="nt">"parameters"</code><code class="p">:</code> <code class="p">[</code>&#13;
         <code class="p">{</code>&#13;
           <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"value"</code><code class="p">,</code>&#13;
           <code class="nt">"description"</code><code class="p">:</code> <code class="s2">"The string value."</code><code class="p">,</code>&#13;
           <code class="nt">"in"</code><code class="p">:</code> <code class="s2">"path"</code><code class="p">,</code>&#13;
           <code class="nt">"required"</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
           <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"string"</code>&#13;
         <code class="p">}</code>&#13;
       <code class="p">],</code>&#13;
       <code class="nt">"tags"</code><code class="p">:</code> <code class="p">[</code>&#13;
         <code class="s2">"ProductInfo"</code>&#13;
       <code class="p">]</code>&#13;
     <code class="p">}</code>&#13;
   <code class="p">}</code>&#13;
 <code class="p">},</code>&#13;
 <code class="nt">"definitions"</code><code class="p">:</code> <code class="p">{</code>&#13;
   <code class="nt">"ecommerceProduct"</code><code class="p">:</code> <code class="p">{</code>&#13;
     <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"object"</code><code class="p">,</code>&#13;
     <code class="nt">"properties"</code><code class="p">:</code> <code class="p">{</code>&#13;
       <code class="nt">"id"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"string"</code>&#13;
       <code class="p">},</code>&#13;
       <code class="nt">"name"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"string"</code>&#13;
       <code class="p">},</code>&#13;
       <code class="nt">"description"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"string"</code>&#13;
       <code class="p">},</code>&#13;
       <code class="nt">"price"</code><code class="p">:</code> <code class="p">{</code>&#13;
         <code class="nt">"type"</code><code class="p">:</code> <code class="s2">"number"</code><code class="p">,</code>&#13;
         <code class="nt">"format"</code><code class="p">:</code> <code class="s2">"float"</code>&#13;
       <code class="p">}</code>&#13;
     <code class="p">}</code>&#13;
   <code class="p">}</code>&#13;
 <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>So now we have implemented the HTTP reverse proxy service for our gRPC service using the gRPC gateway. This way we can expose our gRPC server to use in HTTP client applications. You can get more information about gateway implementation from the <a href="https://oreil.ly/rN1WK">gRPC gateway repository</a>.</p>&#13;
&#13;
<p>As we mentioned earlier, the gRPC gateway is only supported in Go. The same concept is also known as HTTP/JSON transcoding. Let’s talk more about HTTP/JSON transcoding in the next section.<a data-startref="ix_ch08-asciidoc3" data-type="indexterm" id="idm46536629362536"/><a data-startref="ix_ch08-asciidoc2" data-type="indexterm" id="idm46536629361832"/><a data-startref="ix_ch08-asciidoc1" data-type="indexterm" id="idm46536629361160"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP/JSON Transcoding for gRPC" data-type="sect1"><div class="sect1" id="ch_08_sec_02">&#13;
<h1>HTTP/JSON Transcoding for gRPC</h1>&#13;
&#13;
<p><a data-primary="ecosystem" data-secondary="HTTP/JSON transcoding" data-type="indexterm" id="idm46536629064840"/><a data-primary="HTTP/JSON transcoding" data-type="indexterm" id="idm46536629063864"/><a data-primary="JSON" data-secondary="HTTP/JSON transcoding" data-type="indexterm" id="idm46536629063192"/><em>Transcoding</em> is the process of translating HTTP JSON calls to RPC calls and passing them to the gRPC service. This is useful when the client applications don’t have support for gRPC and need to provide access to talk to the gRPC service via JSON over HTTP. There is a library written in C++ languages to support the HTTP/JSON transcoding called grpc-httpjson-transcoding, and it is currently used in <a href="https://oreil.ly/vWllM">Istio</a> and <a href="https://oreil.ly/KR5_X">Google cloud endpoint</a>.</p>&#13;
&#13;
<p><a data-primary="Envoy proxy" data-type="indexterm" id="idm46536629059736"/>The <a href="https://oreil.ly/33hyY">Envoy proxy</a> also supports transcoding by providing an HTTP/JSON interface to the gRPC service. Similar to the gRPC gateway, we need to provide the service definition with HTTP mapping for the gRPC service. It uses the same mapping rules specified in the <a href="https://oreil.ly/H6ysW">Google API documentation</a>. So the service definition we modified in <a data-type="xref" href="#EX8-1">Example 8-1</a> can also be applied to the HTTP/JSON transcoding.</p>&#13;
&#13;
<p>For example, the <code>Product Info</code> service’s <code>getProduct</code> method is defined in the <em>.proto</em> file with its request and response types like the following:</p>&#13;
&#13;
<pre data-code-language="proto" data-type="programlisting">   <code class="k">rpc</code> <code class="n">getProduct</code><code class="p">(</code><code class="n">google.protobuf.StringValue</code><code class="p">)</code> <code class="k">returns</code> <code class="p">(</code><code class="n">Product</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">option</code> <code class="p">(</code><code class="n">google.api.http</code><code class="p">)</code> <code class="o">=</code> <code class="p">{</code>&#13;
            <code class="n">get</code><code class="o">:</code><code class="s">"/v1/product/{value}"</code>&#13;
        <code class="p">};</code>&#13;
   <code class="p">}</code></pre>&#13;
&#13;
<p>If a client calls this method by sending a GET to the URL http://localhost:8081/v1/product/2, the proxy server creates a <em>google.protobuf.StringValue</em> with a value of 2 and then calls the gRPC method <code>getProduct()</code> with it. The gRPC backend then returns the requested <code>Product</code> with the ID 2, which the proxy server converts to JSON format and returns to the client.</p>&#13;
&#13;
<p>Now that we’ve covered HTTP/JSON transcoding, in the next section, we’ll discuss another important concept, called gRPC server reflection.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The gRPC Server Reflection Protocol" data-type="sect1"><div class="sect1" id="ch_08_sec_03">&#13;
<h1>The gRPC Server Reflection Protocol</h1>&#13;
&#13;
<p><a data-primary="ecosystem" data-secondary="gRPC server reflection protocol" data-type="indexterm" id="ix_ch08-asciidoc4"/><a data-primary="server reflection protocol" data-type="indexterm" id="ix_ch08-asciidoc5"/><em>Server reflection</em> is a service defined on a gRPC server that provides information about publicly accessible gRPC services on that server. In simple terms, server reflection provides service definitions of the services registered on a server to the client application. So the client doesn’t need precompiled service definitions to communicate with the services.</p>&#13;
&#13;
<p>As we discussed in <a data-type="xref" href="ch02.html#ch_02">Chapter 2</a>, for the client application to connect and communicate with the gRPC service, it must have the service definition of that service. We first need to compile the service definition and generate the corresponding client stub. Then we need to create client application calling methods of the stub. With the gRPC server reflection, we don’t need to precompile service definitions to communicate with the service.</p>&#13;
&#13;
<p>The service reflection is useful when we build a command-line (CLI) tool for debugging the gRPC server. We don’t need to provide service definitions for the tool, but instead we provide the method and the text payload. It sends the binary payload to the server and takes the response back to the user in a human-readable format. In order to use service reflection, we first need to enable it on the server side. <a data-type="xref" href="#EX8-3">Example 8-3</a> illustrates how to enable server reflection.</p>&#13;
<div data-type="example" id="EX8-3">&#13;
<h5><span class="label">Example 8-3. </span>Enable server reflection in the gRPC Go server</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/reflection"</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO3-1" id="co_the_grpc_ecosystem_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">reflection</code><code class="p">.</code><code class="nx">Register</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO3-2" id="co_the_grpc_ecosystem_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO3-1" id="callout_the_grpc_ecosystem_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Import the reflection package to access reflection APIs.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO3-2" id="callout_the_grpc_ecosystem_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Register reflection service on your gRPC server.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="CLI (command-line interface)" data-type="indexterm" id="idm46536628856424"/><a data-primary="command-line interface (CLI)" data-type="indexterm" id="idm46536628860952"/>After enabling server reflection in your server application, you can use the gRPC CLI tool to check your server.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The gRPC CLI tool comes with the gRPC repository. It supports many functionalities, such as the list server services and methods, and sending and receiving RPC calls with metadata. As of this writing, you need to build the tool from the source code. For details on how to build and use the tool, refer to the <a href="https://oreil.ly/jYl0h">gRPC CLI tool repository</a>.</p>&#13;
</div>&#13;
&#13;
<p>Once you build the gRPC CLI tool from the <a href="https://github.com/grpc/grpc">source code</a>, you can use it to check services. Let’s try to understand this using our product management service that we built in <a data-type="xref" href="ch02.html#ch_02">Chapter 2</a>. Once you start the gRPC server of the product management service, then you can run the CLI tool to retrieve the service information.</p>&#13;
&#13;
<p>Here are the actions that you can execute from the CLI tool:</p>&#13;
<dl>&#13;
<dt>List services</dt>&#13;
<dd>&#13;
<p>Run the following command to list all public services in endpoint <code>localhost:50051</code>:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli ls localhost:50051&#13;
&#13;
Output:&#13;
ecommerce.ProductInfo&#13;
grpc.reflection.v1alpha.ServerReflection</pre>&#13;
</dd>&#13;
<dt>List service details</dt>&#13;
<dd>&#13;
<p>Run the following command by giving the service’s full name (in the format of &lt;package&gt;.&lt;service&gt;) to inspect the service:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli ls localhost:50051 ecommerce.ProductInfo -l&#13;
&#13;
Output:&#13;
package: ecommerce<code class="p">;</code>&#13;
service ProductInfo <code class="o">{</code>&#13;
rpc addProduct<code class="o">(</code>ecommerce.Product<code class="o">)</code> returns&#13;
<code class="o">(</code>google.protobuf.StringValue<code class="o">)</code> <code class="o">{}</code>&#13;
rpc getProduct<code class="o">(</code>google.protobuf.StringValue<code class="o">)</code> returns&#13;
<code class="o">(</code>ecommerce.Product<code class="o">)</code> <code class="o">{}</code>&#13;
<code class="o">}</code></pre>&#13;
</dd>&#13;
<dt>List method details</dt>&#13;
<dd>&#13;
<p>Run the following command by giving the method’s full name (in the format of &lt;package&gt;.&lt;service&gt;.&lt;method&gt;) to method details:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli ls localhost:50051 ecommerce.ProductInfo.addProduct -l&#13;
&#13;
Output:&#13;
rpc addProduct<code class="o">(</code>ecommerce.Product<code class="o">)</code> returns&#13;
<code class="o">(</code>google.protobuf.StringValue<code class="o">)</code> <code class="o">{}</code></pre>&#13;
</dd>&#13;
<dt>Inspect message types</dt>&#13;
<dd>&#13;
<p>Run the following commands by giving the full name of the message type (in the format of &lt;package&gt;.&lt;type&gt;) to inspect the message type:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli <code class="nb">type </code>localhost:50051 ecommerce.Product&#13;
&#13;
Output:&#13;
message Product <code class="o">{</code>&#13;
string <code class="nv">id</code> <code class="o">=</code> 1<code class="o">[</code><code class="nv">json_name</code> <code class="o">=</code> <code class="s2">"id"</code><code class="o">]</code><code class="p">;</code>&#13;
string <code class="nv">name</code> <code class="o">=</code> 2<code class="o">[</code><code class="nv">json_name</code> <code class="o">=</code> <code class="s2">"name"</code><code class="o">]</code><code class="p">;</code>&#13;
string <code class="nv">description</code> <code class="o">=</code> 3<code class="o">[</code><code class="nv">json_name</code> <code class="o">=</code> <code class="s2">"description"</code><code class="o">]</code><code class="p">;</code>&#13;
float <code class="nv">price</code> <code class="o">=</code> 4<code class="o">[</code><code class="nv">json_name</code> <code class="o">=</code> <code class="s2">"price"</code><code class="o">]</code><code class="p">;</code>&#13;
<code class="o">}</code></pre>&#13;
</dd>&#13;
<dt>Call remote methods</dt>&#13;
<dd>&#13;
<p>Run the following commands to send remote calls to the server and get the response:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Call the <code>addProduct</code> method in the <code>ProductInfo</code> service:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli call localhost:50051 addProduct <code class="s2">"name:</code>&#13;
<code class="s2">             'Apple', description: 'iphone 11', price: 699"</code>&#13;
&#13;
Output:&#13;
connecting to localhost:50051&#13;
value: <code class="s2">"d962db94-d907-11e9-b49b-6c96cfe0687d"</code>&#13;
&#13;
Rpc succeeded with OK status</pre>&#13;
</li>&#13;
<li>&#13;
<p>Call <code>getProduct</code> method in the <code>ProductInfo</code> service:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>./grpc_cli call localhost:50051 getProduct <code class="s2">"value:</code>&#13;
<code class="s2">             'd962db94-d907-11e9-b49b-6c96cfe0687d'"</code>&#13;
&#13;
Output:&#13;
connecting to localhost:50051&#13;
id: <code class="s2">"d962db94-d907-11e9-b49b-6c96cfe0687d"</code>&#13;
name: <code class="s2">"Apple"</code>&#13;
description: <code class="s2">"iphone 11"</code>&#13;
price: 699&#13;
&#13;
Rpc succeeded with OK status</pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Now we can enable server reflection in the gRPC Go server and test it using the CLI tool. We can also enable server reflection in our gRPC Java server. If you are more familiar with Java, you can refer to the Java samples in the source code repository.<a data-startref="ix_ch08-asciidoc5" data-type="indexterm" id="idm46536628646792"/><a data-startref="ix_ch08-asciidoc4" data-type="indexterm" id="idm46536628646184"/></p>&#13;
&#13;
<p>Let’s discuss another interesting concept called gRPC middleware.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC Middleware" data-type="sect1"><div class="sect1" id="idm46536629036824">&#13;
<h1>gRPC Middleware</h1>&#13;
&#13;
<p><a data-primary="ecosystem" data-secondary="gRPC Middleware package" data-type="indexterm" id="ix_ch08-asciidoc6"/><a data-primary="gRPC Middleware package" data-type="indexterm" id="ix_ch08-asciidoc7"/><a data-primary="middleware" data-type="indexterm" id="ix_ch08-asciidoc8"/>In basic terms, the <em>middleware</em> is a software component in a distributed system that is used to connect different components to route requests generated by the client to the backend server. In <a href="https://oreil.ly/EqnCQ">gRPC Middleware</a>, we are also talking about running code before and after the gRPC server or client application.</p>&#13;
&#13;
<p>In fact, gRPC middleware is based on the <em>interceptor</em> concept that we learned in <a data-type="xref" href="ch05.html#ch_05">Chapter 5</a>. It’s a Go-based collection of interceptors, helpers, and utils that you will require when building gRPC-based applications. It allows you to apply multiple interceptors at the client or server side as a chain of interceptors. Also, as interceptors are commonly used for implementing common patterns such as auth, logging, message, validation, retries, or monitoring, the gRPC Middleware project acts as the go-to point for such reusable functionalities for Go. In <a data-type="xref" href="#EX8-4">Example 8-4</a>, we have shown the common usage of the gRPC Middleware package. <a data-primary="interceptors" data-secondary="chaining with gRPC Middleware" data-type="indexterm" id="ix_ch08-asciidoc9"/>Here we have used it for applying multiple interceptors for both unary and streaming <a data-primary="server" data-secondary="interceptor chaining" data-type="indexterm" id="idm46536628592984"/>messaging.</p>&#13;
<div data-type="example" id="EX8-4">&#13;
<h5><span class="label">Example 8-4. </span>interceptor chaining at the server side with Go gRPC Middleware</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">import</code><code> </code><code class="s">"github.com/grpc-ecosystem/go-grpc-middleware"</code><code>&#13;
</code><code>&#13;
</code><code class="nx">orderMgtServer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Unaryinterceptor</code><code class="p">(</code><code class="nx">grpc_middleware</code><code class="p">.</code><code class="nx">ChainUnaryServer</code><code class="p">(</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO4-1" id="co_the_grpc_ecosystem_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
        </code><code class="nx">grpc_ctxtags</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_opentracing</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_prometheus</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_zap</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">(</code><code class="nx">zapLogger</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_auth</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">(</code><code class="nx">myAuthFunction</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_recovery</code><code class="p">.</code><code class="nx">UnaryServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Streaminterceptor</code><code class="p">(</code><code class="nx">grpc_middleware</code><code class="p">.</code><code class="nx">ChainStreamServer</code><code class="p">(</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO4-2" id="co_the_grpc_ecosystem_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
        </code><code class="nx">grpc_ctxtags</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_opentracing</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_prometheus</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_zap</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">(</code><code class="nx">zapLogger</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_auth</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">(</code><code class="nx">myAuthFunction</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc_recovery</code><code class="p">.</code><code class="nx">StreamServerinterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">)</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO4-1" id="callout_the_grpc_ecosystem_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Add a unary interceptor chain for the server.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO4-2" id="callout_the_grpc_ecosystem_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Add a streaming interceptor chain for the server.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The interceptors are invoked in the same order that they have registered with the Go gRPC Middleware. The project also offers some reusable interceptors for common patterns. Here are some of those common patterns and interceptor implementations:</p>&#13;
<dl>&#13;
<dt>Auth</dt>&#13;
<dd>&#13;
<dl>&#13;
<dt><code>grpc_auth</code></dt>&#13;
<dd>&#13;
<p>A customizable (via <code>AuthFunc</code>) piece of auth middleware.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
<dt>Logging</dt>&#13;
<dd>&#13;
<dl>&#13;
<dt><code>grpc_ctxtags</code></dt>&#13;
<dd>&#13;
<p>A library that adds a Tag map to context, with data populated from the request body.</p>&#13;
</dd>&#13;
<dt><code>grpc_zap</code></dt>&#13;
<dd>&#13;
<p>Integration of zap logging library into gRPC handlers.</p>&#13;
</dd>&#13;
<dt><code>grpc_logrus</code></dt>&#13;
<dd>&#13;
<p>Integration of logrus logging library into gRPC handlers.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
<dt>Monitoring</dt>&#13;
<dd>&#13;
<dl>&#13;
<dt><code>grpc_prometheus</code></dt>&#13;
<dd>&#13;
<p>Prometheus client-side and server-side monitoring middleware.</p>&#13;
</dd>&#13;
<dt><code>grpc_opentracing</code></dt>&#13;
<dd>&#13;
<p>OpenTracing client-side and server-side interceptors with support for streaming and handler-returned tags.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
<dt>Client</dt>&#13;
<dd>&#13;
<dl>&#13;
<dt><code>grpc_retry</code></dt>&#13;
<dd>&#13;
<p>A generic gRPC response code retry mechanism, client-side middleware.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
<dt>Server</dt>&#13;
<dd>&#13;
<dl>&#13;
<dt><code>grpc_validator</code></dt>&#13;
<dd>&#13;
<p>Codegen inbound message validation from <em>.proto</em> options.</p>&#13;
</dd>&#13;
<dt><code>grpc_recovery</code></dt>&#13;
<dd>&#13;
<p>Turn panics into gRPC errors.</p>&#13;
</dd>&#13;
<dt><code>ratelimit</code></dt>&#13;
<dd>&#13;
<p>gRPC rate-limiting by your own limiter.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="client" data-secondary="interceptor chaining" data-type="indexterm" id="idm46536628390984"/>The usage of Go gRPC Middleware at the client side is exactly the same. <a data-type="xref" href="#EX8-5">Example 8-5</a> shows a code snippet of the client-side interceptor chaining with Go gRPC Middleware.</p>&#13;
<div data-type="example" id="EX8-5">&#13;
<h5><span class="label">Example 8-5. </span>interceptor chaining at the client side with Go gRPC Middleware</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">import</code><code> </code><code class="s">"github.com/grpc-ecosystem/go-grpc-middleware"</code><code>&#13;
</code><code>&#13;
</code><code class="nx">clientConn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="p">=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code>&#13;
</code><code>   </code><code class="nx">address</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithUnaryinterceptor</code><code class="p">(</code><code class="nx">grpc_middleware</code><code class="p">.</code><code class="nx">ChainUnaryClient</code><code class="p">(</code><code>&#13;
</code><code>          </code><code class="nx">monitoringClientUnary</code><code class="p">,</code><code> </code><code class="nx">retryUnary</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO5-1" id="co_the_grpc_ecosystem_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithStreaminterceptor</code><code class="p">(</code><code class="nx">grpc_middleware</code><code class="p">.</code><code class="nx">ChainStreamClient</code><code class="p">(</code><code>&#13;
</code><code>          </code><code class="nx">monitoringClientStream</code><code class="p">,</code><code> </code><code class="nx">retryStream</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO5-2" id="co_the_grpc_ecosystem_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO5-1" id="callout_the_grpc_ecosystem_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Client-side unary interceptor chaining.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO5-2" id="callout_the_grpc_ecosystem_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Client-side streaming interceptor chaining.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similar to the server side, the interceptors are executed in the order that they registered with the client.<a data-startref="ix_ch08-asciidoc9" data-type="indexterm" id="idm46536628333256"/></p>&#13;
&#13;
<p>Next, we will talk about how we can expose the health status of the gRPC server. In a high-availability system, it is essential to have a way to check the health status of the server, so that we can periodically check and take actions to mitigate the damage.<a data-startref="ix_ch08-asciidoc8" data-type="indexterm" id="idm46536628331992"/><a data-startref="ix_ch08-asciidoc7" data-type="indexterm" id="idm46536628331384"/><a data-startref="ix_ch08-asciidoc6" data-type="indexterm" id="idm46536628330776"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Health Checking Protocol" data-type="sect1"><div class="sect1" id="ch_08_sec_04">&#13;
<h1>Health Checking Protocol</h1>&#13;
&#13;
<p><a data-primary="ecosystem" data-secondary="Health Checking Protocol" data-type="indexterm" id="ix_ch08-asciidoc10"/><a data-primary="Health Checking Protocol" data-type="indexterm" id="ix_ch08-asciidoc11"/>gRPC defines a health checking protocol (Health Checking API) that allows the gRPC services to expose the server status so that the consumers can probe the server’s health information. The health of the server is determined if the server responds with an <em>unhealthy</em> status when it is not ready to handle the RPC or does not respond at all for the health probe request. The client can act accordingly if the response denotes an <em>unhealthy</em> status or a response is not received within some time window.</p>&#13;
&#13;
<p>The gRPC Health Checking Protocol defines an API based on gRPC. Then a gRPC service is used as the health checking mechanism for both simple client-to-server scenarios and other control systems such as load balancing. <a data-type="xref" href="#EX8-6">Example 8-6</a> shows the standard service definition of the gRPC health checking interface.</p>&#13;
<div data-type="example" id="EX8-6">&#13;
<h5><span class="label">Example 8-6. </span>gRPC service definition of the Health Checking API</h5>&#13;
&#13;
<pre data-code-language="proto" data-type="programlisting"><code class="na">syntax</code><code> </code><code class="o">=</code><code> </code><code class="s">"proto3"</code><code class="p">;</code><code>&#13;
</code><code>&#13;
</code><code class="kn">package</code><code> </code><code class="nn">grpc</code><code class="o">.</code><code class="n">health.v1</code><code class="p">;</code><code>&#13;
</code><code>&#13;
</code><code class="kd">message</code><code> </code><code class="nc">HealthCheckRequest</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO6-1" id="co_the_grpc_ecosystem_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="kt">string</code><code> </code><code class="kd">service</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">message</code><code> </code><code class="nc">HealthCheckResponse</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO6-2" id="co_the_grpc_ecosystem_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>  </code><code class="kd">enum</code><code> </code><code class="n">ServingStatus</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="na">UNKNOWN</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code>&#13;
</code><code>    </code><code class="na">SERVING</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>&#13;
</code><code>    </code><code class="na">NOT_SERVING</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code class="p">;</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="n">ServingStatus</code><code> </code><code class="na">status</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">service</code><code> </code><code class="n">Health</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="k">rpc</code><code> </code><code class="n">Check</code><code class="p">(</code><code class="n">HealthCheckRequest</code><code class="p">)</code><code> </code><code class="k">returns</code><code> </code><code class="p">(</code><code class="n">HealthCheckResponse</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO6-3" id="co_the_grpc_ecosystem_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">rpc</code><code> </code><code class="n">Watch</code><code class="p">(</code><code class="n">HealthCheckRequest</code><code class="p">)</code><code> </code><code class="k">returns</code><code> </code><code class="p">(</code><code class="n">stream</code><code> </code><code class="n">HealthCheckResponse</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO6-4" id="co_the_grpc_ecosystem_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO6-1" id="callout_the_grpc_ecosystem_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The health check request message structure.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO6-2" id="callout_the_grpc_ecosystem_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The health check response with the serving status.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO6-3" id="callout_the_grpc_ecosystem_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The client can query the server’s health status by calling the <code>Check</code> method.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO6-4" id="callout_the_grpc_ecosystem_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The client can call the <code>Watch</code> method to perform a streaming health check.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The implementation of the health check service is very similar to any conventional gRPC service. Often you will run a health checking service and related gRPC business services together in the same gRPC server instance using multiplexing (which we discussed in <a data-type="xref" href="ch05.html#ch_05">Chapter 5</a>). Since it is a gRPC service, doing a health check is the same as doing normal RPC. It also offers a granular service health semantics that includes details such as per-service health status. Also, it is able to reuse all the existing information on the server and have full control over it.</p>&#13;
&#13;
<p>Based on the server interface shown in <a data-type="xref" href="#EX8-6">Example 8-6</a>, a client can call the <code>Check</code> method (with an optional parameter service name) to check the health status of a particular service or the server.</p>&#13;
&#13;
<p>Additionally, the client can also call the <code>Watch</code> method to perform a streaming health check. This uses a server streaming messaging pattern, which means once the client calls this method, the server starts sending messages indicating the current status and sends subsequent new messages whenever the status changes.</p>&#13;
&#13;
<p>These are the key points to know in the gRPC Health Checking Protocol:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>To serve the status of each service registered in the server, we should manually register all the services, along with their status in the server. We also need to set the server’s overall status with an empty service name.</p>&#13;
</li>&#13;
<li>&#13;
<p>Each health check request from the client should have a deadline set to it, so the client can determine the server status as unhealthy if the RPC is not finished within the deadline period.</p>&#13;
</li>&#13;
<li>&#13;
<p>For each health check request, the client can either set a service name or set as empty. If the request has a service name and it is found in the server registry, a response must be sent back with an HTTP OK status and the status field of the <code>HealthCheckResponse</code> message should be set to the status of the particular service (either <code>SERVING</code> or <code>NOT_SERVING</code>). If the service is not found in the server registry, the server should respond with a <code>NOT_FOUND</code> status.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the client needs to query the overall status of the server instead of a specific service, the client can send the request with an empty string value so the server responds back with the server’s overall health status.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the server doesn’t have a health check API, then the client should deal with it themselves.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The health check services are consumed by other gRPC consumer or intermediate subsystems such as load balancers or proxies. Rather than implementing a client from scratch, you can use the existing implementation of health checking clients such as <code>grpc_health_probe</code>.<a data-startref="ix_ch08-asciidoc11" data-type="indexterm" id="idm46536628130728"/><a data-startref="ix_ch08-asciidoc10" data-type="indexterm" id="idm46536628130120"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC Health Probe" data-type="sect1"><div class="sect1" id="ch_08_sec_05">&#13;
<h1>gRPC Health Probe</h1>&#13;
&#13;
<p><a data-primary="ecosystem" data-secondary="grpc_health_probe" data-type="indexterm" id="idm46536628127944"/><a data-primary="grpc_health_probe" data-type="indexterm" id="idm46536628127096"/><a data-primary="health probe" data-type="indexterm" id="idm46536628126488"/>The <a href="https://oreil.ly/I84Ui"><code>grpc_health_probe</code></a> is a utility provided by the community to check the health status of a server that exposes its status as a service through the gRPC Health Checking Protocol. It’s a generic client that can communicate with the gRPC standard health check service.&#13;
You can use the <code>grpc_health_probe_</code> binary as a CLI utility as shown in the following:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code><code>grpc_health_probe</code><code> </code><code>-addr</code><code class="o">=</code><code>localhost:50051</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO7-1" id="co_the_grpc_ecosystem_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code>healthy:</code><code> </code><code>SERVING</code></pre>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code><code>grpc_health_probe</code><code> </code><code>-addr</code><code class="o">=</code><code>localhost:50052</code><code> </code><code>-connect-timeout</code><code> </code><code>600ms</code><code> </code><code class="se">\&#13;
</code><code> </code><code>-rpc-timeout</code><code> </code><code>300ms</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO7-2" id="co_the_grpc_ecosystem_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code>failed</code><code> </code><code>to</code><code> </code><code>connect</code><code> </code><code>service</code><code> </code><code>at</code><code> </code><code class="s2">"localhost:50052"</code><code>:</code><code> </code><code>context</code><code> </code><code>deadline</code><code> </code><code>exceeded</code><code>&#13;
</code><code class="nb">exit </code><code>status</code><code> </code><code>2</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO7-1" id="callout_the_grpc_ecosystem_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>A health checking request for gRPC server running on localhost port 50051.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO7-2" id="callout_the_grpc_ecosystem_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>A health checking request with few more additional parameters related to the connectivity.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As shown in the preceding CL output, <code>grpc_health_probe_</code> makes an RPC to <code>/grpc.health.v1.Health/Check</code>. If it then responds with a <code>SERVING</code> status, the <code>grpc_health_probe</code> will exit with success; otherwise, it exits with a nonzero exit code.</p>&#13;
&#13;
<p><a data-primary="Kubernetes" data-secondary="grpc_health_probe" data-type="indexterm" id="idm46536628062728"/>If you are running your gRPC applications on Kubernetes, then you can run the <code>grpc_health_probe</code> to check to define Kubernetes’s <a href="https://oreil.ly/a7bOC">liveness and readiness</a> checks for your gRPC server pods.</p>&#13;
&#13;
<p>For that, you can bundle the gRPC health probe along with your Docker image as shown following in the Dockerfile snippet:</p>&#13;
&#13;
<pre data-type="programlisting">RUN GRPC_HEALTH_PROBE_VERSION=v0.3.0 &amp;&amp; \&#13;
    wget -qO/bin/grpc_health_probe \&#13;
    https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/&#13;
            ${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 &amp;&amp; \&#13;
    chmod +x /bin/grpc_health_probe</pre>&#13;
&#13;
<p>Then in the Kubernetes deployment’s pod specification, you can define <code>livenessProbe</code> and/or <code>readinessProbe</code> like this:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">server</code><code>&#13;
</code><code>    </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">kasunindrasiri/grpc-productinfo-server</code><code class="s">"</code><code>&#13;
</code><code>    </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="nt">containerPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">50051</code><code>&#13;
</code><code>    </code><code class="nt">readinessProbe</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">exec</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">command</code><code class="p">:</code><code> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">/bin/grpc_health_probe</code><code class="s">"</code><code class="p-Indicator">,</code><code> </code><code class="s">"</code><code class="s">-addr=:50051</code><code class="s">"</code><code class="p-Indicator">]</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO8-1" id="co_the_grpc_ecosystem_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>      </code><code class="nt">initialDelaySeconds</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">5</code><code>&#13;
</code><code>    </code><code class="nt">livenessProbe</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">exec</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">command</code><code class="p">:</code><code> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">/bin/grpc_health_probe</code><code class="s">"</code><code class="p-Indicator">,</code><code> </code><code class="s">"</code><code class="s">-addr=:50051</code><code class="s">"</code><code class="p-Indicator">]</code><code> </code><a class="co" href="#callout_the_grpc_ecosystem_CO8-2" id="co_the_grpc_ecosystem_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>      </code><code class="nt">initialDelaySeconds</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">10</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO8-1" id="callout_the_grpc_ecosystem_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specify <code>grpc_health_probe</code> as the readiness probe.</p></dd>&#13;
<dt><a class="co" href="#co_the_grpc_ecosystem_CO8-2" id="callout_the_grpc_ecosystem_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Specify <code>grpc_health_probe</code> as the liveness probe.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When you have liveness and readiness probes set using the gRPC health probe, then Kubernetes can make decisions based on the health of your gRPC server.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Ecosystem Projects" data-type="sect1"><div class="sect1" id="idm46536628128920">&#13;
<h1>Other Ecosystem Projects</h1>&#13;
&#13;
<p>There are quite a few other ecosystem projects that can be useful when building gRPC-based applications. <a data-primary="protoc" data-type="indexterm" id="idm46536627943320"/>Customer <em>protoc</em> plugging is a similar ecosystem requirement where projects such as <a href="https://oreil.ly/9eRq8"><em>protoc-gen-star (PG*)</em></a> started getting some traction. Also, libraries such as <a href="https://oreil.ly/KlGy7"><em>protoc-gen-validate (PGV)</em></a> offer a protoc plug-in to generate polyglot message validators. The ecosystem has kept on growing with new projects for various requirements in gRPC application development.</p>&#13;
&#13;
<p>With this, we conclude our discussion of the gRPC ecosystem components. It’s important to keep in mind that these ecosystem projects are not part of the gRPC project. You need to evaluate them properly prior to using them in production. Also, these are subject to change: some projects may become obsolete, others may become mainstream, and other, completely new projects, may emerge in the gRPC ecosystem.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch_08_sec_06">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>As you can see, though gRPC ecosystem projects are not part of the core gRPC implementation, they can be quite useful in building and running gRPC applications for real-world use cases. These projects are built around gRPC to overcome problems or limitations encountered while building a production system using gRPC. For example, when we are moving our RESTful services to gRPC services, we need to consider our existing client who used to call our service in a RESTful manner. In order to overcome this issue, HTTP/JSON transcoding and gRPC gateway concepts are introduced, so that both existing RESTful clients and new gRPC clients can call the same service. Similarly, service reflection is introduced to overcome the limitation in testing gRPC services using a command-line tool.</p>&#13;
&#13;
<p>Since gRPC is a very popular topic in the cloud-native world and developers are now gradually moving toward gRPC from REST services, we will see more projects like these built around gRPC in the future.</p>&#13;
&#13;
<p>Congratulations! You have just completed reading <em>gRPC: Up and Running</em>, and have pretty much covered the entire development life cycle of the gRPC application along with numerous code examples based on Go and Java. We hope this book laid the foundation in the journey of using gRPC as an inter-process communication technology for your applications and microservices. What you learned in this book will help you to rapidly build gRPC applications, understand how they can coexist with other technologies, and run them in production.<a data-startref="ix_ch08-asciidoc0" data-type="indexterm" id="idm46536627915384"/></p>&#13;
&#13;
<p>So, it’s time to explore gRPC further. Try building real-world applications by applying the techniques that you learned in this book. There’s a significant amount of features of gRPC that are dependent on the programming language that you use to develop gRPC applications, so you will have to learn certain techniques that are specific to the language that you use. Also, the gRPC ecosystem is exponentially growing and it will be helpful to stay up to date on the latest technologies and frameworks that support gRPC. Go forth and explore!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>