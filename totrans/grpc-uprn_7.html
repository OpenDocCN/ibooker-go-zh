<html><head></head><body><section data-pdf-bookmark="Chapter 7. Running gRPC in Production" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_07">&#13;
<h1><span class="label">Chapter 7. </span>Running gRPC in Production</h1>&#13;
&#13;
&#13;
<p><a data-primary="production, running gRPC in" data-type="indexterm" id="ix_ch07-asciidoc0"/>In previous chapters, we focused on various aspects of designing and developing gRPC-based applications. Now, it’s time to dive into the details of running gRPC applications in production. In this chapter, we’ll discuss how you can develop unit testing or integration testing for your gRPC services and client as well as how you can integrate them with continuous integration tools. Then we’ll move into the continuous deployment of a gRPC application where we explore some deployment patterns on virtual machines (VMs), Docker, and Kubernetes. Finally, to operate your gRPC applications in production environments, you need to have a solid observability platform. This is where we will discuss different observability tools for gRPC applications and explore troubleshooting and debugging techniques for gRPC applications.&#13;
Let’s begin our discussion with testing these applications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing gRPC Applications" data-type="sect1"><div class="sect1" id="idm46536634423432">&#13;
<h1>Testing gRPC Applications</h1>&#13;
&#13;
<p><a data-primary="production, running gRPC in" data-secondary="testing gRPC applications" data-type="indexterm" id="ix_ch07-asciidoc1"/><a data-primary="testing" data-type="indexterm" id="ix_ch07-asciidoc2"/>Any software application that you develop (including gRPC applications) needs to have associated unit testing along with the application. As gRPC applications always interact with the network, the testing should also cover the network RPC aspect of both the server and client gRPC applications. We’ll start by testing the gRPC server.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing a gRPC Server" data-type="sect2"><div class="sect2" id="idm46536633554232">&#13;
<h2>Testing a gRPC Server</h2>&#13;
&#13;
<p><a data-primary="server" data-secondary="testing" data-type="indexterm" id="ix_ch07-asciidoc3"/><a data-primary="testing" data-secondary="testing a server" data-type="indexterm" id="ix_ch07-asciidoc4"/>gRPC service testing is often done using a gRPC client application as part of the test cases. The server-side testing consists of starting a gRPC server with the required gRPC service and then connecting to the server using the client application where you implement your test cases.&#13;
Let’s take a look at a sample test case written for the Go implementation of our <code>ProductInfo</code> service. In Go, the implementation of the gRPC test case should be implemented as a generic test case of Go using the <code>testing</code> package (see <a data-type="xref" href="#EX7-1">Example 7-1</a>).</p>&#13;
<div data-type="example" id="EX7-1">&#13;
<h5><span class="label">Example 7-1. </span>gRPC server-side test using Go</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="nx">TestServer_AddProduct</code><code class="p">(</code><code class="nx">t</code><code> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO1-1" id="co_running_grpc_in_production_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
	</code><code class="nx">grpcServer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">initGRPCServerHTTP2</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO1-2" id="co_running_grpc_in_production_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
	</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO1-3" id="co_running_grpc_in_production_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>           </code><code class="nx">grpcServer</code><code class="p">.</code><code class="nx">Stop</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>           </code><code class="nx">t</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">name</code><code> </code><code class="o">:=</code><code> </code><code class="s">"Sumsung S10"</code><code>&#13;
</code><code>	</code><code class="nx">description</code><code> </code><code class="o">:=</code><code> </code><code class="s">"Samsung Galaxy S10 is the latest smart phone, launched in&#13;
	February 2019"</code><code>&#13;
</code><code>	</code><code class="nx">price</code><code> </code><code class="o">:=</code><code> </code><code class="nb">float32</code><code class="p">(</code><code class="mf">700.0</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">cancel</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithTimeout</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Second</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">defer</code><code> </code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">r</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">c</code><code class="p">.</code><code class="nx">AddProduct</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">name</code><code class="p">,</code><code>&#13;
</code><code>	                                </code><code class="nx">Description</code><code class="p">:</code><code> </code><code class="nx">description</code><code class="p">,</code><code> </code><code class="nx">Price</code><code class="p">:</code><code> </code><code class="nx">price</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO1-4" id="co_running_grpc_in_production_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO1-5" id="co_running_grpc_in_production_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
		</code><code class="nx">t</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Could not add product: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="k">if</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Value</code><code> </code><code class="o">==</code><code> </code><code class="s">""</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"Invalid Product ID %s"</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Res %s"</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code>      </code><code class="nx">grpcServer</code><code class="p">.</code><code class="nx">Stop</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO1-1" id="callout_running_grpc_in_production_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Conventional test that starts a gRPC server and client to test the service with RPC.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO1-2" id="callout_running_grpc_in_production_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Starting a conventional gRPC server running on HTTP/2.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO1-3" id="callout_running_grpc_in_production_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Connecting to the server application.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO1-4" id="callout_running_grpc_in_production_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Sends RPC for <code>AddProduct</code> method.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO1-5" id="callout_running_grpc_in_production_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Verification of the response message.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As gRPC test cases are based on standard language test cases, the way in which you execute them will not be different from a standard test case. One special thing about the server-side gRPC tests is that they require the server application to open up a port the client application connects to. If you prefer not to do this, or your testing environment doesn’t allow it, you can use a library to help avoid starting up a service with a real port number. In Go, you can use the <a href="https://oreil.ly/gOq46"><code>bufconn</code> package</a>, which provides a <code>net.Conn</code> implemented by a buffer and related dialing and listening functionality. You can find the full code sample in the source code repository for this chapter.&#13;
If you are using Java you can use a test framework such as <em>JUnit</em> and follow the exact same procedure to write a server-side gRPC test. However, if you prefer to write the test case without starting a gRPC server instance, then you can use the gRPC in-process server of the Java implementation. You can find a complete Java code example for this in the code repository of this book.</p>&#13;
&#13;
<p>It is also possible to unit test the business logic of the remote functions that you develop without going through the RPC network layer. You can instead directly test the functions by invoking them without using a gRPC client.</p>&#13;
&#13;
<p>With this, we have learned how to write tests for gRPC services. Now let’s talk about how to test your gRPC client applications.<a data-startref="ix_ch07-asciidoc4" data-type="indexterm" id="idm46536634146872"/><a data-startref="ix_ch07-asciidoc3" data-type="indexterm" id="idm46536634146168"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing a gRPC Client" data-type="sect2"><div class="sect2" id="idm46536634145368">&#13;
<h2>Testing a gRPC Client</h2>&#13;
&#13;
<p><a data-primary="client" data-secondary="testing" data-type="indexterm" id="idm46536634143960"/><a data-primary="testing" data-secondary="testing a client" data-type="indexterm" id="idm46536634142984"/>When we are developing tests for a gRPC client, one of the possible approaches to testing would be to start a gRPC server and implement a mock service. However, this won’t be a very straightforward task as it will have the overhead of opening a port and connecting to a server. <a data-primary="mocking" data-type="indexterm" id="idm46536634141608"/>Therefore, to test client-side logic without the overhead of connecting to a real server, you can use a mocking framework. Mocking of the gRPC server side enables developers to write lightweight unit tests to check functionalities on the client side without invoking RPC calls to a server.</p>&#13;
&#13;
<p><a data-primary="Gomock" data-type="indexterm" id="idm46536634167208"/>If you are developing a gRPC client application with Go, you can use <a href="https://oreil.ly/8GAWB">Gomock</a> to mock the client interface (using the generated code) and programmatically set its methods to expect and return predetermined values. Using Gomock, you can generate mock interfaces for the gRPC client application using:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">mockgen</code> <code class="nx">github</code><code class="p">.</code><code class="nx">com</code><code class="o">/</code><code class="nx">grpc</code><code class="o">-</code><code class="nx">up</code><code class="o">-</code><code class="nx">and</code><code class="o">-</code><code class="nx">running</code><code class="o">/</code><code class="nx">samples</code><code class="o">/</code><code class="nx">ch07</code><code class="o">/</code><code class="nx">grpc</code><code class="o">-</code><code class="nx">docker</code><code class="o">/</code><code class="k">go</code><code class="o">/</code><code class="nx">proto</code><code class="o">-</code><code class="nx">gen</code> \&#13;
<code class="nx">ProductInfoClient</code> <code class="p">&gt;</code> <code class="nx">mock_prodinfo</code><code class="o">/</code><code class="nx">prodinfo_mock</code><code class="p">.</code><code class="k">go</code></pre>&#13;
&#13;
<p>Here, we’ve specified <code>ProductInfoClient</code> as the interface to be mocked. Then the test code you write can import the package generated by <code>mockgen</code> along with the <code>gomock</code> package to write unit tests around client-side logic. As shown in <a data-type="xref" href="#EX7-2">Example 7-2</a>, you can create a mock object to expect a call to its method and return a response.</p>&#13;
<div data-type="example" id="EX7-2">&#13;
<h5><span class="label">Example 7-2. </span>gRPC client-side test with Gomock</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="nx">TestAddProduct</code><code class="p">(</code><code class="nx">t</code><code> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">ctrl</code><code> </code><code class="o">:=</code><code> </code><code class="nx">gomock</code><code class="p">.</code><code class="nx">NewController</code><code class="p">(</code><code class="nx">t</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">defer</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Finish</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">mocklProdInfoClient</code><code> </code><code class="o">:=</code><code> </code><code class="nx">NewMockProductInfoClient</code><code class="p">(</code><code class="nx">ctrl</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO2-1" id="co_running_grpc_in_production_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
     </code><code class="o">...</code><code>&#13;
</code><code>	</code><code class="nx">req</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">name</code><code class="p">,</code><code> </code><code class="nx">Description</code><code class="p">:</code><code> </code><code class="nx">description</code><code class="p">,</code><code> </code><code class="nx">Price</code><code class="p">:</code><code> </code><code class="nx">price</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">mocklProdInfoClient</code><code class="p">.</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO2-2" id="co_running_grpc_in_production_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
	 </code><code class="nx">EXPECT</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">AddProduct</code><code class="p">(</code><code class="nx">gomock</code><code class="p">.</code><code class="nx">Any</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">rpcMsg</code><code class="p">{</code><code class="nx">msg</code><code class="p">:</code><code> </code><code class="nx">req</code><code class="p">}</code><code class="p">,</code><code class="p">)</code><code class="p">.</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO2-3" id="co_running_grpc_in_production_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
	 </code><code class="nx">Return</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code> </code><code class="s">"ABC123"</code><code> </code><code class="o">+</code><code> </code><code class="nx">name</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO2-4" id="co_running_grpc_in_production_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
	</code><code class="nx">testAddProduct</code><code class="p">(</code><code class="nx">t</code><code class="p">,</code><code> </code><code class="nx">mocklProdInfoClient</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO2-5" id="co_running_grpc_in_production_CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">testAddProduct</code><code class="p">(</code><code class="nx">t</code><code> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">,</code><code> </code><code class="nx">client</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">ProductInfoClient</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">cancel</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithTimeout</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Second</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">defer</code><code> </code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">r</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">AddProduct</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">name</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">Description</code><code class="p">:</code><code> </code><code class="nx">description</code><code class="p">,</code><code> </code><code class="nx">Price</code><code class="p">:</code><code> </code><code class="nx">price</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="c1">// test and verify response.&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO2-1" id="callout_running_grpc_in_production_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creating a mock object to expect calls to remote methods.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO2-2" id="callout_running_grpc_in_production_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Programming the mock object.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO2-3" id="callout_running_grpc_in_production_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Expect a call to the <code>AddProduct</code> method.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO2-4" id="callout_running_grpc_in_production_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Return a mock value for product ID.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO2-5" id="callout_running_grpc_in_production_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Call the actual test method that invokes the remote method of the client stub.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="Java" data-secondary="testing client application with Mockito" data-type="indexterm" id="idm46536634865608"/><a data-primary="Mockito" data-type="indexterm" id="idm46536632828552"/>If you are using Java, you can test the client application using <a href="https://site.mockito.org">Mockito</a> and the in-process server implementation for the Java implementation of gRPC. You can refer to the source code repository for more details of these samples.&#13;
Once you have the required server- and client-side testing in place you can integrate them with the continuous integration tools that you use.</p>&#13;
&#13;
<p>It is important to keep in mind that mocking gRPC servers will not give you the exact same behavior as with a real gRPC server. So certain capabilities may not be able to be verified via test unless you re-implement all the error logic present in gRPC servers. In practice, you can verify a selected set of capabilities via mocking and the rest needs to be verified against the actual gRPC server implementation.&#13;
Now let’s look at how you can do load testing and benchmarking of your gRPC applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Load Testing" data-type="sect2"><div class="sect2" id="idm46536632825688">&#13;
<h2>Load Testing</h2>&#13;
&#13;
<p><a data-primary="load testing" data-type="indexterm" id="idm46536632997672"/><a data-primary="testing" data-secondary="load testing" data-type="indexterm" id="idm46536632996968"/>It is difficult to conduct load testing and benchmarking for gRPC applications using conventional tools, as these applications are more or less bound to specific protocols such as HTTP. Therefore, for gRPC we need tailor-made load-testing tools that can load test the gRPC server by generating a virtual load of RPCs to the server.</p>&#13;
&#13;
<p><a data-primary="ghz (load-testing tool)" data-type="indexterm" id="idm46536632995288"/><a href="https://ghz.sh">ghz</a> is such a load-testing tool; it is implemented as a command-line utility using Go. It can be used for testing and debugging services locally, and also in automated continuous integration environments for performance regression testing.&#13;
For example, using ghz you can run a load test with the following command:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">ghz</code> <code class="o">--</code><code class="nx">insecure</code> \&#13;
  <code class="o">--</code><code class="nx">proto</code> <code class="p">.</code><code class="o">/</code><code class="nx">greeter</code><code class="p">.</code><code class="nx">proto</code> \&#13;
  <code class="o">--</code><code class="nx">call</code> <code class="nx">helloworld</code><code class="p">.</code><code class="nx">Greeter</code><code class="p">.</code><code class="nx">SayHello</code> \&#13;
  <code class="o">-</code><code class="nx">d</code> <code class="err">'</code><code class="p">{</code><code class="s">"name"</code><code class="p">:</code><code class="s">"Joe"</code><code class="p">}</code><code class="err">'</code>\&#13;
  <code class="o">-</code><code class="nx">n</code> <code class="mi">2000</code> \&#13;
  <code class="o">-</code><code class="nx">c</code> <code class="mi">20</code> \&#13;
&#13;
  <code class="mf">0.0.0.0</code><code class="p">:</code><code class="mi">50051</code></pre>&#13;
&#13;
<p>Here we invoke a <code>SayHello</code> remote method of the <code>Greeter</code> service insecurely. We can specify the total number of requests (<code>-n 2000</code>) and concurrency (20 threads). The results can also be generated in various output formats.</p>&#13;
&#13;
<p>Once you have the required server- and client-side testing in place, you can integrate them with the continuous integration tools that you use.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Continuous Integration" data-type="sect2"><div class="sect2" id="idm46536632808472">&#13;
<h2>Continuous Integration</h2>&#13;
&#13;
<p><a data-primary="CI (continuous integration)" data-type="indexterm" id="idm46536632807272"/><a data-primary="continuous integration (CI)" data-type="indexterm" id="idm46536632806408"/><a data-primary="testing" data-secondary="continuous integration" data-type="indexterm" id="idm46536632805736"/>If you are new to <em>continuous integration</em> (CI), it is a development practice that requires developers to frequently integrate code into a shared repository. During each check-in the code is then verified by an automated build, allowing teams to detect problems early. When it comes to gRPC applications, often the server- and client-side applications are independent and may be built with disparate technologies. So, as part of the CI process, you will have to verify the gRPC client- or server-side code using the unit and integration testing techniques that we learned in the previous section. Then based on the language that you use to build the gRPC application, you can integrate the testing (e.g., Go testing or Java JUnit) of those applications with the CI tool of your choice. For instance, if you have written tests using Go, then you can easily integrate your Go tests with tools such as <a href="https://jenkins.io">Jenkins</a>, <a href="https://travis-ci.com">TravisCI</a>, <a href="https://www.spinnaker.io">Spinnaker</a>, etc.</p>&#13;
&#13;
<p>Once you establish a testing and CI procedure for your gRPC application, the next thing that you need to look into is the deployment of your gRPC applications.<a data-startref="ix_ch07-asciidoc2" data-type="indexterm" id="idm46536632800776"/><a data-startref="ix_ch07-asciidoc1" data-type="indexterm" id="idm46536632800072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deployment" data-type="sect1"><div class="sect1" id="idm46536632799144">&#13;
<h1>Deployment</h1>&#13;
&#13;
<p><a data-primary="deployment of gRPC applications" data-type="indexterm" id="ix_ch07-asciidoc5"/><a data-primary="production, running gRPC in" data-secondary="deployment" data-type="indexterm" id="ix_ch07-asciidoc6"/>Now, let’s look into the different deployment methods for the gRPC applications that we develop. If you intend to run a gRPC server or client application locally or on VMs, the deployment merely depends on the binaries that you generate for the corresponding programming language of your gRPC application. For local or VM-based deployment, the scaling and high availability of gRPC server applications is usually achieved using standard deployment practices such as using load balancers that support the gRPC protocol.</p>&#13;
&#13;
<p>Most modern applications are now deployed as containers. Therefore, it’s quite useful to take a look at how you can deploy your gRPC applications on containers. Docker is the standard platform for container-based application deployment.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying on Docker" data-type="sect2"><div class="sect2" id="idm46536632794168">&#13;
<h2>Deploying on Docker</h2>&#13;
&#13;
<p><a data-primary="deployment of gRPC applications" data-secondary="on Docker" data-type="indexterm" id="ix_ch07-asciidoc7"/><a data-primary="Docker" data-type="indexterm" id="ix_ch07-asciidoc8"/><a href="https://www.docker.com">Docker</a> is an open platform for developing, shipping, and running applications. Using Docker, you can separate your applications from your infrastructure. It offers the ability to package and run an application in an isolated environment called a <em>container</em> so that you can run multiple containers on the same host. Containers are much more lightweight than conventional VMs and run directly within the host machine’s kernel.</p>&#13;
&#13;
<p>Let’s look at some examples of deploying a gRPC application as a Docker container.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The fundamentals of Docker are beyond the scope of this book. Hence, we recommend you refer to the <a href="https://docs.docker.com">Docker documentation</a> and other resources if you are not familiar with Docker.</p>&#13;
</div>&#13;
&#13;
<p>Once you develop a gRPC server application, you can create a Docker container for it. <a data-type="xref" href="#EX7-3">Example 7-3</a> shows a Dockerfile of a Go-based gRPC server. There are many gRPC-specific constructs in the Dockerfile. In this example, we have used a multistage Docker build where we build the application in stage 1, and then run the application in stage 2 as a much more lightweight runtime. The generated server-side code is also added into the container prior to building the application.</p>&#13;
<div data-type="example" id="EX7-3">&#13;
<h5><span class="label">Example 7-3. </span>Dockerfile for Go gRPC server</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="c"># Multistage build&#13;
</code><code>&#13;
</code><code class="c"># Build stage I: </code><a class="co" href="#callout_running_grpc_in_production_CO3-1" id="co_running_grpc_in_production_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="c">&#13;
</code><code>FROM</code><code> </code><code>golang</code><code> </code><code>AS</code><code> </code><code>build</code><code>&#13;
</code><code>ENV</code><code> </code><code>location</code><code> </code><code>/go/src/github.com/grpc-up-and-running/samples/ch07/grpc-docker/go</code><code>&#13;
</code><code>WORKDIR</code><code> </code><code class="si">${</code><code class="nv">location</code><code class="si">}</code><code>/server</code><code>&#13;
&#13;
</code><code>ADD</code><code> </code><code>./server</code><code> </code><code class="si">${</code><code class="nv">location</code><code class="si">}</code><code>/server</code><code>&#13;
</code><code>ADD</code><code> </code><code>./proto-gen</code><code> </code><code class="si">${</code><code class="nv">location</code><code class="si">}</code><code>/proto-gen</code><code>&#13;
&#13;
</code><code>RUN</code><code> </code><code>go</code><code> </code><code>get</code><code> </code><code>-d</code><code> </code><code>./...</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO3-2" id="co_running_grpc_in_production_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>RUN</code><code> </code><code>go</code><code> </code><code>install</code><code> </code><code>./...</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO3-3" id="co_running_grpc_in_production_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
</code><code>RUN</code><code> </code><code class="nv">CGO_ENABLED</code><code class="o">=</code><code class="m">0</code><code> </code><code>go</code><code> </code><code>build</code><code> </code><code>-o</code><code> </code><code>/bin/grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO3-4" id="co_running_grpc_in_production_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
</code><code class="c"># Build stage II: </code><a class="co" href="#callout_running_grpc_in_production_CO3-5" id="co_running_grpc_in_production_CO3-5"><img alt="5" src="assets/5.png"/></a><code class="c">&#13;
</code><code>FROM</code><code> </code><code>scratch</code><code>&#13;
</code><code>COPY</code><code> </code><code>--from</code><code class="o">=</code><code>build</code><code> </code><code>/bin/grpc-productinfo-server</code><code> </code><code>/bin/grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO3-6" id="co_running_grpc_in_production_CO3-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
</code><code>ENTRYPOINT</code><code> </code><code class="o">[</code><code class="s2">"/bin/grpc-productinfo-server"</code><code class="o">]</code><code>&#13;
</code><code>EXPOSE</code><code> </code><code>50051</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-1" id="callout_running_grpc_in_production_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Only the Go language and Alpine Linux is needed to build the program.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-2" id="callout_running_grpc_in_production_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Download all the dependencies.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-3" id="callout_running_grpc_in_production_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Install all the packages.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-4" id="callout_running_grpc_in_production_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Building the server application.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-5" id="callout_running_grpc_in_production_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Go binaries are self-contained executables.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO3-6" id="callout_running_grpc_in_production_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Copy the binary that we built in the previous stage to the new location.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once you create the Dockerfile you can build the Docker image using:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">docker image build -t grpc-productinfo-server -f server/Dockerfile</pre>&#13;
&#13;
<p>The gRPC client application can be created using the same approach.  One exception here is that, since we are running our server application on Docker, the hostname and port that the client application uses to connect to gRPC is now different.</p>&#13;
&#13;
<p>When we run both the server and client gRPC applications on Docker, they need to communicate with each other and the outside world via the host machine. So there has to be a layer of networking involved. Docker supports different types of networks, each fit for certain use cases. So, when we run the server and client Docker containers, we can specify a common network so that the client application can discover the location of the server application based on the hostname. This means that the client application code has to change so that it connects to the hostname of the server. For example, our Go gRPC application must be modified to call the service hostname instead of localhost:</p>&#13;
&#13;
<pre data-code-language="sh" data-type="programlisting">conn, err :<code class="o">=</code> grpc.Dial<code class="o">(</code><code class="s2">"productinfo:50051"</code>, grpc.WithInsecure<code class="o">())</code></pre>&#13;
&#13;
<p>You may read the hostname from the environment rather than hardcoding it in your client application. Once you are done with the changes to the client application, you need to rebuild the Docker image and then run both the server and client images as shown here:</p>&#13;
&#13;
<pre data-code-language="sh" data-type="programlisting"><code>docker</code><code> </code><code>run</code><code> </code><code>-it</code><code> </code><code>--network</code><code class="o">=</code><code>my-net</code><code> </code><code>--name</code><code class="o">=</code><code>productinfo</code><code> </code><code class="se">\&#13;
</code><code>    </code><code>--hostname</code><code class="o">=</code><code>productinfo</code><code>&#13;
    </code><code>-p</code><code> </code><code>50051:50051</code><code>  </code><code>grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO4-1" id="co_running_grpc_in_production_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code>docker</code><code> </code><code>run</code><code> </code><code>-it</code><code> </code><code>--network</code><code class="o">=</code><code>my-net</code><code> </code><code class="se">\&#13;
</code><code>    </code><code>--hostname</code><code class="o">=</code><code>client</code><code> </code><code>grpc-productinfo-client</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO4-2" id="co_running_grpc_in_production_CO4-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO4-1" id="callout_running_grpc_in_production_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Running the gRPC server with hostname <code>productinfo</code>, port 50051 on Docker network <em>my-net</em>.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO4-2" id="callout_running_grpc_in_production_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Running the gRPC client on Docker network <em>my-net</em>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When starting Docker containers, you can specify a Docker network that a given container runs on. If the service shares the same network, then the client application can discover the actual address of the host service using the hostname provided along with the <code>docker run</code> command.</p>&#13;
&#13;
<p>When the number of containers you run is small and their interactions are relatively simple, then you can possibly build your solution entirely on Docker. However, most real-world scenarios require the management of multiple containers and their interactions. Building such solutions solely based on Docker is quite tedious. That’s where a container orchestration platform comes into the picture.<a data-startref="ix_ch07-asciidoc8" data-type="indexterm" id="idm46536632554936"/><a data-startref="ix_ch07-asciidoc7" data-type="indexterm" id="idm46536632554232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying on Kubernetes" data-type="sect2"><div class="sect2" id="idm46536632793544">&#13;
<h2>Deploying on Kubernetes</h2>&#13;
&#13;
<p><a data-primary="deployment of gRPC applications" data-secondary="on Kubernetes" data-type="indexterm" id="ix_ch07-asciidoc9"/><a data-primary="Kubernetes" data-secondary="deployment on" data-type="indexterm" id="ix_ch07-asciidoc10"/>Kubernetes is an open source platform for automating deployment, scaling, and management of containerized applications. When you run a containerized gRPC application using Docker, there’s no scalability or high-availability guarantee provided out of the box. You need to build those things outside the Docker containers. Kubernetes provides a wide range of such capabilities, so that you can offload most container-management and orchestration tasks to the underlying Kubernetes platform.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a href="https://kubernetes.io">Kubernetes</a> provides a reliable and scalable platform for running containerized workloads. Kubernetes takes care of scaling requirements, failover, service, discovery, configuration management, security, deployment patterns, and much more.</p>&#13;
&#13;
<p>The fundamentals of Kubernetes are beyond the scope of this book. Hence, we recommend that you refer to the <a href="https://oreil.ly/csW_8">Kubernetes documentation</a> and other such resources to learn more.</p>&#13;
</div>&#13;
&#13;
<p>Let’s look at how your gRPC server application can be deployed into Kubernetes.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes deployment resource for a gRPC server" data-type="sect3"><div class="sect3" id="idm46536632522872">&#13;
<h3>Kubernetes deployment resource for a gRPC server</h3>&#13;
&#13;
<p><a data-primary="Kubernetes" data-secondary="deployment resource for a gRPC server" data-type="indexterm" id="idm46536632521624"/><a data-primary="server" data-secondary="Kubernetes deployment resource for" data-type="indexterm" id="idm46536632520776"/>To deploy in Kubernetes, the first thing you need to do is create a Docker container for your gRPC server application. We did exactly this in the previous section, and you can use the same container here. You can push the container image to a container registry such as Docker Hub.</p>&#13;
&#13;
<p>For this example, we have pushed the gRPC server Docker image to Docker Hub under the tag <code>kasunindrasiri/grpc-productinfo-server</code>. <a data-primary="Kubernetes Pod" data-type="indexterm" id="idm46536632518392"/><a data-primary="pods" data-type="indexterm" id="idm46536632517784"/>The Kubernetes platform doesn’t directly manage containers, rather, it uses an abstraction called <em>pods</em>. A pod is a logical unit that may contain one or more containers; it is the unit of replication in Kubernetes. For example, if you need multiple instances of the gRPC server application, then Kubernetes will create more pods. The containers running on a given pod share the same resources and local network. However, in our case, we only need to run a gRPC server container in our pod. So, it’s a pod with a single container. <a data-primary="deployment (Kubernetes abstraction)" data-type="indexterm" id="idm46536632516104"/><a data-primary="Kubernetes Deployment" data-type="indexterm" id="idm46536632515496"/>Kubernetes doesn’t manage pods directly. Rather, it uses another abstraction called a <em>deployment</em>. A deployment specifies the number of pods that should be running at a time. When a new deployment is created, Kubernetes spins up the number of pods specified in the deployment.</p>&#13;
&#13;
<p>To deploy our gRPC server application in Kubernetes, we need to create a Kubernetes deployment using the YAML descriptor shown in <a data-type="xref" href="#EX7-4">Example 7-4</a>.</p>&#13;
<div data-type="example" id="EX7-4">&#13;
<h5><span class="label">Example 7-4. </span>Kubernetes deployment descriptor of a Go gRPC server application</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apps/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Deployment</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO5-1" id="co_running_grpc_in_production_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO5-2" id="co_running_grpc_in_production_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">replicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO5-3" id="co_running_grpc_in_production_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">matchLabels</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-server</code><code>&#13;
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-server</code><code>&#13;
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO5-4" id="co_running_grpc_in_production_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">kasunindrasiri/grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO5-5" id="co_running_grpc_in_production_CO5-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="nt">resources</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">limits</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">memory</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">128Mi</code><code class="s">"</code><code>&#13;
</code><code>            </code><code class="nt">cpu</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">500m</code><code class="s">"</code><code>&#13;
</code><code>        </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="p-Indicator">-</code><code> </code><code class="nt">containerPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">50051</code><code>&#13;
</code><code>          </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO5-1" id="callout_running_grpc_in_production_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Declaring a Kubernetes <code>Deployment</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO5-2" id="callout_running_grpc_in_production_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Name of the deployment.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO5-3" id="callout_running_grpc_in_production_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Number of gRPC server pods that should be running at a time.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO5-4" id="callout_running_grpc_in_production_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Name of the associated gRPC server container.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO5-5" id="callout_running_grpc_in_production_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Image name and tag of the gRPC server container.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When you apply this descriptor in Kubernetes using <code>kubectl apply -f server/grpc-prodinfo-server.yaml</code>, you get a Kubernetes deployment of one gRPC server pod running in your Kubernetes cluster.&#13;
However, if the gRPC client application has to access a gRPC server pod running in the same Kubernetes cluster, it has to find out the exact IP address and port of the pod and send the RPC. However, the IP address may change when the pod gets restarted, and if you are running multiple replicas you have to deal with multiple IP addresses of each replica. <a data-primary="Service (Kubernetes abstraction)" data-type="indexterm" id="idm46536632364056"/>To overcome this limitation, Kubernetes provides an abstraction called a <em>service</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes service resource for a gRPC server" data-type="sect3"><div class="sect3" id="idm46536632362808">&#13;
<h3>Kubernetes service resource for a gRPC server</h3>&#13;
&#13;
<p><a data-primary="Kubernetes" data-secondary="service resource for a gRPC server" data-type="indexterm" id="idm46536632361560"/><a data-primary="Kubernetes Service" data-type="indexterm" id="idm46536632360712"/><a data-primary="server" data-secondary="Kubernetes Service resource for a gRPC server" data-type="indexterm" id="idm46536632360104"/>You can create a Kubernetes service and associate it with the matching pods (gRPC server pods in this case) and you will get a DNS name that will automatically route the traffic to any matching pod. So, you can think of a service as a web proxy or a load balancer that forwards the requests to the underlying pods. <a data-type="xref" href="#EX7-5">Example 7-5</a> shows the Kubernetes service descriptor for the gRPC server application.</p>&#13;
<div data-type="example" id="EX7-5">&#13;
<h5><span class="label">Example 7-5. </span>Kubernetes service descriptor of a Go gRPC server application</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Service</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO6-1" id="co_running_grpc_in_production_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">productinfo</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO6-2" id="co_running_grpc_in_production_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-server</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO6-3" id="co_running_grpc_in_production_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>  </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">port</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">50051</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO6-4" id="co_running_grpc_in_production_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="nt">targetPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">50051</code><code>&#13;
</code><code>    </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc</code><code>&#13;
</code><code>  </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">NodePort</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO6-1" id="callout_running_grpc_in_production_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifying a <code>Service</code> descriptor.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO6-2" id="callout_running_grpc_in_production_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Name of the service. This will be used by the client application when connecting to the service.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO6-3" id="callout_running_grpc_in_production_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This tells the service to route requests to the pods for matching label <code>grpc-productinfo-server</code>.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO6-4" id="callout_running_grpc_in_production_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Service runs on port 50051 and forwards the requests to target port 50051.</p></dd>&#13;
</dl>&#13;
&#13;
<p>So, once you have created both the <code>Deployment</code> and <code>Service</code> descriptor, you can deploy this application into Kubernetes using <code>kubectl apply -f server/grpc-prodinfo-server.yaml</code> (you can have both descriptors in the same YAML file). A successful deployment of these objects should give you a running gRPC server pod, a Kubernetes service for a gRPC server, and a deployment.</p>&#13;
&#13;
<p>The next step is deploying the gRPC client into Kubernetes cluster.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes Job for running a gRPC Client" data-type="sect3"><div class="sect3" id="idm46536632260520">&#13;
<h3>Kubernetes Job for running a gRPC Client</h3>&#13;
&#13;
<p><a data-primary="client" data-secondary="Kubernetes Job for running" data-type="indexterm" id="idm46536632259272"/><a data-primary="Kubernetes" data-secondary="job for running a gRPC client" data-type="indexterm" id="idm46536632258200"/>When you have the gRPC server up and running on the Kubernetes cluster, then you can also run the gRPC client application in the same cluster. The client can access the gRPC server via the gRPC service <code>productinfo</code> that we created in the previous step. So from the client’s code, you should refer to the Kubernetes service name as the hostname and use the service port as the port name of the gRPC server. Therefore, the client will be using <code>grpc.Dial("productinfo:50051", grpc.WithInsecure())</code> when connecting to the server in the Go implementation of the client. If we assume that our client application needs to run a specified number of times (i.e., just calls the gRPC service, logs the response, and exits), then rather than using a Kubernetes Deployment, we may use a <a data-primary="Kubernetes Job" data-type="indexterm" id="idm46536632255688"/>Kubernetes <em>job</em>. A Kubernetes job is designed to run a Pod a specified number of times.</p>&#13;
&#13;
<p>You can create the client application container the same way we did in the gRPC server. Once you have the container pushed into the Docker registry, then you can specify the Kubernetes <code>Job</code> descriptor as shown in <a data-type="xref" href="#EX7-6">Example 7-6</a>.</p>&#13;
<div data-type="example" id="EX7-6">&#13;
<h5><span class="label">Example 7-6. </span>gRPC client application runs as a Kubernetes job</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">batch/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Job</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-1" id="co_running_grpc_in_production_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-client</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-2" id="co_running_grpc_in_production_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">completions</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-3" id="co_running_grpc_in_production_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>  </code><code class="nt">parallelism</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-4" id="co_running_grpc_in_production_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-productinfo-client</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-5" id="co_running_grpc_in_production_CO7-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">kasunindrasiri/grpc-productinfo-client</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO7-6" id="co_running_grpc_in_production_CO7-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>      </code><code class="nt">restartPolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Never</code><code>&#13;
</code><code>  </code><code class="nt">backoffLimit</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">4</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-1" id="callout_running_grpc_in_production_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifying a Kubernetes <code>Job</code>.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-2" id="callout_running_grpc_in_production_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Name of the job.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-3" id="callout_running_grpc_in_production_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Number of times that the pod needs to run successfully before the job is considered completed.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-4" id="callout_running_grpc_in_production_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>How many pods should run in parallel.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-5" id="callout_running_grpc_in_production_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Name of the associated gRPC client container.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO7-6" id="callout_running_grpc_in_production_CO7-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Container image that this job is associated with.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Then you can deploy the Job for the gRPC client application using <code>kubectl apply -f client/grpc-prodinfo-client-job.yaml</code> and check the status of the pod.</p>&#13;
&#13;
<p>Successful completion of the execution of this Job sends an RPC to add a product in our <code>ProductInfo</code> gRPC service. So you can observe the logs for both server and client pods to see whether we get the expected information.</p>&#13;
&#13;
<p>Then we can proceed to exposing your gRPC services outside the Kubernetes cluster using ingress resources.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes Ingress for exposing a gRPC service externally" data-type="sect3"><div class="sect3" id="idm46536632135512">&#13;
<h3>Kubernetes Ingress for exposing a gRPC service externally</h3>&#13;
&#13;
<p><a data-primary="Kubernetes" data-secondary="ingress for exposing a gRPC service externally" data-type="indexterm" id="ix_ch07-asciidoc11"/><a data-primary="Kubernetes Ingress" data-type="indexterm" id="ix_ch07-asciidoc12"/><a data-primary="server" data-secondary="Kubernetes Ingress for exposing a gRPC service externally" data-type="indexterm" id="ix_ch07-asciidoc13"/>So far what we have done is deploy a gRPC server on Kubernetes and make it accessible to another pod (which is running as a Job) running in the same cluster. What if we want to expose the gRPC service to the external applications outside the Kubernetes cluster? As you learned, the Kubernetes service construct is only meant to expose given Kubernetes pods to the other pods running in the cluster. So, the Kubernetes service is not accessible by the external applications that are outside the Kubernetes cluster. Kubernetes gives another abstraction called an <em>ingress</em> to serve this purpose.</p>&#13;
&#13;
<p>We can think of an ingress as a load balancer that sits between the Kubernetes service and the external applications. <code>Ingress</code> routes the external traffic to the service; the service then routes the internal traffic between the matching pods. An ingress controller manages the ingress resource in a given Kubernetes cluster. The type and the behavior of the ingress controller may change based on the cluster you use. Also, when you expose a gRPC service to the external application, one of the mandatory requirements is to support gRPC routing at the ingress level. Therefore, we need to select an ingress controller that supports gRPC.</p>&#13;
&#13;
<p><a data-primary="Nginx" data-type="indexterm" id="idm46536632128280"/>For this example, we’ll use the <a href="https://oreil.ly/0UC0a">Nginx</a> ingress controller, which is based on the <a href="https://www.nginx.com">Nginx</a> load balancer. (Based on the Kubernetes cluster you use, you may select the most appropriate ingress controller that <span class="keep-together">supports</span> gRPC.)  <a href="https://oreil.ly/wZo5w">Nginx Ingress</a> supports gRPC for routing external traffic into internal services.</p>&#13;
&#13;
<p>So, to expose our <code>ProductInfo</code> gRPC server application to the external world (i.e., outside the Kubernetes cluster), we can create an <code>Ingress</code> resource as shown in <a data-type="xref" href="#EX7-7">Example 7-7</a>.</p>&#13;
<div data-type="example" id="EX7-7">&#13;
<h5><span class="label">Example 7-7. </span>Kubernetes Ingress resource of a Go gRPC server application</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">extensions/v1beta1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Ingress</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-1" id="co_running_grpc_in_production_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">annotations</code><code class="p">:</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-2" id="co_running_grpc_in_production_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="nt">kubernetes.io/ingress.class</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">nginx</code><code class="s">"</code><code>&#13;
</code><code>    </code><code class="nt">nginx.ingress.kubernetes.io/ssl-redirect</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">false</code><code class="s">"</code><code>&#13;
</code><code>    </code><code class="nt">nginx.ingress.kubernetes.io/backend-protocol</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">GRPC</code><code class="s">"</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc-prodinfo-ingress</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-3" id="co_running_grpc_in_production_CO8-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">rules</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">host</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">productinfo</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-4" id="co_running_grpc_in_production_CO8-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="nt">http</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">paths</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="p-Indicator">-</code><code> </code><code class="nt">backend</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">serviceName</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">productinfo</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-5" id="co_running_grpc_in_production_CO8-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>          </code><code class="nt">servicePort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">grpc</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO8-6" id="co_running_grpc_in_production_CO8-6"><img alt="6" src="assets/6.png"/></a></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-1" id="callout_running_grpc_in_production_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifying an <code>Ingress</code> resource.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-2" id="callout_running_grpc_in_production_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Annotations related to Nginx Ingress controller and specifying gRPC as the backend protocol.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-3" id="callout_running_grpc_in_production_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Name of the <code>Ingress</code> resource.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-4" id="callout_running_grpc_in_production_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This is the hostname exposed to the external world.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-5" id="callout_running_grpc_in_production_CO8-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Name of the associated Kubernetes service.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO8-6" id="callout_running_grpc_in_production_CO8-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Name of the service port specified in the Kubernetes service.</p></dd>&#13;
</dl>&#13;
&#13;
<p>You will need to install the Nginx Ingress controller prior to deploying the preceding ingress resource. You can find more details on installing and using the Nginx Ingress with gRPC in the <a href="https://oreil.ly/l-vFp">Ingress-Nginx</a> repository of Kubernetes. Once you deploy this <code>Ingress</code> resource, any external application can invoke the gRPC server via the hostname (<code>productinfo</code>) and the default port (80).<a data-startref="ix_ch07-asciidoc13" data-type="indexterm" id="idm46536631990824"/><a data-startref="ix_ch07-asciidoc12" data-type="indexterm" id="idm46536631990216"/><a data-startref="ix_ch07-asciidoc11" data-type="indexterm" id="idm46536631989608"/></p>&#13;
&#13;
<p>With that, you have learned all the fundamentals related to deploying a production-ready gRPC application on Kubernetes. As you have seen, owing to the capabilities that Kubernetes and Docker offer, we don’t really have to worry much about most nonfunctional requirements such as scalability, high availability, load balancing, failover, etc., because Kubernetes is providing them as part of the underlying platform. Hence, certain concepts that we learned in <a data-type="xref" href="ch06.html#ch_06">Chapter 6</a>, such as load balancing, name resolving at the gRPC code level, etc., are not required if you are running your gRPC applications on Kubernetes<a data-startref="ix_ch07-asciidoc10" data-type="indexterm" id="idm46536631987240"/><a data-startref="ix_ch07-asciidoc9" data-type="indexterm" id="idm46536631986632"/>.<a data-startref="ix_ch07-asciidoc6" data-type="indexterm" id="idm46536631985896"/><a data-startref="ix_ch07-asciidoc5" data-type="indexterm" id="idm46536631985288"/></p>&#13;
&#13;
<p>Once you have a gRPC-based application up and running, you need to ensure the smooth operation of the application in production. To accomplish that goal, you need to consistently observe your gRPC application and take the necessary actions when required. Let’s look into the details of the observability aspects of gRPC applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Observability" data-type="sect1"><div class="sect1" id="ch_07_sec_03">&#13;
<h1>Observability</h1>&#13;
&#13;
<p><a data-primary="containers" data-seealso="Docker; Kubernetes" data-type="indexterm" id="ix_ch07-asciidoc14"/><a data-primary="observability" data-type="indexterm" id="ix_ch07-asciidoc15"/><a data-primary="production, running gRPC in" data-secondary="observability" data-type="indexterm" id="ix_ch07-asciidoc16"/>As we discussed in the previous section, gRPC applications are normally deployed and run in containerized environments where there are multiples of such containers running and talking to each other over the network. Then comes the problem of how to keep track of each container and make sure they are actually working. This is where <em>observability</em> comes into the picture.</p>&#13;
&#13;
<p><a data-primary="observability" data-secondary="defined" data-type="indexterm" id="idm46536631978312"/>As the <a href="https://oreil.ly/FVPTN">Wikipedia definition</a> states, “observability is a measure of how well internal states of a system can be inferred from knowledge of its external outputs.” Basically, the purpose of having observability into a system is to answer the question, “Is anything wrong in the system right now?” If the answer is yes, we should also be able to answer a bunch of other questions like “What is wrong?” and “Why is it happening?” If we can answer those questions at any given time and in any part of the system, we can say that our system is observable.</p>&#13;
&#13;
<p>It is also important to note that observability is an attribute of a system that is as important as efficiency, usability, and reliability. So it must be considered from the beginning when we are building gRPC applications.</p>&#13;
&#13;
<p>When talking about observability, there are three main pillars that we normally talk about: metrics, logging, and tracing. These are the main techniques used to gain the observability of the system. Let’s discuss each of them separately in the following <span class="keep-together">sections.</span></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Metrics" data-type="sect2"><div class="sect2" id="idm46536631974248">&#13;
<h2>Metrics</h2>&#13;
&#13;
<p><em>Metrics</em> are a <a data-primary="metrics" data-secondary="observability and" data-type="indexterm" id="ix_ch07-asciidoc17"/><a data-primary="observability" data-secondary="metrics" data-type="indexterm" id="ix_ch07-asciidoc18"/>numeric representation of data measured over intervals of time. When talking about metrics, there are two types of data we can collect. One is system-level metrics like CPU usage, memory usage, etc. The other one is application-level metrics like inbound request rate, request error rate, etc.</p>&#13;
&#13;
<p><a data-primary="system-level metrics" data-type="indexterm" id="idm46536631969752"/>System-level metrics are normally captured when the application is running. These days, there are lots of tools to capture those metrics, and they’re usually captured by the DevOps team. <a data-primary="application-level metrics" data-type="indexterm" id="idm46536631968808"/>But application-level metrics differ between applications. So when designing a new application, it is the task of an application developer to decide what kind of application-level metrics need to be captured to get an understanding of the behavior of a system. In this section, we are going to focus on how to enable application-level metrics in our applications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="OpenCensus with gRPC" data-type="sect3"><div class="sect3" id="idm46536631967560">&#13;
<h3>OpenCensus with gRPC</h3>&#13;
&#13;
<p><a data-primary="metrics" data-secondary="OpenCensus with gRPC" data-type="indexterm" id="ix_ch07-asciidoc19"/><a data-primary="OpenCensus" data-secondary="metrics provided by" data-type="indexterm" id="ix_ch07-asciidoc20"/>For gRPC applications, there are standard metrics that are provided by the <a href="https://oreil.ly/EMfF-">OpenCensus</a> library. We can easily enable them by adding handlers to both the client and server applications. We can also add our own metrics collector (<a data-type="xref" href="#EX7-8">Example 7-8</a>).</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a href="https://opencensus.io">OpenCensus</a> is a set of open source libraries for collecting application metrics and distributed traces; it supports various languages. It collects metrics from the target application and transfers the data to the backend of your choice in real time. Supported backends currently available include Azure Monitor, Datadog, Instana, Jaeger, SignalFX, Stackdriver, and Zipkin. We can also write our own exporter for other backends.</p>&#13;
</div>&#13;
<div data-type="example" id="EX7-8">&#13;
<h5><span class="label">Example 7-8. </span>Enable OpenCensus monitoring for the gRPC Go server</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"errors"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net"</code><code>&#13;
</code><code>  </code><code class="s">"net/http"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/plugin/ocgrpc"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-1" id="co_running_grpc_in_production_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"go.opencensus.io/stats/view"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/zpages"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/examples/exporter"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">const</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">port</code><code> </code><code class="p">=</code><code> </code><code class="s">":50051"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// server is used to implement ecommerce/product_info.&#13;
</code><code class="kd">type</code><code> </code><code class="nx">server</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">productMap</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">go</code><code> </code><code class="kd">func</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-7" id="co_running_grpc_in_production_CO9-2"><img alt="7" src="assets/7.png"/></a><code>&#13;
     </code><code class="nx">mux</code><code> </code><code class="o">:=</code><code> </code><code class="nx">http</code><code class="p">.</code><code class="nx">NewServeMux</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>     </code><code class="nx">zpages</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="nx">mux</code><code class="p">,</code><code> </code><code class="s">"/debug"</code><code class="p">)</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="s">"127.0.0.1:8081"</code><code class="p">,</code><code> </code><code class="nx">mux</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>   </code><code class="nx">view</code><code class="p">.</code><code class="nx">RegisterExporter</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">exporter</code><code class="p">.</code><code class="nx">PrintExporter</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-2" id="co_running_grpc_in_production_CO9-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">view</code><code class="p">.</code><code class="nx">Register</code><code class="p">(</code><code class="nx">ocgrpc</code><code class="p">.</code><code class="nx">DefaultServerViews</code><code class="o">...</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-3" id="co_running_grpc_in_production_CO9-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">grpcServer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">StatsHandler</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">ocgrpc</code><code class="p">.</code><code class="nx">ServerHandler</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-4" id="co_running_grpc_in_production_CO9-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">grpcServer</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-5" id="co_running_grpc_in_production_CO9-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
&#13;
  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpcServer</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO9-6" id="co_running_grpc_in_production_CO9-7"><img alt="6" src="assets/6.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-1" id="callout_running_grpc_in_production_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specify external libraries we need to add to enable monitoring. gRPC OpenCensus provides a predefined set of handlers to support OpenCensus monitoring. Here we are going to use those handlers.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-3" id="callout_running_grpc_in_production_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Register stat exporters to export the collected data. Here we add <code>PrintExporter</code> and it logs exported data to the console. This is only for demonstration purposes; normally it’s not recommended that you log all production loads.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-4" id="callout_running_grpc_in_production_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Register the views to collect the server request count. These are the predefined default service views that collect received bytes per RPC, sent bytes per RPC, latency per RPC, and completed RPC. We can write our own views to collect data.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-5" id="callout_running_grpc_in_production_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Create a gRPC server with a stats handler.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-6" id="callout_running_grpc_in_production_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Register our <code>ProductInfo</code> service to the gRPC server.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-7" id="callout_running_grpc_in_production_CO9-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Start listening to incoming messages on the port (50051).</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO9-2" id="callout_running_grpc_in_production_CO9-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Starts a z-Pages server. An HTTP endpoint starts with the context of <code>/debug</code> in port 8081 for metrics visualization.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similar to the gRPC server, we can enable OpenCensus monitoring in gRPC clients using client-side handlers. <a data-primary="Go" data-secondary="metrics handler code" data-type="indexterm" id="idm46536631678888"/><a data-type="xref" href="#EX7-9">Example 7-9</a> provides the code snippet for adding a metrics handler to a gRPC client written in Go.</p>&#13;
<div data-type="example" id="EX7-9">&#13;
<h5><span class="label">Example 7-9. </span>Enable OpenCensus monitoring for the gRPC Go server</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"context"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"time"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/plugin/ocgrpc"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-1" id="co_running_grpc_in_production_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"go.opencensus.io/stats/view"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/examples/exporter"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">const</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">view</code><code class="p">.</code><code class="nx">RegisterExporter</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">exporter</code><code class="p">.</code><code class="nx">PrintExporter</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-2" id="co_running_grpc_in_production_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
   </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">view</code><code class="p">.</code><code class="nx">Register</code><code class="p">(</code><code class="nx">ocgrpc</code><code class="p">.</code><code class="nx">DefaultClientViews</code><code class="o">...</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-3" id="co_running_grpc_in_production_CO10-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
       </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>   </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-4" id="co_running_grpc_in_production_CO10-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
        </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithStatsHandler</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">ocgrpc</code><code class="p">.</code><code class="nx">ClientHandler</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Can't connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-6" id="co_running_grpc_in_production_CO10-5"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO10-5" id="co_running_grpc_in_production_CO10-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
&#13;
  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip RPC method invocation.&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-1" id="callout_running_grpc_in_production_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specify external libraries we need to add to enable monitoring.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-2" id="callout_running_grpc_in_production_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Register stats and trace exporters to export the collected data. Here we will add <code>PrintExporter</code>, which logs exported data to the console. This is only for demonstration purposes. Normally it is not recommended to log all production loads.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-3" id="callout_running_grpc_in_production_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Register the views to collect server request count. These are the predefined default service views that collect received bytes per RPC, sent bytes per RPC, latency per RPC, and completed RPC. We can write our own views to collect data.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-4" id="callout_running_grpc_in_production_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Set up a connection to the server with client stats handlers.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-6" id="callout_running_grpc_in_production_CO10-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Create a client stub using the server connection.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO10-5" id="callout_running_grpc_in_production_CO10-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Close the connection when everything is done.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we run the server and client, we can access the server and client metrics through the created HTTP endpoint (e.g., RPC metrics on <a href="http://localhost:8081/debug/rpcz"><em class="hyperlink">http://localhost:8081/debug/rpcz</em></a> and traces on <a href="http://localhost:8081/debug/tracez)"><em class="hyperlink">http://localhost:8081/debug/tracez)</em></a>.</p>&#13;
&#13;
<p>As mentioned before, we can use predefined exporters to publish data to the supported backend or we can write our own exporter to send traces and metrics to any backend that is capable of consuming them.<a data-startref="ix_ch07-asciidoc20" data-type="indexterm" id="idm46536631383928"/><a data-startref="ix_ch07-asciidoc19" data-type="indexterm" id="idm46536631383320"/></p>&#13;
&#13;
<p>In the next section we’ll discuss another popular technology, <a href="https://prometheus.io">Prometheus</a>, which is commonly used for enabling metrics for gRPC applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Prometheus with gRPC" data-type="sect3"><div class="sect3" id="idm46536631966968">&#13;
<h3>Prometheus with gRPC</h3>&#13;
&#13;
<p><a data-primary="metrics" data-secondary="Prometheus with gRPC" data-type="indexterm" id="ix_ch07-asciidoc21"/><a data-primary="Prometheus" data-type="indexterm" id="ix_ch07-asciidoc22"/>Prometheus is an open source toolkit for system monitoring and alerting. You can use Prometheus for enabling metrics for your gRPC application using the <a href="https://oreil.ly/nm84_">gRPC Prometheus library</a>. We can easily enable this by adding an interceptor to both the client and server applications and we can also add our own metrics collector, too.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Prometheus collects metrics from the target application by calling an HTTP endpoint that starts with the context <code>/metrics</code>. It stores all collected data and runs rules over this data to either aggregate and record new time series from existing data or generate alerts. We can visualize those aggregated results using tools like <a href="https://grafana.com">Grafana</a>.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="Go" data-secondary="metrics interceptor code" data-type="indexterm" id="idm46536631374616"/><a data-type="xref" href="#EX7-10">Example 7-10</a> illustrates how to add a metrics interceptor and a custom metrics collector to our product management server written in Go.</p>&#13;
<div data-type="example" id="EX7-10">&#13;
<h5><span class="label">Example 7-10. </span>Enable Prometheus monitoring for the gRPC Go server</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="o">...</code><code>&#13;
</code><code>  </code><code class="s">"github.com/grpc-ecosystem/go-grpc-prometheus"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-1" id="co_running_grpc_in_production_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"github.com/prometheus/client_golang/prometheus"</code><code>&#13;
</code><code>  </code><code class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">reg</code><code> </code><code class="p">=</code><code> </code><code class="nx">prometheus</code><code class="p">.</code><code class="nx">NewRegistry</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-2" id="co_running_grpc_in_production_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
  </code><code class="nx">grpcMetrics</code><code> </code><code class="p">=</code><code> </code><code class="nx">grpc_prometheus</code><code class="p">.</code><code class="nx">NewServerMetrics</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-3" id="co_running_grpc_in_production_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
   </code><code class="nx">customMetricCounter</code><code> </code><code class="p">=</code><code> </code><code class="nx">prometheus</code><code class="p">.</code><code class="nx">NewCounterVec</code><code class="p">(</code><code class="nx">prometheus</code><code class="p">.</code><code class="nx">CounterOpts</code><code class="p">{</code><code>&#13;
</code><code>       </code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"product_mgt_server_handle_count"</code><code class="p">,</code><code>&#13;
</code><code>       </code><code class="nx">Help</code><code class="p">:</code><code> </code><code class="s">"Total number of RPCs handled on the server."</code><code class="p">,</code><code>&#13;
</code><code>   </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"name"</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-4" id="co_running_grpc_in_production_CO11-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">init</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>   </code><code class="nx">reg</code><code class="p">.</code><code class="nx">MustRegister</code><code class="p">(</code><code class="nx">grpcMetrics</code><code class="p">,</code><code> </code><code class="nx">customMetricCounter</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-5" id="co_running_grpc_in_production_CO11-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">httpServer</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">http</code><code class="p">.</code><code class="nx">Server</code><code class="p">{</code><code>&#13;
</code><code>      </code><code class="nx">Handler</code><code class="p">:</code><code> </code><code class="nx">promhttp</code><code class="p">.</code><code class="nx">HandlerFor</code><code class="p">(</code><code class="nx">reg</code><code class="p">,</code><code> </code><code class="nx">promhttp</code><code class="p">.</code><code class="nx">HandlerOpts</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">Addr</code><code class="p">:</code><code>  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"0.0.0.0:%d"</code><code class="p">,</code><code> </code><code class="mi">9092</code><code class="p">)</code><code class="p">}</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-6" id="co_running_grpc_in_production_CO11-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
  </code><code class="nx">grpcServer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryInterceptor</code><code class="p">(</code><code class="nx">grpcMetrics</code><code class="p">.</code><code class="nx">UnaryServerInterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-7" id="co_running_grpc_in_production_CO11-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
  </code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">grpcServer</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">grpcMetrics</code><code class="p">.</code><code class="nx">InitializeMetrics</code><code class="p">(</code><code class="nx">grpcServer</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO11-8" id="co_running_grpc_in_production_CO11-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
&#13;
  </code><code class="c1">// Start your http server for prometheus.&#13;
</code><code>  </code><code class="k">go</code><code> </code><code class="kd">func</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">httpServer</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="s">"Unable to start a http server."</code><code class="p">)</code><code>&#13;
</code><code>     </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="p">}</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpcServer</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-1" id="callout_running_grpc_in_production_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifies external libraries we need to add to enable monitoring. The gRPC ecosystem provides a predefined set of interceptors to support Prometheus monitoring. Here we are going to use those interceptors.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-2" id="callout_running_grpc_in_production_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates a metrics registry. This holds all data collectors registered in the system. If we need to add a new collector, we need to register it in this registry.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-3" id="callout_running_grpc_in_production_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Creates standard client metrics. These are the predefined metrics defined in the library.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-4" id="callout_running_grpc_in_production_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Creates a custom metrics counter with the name <code>product_mgt_server_handle_count</code>.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-5" id="callout_running_grpc_in_production_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Registers standard server metrics and custom metrics collector to the registry created in step 2.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-6" id="callout_running_grpc_in_production_CO11-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Creates an HTTP server for Prometheus. An HTTP endpoint starts with the context <code>/metrics</code> on port 9092 for metrics collection.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-7" id="callout_running_grpc_in_production_CO11-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Creates a gRPC server with a metrics interceptor. Here we use <code>grpcMetrics.UnaryServerInterceptor</code>, since we have unary service. There is another interceptor called <code>grpcMetrics.StreamServerInterceptor()</code> for streaming services.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO11-8" id="callout_running_grpc_in_production_CO11-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Initializes all standard metrics.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Using the custom metrics counter created in step 4, we can add more metrics for monitoring. Let’s say we want to collect how many products with the same name are added to our product management system. As shown in <a data-type="xref" href="#EX7-11">Example 7-11</a>, we can add a new metric to <code>customMetricCounter</code> in the <code>addProduct</code> method.</p>&#13;
<div data-type="example" id="EX7-11">&#13;
<h5><span class="label">Example 7-11. </span>Add new metrics to the custom metric counter</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// AddProduct implements ecommerce.AddProduct</code>&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">s</code> <code class="o">*</code><code class="nx">server</code><code class="p">)</code> <code class="nx">AddProduct</code><code class="p">(</code><code class="nx">ctx</code> <code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code>&#13;
     <code class="nx">in</code> <code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">)</code> <code class="p">(</code><code class="o">*</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
     <code class="nx">customMetricCounter</code><code class="p">.</code><code class="nx">WithLabelValues</code><code class="p">(</code><code class="nx">in</code><code class="p">.</code><code class="nx">Name</code><code class="p">).</code><code class="nx">Inc</code><code class="p">()</code>&#13;
  <code class="o">...</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Similar to the gRPC server, we can enable Prometheus monitoring in gRPC clients using client-side interceptors. <a data-primary="Go" data-secondary="metrics interceptor code" data-type="indexterm" id="idm46536630961640"/><a data-type="xref" href="#EX7-12">Example 7-12</a> provides the code snippet for adding a metrics interceptor to the gRPC client written in Go.</p>&#13;
<div data-type="example" id="EX7-12">&#13;
<h5><span class="label">Example 7-12. </span>Enable Prometheus monitoring for the gRPC Go client</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="o">...</code><code>&#13;
</code><code>  </code><code class="s">"github.com/grpc-ecosystem/go-grpc-prometheus"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-1" id="co_running_grpc_in_production_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"github.com/prometheus/client_golang/prometheus"</code><code>&#13;
</code><code>  </code><code class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">const</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">reg</code><code> </code><code class="o">:=</code><code> </code><code class="nx">prometheus</code><code class="p">.</code><code class="nx">NewRegistry</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-2" id="co_running_grpc_in_production_CO12-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">grpcMetrics</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc_prometheus</code><code class="p">.</code><code class="nx">NewClientMetrics</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-3" id="co_running_grpc_in_production_CO12-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
  </code><code class="nx">reg</code><code class="p">.</code><code class="nx">MustRegister</code><code class="p">(</code><code class="nx">grpcMetrics</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-4" id="co_running_grpc_in_production_CO12-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithUnaryInterceptor</code><code class="p">(</code><code class="nx">grpcMetrics</code><code class="p">.</code><code class="nx">UnaryClientInterceptor</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-5" id="co_running_grpc_in_production_CO12-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
          </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>   </code><code class="c1">// Create a HTTP server for prometheus.&#13;
</code><code>   </code><code class="nx">httpServer</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">http</code><code class="p">.</code><code class="nx">Server</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">Handler</code><code class="p">:</code><code> </code><code class="nx">promhttp</code><code class="p">.</code><code class="nx">HandlerFor</code><code class="p">(</code><code class="nx">reg</code><code class="p">,</code><code> </code><code class="nx">promhttp</code><code class="p">.</code><code class="nx">HandlerOpts</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="nx">Addr</code><code class="p">:</code><code> </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"0.0.0.0:%d"</code><code class="p">,</code><code> </code><code class="mi">9094</code><code class="p">)</code><code class="p">}</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO12-6" id="co_running_grpc_in_production_CO12-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
   </code><code class="c1">// Start your http server for prometheus.&#13;
</code><code>   </code><code class="k">go</code><code> </code><code class="kd">func</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>       </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">httpServer</code><code class="p">.</code><code class="nx">ListenAndServe</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>           </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="s">"Unable to start a http server."</code><code class="p">)</code><code>&#13;
</code><code>       </code><code class="p">}</code><code>&#13;
</code><code>   </code><code class="p">}</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="o">...</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-1" id="callout_running_grpc_in_production_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifies external libraries we need to add to enable monitoring.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-2" id="callout_running_grpc_in_production_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates a metrics registry. Similar to server code, this holds all data collectors registered in the system. If we need to add a new collector, we need to register it to this registry.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-3" id="callout_running_grpc_in_production_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Creates standard server metrics. These are the predefined metrics defined in the library.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-4" id="callout_running_grpc_in_production_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Registers standard client metrics to the registry created in step 2.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-5" id="callout_running_grpc_in_production_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Sets up a connection to the server with the metrics interceptor. Here we use <code>grpcMetrics.UnaryClientInterceptor</code>, since we have a unary client. Another interceptor, called <code>grpcMetrics.StreamClientInterceptor()</code>, is used for streaming clients.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO12-6" id="callout_running_grpc_in_production_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Creates an HTTP server for Prometheus. An HTTP endpoint starts with the context <code>/metrics</code> on port 9094 for metrics collection.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we run the server and client, we can access the server and client metrics through the created HTTP endpoint (e.g., server metrics on <a href="http://localhost:9092/metrics"><em class="hyperlink">http://localhost:9092/metrics</em></a> and client metrics on <a href="http://localhost:9094/metrics)"><em class="hyperlink">http://localhost:9094/metrics)</em></a>.</p>&#13;
&#13;
<p>As we mentioned before, Prometheus can collect metrics by accessing the preceding URLs. Prometheus stores all metrics data locally and applies a set of rules to aggregate and create new records. And, using Prometheus as a data source, we can visualize metrics in a dashboard using tools like Grafana.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="Grafana" data-type="indexterm" id="idm46536630781960"/>Grafana is an open source metrics dashboard and graph editor for Graphite, Elasticsearch, and Prometheus. It allows you to query, visualize, and understand your metrics data.<a data-startref="ix_ch07-asciidoc22" data-type="indexterm" id="idm46536630780936"/><a data-startref="ix_ch07-asciidoc21" data-type="indexterm" id="idm46536630780264"/></p>&#13;
</div>&#13;
&#13;
<p>One advantage of metrics-based monitoring in the system is that the cost of handling metrics data doesn’t increase with the activities of the system. For example, an increase in the application’s traffic will not increase handling costs like disk utilization, processing complexity, speed of visualization, operational costs, etc. It has <span class="keep-together">constant</span> overhead. Also, once we collect metrics, we can do numerous mathematical and statistical transformations and create valuable conclusions about the system.<a data-startref="ix_ch07-asciidoc18" data-type="indexterm" id="idm46536630777864"/><a data-startref="ix_ch07-asciidoc17" data-type="indexterm" id="idm46536630777160"/></p>&#13;
&#13;
<p>Another pillar of observability is logs, which we’ll discuss in the next section.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logs" data-type="sect2"><div class="sect2" id="idm46536631381112">&#13;
<h2>Logs</h2>&#13;
&#13;
<p><a data-primary="logs and logging" data-secondary="observability" data-type="indexterm" id="idm46536630774696"/><a data-primary="observability" data-secondary="logs and" data-type="indexterm" id="idm46536630773720"/>Logs are immutable, time-stamped records of discrete events that happened over time. We, as application developers, normally dump data into logs to tell where and what the internal state of the system is at a given point. The benefit of logs is they are the easiest to generate and more granular than metrics. We can attach specific actions or a bunch of context to it like unique IDs, what we are going to do, stack traces, etc. The downside is that they are very expensive because we need to store and index them in a way that makes it easy to search and use them.</p>&#13;
&#13;
<p>In gRPC applications, we can enable logging using interceptors. As we discussed in <a data-type="xref" href="ch05.html#ch_05">Chapter 5</a>, we can attach a new logging interceptor on both the client side and server side and log request and response messages of each remote call.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="ecosystem" data-secondary="predefined logging interceptors" data-type="indexterm" id="idm46536630769848"/>The gRPC ecosystem provides a set of predefined logging interceptors for Go applications. This includes <code>grpc_ctxtags</code>, a library that adds a Tag map to context, with data populated from the request body; <code>grpc_zap</code>, integration of the <a href="https://oreil.ly/XMlIg">zap</a> logging library into gRPC handlers; and <code>grpc_logrus</code>, integration of the <a href="https://oreil.ly/oKJX5">logrus</a> logging library into gRPC handlers. For more information about these interceptors, check out the <a href="https://oreil.ly/8lNaH">gRPC Go Middleware repository</a>.</p>&#13;
</div>&#13;
&#13;
<p>Once you add logs in your gRPC application, they’ll print in either the console or logfile, depending on how you configure logging. How to configure logging depends on the logging framework you used.</p>&#13;
&#13;
<p>We’ve now discussed two pillars of observability: metrics and logs. These are sufficient for understanding the performance and behavior of individual systems, but they aren’t sufficient to understand the lifetime of a request that traverses multiple systems. Distributed tracing is a technique that brings visibility of the lifetime of a request across several systems.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tracing" data-type="sect2"><div class="sect2" id="idm46536630611368">&#13;
<h2>Tracing</h2>&#13;
&#13;
<p><a data-primary="observability" data-secondary="tracing and" data-type="indexterm" id="ix_ch07-asciidoc23"/><a data-primary="tracing" data-secondary="observability and" data-type="indexterm" id="ix_ch07-asciidoc24"/>A <a data-primary="trace, defined" data-type="indexterm" id="idm46536630607752"/>trace is a representation of a series of related events that constructs the end-to-end request flow through a distributed system. As we discussed in the section <a data-type="xref" href="ch03.html#using_grpc_for_microservices_communication">“Using gRPC for Microservices Communication”</a>, in a real-world scenario we have multiple microservices serving different and specific business capabilities. Therefore, a request starting from the client is normally going through a number of services and different systems before the response going back to the client. All these intermediate events are part of the request flow. With tracing, we gain visibility into both the path traversed by a request as well as the structure of a request.</p>&#13;
&#13;
<p>In tracing, a trace is a tree of <em>spans</em>, which are the primary building blocks of distributed tracing. The span contains the metadata about the task, the latency (the time spent to complete the task), and other related attributes of the task. A trace has its own ID called TraceID and it is a unique byte sequence. This traceID groups and distinguishes spans from each other. Let’s try to enable tracing in our gRPC application.</p>&#13;
&#13;
<p><a data-primary="OpenCensus" data-secondary="tracing support" data-type="indexterm" id="idm46536630604216"/>Like metrics, the OpenCensus library provides support to enable tracing in gRPC applications. We will use OpenCensus to enable tracing in our Product Management application. As we said earlier, we can plug any supported exporters to export tracing data to different backends. We will use Jaeger for the distributed tracing sample.</p>&#13;
&#13;
<p>By default, tracing is enabled in gRPC Go. So it only requires registering an exporter to start collecting traces with gRPC Go integration. Let’s initiate a Jaeger exporter in both client and server applications. <a data-type="xref" href="#EX7-13">Example 7-13</a> illustrates how we can initiate the OpenCensus Jaeger exporter using the library.</p>&#13;
<div data-type="example" id="EX7-13">&#13;
<h5><span class="label">Example 7-13. </span>Initialize OpenCensus Jaeger exporter</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">tracer</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/trace"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO13-1" id="co_running_grpc_in_production_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"contrib.go.opencensus.io/exporter/jaeger"</code><code>&#13;
</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">initTracing</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>   </code><code class="nx">trace</code><code class="p">.</code><code class="nx">ApplyConfig</code><code class="p">(</code><code class="nx">trace</code><code class="p">.</code><code class="nx">Config</code><code class="p">{</code><code class="nx">DefaultSampler</code><code class="p">:</code><code> </code><code class="nx">trace</code><code class="p">.</code><code class="nx">AlwaysSample</code><code class="p">(</code><code class="p">)</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>   </code><code class="nx">agentEndpointURI</code><code> </code><code class="o">:=</code><code> </code><code class="s">"localhost:6831"</code><code>&#13;
</code><code>   </code><code class="nx">collectorEndpointURI</code><code> </code><code class="o">:=</code><code> </code><code class="s">"http://localhost:14268/api/traces"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO13-2" id="co_running_grpc_in_production_CO13-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
    </code><code class="nx">exporter</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">jaeger</code><code class="p">.</code><code class="nx">NewExporter</code><code class="p">(</code><code class="nx">jaeger</code><code class="p">.</code><code class="nx">Options</code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="nx">CollectorEndpoint</code><code class="p">:</code><code> </code><code class="nx">collectorEndpointURI</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="nx">AgentEndpoint</code><code class="p">:</code><code> </code><code class="nx">agentEndpointURI</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="nx">ServiceName</code><code class="p">:</code><code>    </code><code class="s">"product_info"</code><code class="p">,</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>       </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="nx">trace</code><code class="p">.</code><code class="nx">RegisterExporter</code><code class="p">(</code><code class="nx">exporter</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO13-3" id="co_running_grpc_in_production_CO13-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO13-1" id="callout_running_grpc_in_production_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Import the OpenTracing and Jaeger libraries.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO13-2" id="callout_running_grpc_in_production_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create the Jaeger exporter with the collector endpoint, service name, and agent endpoint.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO13-3" id="callout_running_grpc_in_production_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Register the exporter with the OpenCensus tracer.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we register the exporter with the server, we can instrument the server by tracing. <a data-type="xref" href="#EX7-14">Example 7-14</a> illustrates how to instrument tracing in service method.</p>&#13;
<div data-type="example" id="EX7-14">&#13;
<h5><span class="label">Example 7-14. </span>Instrument gRPC service method</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// GetProduct implements ecommerce.GetProduct&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">s</code><code> </code><code class="o">*</code><code class="nx">server</code><code class="p">)</code><code> </code><code class="nx">GetProduct</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">in</code><code> </code><code class="o">*</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">)</code><code> </code><code class="p">(</code><code>&#13;
</code><code>         </code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">span</code><code> </code><code class="o">:=</code><code> </code><code class="nx">trace</code><code class="p">.</code><code class="nx">StartSpan</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="s">"ecommerce.GetProduct"</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO14-1" id="co_running_grpc_in_production_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="k">defer</code><code> </code><code class="nx">span</code><code class="p">.</code><code class="nx">End</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO14-2" id="co_running_grpc_in_production_CO14-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">value</code><code class="p">,</code><code> </code><code class="nx">exists</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">productMap</code><code class="p">[</code><code class="nx">in</code><code class="p">.</code><code class="nx">Value</code><code class="p">]</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">exists</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="nx">value</code><code class="p">,</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">OK</code><code class="p">,</code><code> </code><code class="s">""</code><code class="p">)</code><code class="p">.</code><code class="nx">Err</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">NotFound</code><code class="p">,</code><code> </code><code class="s">"Product does not exist."</code><code class="p">,</code><code> </code><code class="nx">in</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO14-1" id="callout_running_grpc_in_production_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Start new span with span name and context.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO14-2" id="callout_running_grpc_in_production_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Stop the span when everything is done.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similar to the gRPC server, we can instrument the client by tracing as shown in <a data-type="xref" href="#EX7-15">Example 7-15</a>.</p>&#13;
<div data-type="example" id="EX7-15">&#13;
<h5><span class="label">Example 7-15. </span>Instrument gRPC client</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"context"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"time"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/client/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"productinfo/client/tracer"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"go.opencensus.io/plugin/ocgrpc"</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-1" id="co_running_grpc_in_production_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="s">"go.opencensus.io/trace"</code><code>&#13;
</code><code>  </code><code class="s">"contrib.go.opencensus.io/exporter/jaeger"</code><code>&#13;
</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">const</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">tracer</code><code class="p">.</code><code class="nx">initTracing</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-2" id="co_running_grpc_in_production_CO15-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">span</code><code> </code><code class="o">:=</code><code> </code><code class="nx">trace</code><code class="p">.</code><code class="nx">StartSpan</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="s">"ecommerce.ProductInfoClient"</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-3" id="co_running_grpc_in_production_CO15-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
  </code><code class="nx">name</code><code> </code><code class="o">:=</code><code> </code><code class="s">"Apple iphone 11"</code><code>&#13;
</code><code>  </code><code class="nx">description</code><code> </code><code class="o">:=</code><code> </code><code class="s">"Apple iphone 11 is the latest smartphone,&#13;
            launched in September 2019"</code><code>&#13;
</code><code>  </code><code class="nx">price</code><code> </code><code class="o">:=</code><code> </code><code class="nb">float32</code><code class="p">(</code><code class="mf">700.0</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">r</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">c</code><code class="p">.</code><code class="nx">AddProduct</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">name</code><code class="p">,</code><code>&#13;
</code><code>      </code><code class="nx">Description</code><code class="p">:</code><code> </code><code class="nx">description</code><code class="p">,</code><code> </code><code class="nx">Price</code><code class="p">:</code><code> </code><code class="nx">price</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-5" id="co_running_grpc_in_production_CO15-4"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Could not add product: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Product ID: %s added successfully"</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">product</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">c</code><code class="p">.</code><code class="nx">GetProduct</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">pb</code><code class="p">.</code><code class="nx">ProductID</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Value</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-6" id="co_running_grpc_in_production_CO15-5"><img alt="6" src="assets/6.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Could not get product: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Product: "</code><code class="p">,</code><code> </code><code class="nx">product</code><code class="p">.</code><code class="nx">String</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">span</code><code class="p">.</code><code class="nx">End</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_running_grpc_in_production_CO15-4" id="co_running_grpc_in_production_CO15-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-1" id="callout_running_grpc_in_production_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Import the OpenTracing and Jaeger libraries.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-2" id="callout_running_grpc_in_production_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Call the <code>initTracing</code> function and initialize the Jaeger exporter instance and register with trace.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-3" id="callout_running_grpc_in_production_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Start new span with span name and context.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-6" id="callout_running_grpc_in_production_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Stop the span when everything is done.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-4" id="callout_running_grpc_in_production_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Invoke addProduct remote method by passing new product details.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO15-5" id="callout_running_grpc_in_production_CO15-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Invoke getProduct remote method by passing productID.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we run the server and client, trace spans are published to the Jaeger agent for which a daemon process acts as a buffer to abstract out batch processing and routing from the clients. Once the Jaeger agent receives trace logs from the client, it forwards them to the collector. The collector processes the logs and stores them. From the Jaeger server, we can visualize tracing.<a data-startref="ix_ch07-asciidoc24" data-type="indexterm" id="idm46536629931400"/><a data-startref="ix_ch07-asciidoc23" data-type="indexterm" id="idm46536629930728"/></p>&#13;
&#13;
<p>From that, we are going to conclude the discussion of observability. Logs, metrics, and traces serve their own unique purpose, and it’s better to have all three pillars enabled in your system to gain maximum visibility of the internal state.<a data-startref="ix_ch07-asciidoc16" data-type="indexterm" id="idm46536629929416"/><a data-startref="ix_ch07-asciidoc15" data-type="indexterm" id="idm46536629928712"/><a data-startref="ix_ch07-asciidoc14" data-type="indexterm" id="idm46536629928040"/></p>&#13;
&#13;
<p>Once you have a gRPC-based observable application running in production, you can keep watching its state and easily find out whenever there is an issue or system outage. When you diagnose an issue in the system, it is important to find the solution, test it, and deploy it to production as soon as possible. To accomplish that goal, you need to have good debugging and troubleshooting mechanisms. Let’s look into the details of these mechanisms for gRPC applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Debugging and Troubleshooting" data-type="sect1"><div class="sect1" id="idm46536630610824">&#13;
<h1>Debugging and Troubleshooting</h1>&#13;
&#13;
<p><a data-primary="debugging and troubleshooting" data-type="indexterm" id="idm46536629925128"/><a data-primary="error handling" data-type="indexterm" id="idm46536629924456"/><a data-primary="production, running gRPC in" data-secondary="debugging and troubleshooting" data-type="indexterm" id="idm46536629923784"/>Debugging and troubleshooting is the process to find out the root cause of a problem and solve the issue that occurred in applications. In order to debug and troubleshoot the issue, we first need to reproduce the same issue in lower environments (referred to as dev or test environments). So we need a set of tools to generate similar kinds of request loads as the production environment.</p>&#13;
&#13;
<p>This process is relatively harder in gRPC services than in the HTTP service, because tools need to support both encoding and decoding messages based on the service definition, and be able to support HTTP/2. Common tools like curl or Postman, which are used to test HTTP services, cannot be used to test gRPC services.</p>&#13;
&#13;
<p>But there are a lot of interesting tools available for debugging and testing gRPC services. You can find a list of those tools in the <a href="https://oreil.ly/Ki2aZ">awesome gRPC repository</a>. It contains a great collection of resources available for gRPC.&#13;
One of the most common ways of debugging gRPC applications is by using extra logging.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling Extra Logging" data-type="sect2"><div class="sect2" id="idm46536629920120">&#13;
<h2>Enabling Extra Logging</h2>&#13;
&#13;
<p><a data-primary="logs and logging" data-secondary="enabling extra logs/traces" data-type="indexterm" id="idm46536629918520"/><a data-primary="tracing" data-secondary="enabling extra logs/traces" data-type="indexterm" id="idm46536629917576"/>We can enable extra logs and traces to diagnose the problem of your gRPC application. In the gRPC Go application, we can enable extra logs by setting the following environment variables:</p>&#13;
&#13;
<pre data-type="programlisting">GRPC_GO_LOG_VERBOSITY_LEVEL=99 <a class="co" href="#callout_running_grpc_in_production_CO16-1" id="co_running_grpc_in_production_CO16-1"><img alt="1" src="assets/1.png"/></a>&#13;
GRPC_GO_LOG_SEVERITY_LEVEL=info <a class="co" href="#callout_running_grpc_in_production_CO16-2" id="co_running_grpc_in_production_CO16-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO16-1" id="callout_running_grpc_in_production_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><em>Verbosity</em> means how many times any single info message should print every five minutes. The verbosity is set to 0 by default.</p></dd>&#13;
<dt><a class="co" href="#co_running_grpc_in_production_CO16-2" id="callout_running_grpc_in_production_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Sets log severity level to <code>info</code>. All the informational messages will be printed.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In the gRPC Java application, there are no environment variables to control the log level. We can turn on extra logs by providing a <em>logging.properties</em> file with log-level changes. Let’s say we want to troubleshoot transport-level frames in our application. We can create a new <em>logging.properties</em> file in our application and set the lower log level to a specific Java package (netty transport package) as follows:</p>&#13;
&#13;
<pre data-type="programlisting">handlers=java.util.logging.ConsoleHandler&#13;
io.grpc.netty.level=FINE&#13;
java.util.logging.ConsoleHandler.level=FINE&#13;
java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter</pre>&#13;
&#13;
<p>Then start up the Java binary with the JVM flag:</p>&#13;
&#13;
<pre data-type="programlisting">-Djava.util.logging.config.file=logging.properties</pre>&#13;
&#13;
<p>Once we set the lower log level in our application, all the logs in which the level is equal or higher than the configured log level will print in the console/logfile. We can gain valuable insight into the state of the system by reading the logs.</p>&#13;
&#13;
<p>With that, we have covered most of what you should know when running a gRPC application in production.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46536629919560">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Making production-ready gRPC applications requires us to focus on multiple aspects related to application development. We start by designing the service contract and generating code for the service or the client, then implementing our service’s business logic. Once we implement the service, we need to focus on the following to make the gRPC application production ready. <em>Testing</em> of gRPC server and client applications is essential.</p>&#13;
&#13;
<p>The <em>deployment</em> of gRPC applications follows the standard application development methodologies. For local and VM deployments, simply use the generated binaries of the server or client program. You can run gRPC applications as a Docker container, and find the sample standard Dockerfiles for deploying Go and Java applications on Docker. Running gRPC on Kubernetes is similar to standard Kubernetes deployment. When you run a gRPC application on Kubernetes, you use underlying features such as load balancing, high availability, ingress controllers,etc. Making gRPC applications observable is critical to using them in production, and gRPC application-level metrics are often used when gRPC applications operate in production.</p>&#13;
&#13;
<p>In one of the most popular implementations for metrics support in gRPC, the gRPC-Prometheus library, we use an interceptor at the server and client side to collect metrics, while logging in gRPC is also enabled using an interceptor. For gRPC applications in production, you may need to troubleshoot or debug by enabling extra logging. In the next chapter, we’ll explore some of the gRPC ecosystem components that are useful in building gRPC applications.<a data-startref="ix_ch07-asciidoc0" data-type="indexterm" id="idm46536629885864"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>