<html><head></head><body><section data-pdf-bookmark="Chapter 5. gRPC: Beyond the Basics" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_05">&#13;
<h1><span class="label">Chapter 5. </span>gRPC: Beyond the Basics</h1>&#13;
&#13;
&#13;
<p>When you build real-world gRPC applications you may have to augment them with various capabilities to meet requirements such as intercepting incoming and outgoing RPC, handling network delays resiliently, handling errors, sharing metadata between services and consumers, and so on.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>To maintain consistency, all samples in this chapter are explained using Go. If you’re more familiar with Java, you can refer to the Java samples in the source code repository for the same use cases.</p>&#13;
</div>&#13;
&#13;
<p>In this chapter, you will learn some key advanced gRPC capabilities including using gRPC interceptors to intercept RPCs on the server and client sides, using deadlines to specify the wait time for an RPC to complete, error-handling best practices on the server and client sides, using multiplexing to run multiple services on the same server, sharing custom metadata between applications, using load-balancing and name resolution techniques when calling other services, and compressing RPC calls to effectively use the network bandwidth.</p>&#13;
&#13;
<p>Let’s begin our discussion with gRPC interceptors.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interceptors" data-type="sect1"><div class="sect1" id="idm46536641219272">&#13;
<h1>Interceptors</h1>&#13;
&#13;
<p><a data-primary="interceptors" data-type="indexterm" id="ix_ch05-asciidoc0"/>As you build gRPC applications, you may want to execute some common logic before or after the execution of the remote function, for either client or server applications. In gRPC you can  intercept that RPC’s execution to meet certain requirements such as logging, authentication, metrics, etc., using an extension mechanism called an <em>interceptor</em>. gRPC provides simple APIs to implement and install interceptors in your <span class="keep-together">client</span> and server gRPC applications. They are one of the key extension mechanisms in gRPC and are quite useful in use cases such as logging, authentication, authorization, metrics, tracing, and any other customer requirements.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Interceptors are not supported in all languages that support gRPC, and the implementation of interceptors in each language may be different. In this book we only cover Go and Java.</p>&#13;
</div>&#13;
&#13;
<p>gRPC interceptors can be categorized into two types based on the type of RPC calls they intercept. For unary RPC you can use <em>unary interceptors</em>, while for streaming RPC you can use <em>streaming interceptors</em>. These interceptors can be used on the gRPC server side or on the gRPC client side. First, let’s start by looking at using interceptors on the server side.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Server-Side Interceptors" data-type="sect2"><div class="sect2" id="idm46536641212104">&#13;
<h2>Server-Side Interceptors</h2>&#13;
&#13;
<p><a data-primary="interceptors" data-secondary="server-side" data-type="indexterm" id="ix_ch05-asciidoc1"/><a data-primary="server-side interceptors" data-type="indexterm" id="ix_ch05-asciidoc2"/>When a client invokes a remote method of a gRPC service, you can execute a common logic prior to the execution of the remote methods by using a server-side interceptor. This helps when you need to apply certain features such as authentication prior to invoking the remote method. As shown in <a data-type="xref" href="#server_side_interceptors">Figure 5-1</a>, you can plug one or more interceptors into any gRPC server that you develop. For example, to plug a new server-side interceptor into your <code>OrderManagement</code> gRPC service, you can implement the interceptor and register it when you create the gRPC server.</p>&#13;
&#13;
<figure><div class="figure" id="server_side_interceptors">&#13;
<img alt="Server-side interceptors " src="assets/grpc_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>Server-side interceptors</h6>&#13;
</div></figure>&#13;
&#13;
<p>On the server side, the unary interceptor allows you to intercept the unary RPC call while the streaming interceptor intercepts the streaming RPC. Let’s first discuss server-side unary interceptors.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unary interceptor" data-type="sect3"><div class="sect3" id="idm46536641203832">&#13;
<h3>Unary interceptor</h3>&#13;
&#13;
<p><a data-primary="server-side interceptors" data-secondary="unary interceptor" data-type="indexterm" id="idm46536641202456"/><a data-primary="unary interceptor" data-secondary="server-side" data-type="indexterm" id="idm46536641201416"/>If you want to intercept the unary RPC of your gRPC service at the server side, you’ll need to implement a unary interceptor for your gRPC server. As shown in the Go code snippet in <a data-type="xref" href="#EX5-1">Example 5-1</a>, you can do this by implementing a function of type <code>UnaryServerInterceptor</code> and registering that function when you create a gRPC server. <code>UnaryServerInterceptor</code> is the type for a server-side unary interceptor with the following signature:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code class="p">(</code><code class="nx">ctx</code> <code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code> <code class="nx">req</code> <code class="kd">interface</code><code class="p">{},</code> <code class="nx">info</code> <code class="o">*</code><code class="nx">UnaryServerInfo</code><code class="p">,</code>&#13;
	                     <code class="nx">handler</code> <code class="nx">UnaryHandler</code><code class="p">)</code> <code class="p">(</code><code class="nx">resp</code> <code class="kd">interface</code><code class="p">{},</code> <code class="nx">err</code> <code class="kt">error</code><code class="p">)</code></pre>&#13;
&#13;
<p>Inside this function you get full control of all unary RPC calls that are coming to your gRPC server.</p>&#13;
<div data-type="example" id="EX5-1">&#13;
<h5><span class="label">Example 5-1. </span>gRPC server-side unary interceptor</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Server - Unary Interceptor&#13;
</code><code class="kd">func</code><code> </code><code class="nx">orderUnaryServerInterceptor</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">req</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                             </code><code class="nx">info</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryServerInfo</code><code class="p">,</code><code> </code><code class="nx">handler</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryHandler</code><code class="p">)</code><code>&#13;
</code><code>                             </code><code class="p">(</code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="c1">// Preprocessing logic&#13;
</code><code>	</code><code class="c1">// Gets info about the current RPC call by examining the args passed in&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"======= [Server Interceptor] "</code><code class="p">,</code><code> </code><code class="nx">info</code><code class="p">.</code><code class="nx">FullMethod</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO1-1" id="co_grpc__beyond_the_basics_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
&#13;
	</code><code class="c1">// Invoking the handler to complete the normal execution of a unary RPC.&#13;
</code><code>	</code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">handler</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO1-2" id="co_grpc__beyond_the_basics_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
	</code><code class="c1">// Post processing logic&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">" Post Proc Message : %s"</code><code class="p">,</code><code> </code><code class="nx">m</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO1-3" id="co_grpc__beyond_the_basics_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
	</code><code class="k">return</code><code> </code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO1-4" id="co_grpc__beyond_the_basics_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// ...&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>     </code><code class="c1">// Registering the Interceptor at the server-side.&#13;
</code><code>	</code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code>&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryInterceptor</code><code class="p">(</code><code class="nx">orderUnaryServerInterceptor</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO1-5" id="co_grpc__beyond_the_basics_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO1-1" id="callout_grpc__beyond_the_basics_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Preprocessing phase: this is where you can intercept the message prior to invoking the respective RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO1-2" id="callout_grpc__beyond_the_basics_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Invoking the RPC method via <code>UnaryHandler</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO1-3" id="callout_grpc__beyond_the_basics_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Postprocessing phase: you can process the response from the RPC invocation.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO1-4" id="callout_grpc__beyond_the_basics_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Sending back the RPC response.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO1-5" id="callout_grpc__beyond_the_basics_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Registering the unary interceptor with the gRPC server.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The implementation of a server-side unary interceptor can usually be divided into three parts: preprocessing, invoking the RPC method, and postprocessing. As the name implies, the preprocessor phase is executed prior to invoking the remote method intended in the RPC call. In the preprocessor phase, users can get info about the current RPC call by examining the args passed in, such as RPC context, RPC request, and server information. Thus, during the preprocessor phase you can even modify the RPC call.</p>&#13;
&#13;
<p>Then, in the invoker phase, you have to call the gRPC <code>UnaryHandler</code> to invoke the RPC method. Once you invoke the RPC, the postprocessor phase is executed. This means that the response for the RPC call goes through the postprocessor phase. In the phase, you can deal with the returned reply and error when required. Once the postprocessor phase is completed, you need to return the message and the error as the return parameters of your interceptor function. If no postprocessing is required, you can simply return the handler call (<code>handler(ctx, req)</code>).</p>&#13;
&#13;
<p>Next, let’s discuss streaming interceptors.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Stream interceptor" data-type="sect3"><div class="sect3" id="idm46536641117288">&#13;
<h3>Stream interceptor</h3>&#13;
&#13;
<p><a data-primary="server-side interceptors" data-secondary="stream interceptor" data-type="indexterm" id="ix_ch05-asciidoc3"/><a data-primary="stream interceptor" data-secondary="server-side" data-type="indexterm" id="ix_ch05-asciidoc4"/>The server-side streaming interceptor intercepts any streaming RPC calls that the gRPC server deals with. The stream interceptor includes a preprocessing phase and a stream operation interception phase.</p>&#13;
&#13;
<p>As shown in the Go code snippet in <a data-type="xref" href="#EX5-2">Example 5-2</a>, suppose that we want to intercept streaming RPC calls of the <code>OrderManagement</code> service. <code>StreamServerInterceptor</code> is the type for server-side stream interceptors.  <code>orderServerStreamInterceptor</code> is an interceptor function of type <code>StreamServerInterceptor</code> with the signature:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code class="p">(</code><code class="nx">srv</code> <code class="kd">interface</code><code class="p">{},</code> <code class="nx">ss</code> <code class="nx">ServerStream</code><code class="p">,</code> <code class="nx">info</code> <code class="o">*</code><code class="nx">StreamServerInfo</code><code class="p">,</code>&#13;
                                     <code class="nx">handler</code> <code class="nx">StreamHandler</code><code class="p">)</code> <code class="kt">error</code></pre>&#13;
&#13;
<p>Similar to a unary interceptor, in the preprocessor phase, you can intercept a streaming RPC call before it goes to the service implementation. After the preprocessor phase, you can then invoke the <code>StreamHandler</code> to complete the execution of RPC invocation of the remote method. After the preprocessor phase, you can intercept the streaming RPC message by using an interface known as a wrapper stream that implements the <code>grpc.ServerStream</code> interface. You can pass this wrapper structure when you invoke <code>grpc.StreamHandler</code> with <code>handler(srv, newWrappedStream(ss))</code>. The wrapper of <code>grpc.ServerStream</code> intercepts the streaming messages sent or received by the gRPC service. It implements the <code>SendMsg</code> and <code>RecvMsg</code> functions, which will be invoked when the service receives or sends an RPC streaming message.</p>&#13;
<div data-type="example" id="EX5-2">&#13;
<h5><span class="label">Example 5-2. </span>gRPC server-side streaming interceptor</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Server - Streaming Interceptor&#13;
</code><code class="c1">// wrappedStream wraps around the embedded grpc.ServerStream,&#13;
</code><code class="c1">// and intercepts the RecvMsg and SendMsg method call.&#13;
</code><code>&#13;
</code><code class="kd">type</code><code> </code><code class="nx">wrappedStream</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-1" id="co_grpc__beyond_the_basics_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
	</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerStream</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-2" id="co_grpc__beyond_the_basics_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">w</code><code> </code><code class="o">*</code><code class="nx">wrappedStream</code><code class="p">)</code><code> </code><code class="nx">RecvMsg</code><code class="p">(</code><code class="nx">m</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"====== [Server Stream Interceptor Wrapper] "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>		</code><code class="s">"Receive a message (Type: %T) at %s"</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Format</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">RFC3339</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">w</code><code class="p">.</code><code class="nx">ServerStream</code><code class="p">.</code><code class="nx">RecvMsg</code><code class="p">(</code><code class="nx">m</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-3" id="co_grpc__beyond_the_basics_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">w</code><code> </code><code class="o">*</code><code class="nx">wrappedStream</code><code class="p">)</code><code> </code><code class="nx">SendMsg</code><code class="p">(</code><code class="nx">m</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"====== [Server Stream Interceptor Wrapper] "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>		</code><code class="s">"Send a message (Type: %T) at %v"</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Format</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">RFC3339</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">w</code><code class="p">.</code><code class="nx">ServerStream</code><code class="p">.</code><code class="nx">SendMsg</code><code class="p">(</code><code class="nx">m</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-4" id="co_grpc__beyond_the_basics_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">newWrappedStream</code><code class="p">(</code><code class="nx">s</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerStream</code><code class="p">)</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerStream</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="o">&amp;</code><code class="nx">wrappedStream</code><code class="p">{</code><code class="nx">s</code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-5" id="co_grpc__beyond_the_basics_CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">orderServerStreamInterceptor</code><code class="p">(</code><code class="nx">srv</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">ss</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerStream</code><code class="p">,</code><code> </code><code class="nx">info</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">StreamServerInfo</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">handler</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">StreamHandler</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"====== [Server Stream Interceptor] "</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">info</code><code class="p">.</code><code class="nx">FullMethod</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-6" id="co_grpc__beyond_the_basics_CO2-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
	</code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">handler</code><code class="p">(</code><code class="nx">srv</code><code class="p">,</code><code> </code><code class="nx">newWrappedStream</code><code class="p">(</code><code class="nx">ss</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-7" id="co_grpc__beyond_the_basics_CO2-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"RPC failed with error %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">err</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code class="c1">// Registering the interceptor&#13;
</code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code>&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">StreamInterceptor</code><code class="p">(</code><code class="nx">orderServerStreamInterceptor</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO2-8" id="co_grpc__beyond_the_basics_CO2-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
&#13;
</code><code class="err">…</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-1" id="callout_grpc__beyond_the_basics_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Wrapper stream of the <code>grpc.ServerStream</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-2" id="callout_grpc__beyond_the_basics_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Implementing the <code>RecvMsg</code> function of the wrapper to process messages received with stream RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-3" id="callout_grpc__beyond_the_basics_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Implementing the <code>SendMsg</code> function of the wrapper to process messages sent with stream RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-4" id="callout_grpc__beyond_the_basics_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Creating an instance of the new wrapper stream.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-5" id="callout_grpc__beyond_the_basics_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Streaming interceptor implementation.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-6" id="callout_grpc__beyond_the_basics_CO2-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Preprocessor phase.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-7" id="callout_grpc__beyond_the_basics_CO2-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Invoking the streaming RPC with the wrapper stream.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO2-8" id="callout_grpc__beyond_the_basics_CO2-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Registering the interceptor.</p></dd>&#13;
</dl>&#13;
&#13;
<p>To understand the behavior of the streaming interceptor on the server side, look at the following output from the gRPC server logs. Based on the order in which each log message is printed you can identify the behavior of the streaming interceptor. The streaming remote method that we have invoked here is <code>SearchOrders</code>, which is a server-streaming RPC:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="p">[</code><code class="nx">Server</code> <code class="nx">Stream</code> <code class="nx">Interceptor</code><code class="p">]</code>  <code class="o">/</code><code class="nx">ecommerce</code><code class="p">.</code><code class="nx">OrderManagement</code><code class="o">/</code><code class="nx">searchOrders</code>&#13;
<code class="p">[</code><code class="nx">Server</code> <code class="nx">Stream</code> <code class="nx">Interceptor</code> <code class="nx">Wrapper</code><code class="p">]</code> <code class="nx">Receive</code> <code class="nx">a</code> <code class="nx">message</code>&#13;
&#13;
<code class="nx">Matching</code> <code class="nx">Order</code> <code class="nx">Found</code> <code class="p">:</code> <code class="mi">102</code> <code class="o">-</code><code class="p">&gt;</code> <code class="nx">Writing</code> <code class="nx">Order</code> <code class="nx">to</code> <code class="nx">the</code> <code class="nx">stream</code> <code class="o">...</code>&#13;
<code class="p">[</code><code class="nx">Server</code> <code class="nx">Stream</code> <code class="nx">Interceptor</code> <code class="nx">Wrapper</code><code class="p">]</code> <code class="nx">Send</code> <code class="nx">a</code> <code class="nx">message</code><code class="o">...</code>&#13;
<code class="nx">Matching</code> <code class="nx">Order</code> <code class="nx">Found</code> <code class="p">:</code> <code class="mi">104</code> <code class="o">-</code><code class="p">&gt;</code> <code class="nx">Writing</code> <code class="nx">Order</code> <code class="nx">to</code> <code class="nx">the</code> <code class="nx">stream</code> <code class="o">...</code>&#13;
<code class="p">[</code><code class="nx">Server</code> <code class="nx">Stream</code> <code class="nx">Interceptor</code> <code class="nx">Wrapper</code><code class="p">]</code> <code class="nx">Send</code> <code class="nx">a</code> <code class="nx">message</code><code class="o">...</code></pre>&#13;
&#13;
<p>Client-side interceptor terminology is quite similar to that of server-side interceptors, with some subtle variations as to the interfaces and function signatures. Let’s move on to the details of client-side interceptors<a data-startref="ix_ch05-asciidoc4" data-type="indexterm" id="idm46536640551032"/><a data-startref="ix_ch05-asciidoc3" data-type="indexterm" id="idm46536640550424"/>.<a data-startref="ix_ch05-asciidoc2" data-type="indexterm" id="idm46536640485432"/><a data-startref="ix_ch05-asciidoc1" data-type="indexterm" id="idm46536640484728"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Client-Side Interceptors" data-type="sect2"><div class="sect2" id="idm46536641116664">&#13;
<h2>Client-Side Interceptors</h2>&#13;
&#13;
<p><a data-primary="client-side interceptors" data-type="indexterm" id="ix_ch05-asciidoc5"/><a data-primary="interceptors" data-secondary="client-side" data-type="indexterm" id="ix_ch05-asciidoc6"/>When a client invokes an RPC call to invoke a remote method of a gRPC service, you can intercept those RPC calls on the client side. As shown in <a data-type="xref" href="#client_side_interceptors">Figure 5-2</a>, with client-side interceptors, you can intercept unary RPC calls as well as streaming RPC calls.</p>&#13;
&#13;
<figure><div class="figure" id="client_side_interceptors">&#13;
<img alt="Client-side Interceptors" src="assets/grpc_0502.png"/>&#13;
<h6><span class="label">Figure 5-2. </span>Client-side interceptors</h6>&#13;
</div></figure>&#13;
&#13;
<p>This is particularly useful when you need to implement certain reusable features, such as securely calling a gRPC service outside the client application code.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unary interceptor" data-type="sect3"><div class="sect3" id="idm46536640476760">&#13;
<h3>Unary interceptor</h3>&#13;
&#13;
<p><a data-primary="client-side interceptors" data-secondary="unary interceptor" data-type="indexterm" id="idm46536640475320"/><a data-primary="unary interceptor" data-secondary="client-side" data-type="indexterm" id="idm46536640474376"/>A client-side unary RPC interceptor is used for intercepting the unary RPC client side.&#13;
<code>UnaryClientInterceptor</code> is the type for a client-side unary interceptor that has a function signature as follows:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code class="p">(</code><code class="nx">ctx</code> <code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code> <code class="nx">method</code> <code class="kt">string</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">reply</code> <code class="kd">interface</code><code class="p">{},</code>&#13;
         <code class="nx">cc</code> <code class="o">*</code><code class="nx">ClientConn</code><code class="p">,</code> <code class="nx">invoker</code> <code class="nx">UnaryInvoker</code><code class="p">,</code> <code class="nx">opts</code> <code class="o">...</code><code class="nx">CallOption</code><code class="p">)</code> <code class="kt">error</code></pre>&#13;
&#13;
<p>As we saw with the server-side unary interceptor, the client-side unary interceptor has different phases. <a data-type="xref" href="#EX5-3">Example 5-3</a> shows the basic Go implementation of a unary interceptor on the client side. In the preprocessor phase, you can intercept the RPC calls before invoking the remote method. Here you will have access to the information about the current RPC call by examining the args passed in, such as RPC context, method string, request to be sent, and <code>CallOptions</code> configured. So, you can even modify the original RPC call before it is sent to the server application. Then using the <code>UnaryInvoker</code> argument you can invoke the actual unary RPC. In the postprocessor phase, you can access the response or the error results of the RPC invocation.</p>&#13;
<div data-type="example" id="EX5-3">&#13;
<h5><span class="label">Example 5-3. </span>gRPC client-side unary interceptor</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="nx">orderUnaryClientInterceptor</code><code class="p">(</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">method</code><code> </code><code class="kt">string</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">,</code><code> </code><code class="nx">reply</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">cc</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientConn</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">invoker</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryInvoker</code><code class="p">,</code><code> </code><code class="nx">opts</code><code> </code><code class="o">...</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">CallOption</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="c1">// Preprocessor phase&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Method : "</code><code> </code><code class="o">+</code><code> </code><code class="nx">method</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO3-1" id="co_grpc__beyond_the_basics_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
	</code><code class="c1">// Invoking the remote method&#13;
</code><code>	</code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">invoker</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">method</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">,</code><code> </code><code class="nx">reply</code><code class="p">,</code><code> </code><code class="nx">cc</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO3-2" id="co_grpc__beyond_the_basics_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
	</code><code class="c1">// Postprocessor phase&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">reply</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO3-3" id="co_grpc__beyond_the_basics_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
	</code><code class="k">return</code><code> </code><code class="nx">err</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO3-4" id="co_grpc__beyond_the_basics_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="c1">// Setting up a connection to the server.&#13;
</code><code>	</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithUnaryInterceptor</code><code class="p">(</code><code class="nx">orderUnaryClientInterceptor</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO3-5" id="co_grpc__beyond_the_basics_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO3-1" id="callout_grpc__beyond_the_basics_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Preprocessing phase has access to the RPC request prior to sending it out to the server.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO3-2" id="callout_grpc__beyond_the_basics_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Invoking the RPC method via <code>UnaryInvoker</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO3-3" id="callout_grpc__beyond_the_basics_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Postprocessing phase where you can process the response or error results.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO3-4" id="callout_grpc__beyond_the_basics_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Returning an error back to the gRPC client application along with a reply, which is passed as an argument.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO3-5" id="callout_grpc__beyond_the_basics_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Setting up a connection to the server by passing a unary interceptor as a dial option.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Registering the interceptor function is done inside the <code>grpc.Dial</code> operation using <code>grpc.WithUnaryInterceptor</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Stream interceptor" data-type="sect3"><div class="sect3" id="idm46536640186424">&#13;
<h3>Stream interceptor</h3>&#13;
&#13;
<p><a data-primary="client-side interceptors" data-secondary="stream interceptor" data-type="indexterm" id="idm46536640185176"/><a data-primary="stream interceptor" data-secondary="client-side" data-type="indexterm" id="idm46536640184328"/>The client-side streaming interceptor intercepts any streaming RPC calls that the gRPC client deals with. The implementation of the client-side stream interceptor is quite similar to that of the server side. <code>StreamClientInterceptor</code> is the type for a client-side stream interceptor; it is a function type with this signature:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code class="p">(</code><code class="nx">ctx</code> <code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code> <code class="nx">desc</code> <code class="o">*</code><code class="nx">StreamDesc</code><code class="p">,</code> <code class="nx">cc</code> <code class="o">*</code><code class="nx">ClientConn</code><code class="p">,</code>&#13;
                                      <code class="nx">method</code> <code class="kt">string</code><code class="p">,</code> <code class="nx">streamer</code> <code class="nx">Streamer</code><code class="p">,</code>&#13;
                                      <code class="nx">opts</code> <code class="o">...</code><code class="nx">CallOption</code><code class="p">)</code> <code class="p">(</code><code class="nx">ClientStream</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code></pre>&#13;
&#13;
<p>As shown in <a data-type="xref" href="#EX5-4">Example 5-4</a>, the client-side stream interceptor implementation includes preprocessing and stream operation interception.</p>&#13;
<div data-type="example" id="EX5-4">&#13;
<h5><span class="label">Example 5-4. </span>gRPC client-side stream interceptor</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="nx">clientStreamInterceptor</code><code class="p">(</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">desc</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">StreamDesc</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">cc</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientConn</code><code class="p">,</code><code> </code><code class="nx">method</code><code> </code><code class="kt">string</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">streamer</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Streamer</code><code class="p">,</code><code> </code><code class="nx">opts</code><code> </code><code class="o">...</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">CallOption</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="p">(</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientStream</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"======= [Client Interceptor] "</code><code class="p">,</code><code> </code><code class="nx">method</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-1" id="co_grpc__beyond_the_basics_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
	</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">streamer</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">desc</code><code class="p">,</code><code> </code><code class="nx">cc</code><code class="p">,</code><code> </code><code class="nx">method</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-2" id="co_grpc__beyond_the_basics_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">newWrappedStream</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="p">,</code><code> </code><code class="kc">nil</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-3" id="co_grpc__beyond_the_basics_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="kd">type</code><code> </code><code class="nx">wrappedStream</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-4" id="co_grpc__beyond_the_basics_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
	</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientStream</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">w</code><code> </code><code class="o">*</code><code class="nx">wrappedStream</code><code class="p">)</code><code> </code><code class="nx">RecvMsg</code><code class="p">(</code><code class="nx">m</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-5" id="co_grpc__beyond_the_basics_CO4-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"====== [Client Stream Interceptor] "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>		</code><code class="s">"Receive a message (Type: %T) at %v"</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Format</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">RFC3339</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">w</code><code class="p">.</code><code class="nx">ClientStream</code><code class="p">.</code><code class="nx">RecvMsg</code><code class="p">(</code><code class="nx">m</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">w</code><code> </code><code class="o">*</code><code class="nx">wrappedStream</code><code class="p">)</code><code> </code><code class="nx">SendMsg</code><code class="p">(</code><code class="nx">m</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-6" id="co_grpc__beyond_the_basics_CO4-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"====== [Client Stream Interceptor] "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>		</code><code class="s">"Send a message (Type: %T) at %v"</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">m</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Format</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">RFC3339</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">w</code><code class="p">.</code><code class="nx">ClientStream</code><code class="p">.</code><code class="nx">SendMsg</code><code class="p">(</code><code class="nx">m</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">newWrappedStream</code><code class="p">(</code><code class="nx">s</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientStream</code><code class="p">)</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ClientStream</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="o">&amp;</code><code class="nx">wrappedStream</code><code class="p">{</code><code class="nx">s</code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="c1">// Setting up a connection to the server.&#13;
</code><code>	</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithStreamInterceptor</code><code class="p">(</code><code class="nx">clientStreamInterceptor</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO4-7" id="co_grpc__beyond_the_basics_CO4-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-1" id="callout_grpc__beyond_the_basics_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Preprocessing phase has access to the RPC request prior to sending it out to the server.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-2" id="callout_grpc__beyond_the_basics_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calling the passed-in streamer to get a <code>ClientStream</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-3" id="callout_grpc__beyond_the_basics_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Wrapping around the <code>ClientStream</code>, overloading its methods with intercepting logic, and returning it to the client application.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-4" id="callout_grpc__beyond_the_basics_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Wrapper stream of <code>grpc.ClientStream</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-5" id="callout_grpc__beyond_the_basics_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Function to intercept messages received from streaming RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-6" id="callout_grpc__beyond_the_basics_CO4-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Function to intercept messages sent from streaming RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO4-7" id="callout_grpc__beyond_the_basics_CO4-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Registering a streaming interceptor.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Intercepting for stream operations is done via a wrapper implementation of the stream where you have to implement a new structure wrapping <code>grpc.ClientStream</code>. Here you implement two wrapped stream methods, <code>RecvMsg</code> and <code>SendMsg</code>, that can be used to intercept streaming messages received or sent from the client side. The registration of the interceptor is the same as for the unary interceptor and is done with the <code>grpc.Dial</code> operation<a data-startref="ix_ch05-asciidoc6" data-type="indexterm" id="idm46536640124824"/><a data-startref="ix_ch05-asciidoc5" data-type="indexterm" id="idm46536640124088"/>.<a data-startref="ix_ch05-asciidoc0" data-type="indexterm" id="idm46536640123288"/></p>&#13;
&#13;
<p>Let’s look at deadlines, another capability you’ll often need to apply when calling gRPC services from the client application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deadlines" data-type="sect1"><div class="sect1" id="idm46536639833512">&#13;
<h1>Deadlines</h1>&#13;
&#13;
<p><a data-primary="deadlines" data-type="indexterm" id="ix_ch05-asciidoc7"/>Deadlines and timeouts are two commonly used patterns in distributed computing. <a data-primary="timeouts" data-type="indexterm" id="idm46536639830808"/><em>Timeouts</em> allow you to specify how long a client application can wait  for an RPC to complete before it terminates with an error. A timeout is usually specified as a duration and locally applied at each client side. For example, a single request may consist of multiple downstream RPCs that chain together multiple services. So we can apply timeouts, relative to each RPC, at each service invocation. Therefore, timeouts cannot be directly applied for the entire life cycle of the request. That’s where we need to use deadlines.</p>&#13;
&#13;
<p>A <em>deadline</em> is expressed in absolute time from the beginning of a request (even if the API presents them as a duration offset) and applied across multiple service invocations. The application that initiates the request sets the deadline and the entire request chain needs to respond by the deadline. gRPC APIs supports using deadlines for your RPC. For many reasons, it is always good practice to use deadlines in your gRPC applications. gRPC communication happens over the network, so there can be delays between the RPC calls and responses. Also, in certain cases the gRPC service itself can take more time to respond depending on the service’s business logic. When client applications are developed without using deadlines, they infinitely wait for a response for RPC requests that are initiated and resources will be held for all in-flight requests. This puts the service as well as the client at risk of running out of resources, increasing the latency of the service; this could even crash the entire gRPC service.</p>&#13;
&#13;
<p>The example scenario shown in <a data-type="xref" href="#using_deadlines_when_calling_services">Figure 5-3</a> illustrates a gRPC client application calling a product management service that again invokes the inventory service.</p>&#13;
&#13;
<p><a data-primary="deadline offset" data-type="indexterm" id="idm46536639825720"/>The client application sets a deadline offset (i.e., deadline = current time + offset) of 50 ms. The network latency between the client and <code>ProductMgt</code> service is 0 ms and the processing latency of the <code>ProductMgt</code> service is 20 ms. The product management service has to set a deadline offset of 30 ms. Since the inventory service takes 30 ms to respond, the deadline event would occur on both client sides (<code>ProductMgt</code> invokes the <code>Inventory</code> service and the client application).</p>&#13;
&#13;
<p>The latency added from the business logic of the <code>ProductMgt</code> service is 20 ms. Then the <code>ProductMgt</code> service’s invocation logic triggers the deadline-exceeded scenario and propagates it back to the client application as well. Therefore, when using deadlines, make sure that they are applied across all services.</p>&#13;
&#13;
<figure><div class="figure" id="using_deadlines_when_calling_services">&#13;
<img alt="Using Deadlines when calling services" src="assets/grpc_0503.png"/>&#13;
<h6><span class="label">Figure 5-3. </span>Using deadlines when calling services</h6>&#13;
</div></figure>&#13;
&#13;
<p>A client application can set a deadline when it initiates a connection with a gRPC service. Once the RPC call is made, the client application waits for the duration specified by the deadline; if the response for the RPC call is not received within that time, the RPC call is terminated with a <code>DEADLINE_EXCEEDED</code> error.</p>&#13;
&#13;
<p>Let’s look at a real-world example of using deadlines when invoking gRPC services. In the same <code>OrderManagement</code> service use case, suppose the <code>AddOrder</code> RPC takes a significant amount of time to complete (we’ve simulated this with the introduction of a delay into the <code>AddOrder</code> method of the <code>OrderManagement</code> gRPC service). But the client application only waits until the response is no longer useful to it. For example, the duration that <code>AddOrder</code> takes to respond is two seconds, while the client only waits two seconds for a response. To implement this (as shown in the Go code snippet shown in <a data-type="xref" href="#EX5-5">Example 5-5</a>), the client application can set the two-second timeout with the <code>context.WithDeadline</code> operation. We have used the <code>status</code> package to process error code; we’ll discuss this in detail in the error-handling section.</p>&#13;
<div data-type="example" id="EX5-5">&#13;
<h5><span class="label">Example 5-5. </span>gRPC deadlines for the client application</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="nx">client</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewOrderManagementClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nx">clientDeadline</code><code> </code><code class="o">:=</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Add</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Second</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">cancel</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithDeadline</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">clientDeadline</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO5-1" id="co_grpc__beyond_the_basics_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code class="k">defer</code><code> </code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// Add Order&#13;
</code><code class="nx">order1</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">Order</code><code class="p">{</code><code class="nx">Id</code><code class="p">:</code><code> </code><code class="s">"101"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">Items</code><code class="p">:</code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"iPhone XS"</code><code class="p">,</code><code> </code><code class="s">"Mac Book Pro"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">Destination</code><code class="p">:</code><code class="s">"San Jose, CA"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">Price</code><code class="p">:</code><code class="mf">2300.00</code><code class="p">}</code><code>&#13;
</code><code class="nx">res</code><code class="p">,</code><code> </code><code class="nx">addErr</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">AddOrder</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">order1</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO5-2" id="co_grpc__beyond_the_basics_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code class="k">if</code><code> </code><code class="nx">addErr</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">got</code><code> </code><code class="o">:=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Code</code><code class="p">(</code><code class="nx">addErr</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO5-3" id="co_grpc__beyond_the_basics_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Error Occured -&gt; addOrder : , %v:"</code><code class="p">,</code><code> </code><code class="nx">got</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO5-4" id="co_grpc__beyond_the_basics_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Print</code><code class="p">(</code><code class="s">"AddOrder Response -&gt; "</code><code class="p">,</code><code> </code><code class="nx">res</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO5-1" id="callout_grpc__beyond_the_basics_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Setting a two-second deadline on the current context.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO5-2" id="callout_grpc__beyond_the_basics_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Invoking the <code>AddOrder</code> remote method and capturing any possible errors into <code>addErr</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO5-3" id="callout_grpc__beyond_the_basics_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Using the status package to determine the error code.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO5-4" id="callout_grpc__beyond_the_basics_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>If the invocation exceeds the specified deadline, it should return an error of the type <code>DEADLINE_EXCEEDED</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>So how should we determine the ideal value for the deadline? There is no single answer to that question, but you need to consider several factors in making that choice; mainly, the end-to-end latency of each service that we invoke, which RPCs are serial and which RPCs can be made in parallel, the latency of the underlying network, and the deadline values of the downstream services. Once you are able to come up with the initial value for the deadline, fine-tune it based on the operating condition of the gRPC applications.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Setting the gRPC deadline in Go is done through Go’s <a href="https://oreil.ly/OTrmY"><code>context</code> package</a>, where <code>WithDeadline</code> is a built-in function. In Go, context is often used to pass down common data that can be used by all downstream operations. Once this is called from the gRPC client application, the gRPC library at the client side creates a required gRPC header to represent the deadline between the client and server applications. In Java, this is slightly different, as the implementation directly comes from the <code>io.grpc.stub.*</code> package’s stub implementation where you will set the gRPC deadline with <code>blockingStub.withDeadlineAfter(long, java.util.concurrent.TimeUnit)</code>. Please refer to the code repository for details of the Java implementation.</p>&#13;
</div>&#13;
&#13;
<p>When it comes to deadlines in gRPC, both the client and server can make their own independent and local determination about whether the RPC was successful; this means their conclusions may not match. For instance, in our example, when the client meets the <code>DEADLINE_EXCEEDED</code> condition, the service may still try to respond. So, the service application needs to determine whether the current RPC is still valid or not. From the server side, you can also detect when the client has reached the deadline specified when invoking the RPC. Inside the <code>AddOrder</code> operation, you can check for <code>ctx.Err() == context.DeadlineExceeded</code> to find out whether the client has already met the deadline exceeded state, and then abandon the RPC at the server side and return an error (this is often implemented using a nonblocking <code>select</code> construct in Go).</p>&#13;
&#13;
<p>Similar to deadlines, there can be certain situations in which your client or server application wants to terminate the ongoing gRPC communication. This is where gRPC cancellation becomes useful.<a data-startref="ix_ch05-asciidoc7" data-type="indexterm" id="idm46536639627656"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cancellation" data-type="sect1"><div class="sect1" id="idm46536639832888">&#13;
<h1>Cancellation</h1>&#13;
&#13;
<p><a data-primary="cancellation" data-type="indexterm" id="idm46536639625544"/>In a gRPC connection between a client and server application, both the client and server make independent and local determinations of the success of the call. For instance, you could have an RPC that finishes successfully on the server side but fails on the client side. Similarly, there can be various conditions where the client and server may end up with different conclusions on the results of an RPC.&#13;
When either the client or server application wants to terminate the RPC this can be done by <em>canceling</em> the RPC. Once the RPC is canceled, no further RPC-related messaging can be done and the fact that one party has canceled the RPC is propagated to the other side.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In Go, similar to deadlines, the cancellation capability is provided via the <a href="https://oreil.ly/OTrmY"><code>context</code> package</a> where <code>WithCancel</code> is a built-in function. Once this is called from the gRPC application, the gRPC library on the client side creates a required gRPC header to represent the gRPC termination between the client and server applications.</p>&#13;
</div>&#13;
&#13;
<p>Let’s take the example of bidirectional streaming between the client and server applications. In the Go code sample shown in <a data-type="xref" href="#EX5-6">Example 5-6</a>, you can obtain the <code>cancel</code> function from the <code>context.WithTimeout</code> call. Once you have the reference to <code>cancel</code>, you can call it at any location where you intend to terminate the RPC.</p>&#13;
<div data-type="example" id="EX5-6">&#13;
<h5><span class="label">Example 5-6. </span>gRPC cancellation</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">cancel</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithTimeout</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="o">*</code><code class="nx">time</code><code class="p">.</code><code class="nx">Second</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-1" id="co_grpc__beyond_the_basics_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
&#13;
</code><code class="nx">streamProcOrder</code><code class="p">,</code><code> </code><code class="nx">_</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">ProcessOrders</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-2" id="co_grpc__beyond_the_basics_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="nx">_</code><code> </code><code class="p">=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">Send</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code class="s">"102"</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-3" id="co_grpc__beyond_the_basics_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="nx">_</code><code> </code><code class="p">=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">Send</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code class="s">"103"</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="nx">_</code><code> </code><code class="p">=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">Send</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code class="s">"104"</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nx">channel</code><code> </code><code class="o">:=</code><code> </code><code class="nb">make</code><code class="p">(</code><code class="kd">chan</code><code> </code><code class="kt">bool</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="k">go</code><code> </code><code class="nx">asncClientBidirectionalRPC</code><code class="p">(</code><code class="nx">streamProcOrder</code><code class="p">,</code><code> </code><code class="nx">channel</code><code class="p">)</code><code>&#13;
</code><code class="nx">time</code><code class="p">.</code><code class="nx">Sleep</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">Millisecond</code><code> </code><code class="o">*</code><code> </code><code class="mi">1000</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// Canceling the RPC&#13;
</code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-4" id="co_grpc__beyond_the_basics_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"RPC Status : %s"</code><code class="p">,</code><code> </code><code class="nx">ctx</code><code class="p">.</code><code class="nx">Err</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-5" id="co_grpc__beyond_the_basics_CO6-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
&#13;
</code><code class="nx">_</code><code> </code><code class="p">=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">Send</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">wrapper</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">{</code><code class="nx">Value</code><code class="p">:</code><code class="s">"101"</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="nx">_</code><code> </code><code class="p">=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">CloseSend</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="o">&lt;-</code><code> </code><code class="nx">channel</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">asncClientBidirectionalRPC</code><code> </code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">streamProcOrder</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">OrderManagement_ProcessOrdersClient</code><code class="p">,</code><code> </code><code class="nx">c</code><code> </code><code class="kd">chan</code><code> </code><code class="kt">bool</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>		</code><code class="nx">combinedShipment</code><code class="p">,</code><code> </code><code class="nx">errProcOrder</code><code> </code><code class="o">:=</code><code> </code><code class="nx">streamProcOrder</code><code class="p">.</code><code class="nx">Recv</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">errProcOrder</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Error Receiving messages %v"</code><code class="p">,</code><code> </code><code class="nx">errProcOrder</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO6-6" id="co_grpc__beyond_the_basics_CO6-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-1" id="callout_grpc__beyond_the_basics_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Obtaining the reference to cancel.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-2" id="callout_grpc__beyond_the_basics_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Invoking the streaming RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-3" id="callout_grpc__beyond_the_basics_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Sending messages to the service via the stream.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-4" id="callout_grpc__beyond_the_basics_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Canceling RPC/terminating RPC from the client side.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-5" id="callout_grpc__beyond_the_basics_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Status of the current context.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO6-6" id="callout_grpc__beyond_the_basics_CO6-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Returning context canceled error when trying to receive messages from a canceled context.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When one party cancels the RPC, the other party can determine it by checking the context. In this example, the server application can check whether the current context is canceled by using <code>stream.Context().Err() == context.Canceled</code>.</p>&#13;
&#13;
<p>As you have seen in the application of deadlines as well as cancellation, handling errors with RPC is a very common requirement. In the next section, we look at gRPC error-handling techniques in detail.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Error Handling" data-type="sect1"><div class="sect1" id="idm46536639606792">&#13;
<h1>Error Handling</h1>&#13;
&#13;
<p><a data-primary="error handling" data-type="indexterm" id="ix_ch05-asciidoc8"/>When we invoke a gRPC call, the client receives a response with a successful status or an error with the corresponding error status. The client application needs to be written in such a way that you handle all the potential errors and error conditions. The server application requires you to handle errors as well as generate the appropriate errors with corresponding status codes.</p>&#13;
&#13;
<p>When an error occurs, gRPC returns one of its error-status codes with an optional error message that provides more details of the error condition. The status object is composed of an integer code and a string message that are common to all gRPC implementations for different languages.</p>&#13;
&#13;
<p>gRPC <a data-primary="status codes" data-type="indexterm" id="idm46536639602152"/>uses a set of well-defined gRPC-specific status codes. This includes status codes such as the following:</p>&#13;
<dl>&#13;
<dt><code>OK</code></dt>&#13;
<dd>&#13;
<p>Successful status; not an error.</p>&#13;
</dd>&#13;
<dt><code>CANCELLED</code></dt>&#13;
<dd>&#13;
<p>The operation was canceled, typically by the caller.</p>&#13;
</dd>&#13;
<dt><code>DEADLINE_EXCEEDED</code></dt>&#13;
<dd>&#13;
<p>The deadline expired before the operation could complete.</p>&#13;
</dd>&#13;
<dt><code>INVALID_ARGUMENT</code></dt>&#13;
<dd>&#13;
<p>The client specified an invalid argument.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="error codes" data-type="indexterm" id="idm46536639286808"/><a data-type="xref" href="#grpc_error_codes">Table 5-1</a> shows the available gRPC error codes and the description of each error code. The complete list of error codes can be found <a href="https://oreil.ly/LiNLn">in the gRPC official documentation</a>, or in the documentation for <a href="https://oreil.ly/E61Q0">Go</a> and <a href="https://oreil.ly/Ugtg0">Java</a>.</p>&#13;
<table id="grpc_error_codes" style="width: 80%">&#13;
<caption><span class="label">Table 5-1. </span>gRPC error codes</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Code</th>&#13;
<th>Number</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>OK</p></td>&#13;
<td><p>0</p></td>&#13;
<td><p>Success status.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>CANCELLED</p></td>&#13;
<td><p>1</p></td>&#13;
<td><p>The operation was canceled (by the caller).</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>UNKNOWN</p></td>&#13;
<td><p>2</p></td>&#13;
<td><p>Unknown error.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>INVALID_ARGUMENT</p></td>&#13;
<td><p>3</p></td>&#13;
<td><p>The client specified an invalid argument.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>DEADLINE_EXCEEDED</p></td>&#13;
<td><p>4</p></td>&#13;
<td><p>The deadline expired before the operation could complete.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>NOT_FOUND</p></td>&#13;
<td><p>5</p></td>&#13;
<td><p>Some requested entity was not found.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>ALREADY_EXISTS</p></td>&#13;
<td><p>6</p></td>&#13;
<td><p>The entity that a client attempted to create already exists.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>PERMISSION_DENIED</p></td>&#13;
<td><p>7</p></td>&#13;
<td><p>The caller does not have permission to execute the specified operation.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>UNAUTHENTICATED</p></td>&#13;
<td><p>16</p></td>&#13;
<td><p>The request does not have valid authentication credentials for the operation.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>RESOURCE_EXHAUSTED</p></td>&#13;
<td><p>8</p></td>&#13;
<td><p>Some resource has been exhausted.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>FAILED_PRECONDITION</p></td>&#13;
<td><p>9</p></td>&#13;
<td><p>The operation was rejected because the system is not in a state required for the operation’s execution.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>ABORTED</p></td>&#13;
<td><p>10</p></td>&#13;
<td><p>The operation was aborted.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>OUT_OF_RANGE</p></td>&#13;
<td><p>11</p></td>&#13;
<td><p>The operation was attempted past the valid range.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>UNIMPLEMENTED</p></td>&#13;
<td><p>12</p></td>&#13;
<td><p>The operation is not implemented or is not supported/enabled in this service.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>INTERNAL</p></td>&#13;
<td><p>13</p></td>&#13;
<td><p>Internal errors.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>UNAVAILABLE</p></td>&#13;
<td><p>14</p></td>&#13;
<td><p>The service is currently unavailable.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>DATA_LOSS</p></td>&#13;
<td><p>15</p></td>&#13;
<td><p>Unrecoverable data loss or corruption.</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The error model provided with gRPC out of the box is quite limited and independent of the underlying gRPC data format (where the most common format is protocol buffers). If you are using protocol buffers as your data format then you can leverage the richer error model the Google APIs provide under the <code>google.rpc</code> package. However, the error model is supported only in the C++, Go, Java, Python, and Ruby libraries, so be mindful of this if you plan to use other languages than these.</p>&#13;
&#13;
<p>Let’s look at how these concepts can be used in a real-world gRPC error-handling use case. In our order management use case, suppose that we need to handle a request with invalid order IDs in the <code>AddOrder</code> remote method. <a data-primary="server" data-secondary="error creation/propagation" data-type="indexterm" id="idm46536639071400"/>As shown in <a data-type="xref" href="#EX5-7">Example 5-7</a>, suppose that if the given order ID equals <code>-1</code> then you need to generate an error and return it to the consumer.</p>&#13;
<div data-type="example" id="EX5-7">&#13;
<h5><span class="label">Example 5-7. </span>Error creation and propagation on the server side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="k">if</code><code> </code><code class="nx">orderReq</code><code class="p">.</code><code class="nx">Id</code><code> </code><code class="o">==</code><code> </code><code class="s">"-1"</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO7-1" id="co_grpc__beyond_the_basics_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Order ID is invalid! -&gt; Received Order ID %s"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">orderReq</code><code class="p">.</code><code class="nx">Id</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="nx">errorStatus</code><code> </code><code class="o">:=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">InvalidArgument</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="s">"Invalid information received"</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO7-2" id="co_grpc__beyond_the_basics_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
    </code><code class="nx">ds</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">errorStatus</code><code class="p">.</code><code class="nx">WithDetails</code><code class="p">(</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO7-3" id="co_grpc__beyond_the_basics_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
        </code><code class="o">&amp;</code><code class="nx">epb</code><code class="p">.</code><code class="nx">BadRequest_FieldViolation</code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="nx">Field</code><code class="p">:</code><code class="s">"ID"</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="nx">Description</code><code class="p">:</code><code> </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code>&#13;
</code><code>                </code><code class="s">"Order ID received is not valid %s : %s"</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="nx">orderReq</code><code class="p">.</code><code class="nx">Id</code><code class="p">,</code><code> </code><code class="nx">orderReq</code><code class="p">.</code><code class="nx">Description</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">errorStatus</code><code class="p">.</code><code class="nx">Err</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">ds</code><code class="p">.</code><code class="nx">Err</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO7-4" id="co_grpc__beyond_the_basics_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="o">...</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO7-1" id="callout_grpc__beyond_the_basics_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Invalid request, needs to generate an error and send it back to the client.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO7-2" id="callout_grpc__beyond_the_basics_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create a new error status with error code <code>InvalidArgument</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO7-3" id="callout_grpc__beyond_the_basics_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Include any error details with an error type <code>BadRequest_FieldViolation</code> from <code>google.golang.org/genproto/googleapis/rpc/errdetails</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO7-4" id="callout_grpc__beyond_the_basics_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Returning the generated error.</p></dd>&#13;
</dl>&#13;
&#13;
<p>You can simply create an error status from <code>grpc.status</code> packages with the required error code and details. In the example here we have used <code>status.New(codes.InvalidArgument, "Invalid information received")</code>. You just need to send this error back to the client with <code>return nil, errorStatus.Err()</code>. However, to include a richer error model, you can use Google API’s <code>google.rpc</code> package. In this example, we have set an error detail with a specific error type from  <em>google.golang.org/genproto/googleapis/rpc/errdetails</em>.</p>&#13;
&#13;
<p><a data-primary="client" data-secondary="error handling" data-type="indexterm" id="idm46536639058504"/>For error handling on the client side, you simply process the error returned as part of your RPC invocation. For example, in <a data-type="xref" href="#EX5-8">Example 5-8</a>, you can find the Go implementation of the client application of this order management use case. Here we invoked the <code>AddOrder</code> method and assigned the returned error to the <code>addOrderError</code> variable. So, the next step is to inspect the results of <code>addOrderError</code> and gracefully handle the error. For that, you can obtain the error code and specific error type that we have set from the server side.</p>&#13;
<div data-type="example" id="EX5-8">&#13;
<h5><span class="label">Example 5-8. </span>Error handling on the client side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">order1</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">Order</code><code class="p">{</code><code class="nx">Id</code><code class="p">:</code><code> </code><code class="s">"-1"</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">Items</code><code class="p">:</code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"iPhone XS"</code><code class="p">,</code><code> </code><code class="s">"Mac Book Pro"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">Destination</code><code class="p">:</code><code class="s">"San Jose, CA"</code><code class="p">,</code><code> </code><code class="nx">Price</code><code class="p">:</code><code class="mf">2300.00</code><code class="p">}</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-1" id="co_grpc__beyond_the_basics_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nx">res</code><code class="p">,</code><code> </code><code class="nx">addOrderError</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">AddOrder</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">order1</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-2" id="co_grpc__beyond_the_basics_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
&#13;
</code><code class="k">if</code><code> </code><code class="nx">addOrderError</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">errorCode</code><code> </code><code class="o">:=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Code</code><code class="p">(</code><code class="nx">addOrderError</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-3" id="co_grpc__beyond_the_basics_CO8-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
	</code><code class="k">if</code><code> </code><code class="nx">errorCode</code><code> </code><code class="o">==</code><code> </code><code class="nx">codes</code><code class="p">.</code><code class="nx">InvalidArgument</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-4" id="co_grpc__beyond_the_basics_CO8-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Invalid Argument Error : %s"</code><code class="p">,</code><code> </code><code class="nx">errorCode</code><code class="p">)</code><code>&#13;
</code><code>		</code><code class="nx">errorStatus</code><code> </code><code class="o">:=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Convert</code><code class="p">(</code><code class="nx">addOrderError</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-5" id="co_grpc__beyond_the_basics_CO8-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
		</code><code class="k">for</code><code> </code><code class="nx">_</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">:=</code><code> </code><code class="k">range</code><code> </code><code class="nx">errorStatus</code><code class="p">.</code><code class="nx">Details</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="k">switch</code><code> </code><code class="nx">info</code><code> </code><code class="o">:=</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="p">(</code><code class="kd">type</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="k">case</code><code> </code><code class="o">*</code><code class="nx">epb</code><code class="p">.</code><code class="nx">BadRequest_FieldViolation</code><code class="p">:</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO8-6" id="co_grpc__beyond_the_basics_CO8-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
				</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Request Field Invalid: %s"</code><code class="p">,</code><code> </code><code class="nx">info</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">default</code><code class="p">:</code><code>&#13;
</code><code>				</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Unexpected error type: %s"</code><code class="p">,</code><code> </code><code class="nx">info</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="p">}</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Unhandled error : %s "</code><code class="p">,</code><code> </code><code class="nx">errorCode</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code class="p">.</code><code class="nx">Print</code><code class="p">(</code><code class="s">"AddOrder Response -&gt; "</code><code class="p">,</code><code> </code><code class="nx">res</code><code class="p">.</code><code class="nx">Value</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-1" id="callout_grpc__beyond_the_basics_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This is an invalid order.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-2" id="callout_grpc__beyond_the_basics_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Invoke the <code>AddOrder</code> remote method and assign the error to <code>addOrderError</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-3" id="callout_grpc__beyond_the_basics_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Obtain the error code using the <code>grpc/status</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-4" id="callout_grpc__beyond_the_basics_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Check for <code>InvalidArgument</code> error code.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-5" id="callout_grpc__beyond_the_basics_CO8-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Obtain the error status from the error.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO8-6" id="callout_grpc__beyond_the_basics_CO8-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Check for <code>BadRequest_FieldViolation</code> error type.</p></dd>&#13;
</dl>&#13;
&#13;
<p>It’s always good practice to use the appropriate gRPC error codes and a richer error model whenever possible for your gRPC applications. gRPC error status and details are normally sent via the trailer headers at the transport protocol level.<a data-startref="ix_ch05-asciidoc8" data-type="indexterm" id="idm46536638629224"/></p>&#13;
&#13;
<p>Now let’s look at multiplexing, a service-hosting mechanism on the same gRPC server runtime.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiplexing" data-type="sect1"><div class="sect1" id="idm46536639605448">&#13;
<h1>Multiplexing</h1>&#13;
&#13;
<p><a data-primary="multiplexing" data-type="indexterm" id="ix_ch05-asciidoc9"/>In terms of gRPC services and client applications, we’ve seen so far a given gRPC server with a gRPC service registered on it and a gRPC client connection being used by a single client stub only. However, gRPC allows you to run multiple gRPC services on the same gRPC server (see <a data-type="xref" href="#muliplexing_multiple_grpc_services_in_the_same_server_application">Figure 5-4</a>), as well as use the same gRPC client connection for multiple gRPC client stubs. This capability is known as <em>multiplexing</em>.</p>&#13;
&#13;
<figure><div class="figure" id="muliplexing_multiple_grpc_services_in_the_same_server_application">&#13;
<img alt="Multiplexing multiple gRPC services in the same server application" src="assets/grpc_0504.png"/>&#13;
<h6><span class="label">Figure 5-4. </span>Multiplexing multiple gRPC services in the same server application</h6>&#13;
</div></figure>&#13;
&#13;
<p>For example, in our <code>OrderManagement</code> service example, suppose that you want to run another service that is required for order-management purposes on the same gRPC server, so that the client application can reuse the same connection to invoke both the services as required. Then you can register both services on the same gRPC server by using their respective server register functions (i.e., <code>ordermgt_pb.RegisterOrderManagementServer</code> and <code>hello_pb.RegisterGreeterServer</code>). Using this method, you can register one or more gRPC services on the same gRPC server (as shown in <a data-type="xref" href="#EX5-9">Example 5-9</a>).</p>&#13;
<div data-type="example" id="EX5-9">&#13;
<h5><span class="label">Example 5-9. </span>Two gRPC services sharing the same grpc.Server</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">initSampleData</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="nx">grpcServer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO9-1" id="co_grpc__beyond_the_basics_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
	</code><code class="c1">// Register Order Management service on gRPC orderMgtServer&#13;
</code><code>	</code><code class="nx">ordermgt_pb</code><code class="p">.</code><code class="nx">RegisterOrderManagementServer</code><code class="p">(</code><code class="nx">grpcServer</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">orderMgtServer</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO9-2" id="co_grpc__beyond_the_basics_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
	</code><code class="c1">// Register Greeter Service on gRPC orderMgtServer&#13;
</code><code>	</code><code class="nx">hello_pb</code><code class="p">.</code><code class="nx">RegisterGreeterServer</code><code class="p">(</code><code class="nx">grpcServer</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">helloServer</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO9-3" id="co_grpc__beyond_the_basics_CO9-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
      </code><code class="o">...</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO9-1" id="callout_grpc__beyond_the_basics_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creating the gRPC server.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO9-2" id="callout_grpc__beyond_the_basics_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Registering the <code>OrderManagement</code> service with the gRPC server.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO9-3" id="callout_grpc__beyond_the_basics_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Registering the <code>Hello</code> service with the same gRPC server.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similarly, from the client side you can share the same gRPC connection between two gRPC client stubs.</p>&#13;
&#13;
<p>As shown in <a data-type="xref" href="#EX5-10">Example 5-10</a>, since both gRPC services are running in the same gRPC server, you can create a gRPC connection and use it when creating the gRPC client instance for different services.</p>&#13;
<div data-type="example" id="EX5-10">&#13;
<h5><span class="label">Example 5-10. </span>Two gRPC client stubs sharing the same grpc.ClientConn</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Setting up a connection to the server.&#13;
</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO10-1" id="co_grpc__beyond_the_basics_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code class="nx">orderManagementClient</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewOrderManagementClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO10-2" id="co_grpc__beyond_the_basics_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// Add Order RPC&#13;
</code><code>	</code><code class="o">...</code><code>&#13;
</code><code class="nx">res</code><code class="p">,</code><code> </code><code class="nx">addErr</code><code> </code><code class="o">:=</code><code> </code><code class="nx">orderManagementClient</code><code class="p">.</code><code class="nx">AddOrder</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">order1</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="nx">helloClient</code><code> </code><code class="o">:=</code><code> </code><code class="nx">hwpb</code><code class="p">.</code><code class="nx">NewGreeterClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO10-3" id="co_grpc__beyond_the_basics_CO10-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
	</code><code class="o">...</code><code>&#13;
</code><code>	</code><code class="c1">// Say hello RPC&#13;
</code><code class="nx">helloResponse</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">helloClient</code><code class="p">.</code><code class="nx">SayHello</code><code class="p">(</code><code class="nx">hwcCtx</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="o">&amp;</code><code class="nx">hwpb</code><code class="p">.</code><code class="nx">HelloRequest</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"gRPC Up and Running!"</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO10-1" id="callout_grpc__beyond_the_basics_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creating a gRPC connection.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO10-2" id="callout_grpc__beyond_the_basics_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Using the created gRPC connection to create an <code>OrderManagement</code> client.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO10-3" id="callout_grpc__beyond_the_basics_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Using the same gRPC connection to create the <code>Hello</code> service client.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Running multiple services or using the same connection between multiple stubs is a design choice that is independent of gRPC concepts. In most everyday use cases such as microservices, it is quite common to not share the same gRPC server instance between two services.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>One powerful use for gRPC multiplexing in a microservice architecture is to host multiple major versions of the same service in one server process. This allows a service to accommodate legacy clients after a breaking API change. Once the old version of the service contract is no longer in use, it can be removed from the server.<a data-startref="ix_ch05-asciidoc9" data-type="indexterm" id="idm46536638394136"/></p>&#13;
</div>&#13;
&#13;
<p>In the next section, we’ll talk about how to exchange data that is not part of RPC parameters and responses between client and service applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Metadata" data-type="sect1"><div class="sect1" id="idm46536638627528">&#13;
<h1>Metadata</h1>&#13;
&#13;
<p><a data-primary="metadata" data-type="indexterm" id="ix_ch05-asciidoc10"/>gRPC applications usually share information via RPC calls between gRPC services and consumers. In most cases, information directly related to the service’s business logic and consumer is part of the remote method invocation arguments. However, in certain conditions, you may want to share information about the RPC calls that are not related to the business context of the RPC, so they shouldn’t be part of the RPC arguments. In such cases, you can use <em>gRPC metadata</em> that you can send or receive from either the gRPC service or the gRPC client. As illustrated in <a data-type="xref" href="#exchanging_grpc_metadata_between_client_and_server_applications">Figure 5-5</a>, the metadata that you create on either the client or server side can be exchanged between the client and server applications using gRPC headers. Metadata is structured in the form of a list of key(string)/value pairs.</p>&#13;
&#13;
<p>One of the most common usages of metadata is to exchange security headers between gRPC applications. Similarly, you can use it to exchange any such information between gRPC applications. Often gRPC metadata APIs are heavily used inside the interceptors that we develop. In the next section, we’ll explore how gRPC supports sending metadata between the client and server.</p>&#13;
&#13;
<figure><div class="figure" id="exchanging_grpc_metadata_between_client_and_server_applications">&#13;
<img alt="Exchanging gRPC metadata between client and server applications. " src="assets/grpc_0505.png"/>&#13;
<h6><span class="label">Figure 5-5. </span>Exchanging gRPC metadata between client and server applications</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating and Retrieving Metadata" data-type="sect2"><div class="sect2" id="idm46536638341304">&#13;
<h2>Creating and Retrieving Metadata</h2>&#13;
&#13;
<p><a data-primary="metadata" data-secondary="creating/retrieving" data-type="indexterm" id="idm46536638340056"/>The creation of metadata from a gRPC application is quite straightforward. In the following Go code snippet, you will find two ways of creating metadata. Metadata is represented as a normal map in Go and can be created with the format <code>metadata.New(map[string]string{"key1": "val1", "key2": "val2"})</code>. Also, you can use <code>metadata.Pairs</code> to create metadata in pairs, so that metadata with the same key will get merged into a list:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Metadata Creation : option I</code>&#13;
<code class="nx">md</code> <code class="o">:=</code> <code class="nx">metadata</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"key1"</code><code class="p">:</code> <code class="s">"val1"</code><code class="p">,</code> <code class="s">"key2"</code><code class="p">:</code> <code class="s">"val2"</code><code class="p">})</code>&#13;
&#13;
<code class="c1">// Metadata Creation : option II</code>&#13;
<code class="nx">md</code> <code class="o">:=</code> <code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code>&#13;
    <code class="s">"key1"</code><code class="p">,</code> <code class="s">"val1"</code><code class="p">,</code>&#13;
    <code class="s">"key1"</code><code class="p">,</code> <code class="s">"val1-2"</code><code class="p">,</code> <code class="c1">// "key1" will have map value []string{"val1", "val1-2"}</code>&#13;
    <code class="s">"key2"</code><code class="p">,</code> <code class="s">"val2"</code><code class="p">,</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>You can also set binary data as metadata values. The binary data that we set as metadata values will be base64 encoded before sending, and will be decoded after being transferred.</p>&#13;
&#13;
<p>Reading metadata from either the client or server side can be done using the incoming context of the RPC call with <code>metadata.FromIncomingContext(ctx)</code>, which returns the metadata map in Go:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="p">(</code><code class="nx">s</code> <code class="o">*</code><code class="nx">server</code><code class="p">)</code> <code class="nx">AddOrder</code><code class="p">(</code><code class="nx">ctx</code> <code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code> <code class="nx">orderReq</code> <code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Order</code><code class="p">)</code>&#13;
    <code class="p">(</code><code class="o">*</code><code class="nx">wrappers</code><code class="p">.</code><code class="nx">StringValue</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
&#13;
<code class="nx">md</code><code class="p">,</code> <code class="nx">metadataAvailable</code> <code class="o">:=</code> <code class="nx">metadata</code><code class="p">.</code><code class="nx">FromIncomingContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code>&#13;
<code class="c1">// read the required metadata from the ‘md’ metadata map.</code></pre>&#13;
&#13;
<p>Now let’s dive into how metadata sending and receiving happens on the client or server side for different unary and streaming RPC styles.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending and Receiving Metadata: Client Side" data-type="sect2"><div class="sect2" id="idm46536638219704">&#13;
<h2>Sending and Receiving Metadata: Client Side</h2>&#13;
&#13;
<p><a data-primary="client" data-secondary="metadata: sending/receiving" data-type="indexterm" id="idm46536638218552"/><a data-primary="metadata" data-secondary="sending/receiving: client side" data-type="indexterm" id="idm46536638217384"/>You can send metadata from the client side to the gRPC service by creating metadata and setting it into the context of the RPC call. In a Go implementation, you can do this in two different ways. As shown in <a data-type="xref" href="#EX5-11">Example 5-11</a>, you can create a new context with the new metadata using <code>NewOutgoingContext</code>, or simply append the metadata to the existing context using <code>AppendToOutgoingContext</code>. Using <code>NewOutgoingContext</code>, however, replaces any existing metadata in the context. Once you create a context with the required metadata, it can be used either for unary or streaming RPC. As you learned in <a data-type="xref" href="ch04.html#ch_04">Chapter 4</a>, the metadata that you set in the context is translated into gRPC headers (on HTTP/2) or trailers at the wire level. So when the client sends those headers they are received by the recipient as headers.</p>&#13;
<div data-type="example" id="EX5-11">&#13;
<h5><span class="label">Example 5-11. </span>Sending metadata from the gRPC client side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">md</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code><code>&#13;
</code><code>	</code><code class="s">"timestamp"</code><code class="p">,</code><code> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Format</code><code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">StampNano</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="s">"kn"</code><code class="p">,</code><code> </code><code class="s">"vn"</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO11-1" id="co_grpc__beyond_the_basics_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nx">mdCtx</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">NewOutgoingContext</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">md</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO11-2" id="co_grpc__beyond_the_basics_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code class="nx">ctxA</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">AppendToOutgoingContext</code><code class="p">(</code><code class="nx">mdCtx</code><code class="p">,</code><code>&#13;
</code><code>      </code><code class="s">"k1"</code><code class="p">,</code><code> </code><code class="s">"v1"</code><code class="p">,</code><code> </code><code class="s">"k1"</code><code class="p">,</code><code> </code><code class="s">"v2"</code><code class="p">,</code><code> </code><code class="s">"k2"</code><code class="p">,</code><code> </code><code class="s">"v3"</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO11-3" id="co_grpc__beyond_the_basics_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
</code><code class="c1">// make unary RPC&#13;
</code><code class="nx">response</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">SomeRPC</code><code class="p">(</code><code class="nx">ctxA</code><code class="p">,</code><code> </code><code class="nx">someRequest</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO11-4" id="co_grpc__beyond_the_basics_CO11-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
</code><code class="c1">// or make streaming RPC&#13;
</code><code class="nx">stream</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">SomeStreamingRPC</code><code class="p">(</code><code class="nx">ctxA</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO11-5" id="co_grpc__beyond_the_basics_CO11-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO11-1" id="callout_grpc__beyond_the_basics_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creating metadata.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO11-2" id="callout_grpc__beyond_the_basics_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creating a new context with the new metadata.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO11-3" id="callout_grpc__beyond_the_basics_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Appending some more metadata to the existing context.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO11-4" id="callout_grpc__beyond_the_basics_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Unary RPC using the new context with the metadata.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO11-5" id="callout_grpc__beyond_the_basics_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The same context can be used for a streaming RPC, too.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Therefore, when it comes to receiving metadata from the client side, you need to treat them as either headers or trailers. In <a data-type="xref" href="#EX5-12">Example 5-12</a>, you can find Go code examples on receiving metadata for both unary and streaming RPC styles.</p>&#13;
<div data-type="example" id="EX5-12">&#13;
<h5><span class="label">Example 5-12. </span>Reading metadata on the gRPC client side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">header</code><code class="p">,</code><code> </code><code class="nx">trailer</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">MD</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO12-1" id="co_grpc__beyond_the_basics_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code class="c1">// ***** Unary RPC *****&#13;
</code><code>&#13;
</code><code class="nx">r</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">SomeRPC</code><code class="p">(</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO12-2" id="co_grpc__beyond_the_basics_CO12-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
    </code><code class="nx">ctx</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">someRequest</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Header</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">header</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Trailer</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">trailer</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// process header and trailer map here.&#13;
</code><code>&#13;
</code><code class="c1">// ***** Streaming RPC *****&#13;
</code><code>&#13;
</code><code class="nx">stream</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">client</code><code class="p">.</code><code class="nx">SomeStreamingRPC</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// retrieve header&#13;
</code><code class="nx">header</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">stream</code><code class="p">.</code><code class="nx">Header</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO12-3" id="co_grpc__beyond_the_basics_CO12-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
&#13;
</code><code class="c1">// retrieve trailer&#13;
</code><code class="nx">trailer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">stream</code><code class="p">.</code><code class="nx">Trailer</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO12-4" id="co_grpc__beyond_the_basics_CO12-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
</code><code class="c1">// process header and trailer map here.</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO12-1" id="callout_grpc__beyond_the_basics_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Variable to store header and trailer returned from the RPC call.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO12-2" id="callout_grpc__beyond_the_basics_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Pass header and trailer reference to store the returned values for unary RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO12-3" id="callout_grpc__beyond_the_basics_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Getting the headers from the stream.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO12-4" id="callout_grpc__beyond_the_basics_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Getting the trailers from the stream. Trailers are used to send status codes and the status message.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Once the values are obtained from the respective RPC operations, you can process them as a generic map and process the required metadata.</p>&#13;
&#13;
<p>Now let’s move on to metadata handling on the server side.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending and Receiving Metadata: Server Side" data-type="sect2"><div class="sect2" id="idm46536637905992">&#13;
<h2>Sending and Receiving Metadata: Server Side</h2>&#13;
&#13;
<p><a data-primary="metadata" data-secondary="sending/receiving: server side" data-type="indexterm" id="idm46536637997096"/><a data-primary="server" data-secondary="metadata: sending/receiving" data-type="indexterm" id="idm46536637996264"/>Receiving metadata on the server side is quite straightforward. Using Go, you can simply obtain the metadata with <code>metadata.FromIncomingContext(ctx)</code> inside your remote method implementations (see <a data-type="xref" href="#EX13">Example 5-13</a>).</p>&#13;
<div data-type="example" id="EX13">&#13;
<h5><span class="label">Example 5-13. </span>Reading metadata on the gRPC server side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">s</code><code> </code><code class="o">*</code><code class="nx">server</code><code class="p">)</code><code> </code><code class="nx">SomeRPC</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">in</code><code> </code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">someRequest</code><code class="p">)</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">someResponse</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO13-1" id="co_grpc__beyond_the_basics_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">md</code><code class="p">,</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">FromIncomingContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO13-2" id="co_grpc__beyond_the_basics_CO13-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
    </code><code class="c1">// do something with metadata&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">s</code><code> </code><code class="o">*</code><code class="nx">server</code><code class="p">)</code><code> </code><code class="nx">SomeStreamingRPC</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">stream</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">Service_SomeStreamingRPCServer</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO13-3" id="co_grpc__beyond_the_basics_CO13-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="nx">md</code><code class="p">,</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">FromIncomingContext</code><code class="p">(</code><code class="nx">stream</code><code class="p">.</code><code class="nx">Context</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO13-4" id="co_grpc__beyond_the_basics_CO13-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
    </code><code class="c1">// do something with metadata&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO13-1" id="callout_grpc__beyond_the_basics_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Unary RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO13-2" id="callout_grpc__beyond_the_basics_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Read the metadata map from the incoming context of the remote method.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO13-3" id="callout_grpc__beyond_the_basics_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Streaming RPC.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO13-4" id="callout_grpc__beyond_the_basics_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Obtain the context from the stream and read metadata from it.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>To send metadata from the server side, send a header with metadata or set a trailer with metadata. The metadata creation method is the same as what we discussed in the previous section. In <a data-type="xref" href="#EX5-14">Example 5-14</a>, you can find Go code examples of sending metadata from a unary and a streaming remote method implementation on the server side.</p>&#13;
<div data-type="example" id="EX5-14">&#13;
<h5><span class="label">Example 5-14. </span>Sending metadata from the gRPC server side</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">s</code><code> </code><code class="o">*</code><code class="nx">server</code><code class="p">)</code><code> </code><code class="nx">SomeRPC</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">in</code><code> </code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">someRequest</code><code class="p">)</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">someResponse</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="c1">// create and send header&#13;
</code><code>    </code><code class="nx">header</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code><code class="s">"header-key"</code><code class="p">,</code><code> </code><code class="s">"val"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">SendHeader</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">header</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO14-1" id="co_grpc__beyond_the_basics_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="c1">// create and set trailer&#13;
</code><code>    </code><code class="nx">trailer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code><code class="s">"trailer-key"</code><code class="p">,</code><code> </code><code class="s">"val"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">SetTrailer</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">trailer</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO14-2" id="co_grpc__beyond_the_basics_CO14-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">s</code><code> </code><code class="o">*</code><code class="nx">server</code><code class="p">)</code><code> </code><code class="nx">SomeStreamingRPC</code><code class="p">(</code><code class="nx">stream</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">Service_SomeStreamingRPCServer</code><code class="p">)</code><code> </code><code class="kt">error</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="c1">// create and send header&#13;
</code><code>    </code><code class="nx">header</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code><code class="s">"header-key"</code><code class="p">,</code><code> </code><code class="s">"val"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="nx">stream</code><code class="p">.</code><code class="nx">SendHeader</code><code class="p">(</code><code class="nx">header</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO14-3" id="co_grpc__beyond_the_basics_CO14-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="c1">// create and set trailer&#13;
</code><code>    </code><code class="nx">trailer</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">Pairs</code><code class="p">(</code><code class="s">"trailer-key"</code><code class="p">,</code><code> </code><code class="s">"val"</code><code class="p">)</code><code>    </code><code class="nx">stream</code><code class="p">.</code><code class="nx">SetTrailer</code><code class="p">(</code><code class="nx">trailer</code><code class="p">)</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO14-4" id="co_grpc__beyond_the_basics_CO14-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO14-1" id="callout_grpc__beyond_the_basics_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Send metadata as a header.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO14-2" id="callout_grpc__beyond_the_basics_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Send metadata along with the trailer.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO14-3" id="callout_grpc__beyond_the_basics_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Send metadata as a header in the stream.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO14-4" id="callout_grpc__beyond_the_basics_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Send metadata along with the trailer of the stream.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>In both the unary and streaming cases, you can send metadata using the <code>grpc.SendHeader</code> method. If you want to send metadata as part of the trailer, you need to set the metadata as part of the trailer of the context using the <code>grpc.SetTrailer</code> or <code>SetTrailer</code> method of the respective stream.</p>&#13;
&#13;
<p>Now let’s discuss another commonly used technique when calling gRPC applications: name resolving.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Name Resolver" data-type="sect2"><div class="sect2" id="idm46536637593832">&#13;
<h2>Name Resolver</h2>&#13;
&#13;
<p><a data-primary="metadata" data-secondary="name resolver" data-type="indexterm" id="idm46536637592584"/><a data-primary="name resolver" data-type="indexterm" id="idm46536637545448"/>A <em>name resolver</em> takes a service name and returns a list of IPs of the backends. The resolver used in <a data-type="xref" href="#EX5-16">Example 5-15</a> resolves <code>lb.example.grpc.io</code> to <code>localhost:50051</code> and <code>localhost:50052</code>.</p>&#13;
<div data-type="example" id="EX5-16">&#13;
<h5><span class="label">Example 5-15. </span>gRPC name resolver implementation in Go</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code> </code><code class="nx">exampleResolverBuilder</code><code> </code><code class="kd">struct</code><code class="p">{</code><code class="p">}</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO15-1" id="co_grpc__beyond_the_basics_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">exampleResolverBuilder</code><code class="p">)</code><code> </code><code class="nx">Build</code><code class="p">(</code><code class="nx">target</code><code> </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Target</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">cc</code><code> </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">ClientConn</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="nx">opts</code><code> </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">BuildOption</code><code class="p">)</code><code> </code><code class="p">(</code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Resolver</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">r</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">exampleResolver</code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO15-2" id="co_grpc__beyond_the_basics_CO15-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
		</code><code class="nx">target</code><code class="p">:</code><code> </code><code class="nx">target</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">cc</code><code class="p">:</code><code>     </code><code class="nx">cc</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="nx">addrsStore</code><code class="p">:</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code>&#13;
</code><code>           </code><code class="nx">exampleServiceName</code><code class="p">:</code><code> </code><code class="nx">addrs</code><code class="p">,</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO15-3" id="co_grpc__beyond_the_basics_CO15-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
		</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="nx">r</code><code class="p">.</code><code class="nx">start</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">r</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">exampleResolverBuilder</code><code class="p">)</code><code> </code><code class="nx">Scheme</code><code class="p">(</code><code class="p">)</code><code> </code><code class="kt">string</code><code> </code><code class="p">{</code><code> </code><code class="k">return</code><code> </code><code class="nx">exampleScheme</code><code> </code><code class="p">}</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO15-4" id="co_grpc__beyond_the_basics_CO15-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
</code><code class="kd">type</code><code> </code><code class="nx">exampleResolver</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO15-5" id="co_grpc__beyond_the_basics_CO15-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
	</code><code class="nx">target</code><code>     </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Target</code><code>&#13;
</code><code>	</code><code class="nx">cc</code><code>         </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">ClientConn</code><code>&#13;
</code><code>	</code><code class="nx">addrsStore</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">r</code><code> </code><code class="o">*</code><code class="nx">exampleResolver</code><code class="p">)</code><code> </code><code class="nx">start</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">addrStrs</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">addrsStore</code><code class="p">[</code><code class="nx">r</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">Endpoint</code><code class="p">]</code><code>&#13;
</code><code>	</code><code class="nx">addrs</code><code> </code><code class="o">:=</code><code> </code><code class="nb">make</code><code class="p">(</code><code class="p">[</code><code class="p">]</code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Address</code><code class="p">,</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="nx">addrStrs</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">for</code><code> </code><code class="nx">i</code><code class="p">,</code><code> </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="k">range</code><code> </code><code class="nx">addrStrs</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="nx">addrs</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Address</code><code class="p">{</code><code class="nx">Addr</code><code class="p">:</code><code> </code><code class="nx">s</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="nx">r</code><code class="p">.</code><code class="nx">cc</code><code class="p">.</code><code class="nx">UpdateState</code><code class="p">(</code><code class="nx">resolver</code><code class="p">.</code><code class="nx">State</code><code class="p">{</code><code class="nx">Addresses</code><code class="p">:</code><code> </code><code class="nx">addrs</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">exampleResolver</code><code class="p">)</code><code> </code><code class="nx">ResolveNow</code><code class="p">(</code><code class="nx">o</code><code> </code><code class="nx">resolver</code><code class="p">.</code><code class="nx">ResolveNowOption</code><code class="p">)</code><code> </code><code class="p">{</code><code class="p">}</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="o">*</code><code class="nx">exampleResolver</code><code class="p">)</code><code> </code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>                                 </code><code class="p">{</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">init</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">resolver</code><code class="p">.</code><code class="nx">Register</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">exampleResolverBuilder</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO15-1" id="callout_grpc__beyond_the_basics_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Name resolver builder that creates the resolver.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO15-2" id="callout_grpc__beyond_the_basics_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creating the example resolver that resolves <code>lb.example.grpc.io</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO15-3" id="callout_grpc__beyond_the_basics_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This resolves <code>lb.example.grpc.io</code> to <code>localhost:50051</code> and <code>localhost:50052</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO15-4" id="callout_grpc__beyond_the_basics_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This resolver is created for scheme <code>example</code>.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO15-5" id="callout_grpc__beyond_the_basics_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Structure of the name resolver.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Thus, based on this name resolver implementation, you can implement resolvers for any service registry of your choice such as <a href="https://www.consul.io">Consul</a>, <a href="https://etcd.io">etcd</a>, and <a href="https://zookeeper.apache.org">Zookeeper</a>.&#13;
The gRPC load-balancing requirements may be quite dependent on the deployment patterns that you use or on the use cases. With the increasing adoption of container orchestration platforms such as Kubernetes and more higher-level abstractions such as service mesh, the need to implement load-balancing logic on the client side is becoming quite rare. We’ll explore some best practices for deploying gRPC applications locally on containers, as well as Kubernetes, in <a data-type="xref" href="ch07.html#ch_07">Chapter 7</a>.<a data-startref="ix_ch05-asciidoc10" data-type="indexterm" id="idm46536637315656"/></p>&#13;
&#13;
<p>Now let’s discuss one of the most common requirements of your gRPC applications, load balancing, in which we can use name resolvers in certain cases.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Load Balancing" data-type="sect1"><div class="sect1" id="idm46536637314056">&#13;
<h1>Load Balancing</h1>&#13;
&#13;
<p><a data-primary="load balancing" data-type="indexterm" id="ix_ch05-asciidoc11"/>Often when you develop production-ready gRPC applications, you need to make sure that your application can cater to high availability and scalability needs. Therefore, you always run more than one gRPC server in production.&#13;
So, distributing RPC calls between these services needs to be taken care of by some entity. That’s where load balancing comes into play.&#13;
Two main load-balancing mechanisms are commonly used in gRPC: a <em>load-balancer (LB) proxy</em> and <em>client-side load balancing</em>. Let’s start by discussing the LB proxy.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Load-Balancer Proxy" data-type="sect2"><div class="sect2" id="idm46536637310296">&#13;
<h2>Load-Balancer Proxy</h2>&#13;
&#13;
<p><a data-primary="LB (load-balancer) proxy" data-type="indexterm" id="idm46536637308888"/><a data-primary="load balancing" data-secondary="load-balancer proxy" data-type="indexterm" id="idm46536637308120"/><a data-primary="load-balancer (LB) proxy" data-type="indexterm" id="idm46536637307176"/><a data-primary="proxy load balancing" data-type="indexterm" id="idm46536637306488"/>In proxy load balancing (<a data-type="xref" href="#client_application_invokes_a_load_balancer_which_is_fronting_multiple_grpc_services">Figure 5-6</a>), the client issues RPCs to the LB proxy. Then the LB proxy distributes the RPC call to one of the available backend gRPC servers that implements the actual logic for serving the call. The LB proxy keeps track of load on each backend server and offers a different load-balancing algorithm for distributing the load among the backend services.</p>&#13;
&#13;
<figure><div class="figure" id="client_application_invokes_a_load_balancer_which_is_fronting_multiple_grpc_services">&#13;
<img alt="Client application invokes a  load balancer which is fronting multiple gRPC services." src="assets/grpc_0506.png"/>&#13;
<h6><span class="label">Figure 5-6. </span>Client application invokes a load balancer that fronts multiple gRPC services</h6>&#13;
</div></figure>&#13;
&#13;
<p>The topology of the backend services is not transparent to the gRPC clients, and they are only aware of the load balancer’s endpoint. Therefore, on the client side, you don’t need to make any changes to cater to a load-balancing use case, apart from using the load balancer’s endpoint as the destination for all your gRPC connections. The backend services can report the load status back to the load balancer so that it can use that information for the load-balancing logic.</p>&#13;
&#13;
<p>In theory, you can select any load balancer that supports HTTP/2 as the LB proxy for your gRPC applications. However, it must have full HTTP/2 support. Thus it’s always a good idea to specifically choose load balancers that explicitly offer gRPC support. For instance, you can use load-balancing solutions such as <a href="https://oreil.ly/QH_1c">Nginx</a>, <a href="https://www.envoyproxy.io">Envoy proxy</a>, etc., as the LB proxy for your gRPC applications.</p>&#13;
&#13;
<p>If you don’t use a gRPC load balancer, then you can implement the load-balancing logic as part of the client applications you write. Let’s look more closely at client-side load balancing.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Client-Side Load Balancing" data-type="sect2"><div class="sect2" id="idm46536637298808">&#13;
<h2>Client-Side Load Balancing</h2>&#13;
&#13;
<p><a data-primary="client" data-secondary="load balancing" data-type="indexterm" id="ix_ch05-asciidoc12"/><a data-primary="load balancing" data-secondary="client-side" data-type="indexterm" id="ix_ch05-asciidoc13"/>Rather than having an intermediate proxy layer for load balancing, you can implement the load-balancing logic at the gRPC client level. In this method, the client is aware of multiple backend gRPC servers and chooses one to use for each RPC. As illustrated in <a data-type="xref" href="#client_side_load_balancing">Figure 5-7</a>, the load-balancing logic may be entirely developed as part of the client application (also known as <em>thick client</em>) or it can be implemented in a dedicated server known as lookaside load balancer. Then the client can query it to obtain the best gRPC server to connect to. The client directly connects to the gRPC server address obtained by the lookaside load balancer.</p>&#13;
&#13;
<figure><div class="figure" id="client_side_load_balancing">&#13;
<img alt="Client-side load balancing" src="assets/grpc_0507.png"/>&#13;
<h6><span class="label">Figure 5-7. </span>Client-side load balancing</h6>&#13;
</div></figure>&#13;
&#13;
<p>To understand how you can implement client-side load balancing, let’s look at an example of a thick client implemented using Go. In this use case, suppose we have two backend gRPC services running an echo server on :50051 and :50052. These gRPC services will include the serving address of the server as part of the RPC response. So we can consider these two servers as two members of an echo gRPC service cluster.&#13;
Now, suppose we want to build a gRPC client application that uses the round-robin (executed in turn against every other) algorithm when selecting the gRPC server endpoint and another client that uses the first endpoint of the server endpoint list. <a data-type="xref" href="#EX5-15">Example 5-16</a> shows the thick client load-balancing implementation. Here you can observe that the client is dialing <em>example:///lb.example.grpc.io</em>. So, we are using the  <code>example</code> scheme name and <code>lb.example.grpc.io</code> as the server name. Based on this scheme, it will look for a name resolver to discover the absolute value for the backend service address. Based on the list of values the name resolver returns, gRPC runs different load-balancing algorithms against those servers. The behavior is configured with <code>grpc.WithBalancerName("round_robin")</code>.</p>&#13;
<div data-type="example" id="EX5-15">&#13;
<h5><span class="label">Example 5-16. </span>Client-side load balancing with a thick client</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">pickfirstConn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code>&#13;
</code><code>		</code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"%s:///%s"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="c1">// 	exampleScheme      = "example"&#13;
</code><code>        </code><code class="c1">//	exampleServiceName = "lb.example.grpc.io"&#13;
</code><code>        </code><code class="nx">exampleScheme</code><code class="p">,</code><code> </code><code class="nx">exampleServiceName</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO16-1" id="co_grpc__beyond_the_basics_CO16-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
        </code><code class="c1">// "pick_first" is the default option. </code><a class="co" href="#callout_grpc__beyond_the_basics_CO16-2" id="co_grpc__beyond_the_basics_CO16-2"><img alt="2" src="assets/2.png"/></a><code class="c1">&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithBalancerName</code><code class="p">(</code><code class="s">"pick_first"</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="k">defer</code><code> </code><code class="nx">pickfirstConn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"==== Calling helloworld.Greeter/SayHello "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>	</code><code class="s">"with pick_first ===="</code><code class="p">)</code><code>&#13;
</code><code class="nx">makeRPCs</code><code class="p">(</code><code class="nx">pickfirstConn</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// Make another ClientConn with round_robin policy.&#13;
</code><code class="nx">roundrobinConn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"%s:///%s"</code><code class="p">,</code><code> </code><code class="nx">exampleScheme</code><code class="p">,</code><code> </code><code class="nx">exampleServiceName</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="c1">// "example:///lb.example.grpc.io"&#13;
</code><code>    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithBalancerName</code><code class="p">(</code><code class="s">"round_robin"</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_grpc__beyond_the_basics_CO16-3" id="co_grpc__beyond_the_basics_CO16-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="k">defer</code><code> </code><code class="nx">roundrobinConn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nx">log</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"==== Calling helloworld.Greeter/SayHello "</code><code> </code><code class="o">+</code><code>&#13;
</code><code>	</code><code class="s">"with round_robin ===="</code><code class="p">)</code><code>&#13;
</code><code class="nx">makeRPCs</code><code class="p">(</code><code class="nx">roundrobinConn</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO16-1" id="callout_grpc__beyond_the_basics_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creating a gRPC connection with a <em>scheme</em> and the service name. The scheme is resolved from a scheme resolver, which is part of the client application.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO16-2" id="callout_grpc__beyond_the_basics_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Specifying a load-balancing algorithm that picks the first server on the server endpoint list.</p></dd>&#13;
<dt><a class="co" href="#co_grpc__beyond_the_basics_CO16-3" id="callout_grpc__beyond_the_basics_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Using the round-robin load-balancing algorithm.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>There are two load-balancing policies supported in gRPC by default: <code>pick_first</code> and <code>round_robin</code>. <code>pick_first</code> tries to connect to the first address, uses it for all RPCs if it connects, or tries the next address if it fails. <code>round_robin</code> connects to all the addresses it sees and sends an RPC to each backend one at a time in order.</p>&#13;
&#13;
<p>In the client-side load-balancing scenario in <a data-type="xref" href="#EX5-15">Example 5-16</a>, we have a name resolver to resolve scheme <code>example</code>, which contains the logic of discovering the actual values of the endpoint URLs.&#13;
Now let’s talk about compression, another commonly used feature of gRPC, for sending large amounts of content over RPC.<a data-startref="ix_ch05-asciidoc13" data-type="indexterm" id="idm46536637271560"/><a data-startref="ix_ch05-asciidoc12" data-type="indexterm" id="idm46536637270856"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Compression" data-type="sect2"><div class="sect2" id="idm46536637270056">&#13;
<h2>Compression</h2>&#13;
&#13;
<p><a data-primary="bandwidth, compression and" data-type="indexterm" id="idm46536637268888"/><a data-primary="compression" data-type="indexterm" id="idm46536637189416"/><a data-primary="load balancing" data-secondary="compression" data-type="indexterm" id="idm46536637188856"/>To use network bandwidth efficiently, use compression when performing RPCs between client and services. <a data-primary="client" data-secondary="compression" data-type="indexterm" id="idm46536637187656"/>Using gRPC compression on the client side can be implemented by setting a compressor when you do the RPC. For example, in Go, this is as easy as using <code>client.AddOrder(ctx, &amp;order1, grpc.UseCompressor(gzip.Name))</code>, where <code>"google.golang.org/grpc/encoding/gzip"</code> provides the gzip package.</p>&#13;
&#13;
<p><a data-primary="server" data-secondary="compression" data-type="indexterm" id="idm46536637185368"/>From the server side, registered compressors will be used automatically to decode request messages and encode the responses. In Go, registering a compressor is as simple as importing <code>"google.golang.org/grpc/encoding/gzip"</code> into your gRPC server application. The server always responds using the same compression method specified by the client. If the corresponding compressor has not been registered, an <code>Unimplemented</code> status will be returned to the client. <a data-startref="ix_ch05-asciidoc11" data-type="indexterm" id="idm46536637183064"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46536637182104">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Building production-ready, real-world gRPC applications often requires you to include various capabilities besides defining the service interface, generating the server and client code, and implementing the business logic. As you saw in this chapter, gRPC offers a wide range of capabilities that you will need when building gRPC applications, including interceptors, deadlines, cancellations, and error handling.</p>&#13;
&#13;
<p>However, we haven’t yet discussed how to secure gRPC applications and how to consume them. So, in the next chapter we’ll cover this topic in detail.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>