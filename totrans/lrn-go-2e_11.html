<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Go Tooling"><div class="chapter" id="unique_chapter_id_11">
<h1><span class="label">Chapter 11. </span>Go Tooling</h1>


<p>A programming language doesn’t exist<a data-type="indexterm" data-primary="tools" data-secondary="about" data-seealso="go commands" id="id2244"/> in isolation. For it to be useful, tools must help the developer turn source code into an executable. Since Go is intended to address the problems that software engineers face today and to help them build quality software, careful thought has been put into tooling that simplifies tasks that are often difficult with other development platforms. This includes improvements in how you build, format, update, validate, and distribute, and even how your users will install your code.</p>

<p>I have already covered many of the bundled Go tools: <code>go vet</code>, <code>go fmt</code>, <code>go mod</code>, <code>go get</code>, <code>go list</code>, <code>go work</code>, <code>go doc</code>, and <code>go build</code>. The testing support provided by the <code>go test</code> tool is so extensive, it is covered by itself in <a data-type="xref" href="ch15.html#unique_chapter_id_15">Chapter 15</a>. In this chapter, you will explore additional tools that make Go development great, both from the Go team and from third parties.</p>






<section data-type="sect1" data-pdf-bookmark="Using go run to Try Out Small Programs"><div class="sect1" id="go_run">
<h1>Using go run to Try Out Small Programs</h1>

<p>Go is a compiled language, which<a data-type="indexterm" data-primary="tools" data-secondary="go run to build and execute" id="id2245"/><a data-type="indexterm" data-primary="go commands" data-secondary="go run" id="id2246"/><a data-type="indexterm" data-primary="compiling" data-secondary="go run to build and execute" id="id2247"/><a data-type="indexterm" data-primary="builds" data-secondary="go run to build and execute" id="id2248"/> means that before Go code is run, it must be converted into an executable file. This is in contrast to interpreted languages like Python or JavaScript, which allow you to write a quick script to test an idea and execute it immediately. Having that rapid feedback cycle is important, so Go provides similar functionality via the <code>go run</code> command. It builds and executes a program in one step. Let’s go back to the first program from <a data-type="xref" href="ch01.html#unique_chapter_id_01">Chapter 1</a>. Put it in a file called <em>hello.go</em>:</p>

<pre data-type="programlisting" data-code-language="go" class="pagebreak-before"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="s">"fmt"</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Hello, world!"</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>(You can also find this code in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> in the <em>sample_code/gorun</em> directory.)<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2249"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2250"/></p>

<p>Once the file is saved, use the <code>go run</code> command to build and execute it:</p>
<pre data-type="programlisting">
<strong>go run hello.go</strong>
Hello, world!
</pre>

<p>If you look inside the directory after running the <code>go run</code> command, you see that no binary has been saved there; the only file in the directory is the <em>hello.go</em> file you just created. Where did the executable go (no pun intended)?</p>

<p>The <code>go run</code> command does, in fact, compile your code into a binary. However, the binary is built in a temporary directory. The <code>go run</code> command builds the binary, executes the binary from that temporary directory, and then deletes the binary after your program finishes. <a data-type="indexterm" data-primary="“scripting” via go run" data-primary-sortas="scripting" id="id2251"/>This makes the <code>go run</code> command useful for testing out small programs or using Go like a scripting language.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Use <code>go run</code> when you want to treat a Go program like a script and run the source code immediately.</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Adding Third-Party Tools with go install"><div class="sect1" id="go_install">
<h1>Adding Third-Party Tools with go install</h1>

<p>While some people choose to distribute<a data-type="indexterm" data-primary="tools" data-secondary="go install" id="ch11-ins"/><a data-type="indexterm" data-primary="go commands" data-secondary="go install" id="ch11-ins2"/><a data-type="indexterm" data-primary="compiling" data-secondary="go install" id="ch11-ins3"/><a data-type="indexterm" data-primary="builds" data-secondary="go install" id="ch11-ins4"/> their Go programs as precompiled binaries, tools written in Go can also be built from source and installed on your computer via the <code>go install</code> command.</p>

<p>As you saw in <a data-type="xref" href="ch10.html#publish_module">“Publishing Your Module”</a>, Go modules are identified via their source code repositories.<a data-type="indexterm" data-primary="@latest" data-secondary="installing third-party tools" id="id2252"/><a data-type="indexterm" data-primary="@version" data-secondary="installing third-party tools" id="id2253"/> The <code>go install</code> command takes an argument, which is the path to the main package in a module’s source code repository, followed by an <code>@</code> and the version of the tool you want (if you just want to get the latest version, use <code>@latest</code>). It then downloads, compiles, and installs the tool.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Always be sure to include the <code>@version</code> or <code>@latest</code> after the name of the package that you are installing! If you don’t, it triggers a variety of confusing behaviors and is almost certainly not what you want to do. You either get an error message (if the current directory is not in a module, or if the current directory is a module, but the package isn’t referenced in the module’s <em>go.mod</em> file), or it installs the package version mentioned in <em>go.mod</em>.</p>
</div>

<p>By default, <code>go install</code> places binaries<a data-type="indexterm" data-primary="environment variables" data-secondary="GOBIN" id="id2254"/><a data-type="indexterm" data-primary="GOBIN environment variable" id="id2255"/><a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="GOBIN to set install path" id="id2256"/><a data-type="indexterm" data-primary="go/bin directory" id="id2257"/> into the <em>go/bin</em> directory within your home directory. Set the <em>GOBIN</em> environment variable to change this location. It is strongly recommended that you add the <code>go install</code> directory to your executable search path (this is done by modifying the <em>PATH</em> environment variable on both Unix and Windows). For simplicity, all the examples in this chapter assume that you’ve added this directory.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Other environment variables<a data-type="indexterm" data-primary="environment variables" data-secondary="go help environment to list" id="id2258"/><a data-type="indexterm" data-primary="go commands" data-secondary="go help" data-tertiary="go help environment" id="id2259"/><a data-type="indexterm" data-primary="tools" data-secondary="go help" data-tertiary="go help environment" id="id2260"/> are recognized by the <code>go</code> tool. You can get a complete list, along with a brief description of each variable, using the <code>go help environment</code> command. Many of them control low-level behavior that can be safely ignored. I’ll point out the relevant ones as needed.</p>

<p>Some online resources tell you<a data-type="indexterm" data-primary="environment variables" data-secondary="GOROOT" id="id2261"/><a data-type="indexterm" data-primary="GOROOT environment variable" id="id2262"/><a data-type="indexterm" data-primary="environment variables" data-secondary="GOPATH" id="id2263"/><a data-type="indexterm" data-primary="GOPATH environment variable" id="id2264"/> to set the <code>GOROOT</code> or <code>GOPATH</code> environment variables. <code>GOROOT</code> specifies the location where your Go development environment is installed, and <code>GOPATH</code> was used to store all Go source code, both your own and third-party dependencies. Setting these variables is no longer necessary; the <code>go</code> tool figures out <code>GOROOT</code> automatically, and <code>GOPATH</code>-based development has been superseded by modules.</p>
</div>

<p>Let’s look at a quick example.<a data-type="indexterm" data-primary="Dogan, Jaana" id="id2265"/><a data-type="indexterm" data-primary="tools" data-secondary="hey to load test HTTP servers" id="id2266"/><a data-type="indexterm" data-primary="hey tool to load test HTTP servers" id="id2267"/><a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="installing hey" id="id2268"/> Jaana Dogan created a great Go tool called <code>hey</code> that load tests HTTP servers. You can point it at the website of your choosing or an application that you’ve written. Here’s how to install <code>hey</code> with the <code>go install</code> command:</p>
<pre data-type="programlisting">
$ <strong>go install github.com/rakyll/hey@latest</strong>
go: downloading github.com/rakyll/hey v0.1.4
go: downloading golang.org/x/net v0.0.0-20181017193950-04a2e542c03f
go: downloading golang.org/x/text v0.3.0
</pre>

<p>This downloads <code>hey</code> and all its dependencies, builds the program, and installs the binary in your Go binary directory.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As I covered in <a data-type="xref" href="ch10.html#proxy_server">“Module Proxy Servers”</a>, the contents of Go repositories are cached in proxy servers. <a data-type="indexterm" data-primary="GOPROXY environment variable" id="id2269"/><a data-type="indexterm" data-primary="environment variables" data-secondary="GOPROXY" id="id2270"/><a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="GOPROXY for proxy or repository" id="id2271"/>Depending on the repository and the values in your <code>GOPROXY</code> environment variable, <code>go install</code> may download from a proxy or directly from a repository. If <code>go install</code> downloads directly from a repository, it relies on command-line tools being installed on your computer. <a data-type="indexterm" data-primary="GitHub" data-secondary="Git needed for downloading" id="id2272"/><a data-type="indexterm" data-primary="Git for version control" data-secondary="needed to download from GitHub" id="id2273"/><a data-type="indexterm" data-primary="repositories" data-secondary="GitHub" data-tertiary="Git needed for downloading" id="id2274"/><a data-type="indexterm" data-primary="repositories" data-secondary="version control software" data-tertiary="Git needed for GitHub downloads" id="id2275"/>For example, you must have Git installed to download from 
<span class="keep-together">GitHub.</span></p>
</div>

<p>Now that you have built and installed <code>hey</code>, you can run it with the following:</p>
<pre data-type="programlisting">
$ <strong>hey https://go.dev</strong>

Summary:
  Total:           2.1272 secs
  Slowest:         1.4227 secs
  Fastest:         0.0573 secs
  Average:         0.3467 secs
  Requests/sec:    94.0181
</pre>

<p>If you have already installed a tool<a data-type="indexterm" data-primary="tools" data-secondary="updating to newer version" id="id2276"/><a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="updating a tool to newer version" id="id2277"/><a data-type="indexterm" data-primary="updating third-party tools" id="id2278"/><a data-type="indexterm" data-primary="@latest" data-secondary="installing third-party tools" data-tertiary="updating a tool" id="id2279"/><a data-type="indexterm" data-primary="@version" data-secondary="installing third-party tools" data-tertiary="updating a tool" id="id2280"/> and want to update it to a newer version, rerun <code>go install</code> with the newer version specified or with <code>@latest</code>:</p>
<pre data-type="programlisting">
$ <strong>go install github.com/rakyll/hey@latest</strong>
</pre>

<p>Of course, you don’t need to leave programs installed via <code>go install</code> in the <em>go/bin</em> directory; they are regular executable binaries and can be stored anywhere on your computer. Likewise, you don’t have to distribute programs written in Go using <code>go install</code>; you can put a binary up for download. However, <code>go install</code> is convenient for Go developers, and it has become the method of choice for distributing third-party developer tools.<a data-type="indexterm" data-startref="ch11-ins" id="id2281"/><a data-type="indexterm" data-startref="ch11-ins2" id="id2282"/><a data-type="indexterm" data-startref="ch11-ins3" id="id2283"/><a data-type="indexterm" data-startref="ch11-ins4" id="id2284"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Improving Import Formatting with goimports"><div class="sect1" id="id140">
<h1>Improving Import Formatting with goimports</h1>

<p>An enhanced version<a data-type="indexterm" data-primary="tools" data-secondary="goimports improving formatting" id="id2285"/><a data-type="indexterm" data-primary="goimports tool improving formatting" id="id2286"/><a data-type="indexterm" data-primary="go commands" data-secondary="go fmt" data-tertiary="goimports as enhanced version" id="id2287"/> of <code>go fmt</code> called <code>goimports</code> also cleans up your import statements. It puts them in alphabetical order, removes unused imports, and attempts to guess any unspecified imports. Its guesses are sometimes inaccurate, so you should insert imports yourself.</p>

<p>You can download <code>goimports</code> with<a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="goimports tool install command" id="id2288"/> the command <code>go install golang.org/x/tools/cmd/goimports@latest</code>. You run it across your project with this command:</p>
<pre data-type="programlisting">
$ <strong>goimports -l -w .</strong>
</pre>

<p>The <code>-l</code> flag tells <code>goimports</code> to print the files with incorrect formatting to the console. The <code>-w</code> flag tells <code>goimports</code> to modify the files in place. The <code>.</code> specifies the files to be scanned: everything in the current directory and all its subdirectories.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The packages under <code>golang.org/x</code> are part<a data-type="indexterm" data-primary="Go Project golang.org/x packages" id="id2289"/><a data-type="indexterm" data-primary="golang.org/x packages" id="id2290"/> of the Go Project but outside the main Go tree. While useful, they are developed under looser compatibility requirements than the Go standard library and may introduce backward-breaking changes. Some packages in the standard library, such as the context package that is covered in <a data-type="xref" href="ch14.html#unique_chapter_id_14">Chapter 14</a>, started out in <code>golang.org/x</code>. The <code>pkgsite</code> tool that was covered in <a data-type="xref" href="ch10.html#godoc">“Documenting Your Code with Go Doc Comments”</a> is also located there. You can see the other packages in the <a href="https://oreil.ly/tuROf">“Sub-repositories” section</a>.</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using Code-Quality Scanners"><div class="sect1" id="code_quality">
<h1>Using Code-Quality Scanners</h1>

<p>Back in <a data-type="xref" href="ch01.html#go_vet">“go vet”</a>, you looked at<a data-type="indexterm" data-primary="tools" data-secondary="code style check and bug scan" id="ch11-vet"/><a data-type="indexterm" data-primary="go commands" data-secondary="go vet" data-tertiary="third-party tools" id="ch11-vet2"/><a data-type="indexterm" data-primary="linters" id="ch11-vet3"/><a data-type="indexterm" data-primary="testing" data-secondary="go vet" data-tertiary="third-party tools" id="ch11-vet4"/> the built-in tool <code>go vet</code>, which scans source code for common programming errors. Many third-party tools can check code style and scan for potential bugs that are missed by <code>go vet</code>. These tools are often called <em>linters</em>.<sup><a data-type="noteref" id="id2291-marker" href="ch11.html#id2291">1</a></sup> In addition to likely programming errors, some of the changes suggested by these tools include properly naming variables, formatting error messages, and placing comments on public methods and types. These aren’t errors since they don’t keep your programs from compiling or make your program run incorrectly, but they do flag situations where you are writing nonidiomatic code.</p>

<p>When you add linters to your build process, follow the old maxim “trust, but verify.” Since the kinds of issues that linters find are fuzzier, they sometimes have false positives and false negatives. This means you don’t <em>have</em> to make the changes that they suggest, but you should take the suggestions seriously. Go developers expect code to look a certain way and follow certain rules, and if your code does not, it sticks out.</p>

<p>If you find a linter’s suggestion to be unhelpful, each linting tool allows you to add a comment to your source code that blocks the errant result (the format of the comment varies from linter to linter; check each tool’s documentation to learn what to write). Your comment should also include an explanation of why you are ignoring the linter’s finding, so code reviewers (and future you, when you look back on your source code in six months) understand your reasoning.</p>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="staticcheck"><div class="sect2" id="staticcheck">
<h2>staticcheck</h2>

<p>If you had to pick one third-party scanner,<a data-type="indexterm" data-primary="tools" data-secondary="code style check and bug scan" data-tertiary="staticcheck" id="ch11-sta"/><a data-type="indexterm" data-primary="staticcheck linter" id="ch11-sta2"/><a data-type="indexterm" data-primary="linters" data-secondary="staticcheck" id="ch11-sta3"/> use <a href="https://oreil.ly/ky8ZD"><code>staticcheck</code></a>. It is supported by many companies that are active in the Go community, includes more than 150 code-quality checks, and tries to produce few to no false positives. It is installed via <code>go install honnef.co/go/tools/cmd/staticcheck@latest</code>. Invoke it with  <code>staticcheck ./...</code> to examine your module.</p>

<p>Here’s an example of something that <code>staticcheck</code> finds that <code>go vet</code> does not:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="s">"fmt"</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">s</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"Hello"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>(You can also find this code in the <em>sample_code/staticcheck_test</em> directory in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a>.)<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_kkkk"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_kkk"/></p>

<p>If you run <code>go vet</code> on this code, it doesn’t find anything wrong. But, <code>staticcheck</code> notices a problem:</p>
<pre data-type="programlisting">
$ <strong>staticcheck ./...</strong>
main.go:6:7: unnecessary use of fmt.Sprintf (S1039)
</pre>

<p>Pass the code in parentheses to <code>staticcheck</code> with the <code>-explain</code> flag for an explanation of the issue:</p>
<pre data-type="programlisting">
$ <strong>staticcheck -explain S1039</strong>
Unnecessary use of fmt.Sprint

Calling fmt.Sprint with a single string argument is unnecessary
and identical to using the string directly.

Available since
    2020.1

Online documentation
    https://staticcheck.io/docs/checks#S1039
</pre>

<p>Another common issue that <code>staticcheck</code> finds is unused assignments to variables. While the Go compiler requires all variables to be read <em>once</em>, it doesn’t check that <em>every</em> value assigned to a variable is read. It is a common practice to reuse an <code>err</code> variable when there are multiple function calls within a function. If you forget to write <code>if err != nil</code> after one of those function invocations, the compiler won’t be able to help you. However, <code>staticcheck</code> can. This code compiles without a problem:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">returnErr</code><code class="p">(</code><code class="kc">false</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">returnErr</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"end of program"</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>(This code is in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> in the <em>sample_code/check_err</em> directory.)</p>

<p>Running <code>staticcheck</code> finds the mistake:</p>
<pre data-type="programlisting">
$ <strong>staticcheck ./...</strong>
main.go:13:2: this value of err is never used (SA4006)
main.go:13:8: returnErr doesn't have side effects and its return value is
ignored (SA4017)
</pre>

<p>There are two related issues on line 13. The first is that the error returned by <code>returnErr</code> is never read. The second is that the <code>returnErr</code> function’s output (the error) is being ignored.<a data-type="indexterm" data-startref="ch11-sta" id="id2292"/><a data-type="indexterm" data-startref="ch11-sta2" id="id2293"/><a data-type="indexterm" data-startref="ch11-sta3" id="id2294"/></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="revive"><div class="sect2" id="id143">
<h2>revive</h2>

<p>Another good linting option<a data-type="indexterm" data-primary="tools" data-secondary="code style check and bug scan" data-tertiary="revive" id="id2295"/><a data-type="indexterm" data-primary="linters" data-secondary="revive" id="id2296"/><a data-type="indexterm" data-primary="revive linter" id="id2297"/> is <a href="https://revive.run"><code>revive</code></a>. It is based on <code>golint</code>, a tool that used to be maintained by the Go team. Install <code>revive</code> with the command <code>go install github.com/mgechev/revive@latest</code>. By default, it enables only the rules that were present in <code>golint</code>. It can find style and code-quality issues like exported identifiers that don’t have comments, variables that don’t follow naming conventions, or error return values that aren’t the last return value.</p>

<p>With a configuration file, you can turn on many more rules. For example, to enable a check for shadowing of universe block identifiers, create a file named <em>built_in.toml</em> with the following contents:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[rule.redefines-builtin-id]</code><code class="w"/></pre>

<p>If you scan the following code:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="s">"fmt"</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kc">true</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="kc">false</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>you’ll get this warning:</p>
<pre data-type="programlisting" class="less_space pagebreak-before">
$ <strong>revive -config built_in.toml ./...</strong>
main.go:6:2: assignment creates a shadow of built-in identifier true
</pre>

<p>(You can also find this code in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> in the <em>sample_code/revive_test</em> directory.)</p>

<p>Other rules that can be enabled are focused on opinionated code organization, like limiting the number of lines in a function or number of public structs in a file. There are even rules for evaluating the complexity of the logic in a function. Check out the <a href="https://oreil.ly/WGY9S"><code>revive</code> documentation</a> and its <a href="https://revive.run/r">supported rules</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="golangci-lint"><div class="sect2" id="id144">
<h2>golangci-lint</h2>

<p>Finally, if you’d rather take the<a data-type="indexterm" data-primary="tools" data-secondary="code style check and bug scan" data-tertiary="golangci-lint" id="ch11-golang"/><a data-type="indexterm" data-primary="golangci-lint linter" id="ch11-golang2"/><a data-type="indexterm" data-primary="linters" data-secondary="golangci-lint" id="ch11-golang3"/> buffet approach to tool selection, there’s <a href="https://oreil.ly/p9BH4"><code>golangci-lint</code></a>. It is designed to make it as efficient as possible to configure and run over 50 code-quality tools, including <code>go vet</code>, <code>staticcheck</code>, and <code>revive</code>.</p>

<p>While you can use <code>go install</code> to install <code>golangci-lint</code>, it is recommended that you download a binary version instead. Follow the installation instructions on the <a href="https://oreil.ly/IKa_S">website</a>. Once it is installed, you run <code>golangci-lint</code>:</p>
<pre data-type="programlisting">
$ <strong>golangci-lint run</strong>
</pre>

<p>Back in <a data-type="xref" href="ch02.html#unused_vars_section">“Unused Variables”</a>, you looked at a program with variables set to values that were never read, and I mentioned that <code>go vet</code> and the go compiler were unable to detect these issues. Neither <code>staticcheck</code> nor <code>revive</code> catches this problem. However, one of the tools bundled with <code>golangci-lint</code> does:</p>
<pre data-type="programlisting">
$ <strong>golangci-lint run</strong>
main.go:6:2: ineffectual assignment to x (ineffassign)
    x := 10
    ^
main.go:9:2: ineffectual assignment to x (ineffassign)
    x = 30
    ^
</pre>

<p>You can also use <code>golangci-lint</code> to provide shadowing checks that go beyond what <code>revive</code> can do. Configure <code>golangci-lint</code> to detect shadowing of both universe block identifiers and identifiers within your own code by putting the following configuration into a file named <em>.golangci.yml</em> in the directory where you run <code>golangci-lint</code>:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">linters</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">enable</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">govet</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">predeclared</code><code class="w"/>

<code class="nt">linters-settings</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">govet</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">check-shadowing</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">    </code><code class="nt">settings</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">shadow</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">strict</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">    </code><code class="nt">enable-all</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/></pre>

<p>With these settings, running <code>golangci-lint</code> on this code</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="s">"fmt"</code><code class="w"/>

<code class="kd">var</code><code class="w"> </code><code class="nx">b</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="mi">20</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kc">true</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="kc">false</code><code class="w"/>
<code class="w">    </code><code class="nx">a</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">10</code><code class="w"/>
<code class="w">    </code><code class="nx">b</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">30</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kc">true</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">a</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">20</code><code class="w"/>
<code class="w">        </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">a</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>detects the following issues:</p>
<pre data-type="programlisting">
$ <strong>golangci-lint run</strong>
main.go:5:5: var `b` is unused (unused)
var b = 20
    ^
main.go:10:2: shadow: declaration of "b" shadows declaration at line 5 (govet)
    b := 30
    ^
main.go:12:3: shadow: declaration of "a" shadows declaration at line 9 (govet)
        a := 20
        ^
main.go:8:2: variable true has same name as predeclared identifier (predeclared)
    true := false
    ^
</pre>

<p>(You can find both <code>golangci-lint</code> code samples in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> in the <em>sample_code/golangci-lint_test</em> directory.)<a data-type="indexterm" data-startref="ix_kkkk" id="id2298"/><a data-type="indexterm" data-startref="ix_kkk" id="id2299"/></p>

<p>Because <code>golangci-lint</code> runs so many tools (as of this writing, it runs 7 different tools by default and allows you to enable more than 50 more), it’s inevitable that your team may disagree with some of its suggestions. Review the <a href="https://oreil.ly/L_mH4">documentation</a> to understand what each tool can do. Once you come to agreement on which linters to enable, update the <em>.golangci.yml</em> file at the root of your module and commit it to source control. Check out the <a href="https://oreil.ly/vufj1">documentation</a> for the file format.</p>
<div data-type="note" epub:type="note" class="less_space pagebreak-before"><h6>Note</h6>
<p>While <code>golangci-lint</code> allows you to have a configuration file in your home directory, don’t put one there if you are working with other developers. Unless you enjoy adding hours of silly arguments to your code reviews, you want to make sure that everyone is using the same code-quality tests and formatting rules.</p>
</div>

<p>I recommend that you start using <code>go vet</code> as a required part of your automated build process. Add <code>staticcheck</code> next since it produces few false positives. When you are interested in configuring tools and setting code-quality standards, look at <code>revive</code>, but be aware that it might have false positives and false negatives, so you can’t require your team to fix every issue it reports. Once you are used to their recommendations, try out <code>golangci-lint</code> and tweak its settings until it works for your team.<a data-type="indexterm" data-startref="ch11-vet" id="id2300"/><a data-type="indexterm" data-startref="ch11-vet2" id="id2301"/><a data-type="indexterm" data-startref="ch11-vet3" id="id2302"/><a data-type="indexterm" data-startref="ch11-vet4" id="id2303"/><a data-type="indexterm" data-startref="ch11-golang" id="id2304"/><a data-type="indexterm" data-startref="ch11-golang2" id="id2305"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using govulncheck to Scan for Vulnerable Dependencies"><div class="sect1" id="id145">
<h1>Using govulncheck to Scan for Vulnerable Dependencies</h1>

<p>One kind of code quality<a data-type="indexterm" data-primary="tools" data-secondary="govulncheck scan for security vulnerabilities" id="ch11-vuls"/><a data-type="indexterm" data-primary="govulncheck tool for security vulnerabilities" id="ch11-vuls2"/><a data-type="indexterm" data-primary="security vulnerabilities tool govulncheck" id="ch11-vuls3"/><a data-type="indexterm" data-primary="vulnerabilities scanned for by govulncheck tool" id="ch11-vuls4"/> isn’t enforced by the tools you’ve looked at so far: software vulnerabilities. Having a rich ecosystem of third-party modules is fantastic, but clever hackers find security vulnerabilities in libraries and exploit them. Developers patch these bugs when they are reported, but how do you ensure that the software that uses a vulnerable version of a library is updated to the fixed version?</p>

<p>The Go team has released a tool called <code>govulncheck</code> to address this situation. It scans through your dependencies and finds known vulnerabilities in both the standard library and in third-party libraries imported into your module. These vulnerabilities are reported in a <a href="https://oreil.ly/dffxM">public database</a> maintained by the Go team. You can install it with this:</p>
<pre data-type="programlisting">
$ <strong>go install golang.org/x/vuln/cmd/govulncheck@latest</strong>
</pre>

<p>Let’s take a look at a small program to see the vulnerability checker in action. First, download the <a href="https://oreil.ly/TcwW8">repository</a>. The source code in <em>main.go</em> is very simple. It imports a third-party YAML library and uses it to load a small YAML string into a struct:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">info</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">Info</code><code class="p">{}</code><code class="w"/>

<code class="w">    </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">yaml</code><code class="p">.</code><code class="nx">Unmarshal</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="nx">data</code><code class="p">),</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">info</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"error: %v\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">os</code><code class="p">.</code><code class="nx">Exit</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"%+v\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">info</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The <em>go.mod</em> file contains the required modules and their versions:</p>

<pre data-type="programlisting">module github.com/learning-go-book-2e/vulnerable

go 1.20

require gopkg.in/yaml.v2 v2.2.7

require gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c // indirect</pre>

<p>Let’s see what happens when you run <code>govulncheck</code> on this project:</p>
<pre data-type="programlisting">
$ <strong>govulncheck ./...</strong>
Using go1.21 and govulncheck@v1.0.0 with vulnerability data from
    https://vuln.go.dev (last modified 2023-07-27 20:09:46 +0000 UTC).

Scanning your code and 49 packages across 1 dependent module
    for known vulnerabilities...

Vulnerability #1: GO-2020-0036
    Excessive resource consumption in YAML parsing in gopkg.in/yaml.v2
  More info: https://pkg.go.dev/vuln/GO-2020-0036
  Module: gopkg.in/yaml.v2
    Found in: gopkg.in/yaml.v2@v2.2.7
    Fixed in: gopkg.in/yaml.v2@v2.2.8
    Example traces found:
      #1: main.go:25:23: vulnerable.main calls yaml.Unmarshal

Your code is affected by 1 vulnerability from 1 module.
</pre>

<p>This module is using an old and vulnerable version of the YAML package. <code>govulncheck</code> helpfully gives the exact line in the codebase that calls the problematic code.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If <code>govulncheck</code> knows there a vulnerability in a module that your code uses, but can’t find an explicit call to the buggy part of the module, you’ll get a less severe warning. The message informs you of the library’s vulnerability and what version resolves the issue, but it will also let you know that your module is likely not affected.</p>
</div>

<p>Let’s update to a fixed version and see if that solves the problem:</p>
<pre data-type="programlisting">
$ <strong>go get -u=patch gopkg.in/yaml.v2</strong>
go: downloading gopkg.in/yaml.v2 v2.2.8
go: upgraded gopkg.in/yaml.v2 v2.2.7 =&gt; v2.2.8
$ <strong>govulncheck ./...</strong>
Using go1.21and govulncheck@v1.0.0 with vulnerability data from
    https://vuln.go.dev (last modified 2023-07-27 20:09:46 +0000 UTC).

Scanning your code and 49 packages across 1 dependent module
    for known vulnerabilities...

No vulnerabilities found.
</pre>

<p class="pagebreak-before">Remember, you should always strive for the smallest possible change to your project’s dependencies since that makes it less likely that a change in a dependency breaks your code. For that reason, update to the most recent patch version for v2.2.<em>x</em>, which is v2.2.8. When <code>govulncheck</code> is run again, there are no known issues.</p>

<p>While <code>govulncheck</code> currently requires a <code>go install</code> to download it, it likely will be added to the standard toolset eventually. In the meantime, be sure to install and run it against your projects as a regular part of your builds. You can learn more about it in the <a href="https://oreil.ly/uR09p">blog post</a> that announced it.<a data-type="indexterm" data-startref="ch11-vuls2" id="id2306"/><a data-type="indexterm" data-startref="ch11-vuls3" id="id2307"/><a data-type="indexterm" data-startref="ch11-vuls4" id="id2308"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Embedding Content into Your Program"><div class="sect1" id="embedding">
<h1>Embedding Content into Your Program</h1>

<p>Many programs are distributed with<a data-type="indexterm" data-primary="tools" data-secondary="embedding content into program" id="ch11-mbed"/><a data-type="indexterm" data-primary="embedding content into program" id="ch11-mbed2"/><a data-type="indexterm" data-primary="content embedded into program" id="ch11-mbed3"/><a data-type="indexterm" data-primary="data embedded into program" id="ch11-mbed4"/><a data-type="indexterm" data-primary="go:embed" id="ch11-mbed5"/> directories of support files; you might have web page templates or some standard data that’s loaded when a program starts. If a Go program needs support files, you could include a directory of files, but this takes away one of the advantages of Go: its ability to compile to a single binary that’s easy to ship and distribute. However, there’s another option. You can embed the contents of the files within your Go binary by using <code>go:embed</code> comments.</p>

<p>You can find a program demonstrating embedding<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2309"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2310"/> on GitHub in the <em>sample_code/embed_passwords</em> directory in the  <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a>. It checks to see if a password is one of the 10,000 most commonly used passwords. Rather than write that list of passwords directly into the source code, you’re going to embed it.</p>

<p>The code in <em>main.go</em> is straightforward:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w"/>
<code class="w">    </code><code class="nx">_</code><code class="w"> </code><code class="s">"embed"</code><code class="w"/>
<code class="w">    </code><code class="s">"fmt"</code><code class="w"/>
<code class="w">    </code><code class="s">"os"</code><code class="w"/>
<code class="w">    </code><code class="s">"strings"</code><code class="w"/>
<code class="p">)</code><code class="w"/>

<code class="c1">//go:embed passwords.txt</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">passwords</code><code class="w"> </code><code class="kt">string</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">pwds</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">Split</code><code class="p">(</code><code class="nx">passwords</code><code class="p">,</code><code class="w"> </code><code class="s">"\n"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">os</code><code class="p">.</code><code class="nx">Args</code><code class="p">)</code><code class="w"> </code><code class="p">&gt;</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">v</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">pwds</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">v</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="nx">os</code><code class="p">.</code><code class="nx">Args</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"true"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="nx">os</code><code class="p">.</code><code class="nx">Exit</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"false"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You must do two things to enable embedding.<a data-type="indexterm" data-primary="blank imports" data-secondary="embed package import" id="id2311"/><a data-type="indexterm" data-primary="embed package" id="id2312"/> First, the <code>embed</code> package must be imported. The Go compiler uses this import as a flag to indicate that embedding should be enabled. Because this sample code isn’t referring to anything exported from the <code>embed</code> package, you use a blank import, which was discussed in <a data-type="xref" href="ch10.html#pkg_init">“Avoiding the init Function if Possible”</a>. The only symbol exported from <code>embed</code> is <code>FS</code>. You’ll see it in the next example.</p>

<p>Next, you place a magic comment directly before each package-level variable that holds the contents of a file. This comment must start with <code>go:embed</code>, with no space between the slashes and <code>go:embed</code>. The comment must also be on the line directly before the variable. (Technically, it is legal to have blank lines or other, nonmagic comments between the embedding comment and the variable declaration, but don’t do it.) In this sample, you are embedding the contents of <em>passwords.txt</em> into the package-level variable named <code>passwords</code>. It is idiomatic to treat a variable with an embedded value as immutable. As mentioned earlier, you can embed into only a package-level variable. The variable must be of type <code>string</code>, <code>[]byte</code>, or <code>embed.FS</code>. If you have a single file, it’s simplest to use <code>string</code> or <code>[]byte</code>.</p>

<p>If you need to place one or more directories<a data-type="indexterm" data-primary="embedding content into program" data-secondary="virtual filesystem" id="id2313"/><a data-type="indexterm" data-primary="virtual filesystem in embedded content" id="id2314"/><a data-type="indexterm" data-primary="io/fs package" data-secondary="fs.embed.FS type" id="id2315"/><a data-type="indexterm" data-primary="io/fs package" data-secondary="fs.FS" id="id2316"/><a data-type="indexterm" data-primary="io/fs package" data-secondary="fs.ReadDirFS" id="id2317"/><a data-type="indexterm" data-primary="io/fs package" data-secondary="fs.ReadFileFS" id="id2318"/> of files into your program, use a variable of type <code>embed.FS</code>. This type implements three interfaces defined in the <code>io/fs</code> package: <code>FS</code>, <code>ReadDirFS</code>, and <code>ReadFileFS</code>. This allows an instance of <code>embed.FS</code> to represent a virtual filesystem. The following program provides a simple command-line help system. If you don’t provide a help file, it lists all available files. If you specify a file that’s not present, it returns an error:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w"/>
<code class="w">    </code><code class="s">"embed"</code><code class="w"/>
<code class="w">    </code><code class="s">"fmt"</code><code class="w"/>
<code class="w">    </code><code class="s">"io/fs"</code><code class="w"/>
<code class="w">    </code><code class="s">"os"</code><code class="w"/>
<code class="w">    </code><code class="s">"strings"</code><code class="w"/>
<code class="p">)</code><code class="w"/>

<code class="c1">//go:embed help</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">helpInfo</code><code class="w"> </code><code class="nx">embed</code><code class="p">.</code><code class="nx">FS</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">os</code><code class="p">.</code><code class="nx">Args</code><code class="p">)</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">printHelpFiles</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="nx">os</code><code class="p">.</code><code class="nx">Exit</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">helpInfo</code><code class="p">.</code><code class="nx">ReadFile</code><code class="p">(</code><code class="s">"help/"</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">os</code><code class="p">.</code><code class="nx">Args</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">os</code><code class="p">.</code><code class="nx">Exit</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nb">string</code><code class="p">(</code><code class="nx">data</code><code class="p">))</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You can find this code, along with the sample help files, in the <em>sample_code/help_system</em> directory in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_kkk123"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_k123k"/></p>

<p>Here’s the output when you build and run this program:</p>
<pre data-type="programlisting">
$ <strong>go build</strong>
$ <strong>./help_system</strong>
contents:
advanced/topic1.txt
advanced/topic2.txt
info.txt

$ <strong>./help_system advanced/topic1.txt</strong>
This is advanced topic 1.

$ <strong>./help_system advanced/topic3.txt</strong>
open help/advanced/topic3.txt: file does not exist
</pre>

<p>You should notice a couple of things. First, you no longer need to use a blank import for <code>embed</code>, since you are using <code>embed.FS</code>. Second, the directory name is part of the filesystem that’s embedded. The users of this program don’t enter the “help/” prefix, so you have to prepend it in the call to <code>ReadFile</code>.</p>

<p>The <code>printHelpFiles</code> function shows how you can treat an embedded virtual filesystem just like a real one:<a data-type="indexterm" data-primary="virtual filesystem in embedded content" data-secondary="example code for treating like real" id="id2319"/></p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">printHelpFiles</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"contents:"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">fs</code><code class="p">.</code><code class="nx">WalkDir</code><code class="p">(</code><code class="nx">helpInfo</code><code class="p">,</code><code class="w"> </code><code class="s">"help"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="kd">func</code><code class="p">(</code><code class="nx">path</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="nx">fs</code><code class="p">.</code><code class="nx">DirEntry</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="p">!</code><code class="nx">d</code><code class="p">.</code><code class="nx">IsDir</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">fileName</code><code class="p">,</code><code class="w"> </code><code class="nx">_</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">Cut</code><code class="p">(</code><code class="nx">path</code><code class="p">,</code><code class="w"> </code><code class="s">"/"</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">fileName</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You use the <code>WalkDir</code> function<a data-type="indexterm" data-primary="io/fs package" data-secondary="fs.WalkDir" id="id2320"/> in <code>io/fs</code> to walk through the embedded filesystem. <code>WalkDir</code> takes in an instance of <code>fs.FS</code>, a path to start at, and a function. This function is called for every file and directory in the filesystem, starting from the specified path. If the <code>fs.DirEntry</code> is not a directory, you print out its full pathname, removing the <code>help/</code> prefix by using <code>strings.Cut</code>.</p>

<p>There are a few more things to know about file embedding. While all the examples have been text files, you can embed binary files as well. You can also embed multiple files or directories into a single <code>embed.FS</code> variable by specifying their names, separated by spaces. When embedding a file or directory that has a space in its name, put the name in quotes.</p>

<p>In addition to exact file and directory names, you can use wildcards and ranges to specify the names of the files and directories you want to embed. The syntax is defined in the <a href="https://oreil.ly/BQTEX">documentation for the Match function in the <code>path</code> package in the standard library</a>, but it follows common conventions. For example, <code>*</code> matches 0 or more characters, and <code>?</code> matches a single character.</p>

<p>All embedding specifications, whether or not they use match patterns, are checked by the compiler. If they aren’t valid, compilation fails. Here are the ways a pattern can be invalid:<a data-type="indexterm" data-startref="ch11-mbed" id="id2321"/><a data-type="indexterm" data-startref="ch11-mbed2" id="id2322"/><a data-type="indexterm" data-startref="ch11-mbed3" id="id2323"/><a data-type="indexterm" data-startref="ch11-mbed4" id="id2324"/><a data-type="indexterm" data-startref="ch11-mbed5" id="id2325"/></p>

<ul>
<li>
<p>If the specified name or pattern doesn’t match a file or directory</p>
</li>
<li>
<p>If you specify multiple filenames or patterns for a <code>string</code> or <code>[]byte</code> variable</p>
</li>
<li>
<p>If you specify a pattern for a <code>string</code> or <code>[]byte</code> variable and it matches more than one file</p>
</li>
</ul>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Embedding Hidden Files"><div class="sect1" id="id147">
<h1>Embedding Hidden Files</h1>

<p>Including files in a directory tree<a data-type="indexterm" data-primary="embedding content into program" data-secondary="hidden files" id="id2326"/><a data-type="indexterm" data-primary="virtual filesystem in embedded content" data-secondary="hidden files" id="id2327"/><a data-type="indexterm" data-primary="tools" data-secondary="embedding content into program" data-tertiary="hidden files" id="id2328"/><a data-type="indexterm" data-primary=". prefix for hidden file names" id="id2329"/><a data-type="indexterm" data-primary="_ (underscore)" data-secondary="hidden file name prefix" id="id2330"/><a data-type="indexterm" data-primary="underscore (_)" data-secondary="hidden file name prefix" id="id2331"/><a data-type="indexterm" data-primary="hidden files in embedded content" id="id2332"/> that start with <code>.</code> or <code>_</code> is a little complicated. Many operating systems consider these to be hidden files, so they are not included by default when a directory name is specified. However, you can override this behavior in two ways. The first is to put <code>/*</code> after the name of a directory you want to embed. This will include all hidden files within the root directory, but it will not include hidden files in its subdirectories. To include all hidden files in all subdirectories, put <code>all:</code> before the name of the directory.</p>

<p>This sample program (which you can find in the <em>sample_code/embed_hidden</em> directory in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a>) <a data-type="indexterm" data-startref="ix_kkk123" id="id2333"/><a data-type="indexterm" data-startref="ix_k123k" id="id2334"/>makes this easier to understand. In the sample, the directory <em>parent_dir</em> contains two files, <em>.hidden</em> and <em>visible</em>, and one subdirectory, <em>child_dir</em>. The <em>child_dir</em> subdirectory contains two files, <em>.hidden</em> and <em>visible</em>.</p>

<p>Here is the code for the program:</p>

<pre data-type="programlisting" data-code-language="go"><code class="c1">//go:embed parent_dir</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">noHidden</code><code class="w"> </code><code class="nx">embed</code><code class="p">.</code><code class="nx">FS</code><code class="w"/>

<code class="c1">//go:embed parent_dir/*</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">parentHiddenOnly</code><code class="w"> </code><code class="nx">embed</code><code class="p">.</code><code class="nx">FS</code><code class="w"/>

<code class="c1">//go:embed all:parent_dir</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">allHidden</code><code class="w"> </code><code class="nx">embed</code><code class="p">.</code><code class="nx">FS</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">checkForHidden</code><code class="p">(</code><code class="s">"noHidden"</code><code class="p">,</code><code class="w"> </code><code class="nx">noHidden</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">checkForHidden</code><code class="p">(</code><code class="s">"parentHiddenOnly"</code><code class="p">,</code><code class="w"> </code><code class="nx">parentHiddenOnly</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">checkForHidden</code><code class="p">(</code><code class="s">"allHidden"</code><code class="p">,</code><code class="w"> </code><code class="nx">allHidden</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">checkForHidden</code><code class="p">(</code><code class="nx">name</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">dir</code><code class="w"> </code><code class="nx">embed</code><code class="p">.</code><code class="nx">FS</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">allFileNames</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="s">"parent_dir/.hidden"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="s">"parent_dir/child_dir/.hidden"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">v</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">allFileNames</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">dir</code><code class="p">.</code><code class="nx">Open</code><code class="p">(</code><code class="nx">v</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">v</code><code class="p">,</code><code class="w"> </code><code class="s">"found"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">()</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The output of the program is shown here:</p>

<pre data-type="programlisting">noHidden

parentHiddenOnly
parent_dir/.hidden found

allHidden
parent_dir/.hidden found
parent_dir/child_dir/.hidden found</pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using go generate"><div class="sect1" id="id148">
<h1>Using go generate</h1>

<p>The <code>go generate</code>  tool is a little different,<a data-type="indexterm" data-primary="tools" data-secondary="go generate" id="ch11-gen"/><a data-type="indexterm" data-primary="go commands" data-secondary="go generate" id="ch11-gen2"/><a data-type="indexterm" data-primary="code" data-secondary="go generate" id="ch11-gen3"/><a data-type="indexterm" data-primary="builds" data-secondary="go generate" id="ch11-gen4"/> because it doesn’t do anything by itself. When you run <code>go generate</code>, it looks for specially formatted comments in your source code and runs programs specified in those comments. While you could use <code>go generate</code> to run anything at all, it is most commonly used by developers to run tools that (unsurprisingly, given the name) generate source code. This could be from analyzing existing code and adding functionality or processing schemas and making source code out of it.</p>

<p>A good example of something that can be automatically<a data-type="indexterm" data-primary="Protocol Buffers (protobufs)" id="id2335"/><a data-type="indexterm" data-primary="Protocol Buffers (protobufs)" data-secondary="schema" id="id2336"/><a data-type="indexterm" data-primary="schema for Protocol Buffer" id="id2337"/> converted to code are <a href="https://protobuf.dev">Protocol Buffers</a>, sometimes called <em>protobufs</em>. Protobuf is a popular binary format that is used by Google to store and transmit data. When working with protobufs, you write a <em>schema</em>, which is a language-independent description of the data structure. Developers who want to write programs to interact with data in protobuf format run tools that process the schema and produce language-specific data structures to hold the data and language-specific functions to read and write data in protobuf format.</p>

<p>Let’s see how this works in Go. You can find a sample module in the <a href="https://oreil.ly/OJdYU">proto_generate repo</a>. The module contains a protobuf schema file called <em>person.proto</em>:</p>

<pre data-type="programlisting">syntax = "proto3";

message Person {
  string name = 1;
  int32 id = 2;
  string email = 3;
}</pre>

<p>While making a struct that implements <code>Person</code> would be easy, writing the code to convert back and forth from the binary format is difficult. Let’s use tools from Google to do the hard work and invoke them with <code>go generate</code>. You need to install two things. The first is the <code>protoc</code> binary for your computer (see the <a href="https://oreil.ly/UIvZN">installation instructions</a>. Next, use <code>go install</code> to install the Go protobuf plug-ins:</p>
<pre data-type="programlisting">
$ <strong>go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</strong>
</pre>

<p>In <em>main.go</em>, there is the magic comment that’s processed by <code>go generate</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="c1">//go:generate protoc -I=. --go_out=.</code><code class="w"/>
<code class="w">  </code><code class="o">--</code><code class="nx">go_opt</code><code class="p">=</code><code class="nx">module</code><code class="p">=</code><code class="nx">github</code><code class="p">.</code><code class="nx">com</code><code class="o">/</code><code class="nx">learning</code><code class="o">-</code><code class="k">go</code><code class="o">-</code><code class="nx">book</code><code class="o">-</code><code class="mi">2</code><code class="nx">e</code><code class="o">/</code><code class="nx">proto_generate</code><code class="w"/>
<code class="w">  </code><code class="o">--</code><code class="nx">go_opt</code><code class="p">=</code><code class="nx">Mperson</code><code class="p">.</code><code class="nx">proto</code><code class="p">=</code><code class="nx">github</code><code class="p">.</code><code class="nx">com</code><code class="o">/</code><code class="nx">learning</code><code class="o">-</code><code class="k">go</code><code class="o">-</code><code class="nx">book</code><code class="o">-</code><code class="mi">2</code><code class="nx">e</code><code class="o">/</code><code class="nx">proto_generate</code><code class="o">/</code><code class="nx">data</code><code class="w"/>
<code class="w">  </code><code class="nx">person</code><code class="p">.</code><code class="nx">proto</code><code class="w"/></pre>

<p>(If you look at the source code in GitHub, you’ll see this should be a single line. It’s wrapped to fit the constraints of a printed page.)</p>

<p>Run <code>go generate</code> by typing the following:</p>
<pre data-type="programlisting">
$ <strong>go generate ./...</strong>
</pre>

<p>After running <code>go generate</code>, you’ll see a new directory called <em>data</em> that contains a file named <em>person.pb.go</em>. It contains the source code for the <code>Person</code> struct, and some methods and functions that are used by the <code>Marshal</code> and <code>Unmarshal</code> functions in the <code>google.golang.org/protobuf/proto</code> module. You call these functions in your <code>main</code> function:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">p</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">data</code><code class="p">.</code><code class="nx">Person</code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">Name</code><code class="p">:</code><code class="w">  </code><code class="s">"Bob Bobson"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">Id</code><code class="p">:</code><code class="w">    </code><code class="mi">20</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">Email</code><code class="p">:</code><code class="w"> </code><code class="s">"bob@bobson.com"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">p</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">protoBytes</code><code class="p">,</code><code class="w"> </code><code class="nx">_</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">proto</code><code class="p">.</code><code class="nx">Marshal</code><code class="p">(</code><code class="nx">p</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">protoBytes</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">p2</code><code class="w"> </code><code class="nx">data</code><code class="p">.</code><code class="nx">Person</code><code class="w"/>
<code class="w">    </code><code class="nx">proto</code><code class="p">.</code><code class="nx">Unmarshal</code><code class="p">(</code><code class="nx">protoBytes</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">p2</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">p2</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Build and run the program as usual:</p>

<pre data-type="programlisting" data-code-language="go"><code class="err">$</code><code class="w"> </code><code class="k">go</code><code class="w"> </code><code class="nx">build</code><code class="w"/>
<code class="err">$</code><code class="w"> </code><code class="p">.</code><code class="o">/</code><code class="nx">proto_generate</code><code class="w"/>
<code class="nx">name</code><code class="p">:</code><code class="s">"Bob Bobson"</code><code class="w">  </code><code class="nx">id</code><code class="p">:</code><code class="mi">20</code><code class="w">  </code><code class="nx">email</code><code class="p">:</code><code class="s">"bob@bobson.com"</code><code class="w"/>
<code class="p">[</code><code class="mi">10</code><code class="w"> </code><code class="mi">10</code><code class="w"> </code><code class="mi">66</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">98</code><code class="w"> </code><code class="mi">32</code><code class="w"> </code><code class="mi">66</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">98</code><code class="w"> </code><code class="mi">115</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">110</code><code class="w"> </code><code class="mi">16</code><code class="w"> </code><code class="mi">20</code><code class="w"> </code><code class="mi">26</code><code class="w"> </code><code class="mi">14</code><code class="w"> </code><code class="mi">98</code><code class="w"/>
<code class="w">  </code><code class="mi">111</code><code class="w"> </code><code class="mi">98</code><code class="w"> </code><code class="mi">64</code><code class="w"> </code><code class="mi">98</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">98</code><code class="w"> </code><code class="mi">115</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">110</code><code class="w"> </code><code class="mi">46</code><code class="w"> </code><code class="mi">99</code><code class="w"> </code><code class="mi">111</code><code class="w"> </code><code class="mi">109</code><code class="p">]</code><code class="w"/>
<code class="nx">name</code><code class="p">:</code><code class="s">"Bob Bobson"</code><code class="w">  </code><code class="nx">id</code><code class="p">:</code><code class="mi">20</code><code class="w">  </code><code class="nx">email</code><code class="p">:</code><code class="s">"bob@bobson.com"</code><code class="w"/></pre>

<p>Another tool commonly used with <code>go generate</code> is <code>stringer</code>. As<a data-type="indexterm" data-primary="tools" data-secondary="stringer for printable enumerations" id="id2338"/><a data-type="indexterm" data-primary="stringer tool for printable enumerations" id="id2339"/><a data-type="indexterm" data-primary="enumerations via iota" data-secondary="printable via stringer" id="id2340"/> I discussed in <a data-type="xref" href="ch07.html#iota_section">“iota Is for Enumerations—Sometimes”</a>, enumerations in Go lack many of the features that are found in other languages with enumerations. One of those features is automatically generating a printable name for each value in the enumeration. The <code>stringer</code> tool is used with <code>go generate</code> to add a <code>String</code> method to your enumeration’s values so they can be printed.</p>

<p>Install <code>stringer</code> with <code>go install golang.org/x/tools/cmd/stringer@latest</code>. The <em>sample_code/stringer_demo</em> directory in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> <a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_kkk1234"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="ix_k12345k"/>provides a very simple example of how to use <code>stringer</code>. Here’s the source in <em>main.go</em>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">Direction</code><code class="w"> </code><code class="kt">int</code><code class="w"/>

<code class="kd">const</code><code class="w"> </code><code class="p">(</code><code class="w"/>
<code class="w">    </code><code class="nx">_</code><code class="w"> </code><code class="nx">Direction</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="kc">iota</code><code class="w"/>
<code class="w">    </code><code class="nx">North</code><code class="w"/>
<code class="w">    </code><code class="nx">South</code><code class="w"/>
<code class="w">    </code><code class="nx">East</code><code class="w"/>
<code class="w">    </code><code class="nx">West</code><code class="w"/>
<code class="p">)</code><code class="w"/>

<code class="c1">//go:generate stringer -type=Direction</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">North</code><code class="p">.</code><code class="nx">String</code><code class="p">())</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Run <code>go generate ./...</code> and you’ll see a new file generated called <em>direction_string.go</em>. Use <code>go build</code> to build the <code>string_demo</code> binary and when you run it, you’ll get the output:</p>

<pre data-type="programlisting">North</pre>

<p>You can configure <code>stringer</code> and its output in multiple ways. Arjun Mahishi has written a great <a href="https://oreil.ly/2YVE2">blog post</a> describing how to use <code>stringer</code> and customize its output.<a data-type="indexterm" data-startref="ch11-gen" id="id2341"/><a data-type="indexterm" data-startref="ch11-gen2" id="id2342"/><a data-type="indexterm" data-startref="ch11-gen3" id="id2343"/><a data-type="indexterm" data-startref="ch11-gen4" id="id2344"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Working with go generate and Makefiles"><div class="sect1" id="id149">
<h1>Working with go generate and Makefiles</h1>

<p>Since the job of <code>go generate</code> is to run<a data-type="indexterm" data-primary="tools" data-secondary="go generate" data-tertiary="Makefiles and" id="id2345"/><a data-type="indexterm" data-primary="Makefiles" data-secondary="go generate and" id="id2346"/><a data-type="indexterm" data-primary="go commands" data-secondary="go generate" data-tertiary="Makefiles and" id="id2347"/> other tools, you might wonder if it’s worth using when you have a perfectly good Makefile in your project. The advantage of <code>go generate</code> is that it creates a separation of responsibilities. Use <code>go generate</code> commands to mechanically create source code, and use the Makefile to validate and compile source code.</p>

<p>It is a best practice to commit the source code created by <code>go generate</code> to version control. <a data-type="indexterm" data-startref="ix_kkk1234" id="id2348"/><a data-type="indexterm" data-startref="ix_k12345k" id="id2349"/>(The sample projects in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a> don’t include generated source code so you can see <code>go generate</code> work.) This allows people browsing your source code to see everything that’s invoked, even the generated parts. It also means they don’t need to have tools like <code>protoc</code> installed in order to build your code.</p>

<p>Checking in your generated source code technically means that you don’t <em>need</em> to run <code>go generate</code> unless it will produce different output, such as processing a modified protobuf definition or an updated enumeration. However, it’s still a good idea to automate calling <code>go generate</code> before <code>go build</code>. Relying on a manual process is asking for trouble. Some generator tools, like <code>stringer</code>, include clever tricks to block compilation if you forget to rerun <code>go generate</code>, but that’s not universal. You’ll inevitably waste time during testing trying to understand why a change didn’t show up before realizing that you forgot to invoke <code>go generate</code>. (I made this mistake multiple times before I learned my lesson.) Given this, it is best to add a <code>generate</code> step to your Makefile and make it a dependency of your <code>build</code> step.</p>

<p>However, I would disregard this advice in two situations. The first is if invoking <code>go generate</code> on identical input produces source files with minor differences, such as a timestamp. A well-written <code>go generate</code> tool should produce identical output every time it’s run on the same input, but there are no guarantees that every tool you need to use is well written. You don’t want to keep on checking in new versions of files that are functionally identical, as they will clutter your version control system and make your code reviews noisier.</p>

<p>The second situation is if <code>go generate</code> takes a very long time to complete. Fast builds are a feature of Go, because they allow developers to stay focused and get rapid feedback. If you are noticeably slowing down a build to generate identical files, the loss in developer productivity is not worth it. In both cases, all you can do is leave lots of comments to remind people to rebuild when things change and hope that everyone on your team is diligent.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Reading the Build Info Inside a Go Binary"><div class="sect1" id="id286">
<h1>Reading the Build Info Inside a Go Binary</h1>

<p>As companies develop more of their own software,<a data-type="indexterm" data-primary="builds" data-secondary="single native binary" data-tertiary="reading build info inside" id="id2350"/><a data-type="indexterm" data-primary="compiling" data-secondary="single native binary" data-tertiary="reading build info inside" id="id2351"/><a data-type="indexterm" data-primary="Go" data-secondary="compiling to a single native binary" data-tertiary="reading build info inside" id="id2352"/><a data-type="indexterm" data-primary="Go runtime" data-secondary="compiling to a single native binary" data-tertiary="reading build info inside" id="id2353"/><a data-type="indexterm" data-primary="go commands" data-secondary="go build" data-tertiary="reading build info inside binary" id="id2354"/> it is becoming increasingly common for them to want to understand exactly what they have deployed to their data centers and cloud environments, down to the version and the dependencies. You might wonder why you’d want to get this information from compiled code. After all, a company already has this information in version control.</p>

<p>Companies with mature development and deployment pipelines can capture this information right before deploying a program, allowing them to be sure that the information is accurate. However, many, if not most, companies don’t track the exact version of internal software that’s deployed. In some cases, software can be deployed for years without being replaced, and no one remembers much about it. If a vulnerability is reported in a version of a third-party library, you need to either find some way to scan your deployed software and figure out what versions of third-party libraries are deployed, or redeploy everything just to be safe. In the Java world, this exact problem happened when a serious vulnerability was discovered in the popular Log4j library.</p>

<p>Luckily, Go solves this problem for you. Every Go binary you create with <code>go build</code> automatically contains build information on what versions of what modules make up the binary, and also what build commands were used, what version control system was used, and what revision the code was at in your version control system. <a data-type="indexterm" data-primary="go commands" data-secondary="go version" data-tertiary="-m flag to specify filename" id="id2355"/>You can view this information with the <code>go version -m</code> command. The following shows the output for the <code>vulnerable</code> program when built on an Apple Silicon Mac:</p>
<pre data-type="programlisting">
$ <strong>go build</strong>
go: downloading gopkg.in/yaml.v2 v2.2.7
$ <strong>go version -m vulnerable</strong>
vulnerable: go1.20
    path     github.com/learning-go-book-2e/vulnerable
    mod      github.com/learning-go-book-2e/vulnerable    (devel)
    dep      gopkg.in/yaml.v2  v2.2.7  h1:VUgggvou5XRW9mHwD/yXxIYSMtY0zoKQf/v...
    build    -compiler=gc
    build    CGO_ENABLED=1
    build    CGO_CFLAGS=
    build    CGO_CPPFLAGS=
    build    CGO_CXXFLAGS=
    build    CGO_LDFLAGS=
    build    GOARCH=arm64
    build    GOOS=darwin
    build    vcs=git
    build    vcs.revision=623a65b94fd02ea6f18df53afaaea3510cd1e611
    build    vcs.time=2022-10-02T03:31:05Z
    build    vcs.modified=false
</pre>

<p>Because this information is embedded into every binary, <code>govulncheck</code> is capable of scanning Go programs to check for libraries with known vulnerabilities:</p>
<pre data-type="programlisting">
$ <strong>govulncheck -mode binary vulnerable</strong>
Using govulncheck@v1.0.0 with vulnerability data from
    https://vuln.go.dev (last modified 2023-07-27 20:09:46 +0000 UTC).

Scanning your binary for known vulnerabilities...

Vulnerability #1: GO-2020-0036
    Excessive resource consumption in YAML parsing in gopkg.in/yaml.v2
  More info: https://pkg.go.dev/vuln/GO-2020-0036
  Module: gopkg.in/yaml.v2
    Found in: gopkg.in/yaml.v2@v2.2.7
    Fixed in: gopkg.in/yaml.v2@v2.2.8
    Example traces found:
      #1: yaml.Unmarshal

Your code is affected by 1 vulnerability from 1 module.
</pre>

<p>Be aware that <code>govulncheck</code> can’t track down exact lines of code when inspecting a binary. If <code>govulncheck</code> finds a problem in a binary, use <code>go version -m</code> to find out the exact deployed version, check the code out of version control, and run it again against the source code to pinpoint the issue.</p>

<p>If you want to build your own tools to read the build information, look at the <a href="https://oreil.ly/M5Jmq"><code>debug/buildinfo</code></a> package in the standard library.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Building Go Binaries for Other Platforms"><div class="sect1" id="id150">
<h1>Building Go Binaries for Other Platforms</h1>

<p>One of the advantages of a VM-based language<a data-type="indexterm" data-primary="builds" data-secondary="binaries for other platforms" id="id2356"/><a data-type="indexterm" data-primary="tools" data-secondary="building binaries for other platforms" id="id2357"/> like Java, JavaScript, or Python is that you can take your code and get it to run on any computer where the virtual machine has been installed. This portability makes it easy for developers using these languages to build programs on a Windows or Mac computer and deploy it on a Linux server, even though the operating system and possibly the CPU architecture are different.</p>

<p>Go programs are compiled to native code, so the generated binary is compatible with only a single operating system and CPU architecture. However, that doesn’t mean that Go developers need to maintain a menagerie of machines (virtual or otherwise) to release on multiple platforms. <a data-type="indexterm" data-primary="environment variables" data-secondary="GOARCH" id="id2358"/><a data-type="indexterm" data-primary="GOARCH environment variable" id="id2359"/><a data-type="indexterm" data-primary="GOOS environment variable" id="id2360"/><a data-type="indexterm" data-primary="environment variables" data-secondary="GOOS" id="id2361"/><a data-type="indexterm" data-primary="compiling" data-secondary="cross-compiling" id="id2362"/><a data-type="indexterm" data-primary="cross-compiling" id="id2363"/>The <code>go build</code> command makes it easy to <em>cross-compile</em>, or create a binary for a different operating system and/or CPU.  When <code>go build</code> is run, the target operating system is specified by the <code>GOOS</code> environment variable. Similarly, the <code>GOARCH</code> environment variable specifies the CPU architecture. If you don’t set them explicitly, <code>go build</code> defaults to using the values for your current computer, which is why you’ve never had to worry about these variables before.</p>

<p>You can find the valid values and combinations for <code>GOOS</code> and <code>GOARCH</code> (sometimes pronounced “GOOSE” and “GORCH”) in the <a href="https://oreil.ly/Zf1lx">installation documentation</a>. Some of the supported operating systems and CPUs are a bit esoteric, and others might require some translation. For example, <code>darwin</code> refers to macOS (Darwin is the name of the macOS kernel), and <code>amd64</code> means 64-bit Intel-compatible CPUs.</p>

<p>Let’s go back to the <code>vulnerable</code> program one last time. When using an Apple Silicon Mac (which has an ARM64 CPU), running <code>go build</code> defaults to <code>darwin</code> for <code>GOOS</code> and <code>arm64</code> for <code>GOARCH</code>. You can confirm this using the <code>file</code> command:</p>
<pre data-type="programlisting">
$ <strong>go build</strong>
$ <strong>file vulnerable</strong>
vulnerable: Mach-O 64-bit executable arm64
</pre>

<p>Here is how to build a binary for Linux on 64-bit Intel CPUs:</p>
<pre data-type="programlisting">
$ <strong>GOOS=linux GOARCH=amd64 go build</strong>
$ <strong>file vulnerable</strong>
vulnerable: ELF 64-bit LSB executable, x86-64, version 1 (SYSV),
    statically linked, Go BuildID=IDHVCE8XQPpWluGpMXpX/4VU3GpRZEifN
    8TzUrT_6/1c30VcDYNVPfSSN-zCkz/JsZSLAbWkxqIVhPkC5p5, with debug_info,
    not stripped
</pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using Build Tags"><div class="sect1" id="build_tags">
<h1>Using Build Tags</h1>

<p>When writing programs that need<a data-type="indexterm" data-primary="tools" data-secondary="building binaries for other platforms" data-tertiary="build tags" id="id2364"/><a data-type="indexterm" data-primary="build tags" id="id2365"/> to run on multiple operating systems or CPU architectures, you sometimes need different code for different platforms. You also might want to write a module that takes advantage of the latest Go features but is still backward compatible with older Go compilers.</p>

<p>You can create targeted code in two ways.<a data-type="indexterm" data-primary="underscore (_)" data-secondary="targeted code build tags" id="id2366"/><a data-type="indexterm" data-primary="_ (underscore)" data-secondary="targeted code build tags" id="id2367"/> The first is to use the name of the file to indicate when the file should be included in the build. You do this by adding the target <em>GOOS</em> and <em>GOARCH</em>, separated by <code>_</code>, to the filename before <em>.go</em>. For example, if you have a file that you want to be compiled only on Windows, you’d name the file <em>something_windows.go</em>, but if you wanted it to be compiled only when building for ARM64 Windows, name the file <em>something_windows_arm64.go</em>.</p>

<p>A <em>build tag</em> (also called a <em>build constraint</em>) is the other option you can use to specify when a file is compiled. Like embedding and generating, build tags take advantage of a magic comment. In this case, it’s <code>//go:build</code>. This comment must be placed on the line before the package declaration in your file.</p>

<p>Build tags use boolean operators (<code>||</code>, <code>&amp;&amp;</code>, and <code>!</code>) and parentheses to specify exact build rules for architectures, operating systems, and Go versions. The build tag <code>//go:build (!darwin &amp;&amp; !linux) || (darwin &amp;&amp; !go1.12)</code>—which really appears in the Go standard library—specifies that the file should not be compiled on Linux or macOS, except it’s OK to compile it on macOS if the Go version is 1.11 or earlier.</p>

<p>Some meta build constraints are also available. The constraint <code>unix</code> matches any Unix-ish platform, and <code>cgo</code> matches if <code>cgo</code> is supported by the current platform and is enabled. (I cover <code>cgo</code> in <a data-type="xref" href="ch16.html#cgo">“Cgo Is for Integration, Not Performance”</a>.)</p>

<p>The question becomes when you should use filenames to indicate where to run code and when you should use build tags. Because build tags allow binary operators, you can specify a more specific set of platforms with them. The Go standard library sometimes takes a belt-and-suspenders approach. The package <code>internal/cpu</code> in the standard library has platform-specific source code for CPU feature detection. The file <em>internal/cpu/cpu_arm64_darwin.go</em> has a name that indicates that it is meant only for computers using Apple CPUs. It also has a <code>//go:build arm64 &amp;&amp; darwin &amp;&amp; !ios</code> line in the file to indicate that it should be compiled only when building for Apple Silicon Macs and not for iPhones or iPads. The build tags are able to specify the target platform with more detail, but following the filename convention makes it easy for a person to find the right file for a given platform.</p>

<p>In addition to the built-in build tags that represent Go versions, operating systems and CPU architectures, you can also use any string at all as a custom build tag. You can then control compilation of that file with the <code>-tags</code> command-line flag. For example, if you put <code>//go:build gopher</code> on the line before the package declaration in a file, it will not be compiled unless you include a <code>-tags gopher</code> flag as part of the <code>go build</code>, <code>go run</code>, or <code>go test</code> command.</p>

<p>Custom build tags are surprisingly handy. If you have a source file that you don’t want to build right now (perhaps it doesn’t compile yet, or it’s an experiment that’s not ready to be included), it is idiomatic to skip over the file by putting <code>//go:build ignore</code> on the line before the package declaration. You will see another use for custom build tags when looking at integration tests in <a data-type="xref" href="ch15.html#test_build_tag">“Using Integration Tests and Build Tags”</a>.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>When writing your build tags, make sure there isn’t any whitespace between the <code>//</code> and <code>go:build</code>. If there is, Go will not consider it a build tag.</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Testing Versions of Go"><div class="sect1" id="id255">
<h1>Testing Versions of Go</h1>

<p>Despite Go’s strong backward-compatibility guarantees,<a data-type="indexterm" data-primary="tools" data-secondary="testing versions of Go" id="id2368"/><a data-type="indexterm" data-primary="testing" data-secondary="versions of Go" id="id2369"/> bugs do happen. It’s natural to want to make sure that a new release doesn’t break your programs. You also might get a bug report from a user of your library saying that your code doesn’t work as expected on an older version of Go. <a data-type="indexterm" data-primary="go commands" data-secondary="go install" data-tertiary="secondary Go environment" id="id2370"/><a data-type="indexterm" data-primary="tools" data-secondary="go install" data-tertiary="secondary Go environment" id="id2371"/>One option is to install a secondary Go environment. For example, if you wanted to try out version 1.19.2, you would use the following commands:</p>
<pre data-type="programlisting">
$ <strong>go install golang.org/dl/go1.19.2@latest</strong>
$ <strong>go1.19.2 download</strong>
</pre>

<p class="pagebreak-before">You can then use the command <code>go1.19.2</code> instead of the <code>go</code> command to see if version 1.19.2 works for your programs:</p>
<pre data-type="programlisting">
$ <strong>go1.19.2 build</strong>
</pre>

<p>Once you have validated that your code works, you can uninstall the secondary environment. Go stores secondary Go environments in the <em>sdk</em> directory within your home directory. To uninstall, delete the environment from the <em>sdk</em> directory and the binary from the <em>go/bin</em> directory. Here’s how to do that on macOS, Linux, and BSD:</p>
<pre data-type="programlisting">
$ <strong>rm -rf ~/sdk/go.19.2</strong>
$ <strong>rm ~/go/bin/go1.19.2</strong>
</pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using go help to Learn More About Go Tooling"><div class="sect1" id="id256">
<h1>Using go help to Learn More About Go Tooling</h1>

<p>You can learn more about Go’s tooling and<a data-type="indexterm" data-primary="tools" data-secondary="go help" id="id2372"/><a data-type="indexterm" data-primary="go commands" data-secondary="go help" id="id2373"/> runtime environment with the <code>go help</code> command. It contains exhaustive information about all the commands mentioned here, as well as things like modules, import path syntax, and working with nonpublic source code. <a data-type="indexterm" data-primary="go commands" data-secondary="go help" data-tertiary="go help importpath" id="id2374"/><a data-type="indexterm" data-primary="tools" data-secondary="go help" data-tertiary="go help importpath" id="id2375"/>For example, you can get information on import path syntax by typing <code>go help importpath</code>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Exercises"><div class="sect1" id="id287">
<h1>Exercises</h1>

<p>These exercises cover some of the tools that you’ve learned about in this chapter. You can find the solutions in the <em>exercise_solutions</em> directory in the <a href="https://oreil.ly/Z_Fpg">Chapter 11 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2376"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 11" data-tertiary-sortas="kkk" id="id2377"/></p>
<ol>
<li>
<p>Go to the <a href="https://oreil.ly/-q7Cn">UN’s Universal Declaration of Human Rights (UDHR) page</a> and copy the text of the UDHR into a text file called <em>english_rights.txt</em>. Click the Other Languages link and copy the document text in a few additional languages into files named <em>LANGUAGE_rights.txt</em>. Create a program that embeds these files into package-level variables. Your program should take in one command-line parameter, the name of a language. It should then print out the UDHR in that language.</p>
</li>
<li>
<p>Use <code>go install</code> to install <code>staticcheck</code>. Run it against your program and fix any problems it finds.</p>
</li>
<li>
<p>Cross-compile your program for ARM64 on Windows. If you are using an ARM64 Windows computer, cross-compile for AMD64 on Linux.</p>
</li>

</ol>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Wrapping Up"><div class="sect1" id="id352">
<h1>Wrapping Up</h1>

<p>In this chapter, you learned about the tools that Go provides to improve software engineering practices and third-party code-quality tools. In the next chapter, you’re going to explore one of the signature features in Go: concurrency.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id2291"><sup><a href="ch11.html#id2291-marker">1</a></sup> The term “linter” comes from the original <code>lint</code> program written by Steve Johnson when he was on the Unix team at Bell Labs and described in his <a href="https://oreil.ly/RgZbU">1978 paper</a>. The name comes from the tiny bits of fabric that come off clothes in a dryer and are captured by a filter. He saw his program as being like a filter capturing small errors.</p></div></div></section></div>
</div>
</body></html>