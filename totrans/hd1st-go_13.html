<html><head></head><body><section data-pdf-bookmark="Chapter 12. back on your feet: Recovering from Failure" data-type="chapter" epub:type="chapter" class="preface"><div class="preface" id="back_on_your_feetcolon_recovering_from_f">
<h1 class="calibre17"><span class="calibre">Chapter 12. </span>back on your feet: Recovering from Failure</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0349-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><strong class="calibre8">Every program encounters errors. You should plan for them.</strong></p>
<p class="calibre7">Sometimes handling an error can be as simple as reporting it and exiting the program. But other errors may require additional action. You may need to close opened files or network connections, or otherwise clean up, so your program doesn’t leave a mess behind. In this chapter, we’ll show you how to <strong class="calibre8">defer</strong> cleanup actions so they happen even when there’s an error. We’ll also show you how to make your program <strong class="calibre8">panic</strong> in those (rare) situations where it’s appropriate, and how to <strong class="calibre8">recover</strong> afterward.</p>
<section data-pdf-bookmark="Reading numbers from a file, revisited" data-type="sect1" class="preface"><div class="preface" id="reading_numbers_from_a_filecomma_revisit">
<h1 class="calibre25">Reading numbers from a file, revisited</h1>
<p class="calibre7"><a data-primary="file management" data-secondary="reading numbers from files" data-type="indexterm" id="idm46062709900456" class="calibre10"/><a data-primary="numbers and numeric types" data-secondary="reading numbers from files" data-type="indexterm" id="idm46062709899256" class="calibre10"/><a data-primary="reading text files" data-secondary="reading numbers" data-type="indexterm" id="idm46062709896568" class="calibre10"/>We’ve talked about handling errors in Go quite a lot. But the techniques we’ve shown thus far don’t work in every situation. Let’s look at one such scenario.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0350-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">We want to create a program, <em class="calibre9">sum.go</em>, that reads <code class="calibre20">float64</code> values from a text file, adds them all together, and prints their sum.</p>
<p class="calibre7">In <a data-type="xref" href="ch06.html#appending_issuecolon_slices" class="calibre10">Chapter 6</a> we created a <code class="calibre20">GetFloats</code> function that opened a text file, converted each line of the file to a <code class="calibre20">float64</code> value, and returned those values as a slice.</p>
<p class="calibre7">Here, we’ve moved <code class="calibre20">GetFloats</code> to the <code class="calibre20">main</code> package and updated it to rely on two new functions, <code class="calibre20">OpenFile</code> and <code class="calibre20">CloseFile</code>, to open and close the text file.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0350-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="Args variable (os)" data-type="indexterm" id="idm46062709885480" class="calibre10"/><a data-primary="os package" data-secondary="Args variable" data-type="indexterm" id="idm46062709884184" class="calibre10"/>We want to specify the name of the file we’re going to read as a command-line argument. You may recall using the <code class="calibre20">os.Args</code> slice in <a data-type="xref" href="ch06.html#appending_issuecolon_slices" class="calibre10">Chapter 6</a>—it’s a slice of <code class="calibre20">string</code> values containing all the arguments used when the program is run.</p>
<p class="calibre7">So in our <code class="calibre20">main</code> function, we get the name of the file to open from the first command-line argument by accessing <code class="calibre20">os.Args[1]</code>. (Remember, the <code class="calibre20">os.Args[0]</code> element is the name of the program being run; the actual program arguments appear in <code class="calibre20">os.Args[1]</code> and later elements.)</p>
<p class="calibre7">We then pass that filename to <code class="calibre20">GetFloats</code> to read the file, and get a slice of <code class="calibre20">float64</code> values back.</p>
<p class="calibre7">If any errors are encountered along the way, they’ll be returned from the <code class="calibre20">GetFloats</code> function, and we’ll store them in the <code class="calibre20">err</code> variable. If <code class="calibre20">err</code> is not <code class="calibre20">nil</code>, it means there was an error, so we simply log it and exit.</p>
<p class="calibre7">Otherwise, it means the file was read successfully, so we use a <code class="calibre20">for</code> loop to add every value in the slice together, and end by printing the total.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0351-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Let’s save all this code together in a file named <em class="calibre9">sum.go</em>. Then, let’s create a plain-text file filled with numbers, one number per line. We’ll name it <em class="calibre9">data.txt</em> and save it in the same directory as <em class="calibre9">sum.go</em>.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0351-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">We can run the program with <code class="calibre20">go run sum.go data.txt</code>. The string <code class="calibre20">"data.txt"</code> will be the first argument to the <em class="calibre9">sum.go</em> program, so that’s the filename that will be passed to <code class="calibre20">GetFloats</code>.</p>
<p class="calibre7">We can see when the <code class="calibre20">OpenFile</code> and <code class="calibre20">CloseFile</code> functions get called, since they both include calls to <code class="calibre20">fmt.Println</code>. And at the end of the output, we can see the total of all the numbers in <em class="calibre9">data.txt</em>. Looks like everything’s working!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0351-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Any errors will prevent the file from being closed!" data-type="sect1" class="preface"><div class="preface" id="any_errors_will_prevent_the_file_from_be">
<h1 class="calibre25">Any errors will prevent the file from being closed!</h1>
<p class="calibre7"><a data-primary="closing files" data-type="indexterm" id="idm46062709860216" class="calibre10"/><a data-primary="file management" data-secondary="closing files" data-type="indexterm" id="idm46062709858760" class="calibre10"/><a data-primary="ParseFloat function (strconv)" data-type="indexterm" id="idm46062709857736" class="calibre10"/><a data-primary="strconv package" data-secondary="ParseFloat function" data-type="indexterm" id="idm46062709856856" class="calibre10"/>If we give the <em class="calibre9">sum.go</em> program an improperly formatted file, though, we run into problems. A file with a line that can’t be parsed into a <code class="calibre20">float64</code> value, for example, results in an error.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0352-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Now, that in itself is fine; every program receives invalid data occasionally. But the <code class="calibre20">GetFloats</code> function is supposed to call the <code class="calibre20">CloseFile</code> function when it’s done. We don’t see “<code class="calibre20">Closing file</code>” in the program output, which would suggest that <code class="calibre20">CloseFile</code> isn’t getting called!</p>
<p class="calibre7">The problem is that when we call <code class="calibre20">strconv.ParseFloat</code> with a string that can’t be converted to a <code class="calibre20">float64</code>, it returns an error. Our code is set up to return from the <code class="calibre20">GetFloats</code> function at that point.</p>
<p class="calibre7">But that return happens <em class="calibre9">before</em> the call to <code class="calibre20">CloseFile</code>, which means the file never gets closed!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0352-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Deferring function calls" data-type="sect1" class="preface"><div class="preface" id="deferring_function_calls">
<h1 class="calibre25">Deferring function calls</h1>
<p class="calibre7"><a data-primary="calling functions" data-secondary="deferring" data-type="indexterm" id="idm46062709843688" class="calibre10"/><a data-primary="defer keyword" data-type="indexterm" id="idm46062709842200" class="calibre10"/><a data-primary="functions" data-secondary="deferring calling" data-type="indexterm" id="idm46062709841320" class="calibre10"/><a data-primary="methods" data-secondary="deferring" data-type="indexterm" id="idm46062709840168" class="calibre10"/><a data-primary="statements" data-secondary="deferring function/method calls" data-type="indexterm" id="idm46062709839032" class="calibre10"/>Now, failing to close a file may not seem like such a big deal. And for a simple program that just opens a single file, it’s probably fine. But each file that’s left open continues to consume operating system resources. Over time, multiple files left open can build up and cause a program to fail, or even hamper performance of the entire system. It’s really important to get in the habit of ensuring that files are closed when your program is done with them.</p>
<p class="calibre7">But how can we accomplish this? The <code class="calibre20">GetFloats</code> function is set up to immediately exit if it encounters an error reading the file, even if <code class="calibre20">CloseFile</code> hasn’t been called yet!</p>
<p class="calibre7">If you have a function call that you want to ensure is run, <em class="calibre9">no matter what</em>, you can use a <code class="calibre20">defer</code> statement. You can place the <code class="calibre20">defer</code> keyword before any ordinary function or method call, and Go will defer (that is, delay) making the function call until after the current function exits.</p>
<p class="calibre7">Normally, function calls are executed as soon as they’re encountered. In this code, the <code class="calibre20">fmt.Println("Goodbye!")</code> call runs before the other two <code class="calibre20">fmt.Println</code> calls.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0353-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">But if we add the <code class="calibre20">defer</code> keyword before the <code class="calibre20">fmt.Println("Goodbye!")</code> call, then that call won’t be run until all the remaining code in the <code class="calibre20">Socialize</code> function runs, and <code class="calibre20">Socialize</code> exits.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0353-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Recovering from errors using deferred function calls" data-type="sect1" class="preface"><div class="preface" id="recovering_from_errors_using_deferred_fu">
<h1 class="calibre25">Recovering from errors using deferred function calls</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0354-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">The <code class="calibre20">defer</code> keyword ensures a function call takes place even if the calling function exits early, say, by using the <code class="calibre20">return</code> keyword.</p>
<blockquote class="calibre37 pcalibre1 pcalibre2">
<p class="calibre38"><strong class="calibre8">The “defer” keyword ensures a function call takes place, even if the calling function exits early.</strong></p>
</blockquote>
<p class="calibre7">Below, we’ve updated our <code class="calibre20">Socialize</code> function to return an <code class="calibre20">error</code> because we don’t feel like talking. <code class="calibre20">Socialize</code> will exit before the <code class="calibre20">fmt.Println("Nice weather, eh?")</code> call. But because we include a <code class="calibre20">defer</code> keyword before the <code class="calibre20">fmt.Println("Goodbye!")</code> call, <code class="calibre20">Socialize</code> will always be polite enough to print “<code class="calibre20">Goodbye!</code>” before ending the conversation.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0354-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Ensuring files get closed using deferred function calls" data-type="sect1" class="preface"><div class="preface" id="ensuring_files_get_closed_using_deferred">
<h1 class="calibre25">Ensuring files get closed using deferred function calls</h1>
<p class="calibre7">Because the <code class="calibre20">defer</code> keyword can ensure a function call is made “no matter what,” it’s usually used for code that needs to be run even in the event of an error. One common example of this is closing files after they’ve been opened.</p>
<p class="calibre7">And that’s exactly what we need in our <em class="calibre9">sum.go</em> program’s <code class="calibre20">GetFloats</code> function. After we call the <code class="calibre20">OpenFile</code> function, we need it to call <code class="calibre20">CloseFile</code>, even if there’s an error parsing the file contents.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0355-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">We can achieve this by simply moving the call to <code class="calibre20">CloseFile</code> immediately after the call to <code class="calibre20">OpenFile</code> (and its accompanying error handling code), and placing the <code class="calibre20">defer</code> keyword in front of it.</p>
<p class="calibre7">Using <code class="calibre20">defer</code> ensures <code class="calibre20">CloseFile</code> will be called when <code class="calibre20">GetFloats</code> exits, whether it completes normally or there’s an error parsing the file.</p>
<p class="calibre7">Now, even if <em class="calibre9">sum.go</em> is given a file with bad data, it will still close the file before exiting!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0355-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Code Magnets" data-type="sect1" class="preface"><div class="preface" id="code_magnets_7">
<h1 class="calibre25">Code Magnets</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0356-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">This code sets up a <code class="calibre20">Refrigerator</code> type that simulates a refrigerator. <code class="calibre20">Refrigerator</code> uses a slice of strings as its underlying type; the strings represent the names of foods the refrigerator contains. The type has an <code class="calibre20">Open</code> method that simulates opening the door, and a corresponding <code class="calibre20">Close</code> method to close it again (we don’t want to waste energy, after all). The <code class="calibre20">FindFood</code> method calls <code class="calibre20">Open</code> to open the door, calls a <code class="calibre20">find</code> function we’ve written to search the underlying slice for a particular food, and then calls <code class="calibre20">Close</code> to close the door again.</p>
<p class="calibre7">But there’s a problem with <code class="calibre20">FindFood</code>. It’s set up to return an error value if the food we’re searching for isn’t found. But when that happens, it’s returning before <code class="calibre20">Close</code> gets called, leaving the virtual refrigerator door wide open!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0356-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><img alt="image" src="assets/arrow.png" class="calibre4"/> Answers in <a data-type="xref" href="#code_magnets_solution_7" class="calibre10">“Code Magnets Solution”</a>.</p>
<p class="calibre7"><a data-primary="calling functions" data-secondary="deferring" data-type="indexterm" id="idm46062709787000" class="calibre10"/><a data-primary="defer keyword" data-type="indexterm" id="idm46062709785912" class="calibre10"/><a data-primary="functions" data-secondary="deferring calling" data-type="indexterm" id="idm46062709785032" class="calibre10"/><a data-primary="methods" data-secondary="deferring" data-type="indexterm" id="idm46062709783880" class="calibre10"/><a data-primary="statements" data-secondary="deferring function/method calls" data-type="indexterm" id="idm46062709782728" class="calibre10"/>Use the magnets below to create an updated version of the <code class="calibre20">FindFood</code> method. It should defer the call to the <code class="calibre20">Close</code> method, so that it runs when <code class="calibre20">FindFood</code> exits (regardless of whether the food was found successfully).</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0357-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="there are no Dumb Questions" data-type="sect1" class="preface"><div class="preface" id="there_are_no_dumb_questions_10">
<h1 class="calibre25">there are no Dumb Questions</h1>
<p class="calibre7"><strong class="calibre8">Q: So I can defer function and method calls... Can I defer other statements too, like <code class="calibre40">for</code> loops or variable assignments?</strong></p>
<p class="calibre7"><strong class="calibre8">A:</strong> No, only function and method calls. You can write a function or method to do whatever you want and then defer a call to that function or method, but the <code class="calibre20">defer</code> keyword itself can only be used with a function or method call.</p>
</div></section>
<section data-pdf-bookmark="Listing the files in a directory" data-type="sect1" class="preface"><div class="preface" id="listing_the_files_in_a_directory">
<h1 class="calibre25">Listing the files in a directory</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/common3.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="directories" data-secondary="listing files in" data-type="indexterm" id="idm46062709770888" class="calibre10"/><a data-primary="file management" data-secondary="listing files in directories" data-type="indexterm" id="idm46062709769304" class="calibre10"/><a data-primary="io/ioutil package" data-secondary="ReadDir function" data-type="indexterm" id="idm46062709768152" class="calibre10"/><a data-primary="ReadDir function (io/ioutil)" data-type="indexterm" id="idm46062709767032" class="calibre10"/>Go has a couple more features to help you handle errors, and we’ll be showing you a program that demonstrates them in a bit. But that program uses a couple new tricks, which we’ll need to show you before we dive in. First up, we’re going to need to know how to read the contents of a directory.</p>
<p class="calibre7">Try creating a directory, named <em class="calibre9">my_directory</em>, that includes two files and a subdirectory, as shown at the right. The program below will list the contents of <em class="calibre9">my_directory</em>, indicating the name of each item it contains, and whether it’s a file or a subdirectory.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0358-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">The <code class="calibre20">io/ioutil</code> package includes a <code class="calibre20">ReadDir</code> function that will let us read the directory contents. You pass <code class="calibre20">ReadDir</code> the name of a directory, and it will return a slice of values, one for each file or subdirectory the directory contains (along with any error it encounters).</p>
<p class="calibre7">Each of the slice’s values satisfies the <code class="calibre20">FileInfo</code> interface, which includes a <code class="calibre20">Name</code> method that returns the file’s name, and an <code class="calibre20">IsDir</code> method that returns <code class="calibre20">true</code> if it’s a directory.</p>
<p class="calibre7">So our program calls <code class="calibre20">ReadDir</code>, passing it the name of <em class="calibre9">my_directory</em> as an argument. It then loops over each value in the slice it gets back. If <code class="calibre20">IsDir</code> returns <code class="calibre20">true</code> for the value, it prints <code class="calibre20">"Directory:"</code> and the file’s name. Otherwise, it prints <code class="calibre20">"File:"</code> and the file’s name.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0358-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Save the above code as <em class="calibre9">files.go</em>, in the same directory as <em class="calibre9">my_directory</em>. In your terminal, change to that parent directory, and type <code class="calibre20"><strong class="calibre39">go run files.go</strong></code>. The program will run and produce a list of the files and directories <em class="calibre9">my_directory</em> contains.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0358-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Listing the files in subdirectories (will be trickier)" data-type="sect1" class="preface"><div class="preface" id="listing_the_files_in_subdirectories_left">
<h1 class="calibre25">Listing the files in subdirectories (will be trickier)</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/common3.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0359-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="subdirectories" data-type="indexterm" id="idm46062709743128" class="calibre10"/>A program that reads the contents of a single directory isn’t too complicated. But suppose we wanted to list the contents of something more complicated, like a Go workspace directory. That would contain an entire tree of subdirectories nested within subdirectories, some containing files, some not.</p>
<p class="calibre7">Normally, such a program would be quite complicated. In outline form, the logic would be something like this:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0359-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Pretty complicated, right? We’d rather not have to write <em class="calibre9">that</em> code!</p>
<p class="calibre7">But what if there were a simpler way? Some logic like this:</p>
<ol class="calibre27">
<li class="calibre28"><p class="calibre7">Get a list of files in the directory.</p>
<ol class="calibre44">
<li class="calibre45"><p class="calibre7">Get the next file.</p></li>
<li class="calibre45"><p class="calibre7">Is the file a directory?</p>
<ol class="calibre46">
<li class="calibre47"><p class="calibre7">If yes: start over at step <strong class="calibre8">I</strong> with this directory.</p></li>
<li class="calibre47"><p class="calibre7">If no: just print the filename.</p></li>
</ol></li>
</ol></li>
</ol>
<p class="calibre7">It’s not clear how to handle the “Start the logic over with this new directory” part, though. To achieve this, we’ll need a new programming concept...</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0359-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Recursive function calls" data-type="sect1" class="preface"><div class="preface" id="recursive_function_calls">
<h1 class="calibre25">Recursive function calls</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/common3.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="calling functions" data-secondary="recursively" data-type="indexterm" id="idm46062709726264" class="calibre10"/><a data-primary="functions" data-secondary="calling recursively" data-type="indexterm" id="idm46062709724920" class="calibre10"/><a data-primary="functions" data-secondary="recursive" data-type="indexterm" id="idm46062709723880" class="calibre10"/><a data-primary="recursive functions" data-secondary="about" data-type="indexterm" id="idm46062709722728" class="calibre10"/>That brings us to the second (and last) trick we’ll need to show you before we end our detour and get back to handling errors.</p>
<p class="calibre7">Go is one of many programming languages that support <strong class="calibre8">recursion</strong>, which allows a function to call itself.</p>
<p class="calibre7">If you do this carelessly, you’ll just wind up with an infinite loop where the function calls itself over and over:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0360-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">But if you make sure that the recursion loop stops itself eventually, recursive functions can actually be useful.</p>
<p class="calibre7">Here’s a recursive <code class="calibre20">count</code> function that counts from a starting number up to an ending number. (Normally a loop would be more efficient, but this is a simple way of demonstrating how recursion works.)</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0360-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/common3.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Here’s the sequence the program follows:</p>
<ol class="calibre27">
<li class="calibre28"><p class="calibre7"><code class="calibre20">main</code> calls <code class="calibre20">count</code> with a <code class="calibre20">start</code> parameter of <code class="calibre20">1</code> and an <code class="calibre20">end</code> of <code class="calibre20">3</code></p></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">count</code> prints the <code class="calibre20">start</code> parameter: <code class="calibre20">1</code></p></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">start</code> (<code class="calibre20">1</code>) is less than <code class="calibre20">end</code> (<code class="calibre20">3</code>), so <code class="calibre20">count</code> calls itself with a <code class="calibre20">start</code> of <code class="calibre20">2</code> and an <code class="calibre20">end</code> of <code class="calibre20">3</code></p></li>
<li class="calibre28"><p class="calibre7">This second invocation of <code class="calibre20">count</code> prints its new <code class="calibre20">start</code> parameter: <code class="calibre20">2</code></p></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">start</code> (<code class="calibre20">2</code>) is less than <code class="calibre20">end</code> (<code class="calibre20">3</code>), so <code class="calibre20">count</code> calls itself with a <code class="calibre20">start</code> of <code class="calibre20">3</code> and an <code class="calibre20">end</code> of <code class="calibre20">3</code></p></li>
<li class="calibre28"><p class="calibre7">The third invocation of <code class="calibre20">count</code> prints its new <code class="calibre20">start</code> parameter: <code class="calibre20">3</code></p></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">start</code> (<code class="calibre20">3</code>) is <em class="calibre9">not</em> less than <code class="calibre20">end</code> (<code class="calibre20">3</code>), so <code class="calibre20">count</code> does <em class="calibre9">not</em> call itself again; it just returns</p></li>
<li class="calibre28"><p class="calibre7">The previous two invocations of <code class="calibre20">count</code> return as well, and the program ends</p></li>
</ol>
<p class="calibre7">If we add calls to <code class="calibre20">Printf</code> showing each time <code class="calibre20">count</code> is called and each time the function exits, this sequence will be a little more obvious:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0361-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">So that’s a simple recursive function. Let’s try applying recursion to our <em class="calibre9">files.go</em> program, and see if it can help us list the contents of subdirectories...</p>
</div></section>
<section data-pdf-bookmark="Recursively listing directory contents" data-type="sect1" class="preface"><div class="preface" id="recursively_listing_directory_contents">
<h1 class="calibre25">Recursively listing directory contents</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/common3.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="directories" data-secondary="listing contents recursively" data-type="indexterm" id="idm46062709681448" class="calibre10"/><a data-primary="io/ioutil package" data-secondary="ReadDir function" data-type="indexterm" id="idm46062709680472" class="calibre10"/><a data-primary="ReadDir function (io/ioutil)" data-type="indexterm" id="idm46062709679496" class="calibre10"/><a data-primary="recursive functions" data-secondary="listing directory contents" data-type="indexterm" id="idm46062709678696" class="calibre10"/>We want our <em class="calibre9">files.go</em> program to list the contents of all of the subdirectories in our Go workspace directory. We’re hoping to achieve that using recursive logic like this:</p>
<ol class="calibre27">
<li class="calibre28"><p class="calibre7">Get a list of files in the directory.</p>
<ol class="calibre44">
<li class="calibre45"><p class="calibre7">Get the next file.</p></li>
<li class="calibre45"><p class="calibre7">Is the file a directory?</p>
<ol class="calibre46">
<li class="calibre47"><p class="calibre7">If yes: start over at step <strong class="calibre8">I</strong> with this directory.</p></li>
<li class="calibre47"><p class="calibre7">If no: just print the filename.</p></li>
</ol></li>
</ol></li>
</ol>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0362-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">We’ve removed the code from the <code class="calibre20">main</code> function that reads the directory contents; <code class="calibre20">main</code> now simply calls a recursive <code class="calibre20">scanDirectory</code> function. The <code class="calibre20">scanDirectory</code> function takes the path of the directory it should scan, so we pass it the path of the <code class="calibre20">"go"</code> subdirectory.</p>
<p class="calibre7">The first thing <code class="calibre20">scanDirectory</code> does is print the current path, so we know what directory we’re working in. Then it calls <code class="calibre20">ioutil.ReadDir</code> on that path, to get the directory contents.</p>
<p class="calibre7">It loops over the slice of <code class="calibre20">FileInfo</code> values that <code class="calibre20">ReadDir</code> returns, processing each one. It calls <code class="calibre20">filepath.Join</code> to join the current directory path and the current filename together with slashes (so <code class="calibre20">"go"</code> and <code class="calibre20">"src"</code> are joined to become <code class="calibre20">"go/src"</code>).</p>
<p class="calibre7">If the current file isn’t a directory, <code class="calibre20">scanDirectory</code> just prints its full path, and moves on to the next file (if there are any more in the current directory).</p>
<p class="calibre7">But if the current file <em class="calibre9">is</em> a directory, the recursion kicks in: <code class="calibre20">scanDirectory</code> calls itself with the subdirectory’s path. If that subdirectory has any subdirectories, <code class="calibre20">scanDirectory</code> will call itself with each of <em class="calibre9">those</em> subdirectories, and so on through the whole file tree.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0362-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0363-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Save the preceding code as <em class="calibre9">files.go</em> in the directory that contains your Go workspace (probably your user’s home directory). In your terminal, change to that directory, and run the program with <code class="calibre20"><strong class="calibre39">go run files.go</strong></code>.</p>
<p class="calibre7">When you see the <code class="calibre20">scanDirectory</code> function at work, you’ll see the real beauty of recursion. For our sample directory structure, the process goes something like this:</p>
<ol class="calibre27">
<li class="calibre28"><p class="calibre7"><code class="calibre20">main</code> calls <code class="calibre20">scanDirectory</code> with a path of <code class="calibre20">"go"</code></p></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">scanDirectory</code> prints the path it’s passed, <code class="calibre20">"go"</code>, indicating the directory it’s working in</p></li>
<li class="calibre28"><p class="calibre7">It calls <code class="calibre20">ioutil.ReadDir</code> with the <code class="calibre20">"go"</code> path</p></li>
<li class="calibre28"><p class="calibre7">There’s only one entry in the returned slice: <code class="calibre20">"src"</code></p></li>
<li class="calibre28"><p class="calibre7">Calling <code class="calibre20">filepath.Join</code> with the current directory path of <code class="calibre20">"go"</code> and a filename of <code class="calibre20">"src"</code> gives a new path of <code class="calibre20">"go/src"</code></p></li>
<li class="calibre28"><p class="calibre7"><em class="calibre9">src</em> is a subdirectory, so <code class="calibre20">scanDirectory</code> is called again, this time with a path of <code class="calibre20">"go/src"</code></p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="calibre7">Recursion!</p>
</div></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">scanDirectory</code> prints the new path: <code class="calibre20">"go/src"</code></p></li>
<li class="calibre28"><p class="calibre7">It calls <code class="calibre20">ioutil.ReadDir</code> with the <code class="calibre20">"go/src"</code> path</p></li>
<li class="calibre28"><p class="calibre7">The first entry in the returned slice is <code class="calibre20">"geo"</code></p></li>
<li class="calibre28"><p class="calibre7">Calling <code class="calibre20">filepath.Join</code> with the current directory path of <code class="calibre20">"go/src"</code> and a filename of <code class="calibre20">"geo"</code> gives a new path of <code class="calibre20">"go/src/geo"</code></p></li>
<li class="calibre28"><p class="calibre7"><em class="calibre9">geo</em> is a subdirectory, so <code class="calibre20">scanDirectory</code> is called again, this time with a path of <code class="calibre20">"go/src/geo"</code></p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="calibre7">Recursion!</p>
</div></li>
<li class="calibre28"><p class="calibre7"><code class="calibre20">scanDirectory</code> prints the new path: <code class="calibre20">"go/src/geo"</code></p></li>
<li class="calibre28"><p class="calibre7">It calls <code class="calibre20">ioutil.ReadDir</code> with the <code class="calibre20">"go/src/geo"</code> path</p></li>
<li class="calibre28"><p class="calibre7">The first entry in the returned slice is <code class="calibre20">"coordinates.go"</code></p></li>
<li class="calibre28"><p class="calibre7"><em class="calibre9">coordinates.go</em> is <em class="calibre9">not</em> a directory, so its name is simply printed</p></li>
<li class="calibre28"><p class="calibre7">And so on...</p></li>
</ol>
<p class="calibre7">Recursive functions can be tricky to write, and they often consume more computing resources than nonrecursive solutions. But sometimes, recursive functions offer solutions to problems that would be very difficult to solve using other means.</p>
<p class="calibre7">Now that our <em class="calibre9">files.go</em> program is set up, we can end our detour. Up next, we’ll return to our discussion of Go’s error handling features.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0363-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Error handling in a recursive function" data-type="sect1" class="preface"><div class="preface" id="error_handling_in_a_recursive_function">
<h1 class="calibre25">Error handling in a recursive function</h1>
<p class="calibre7"><a data-primary="error handling" data-secondary="recursive functions" data-type="indexterm" id="idm46062709622264" class="calibre10"/><a data-primary="recursive functions" data-secondary="error handling" data-type="indexterm" id="idm46062709619608" class="calibre10"/>If <code class="calibre20">scanDirectory</code> encounters an error while scanning any subdirectory (for example, if a user doesn’t have permission to access that directory), it will return an error. This is expected behavior; the program doesn’t have any control over the filesystem, and it’s important to report errors when they inevitably occur.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0364-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">But if we add a couple <code class="calibre20">Printf</code> statements showing the errors being returned, we’ll see that the <em class="calibre9">way</em> this error is handled isn’t ideal:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0364-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">If an error occurs in one of the recursive <code class="calibre20">scanDirectory</code> calls, that error has to be returned up the entire chain until it reaches the <code class="calibre20">main</code> function!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0364-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Starting a panic" data-type="sect1" class="preface"><div class="preface" id="starting_a_panic">
<h1 class="calibre25">Starting a panic</h1>
<p class="calibre7"><a data-primary="error handling" data-secondary="type assertions" data-type="indexterm" id="idm46062709608168" class="calibre10"/><a data-primary="panic built-in function" data-type="indexterm" id="idm46062709607192" class="calibre10"/><a data-primary="panicking programs and messages" data-secondary="starting a panic" data-type="indexterm" id="idm46062709606392" class="calibre10"/><a data-primary="type assertions" data-secondary="error handling and" data-type="indexterm" id="idm46062709605288" class="calibre10"/>Our <code class="calibre20">scanDirectory</code> function is a rare example of a place it might be appropriate for a program to panic at runtime.</p>
<p class="calibre7">We’ve encountered panics before. We’ve seen them when accessing invalid indexes in arrays and slices:</p>
<p class="calibre7">We’ve also seen them when a type assertion fails (if we didn’t use the optional <code class="calibre20">ok</code> Boolean value):</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0365-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">When a program panics, the current function stops running, and the program prints a log message and crashes.</p>
<p class="calibre7">You can cause a panic yourself simply by calling the built-in <code class="calibre20">panic</code> function.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0365-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">The <code class="calibre20">panic</code> function expects a single argument that satisfies the empty interface (that is, it can be of any type). That argument is converted to a string (if necessary) and printed as part of the panic’s log message.</p>
</div></section>
<section data-pdf-bookmark="Stack traces" data-type="sect1" class="preface"><div class="preface" id="stack_traces">
<h1 class="calibre25">Stack traces</h1>
<p class="calibre7"><a data-primary="calling functions" data-secondary="deferring" data-type="indexterm" id="idm46062709595704" class="calibre10"/><a data-primary="call stacks" data-type="indexterm" id="idm46062709594328" class="calibre10"/><a data-primary="functions" data-secondary="deferring calling" data-type="indexterm" id="idm46062709592200" class="calibre10"/><a data-primary="panicking programs and messages" data-secondary="deferred calls and" data-type="indexterm" id="idm46062709591064" class="calibre10"/><a data-primary="panicking programs and messages" data-secondary="stack traces and" data-type="indexterm" id="idm46062709589960" class="calibre10"/><a data-primary="stack traces" data-type="indexterm" id="idm46062709588888" class="calibre10"/><a data-primary="statements" data-secondary="deferring function/method calls" data-type="indexterm" id="idm46062709588056" class="calibre10"/>Each function that’s called needs to return to the function that called it. To enable this, like other programming languages, Go keeps a <strong class="calibre8">call stack</strong>, a list of the function calls that are active at any given point.</p>
<p class="calibre7">When a program panics, a <strong class="calibre8">stack trace</strong>, or listing of the call stack, is included in the panic output. This can be useful in determining what caused the program to crash.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0366-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Deferred calls completed before crash" data-type="sect1" class="preface"><div class="preface" id="deferred_calls_completed_before_crash">
<h1 class="calibre25">Deferred calls completed before crash</h1>
<p class="calibre7">When a program panics, all deferred function calls will still be made. If there’s more than one deferred call, they’ll be made in the reverse of the order they were deferred in.</p>
<p class="calibre7">The code below defers two calls to <code class="calibre20">Println</code> and then panics. The top of the program output shows the two calls being completed before the program crashes.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0366-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Using “panic” with scanDirectory" data-type="sect1" class="preface"><div class="preface" id="using_ldquopanicrdquo_with_scandirectory">
<h1 class="calibre25">Using “panic” with scanDirectory</h1>
<p class="calibre7"><a data-primary="panicking programs and messages" data-secondary="panic function vs. error values" data-type="indexterm" id="idm46062709576808" class="calibre10"/>The <code class="calibre20">scanDirectory</code> function at the right has been updated to call <code class="calibre20">panic</code> instead of returning an error value. This greatly simplifies the error handling.</p>
<p class="calibre7">First, we remove the <code class="calibre20">error</code> return value from the <code class="calibre20">scanDirectory</code> declaration. If an <code class="calibre20">error</code> value is returned from <code class="calibre20">ReadDir</code>, we pass it to <code class="calibre20">panic</code> instead. We can remove the error handling code from the recursive call to <code class="calibre20">scanDirectory</code>, and the call to <code class="calibre20">scanDirectory</code> in <code class="calibre20">main</code>, as well.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0367-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Now, when <code class="calibre20">scanDirectory</code> encounters an error reading a directory, it simply panics. All the recursive calls to <code class="calibre20">scanDirectory</code> exit.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0367-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="When to panic" data-type="sect1" class="preface"><div class="preface" id="when_to_panic">
<h1 class="calibre25">When to panic</h1>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0368-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">We’ll show you a way to prevent the program from crashing in a moment. But it’s true that calling <code class="calibre20">panic</code> is rarely the ideal way to deal with errors.</p>
<p class="calibre7">Things like inaccessible files, network failures, and bad user input should usually be considered “normal,” and should be handled gracefully though <code class="calibre20">error</code> values. Generally, calling <code class="calibre20">panic</code> should be reserved for “impossible” situations: errors that indicate a bug in the program, not a mistake on the user’s part.</p>
<p class="calibre7">Here’s a program that uses <code class="calibre20">panic</code> to indicate a bug. It awards a prize hidden behind one of three virtual doors. The <code class="calibre20">doorNumber</code> variable is populated not with user input, but with a random number chosen by the <code class="calibre20">rand.Intn</code> function. If <code class="calibre20">doorNumber</code> contains any number other than <code class="calibre20">1</code>, <code class="calibre20">2</code>, or <code class="calibre20">3</code>, it’s not user error, it’s a bug in the program.</p>
<p class="calibre7">So it makes sense to call <code class="calibre20">panic</code> if <code class="calibre20">doorNumber</code> contains an invalid value. It <em class="calibre9">should</em> never happen, and if it does, we want to stop the program before it behaves in unexpected ways.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0368-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar" class="calibre30"><div class="sidebar" id="exercise_22">
<h5 class="calibre31"><span class="calibre"><img alt="image" src="assets/common.png" class="calibre4"/></span> Exercise</h5>
<p class="calibre7">A code sample and its output are shown below, but we’ve left some blanks in the output. See if you can fill them in.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0369-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><img alt="image" src="assets/arrow.png" class="calibre4"/> Answers in <a data-type="xref" href="#exercise_solution_22" class="calibre10">“<span class="calibre"><img alt="image" src="assets/common1.png" class="calibre4"/></span> Exercise Solution”</a>.</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="The “recover” function" data-type="sect1" class="preface"><div class="preface" id="the_ldquorrecoverrdquor_function">
<h1 class="calibre25">The “recover” function</h1>
<p class="calibre7"><a data-primary="defer keyword" data-type="indexterm" id="idm46062709542280" class="calibre10"/><a data-primary="panic built-in function" data-type="indexterm" id="idm46062709541224" class="calibre10"/><a data-primary="panicking programs and messages" data-secondary="recover function and" data-type="indexterm" id="idm46062709540360" class="calibre10"/><a data-primary="recover built-in function" data-type="indexterm" id="idm46062709539208" class="calibre10"/>Changing our <code class="calibre20">scanDirectory</code> function to use <code class="calibre20">panic</code> instead of returning an error greatly simplified the error handling code. But panicking is also causing our program to crash with an ugly stack trace. We’d rather just show users the error message.</p>
<p class="calibre7">Go offers a built-in <code class="calibre20">recover</code> function that can stop a program from panicking. We’ll need to use it to exit the program gracefully.</p>
<p class="calibre7">When you call <code class="calibre20">recover</code> during normal program execution, it just returns <code class="calibre20">nil</code> and does nothing else:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0370-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">If you call <code class="calibre20">recover</code> when a program is panicking, it will stop the panic. But when you call <code class="calibre20">panic</code> in a function, that function stops executing. So there’s no point calling <code class="calibre20">recover</code> in the same function as <code class="calibre20">panic</code>, because the panic will continue anyway:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0370-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">But there <em class="calibre9">is</em> a way to call <code class="calibre20">recover</code> when a program is panicking... During a panic, any deferred function calls are completed. So you can place a call to <code class="calibre20">recover</code> in a separate function, and use <code class="calibre20">defer</code> to call that function before the code that panics.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0370-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Calling <code class="calibre20">recover</code> will <em class="calibre9">not</em> cause execution to resume at the point of the panic, at least not exactly. The function that panicked will return immediately, and none of the code in that function’s block following the panic will be executed. After the function that panicked returns, however, normal execution resumes.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0371-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="The panic value is returned from recover" data-type="sect1" class="preface"><div class="preface" id="the_panic_value_is_returned_from_recover">
<h1 class="calibre25">The panic value is returned from recover</h1>
<p class="calibre7">As we mentioned, when there is no panic, calls to <code class="calibre20">recover</code> return <code class="calibre20">nil</code>.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0371-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">But when there <em class="calibre9">is</em> a panic, <code class="calibre20">recover</code> returns whatever value was passed to <code class="calibre20">panic</code>. This can be used to gather information about the panic, to aid in recovering or to report errors to the user.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0371-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7"><a data-primary="type assertions" data-secondary="panicking and" data-type="indexterm" id="idm46062709511688" class="calibre10"/>Back when we introduced the <code class="calibre20">panic</code> function, we mentioned the type for its argument is <code class="calibre20">interface{}</code>, the empty interface, so that <code class="calibre20">panic</code> can accept any value. Likewise, the type for <code class="calibre20">recover</code>’s return value is also <code class="calibre20">interface{}</code>. You can pass <code class="calibre20">recover</code>’s return value to <code class="calibre20">fmt</code> functions like <code class="calibre20">Println</code> (which accept <code class="calibre20">interface{}</code> values), but you won’t be able to call methods on it directly.</p>
<p class="calibre7">Here’s some code that passes an <code class="calibre20">error</code> value to <code class="calibre20">panic</code>. But in doing so, the <code class="calibre20">error</code> is converted to an <code class="calibre20">interface{}</code> value. When the deferred function calls <code class="calibre20">recover</code> later, that <code class="calibre20">interface{}</code> value is what’s returned. So even though the underlying <code class="calibre20">error</code> value has an <code class="calibre20">Error</code> method, attempting to call <code class="calibre20">Error</code> on the <code class="calibre20">interface{}</code> value results in a compile error.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0372-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">To call methods or do anything else with the panic value, you’ll need to convert it back to its underlying type using a type assertion.</p>
<p class="calibre7">Here’s an update to the above code that takes the return value of <code class="calibre20">recover</code> and converts it back to an <code class="calibre20">error</code> value. Once that’s done, we can safely call the <code class="calibre20">Error</code> method.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0372-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Recovering from panics in scanDirectory" data-type="sect1" class="preface"><div class="preface" id="recovering_from_panics_in_scandirectory">
<h1 class="calibre25">Recovering from panics in scanDirectory</h1>
<p class="calibre7"><a data-primary="defer keyword" data-type="indexterm" id="idm46062709492904" class="calibre10"/>When we last left our <em class="calibre9">files.go</em> program, adding a call to <code class="calibre20">panic</code> in the <code class="calibre20">scanDirectory</code> function cleaned up our error handling code, but it also caused the program to crash. We can take everything we’ve learned so far about <code class="calibre20">defer</code>, <code class="calibre20">panic</code>, and <code class="calibre20">recover</code> and use it to print an error message and exit the program gracefully.</p>
<p class="calibre7">We do this by adding a <code class="calibre20">reportPanic</code> function, which we’ll call using <code class="calibre20">defer</code> in <code class="calibre20">main</code>. We do this <em class="calibre9">before</em> calling <code class="calibre20">scanDirectory</code>, which could potentially panic.</p>
<p class="calibre7">Within <code class="calibre20">reportPanic</code>, we call <code class="calibre20">recover</code> and store the panic value it returns. If the program is panicking, this will stop the panic.</p>
<p class="calibre7">But when <code class="calibre20">reportPanic</code> is called, we <em class="calibre9">don’t</em> know whether the program is actually panicking or not. The deferred call to <code class="calibre20">reportPanic</code> will be made regardless of whether <code class="calibre20">scanDirectory</code> calls <code class="calibre20">panic</code> or not. So the first thing we do is test whether the panic value returned from <code class="calibre20">recover</code> is <code class="calibre20">nil</code>. If it is, it means there’s no panic, so we return from <code class="calibre20">reportPanic</code> without doing anything further.</p>
<p class="calibre7">But if the panic value is <em class="calibre9">not</em> <code class="calibre20">nil</code>, it means there’s a panic, and we need to report it.</p>
<p class="calibre7">Because <code class="calibre20">scanDirectory</code> passes an <code class="calibre20">error</code> value to <code class="calibre20">panic</code>, we use a type assertion to convert the <code class="calibre20">interface{}</code> panic value to an <code class="calibre20">error</code> value. If that conversion is successful, we print the <code class="calibre20">error</code> value.</p>
<p class="calibre7">With these changes in place, instead of an ugly panic log and stack trace, our users will simply see an error message!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0373-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0373-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Reinstating a panic" data-type="sect1" class="preface"><div class="preface" id="reinstating_a_panic">
<h1 class="calibre25">Reinstating a panic</h1>
<p class="calibre7"><a data-primary="panicking programs and messages" data-secondary="reinstating panics" data-type="indexterm" id="idm46062709469992" class="calibre10"/>There’s one other potential issue with <code class="calibre20">reportPanic</code> that we need to address. Right now, it intercepts <em class="calibre9">any</em> panic, even ones that didn’t originate from <code class="calibre20">scanDirectory</code>. And if the panic value can’t be converted to an <code class="calibre20">error</code> type, <code class="calibre20">reportPanic</code> won’t print it.</p>
<p class="calibre7">We can test this out by adding another call to <code class="calibre20">panic</code> within <code class="calibre20">main</code> using a <code class="calibre20">string</code> argument:</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0374-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">The <code class="calibre20">reportPanic</code> function recovers from the new panic, but because the panic value isn’t an <code class="calibre20">error</code>, <code class="calibre20">reportPanic</code> doesn’t print it. Our users are left wondering why the program failed!</p>
<p class="calibre7">A common strategy for dealing with unanticipated panics you’re not prepared to recover from is to simply renew the panic state. Panicking again is usually appropriate because, after all, this is an unanticipated situation.</p>
<p class="calibre7">The code at right updates <code class="calibre20">reportPanic</code> to handle unanticipated panics. If the type assertion to convert the panic value to an <code class="calibre20">error</code> succeeds, we simply print it as before. But if it fails, we simply call <code class="calibre20">panic</code> again with the same panic value.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0374-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<p class="calibre7">Running <em class="calibre9">files.go</em> again shows that the fix works: <code class="calibre20">reportPanic</code> recovers from our test call to <code class="calibre20">panic</code>, but then panics again when the <code class="calibre20">error</code> type assertion fails. Now we can remove the call to <code class="calibre20">panic</code> in <code class="calibre20">main</code>, confident that any other unanticipated panics will be reported!</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0374-03.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></section>
<section data-pdf-bookmark="there are no Dumb Questions" data-type="sect1" class="preface"><div class="preface" id="there_are_no_dumb_questions_11">
<h1 class="calibre25">there are no Dumb Questions</h1>
<p class="calibre7"><a data-primary="recover built-in function" data-type="indexterm" id="idm46062709449656" class="calibre10"/><strong class="calibre8">Q: I’ve seen other programming languages that have “exceptions.” The <code class="calibre40">panic</code> and <code class="calibre40">recover</code> functions seem to work in a similar way. Can I use them like exceptions?</strong></p>
<p class="calibre7"><strong class="calibre8">A:</strong> We strongly recommend against it, and so do the Go language maintainers. It can even be said that using <code class="calibre20">panic</code> and <code class="calibre20">recover</code> is discouraged by the design of the language itself. In a conference keynote in 2012, Rob Pike (one of the creators of Go) described <code class="calibre20">panic</code> and <code class="calibre20">recover</code> as “intentionally clumsy.” That means that when designing Go, its creators didn’t try to make <code class="calibre20">panic</code> and <code class="calibre20">recover</code> easy or pleasant to use, so that they’d be used <em class="calibre9">less</em> often.</p>
<p class="calibre7">This is the Go designers’ response to one of the major weaknesses of exceptions: they can make program flow much more complex. Instead, Go developers are encouraged to handle errors the exact same way they handle the other parts of their program: with <code class="calibre20">if</code> and <code class="calibre20">return</code> statements, along with <code class="calibre20">error</code> values. Sure, dealing with errors directly within a function can make that function’s code a little longer, but that beats not dealing with the errors at all. (The Go creators found many developers using exceptions would just raise an exception and then not properly handle it later.) Dealing with errors directly also makes it immediately obvious how the error is handled—you don’t have to go look at a different part of the program to see the error handling code.</p>
<p class="calibre7">So don’t look for an equivalent to exceptions in Go. That feature has been left out, on purpose. It may require a period of adjustment for developers used to using exceptions, but the Go maintainers believe it makes for better software in the end.</p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="calibre7">You can review a summary of Rob Pike’s talk at:<br class="calibre16"/><a href="https://talks.golang.org/2012/splash.article#TOC_16" class="calibre10">https://talks.golang.org/2012/splash.article#TOC_16</a>.</p>
</div>
</div></section>
<section data-pdf-bookmark="Your Go Toolbox" data-type="sect1" class="preface"><div class="preface" id="your_go_toolbox_12">
<h1 class="calibre25">Your Go Toolbox</h1>
<p class="calibre7"><strong class="calibre8">That’s it for <a data-type="xref" href="#back_on_your_feetcolon_recovering_from_f" class="calibre10">Chapter 12</a>! You’ve added deferred function calls and recovery from panics to your toolbox.</strong></p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0376-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0376-02.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar" class="calibre30"><div class="sidebar" id="bullet_point_12">
<h5 class="calibre31">Bullet Points</h5>
<ul class="list_style_type_none">
<li class="calibre18"><p class="calibre7">Returning early from a function with an error value is a good way to indicate an error has occurred, but it can prevent cleanup code later in the function from being run.</p></li>
<li class="calibre18"><p class="calibre7">You can use the <code class="calibre20">defer</code> keyword to call your cleanup function immediately after the code that requires cleanup. That will set up the cleanup code to run when the current function exits, whether or not there was an error.</p></li>
<li class="calibre18"><p class="calibre7">You can call the built-in <code class="calibre20">panic</code> function to cause your program to panic.</p></li>
<li class="calibre18"><p class="calibre7">Unless the built-in <code class="calibre20">recover</code> function is called, a panicking program will crash with a log message.</p></li>
<li class="calibre18"><p class="calibre7">You can pass any value as an argument to <code class="calibre20">panic</code>. That value will be converted to a string and printed as part of the log message.</p></li>
<li class="calibre18"><p class="calibre7">A panic log message includes a stack trace, a list of all active function calls that can be useful for debugging.</p></li>
<li class="calibre18"><p class="calibre7">When a program panics, any deferred function calls will still be made, allowing cleanup code to be executed before a crash.</p></li>
<li class="calibre18"><p class="calibre7">Deferred functions can also call the built-in <code class="calibre20">recover</code> function, which will cause the program to resume normal execution.</p></li>
<li class="calibre18"><p class="calibre7">If <code class="calibre20">recover</code> is called when there is no panic, it simply returns <code class="calibre20">nil</code>.</p></li>
<li class="calibre18"><p class="calibre7">If <code class="calibre20">recover</code> is called during a panic, it returns the value that was passed to <code class="calibre20">panic</code>.</p></li>
<li class="calibre18"><p class="calibre7">Most programs should panic only in the event of an unanticipated error. You should think about all possible errors your program might encounter (such as missing files or badly formatted data), and handle those using <code class="calibre20">error</code> values instead.</p></li>
</ul>
</div></aside>
</div></section>
<section data-pdf-bookmark="Code Magnets Solution" data-type="sect1" class="preface"><div class="preface" id="code_magnets_solution_7">
<h1 class="calibre25">Code Magnets Solution</h1>
<pre data-type="programlisting" class="calibre32">func find(item string, slice []string) bool {
      for _, sliceItem := range slice {
             if item == sliceItem {
                   return true
           }
      }
     return false
}

type Refrigerator []string

func (r Refrigerator) Open() {
       fmt.Println("Opening refrigerator")
}
func (r Refrigerator) Close() {
       fmt.Println("Closing refrigerator")
}

func main() {
            fridge := Refrigerator{"Milk", "Pizza", "Salsa"}
            for _, food := range []string{"Milk", "Bananas"} {
                  err := fridge.FindFood(food)
                  if err != nil {
                         log.Fatal(err)
                  }
            }
}</pre>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0377-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar" class="calibre30"><div class="sidebar" id="exercise_solution_22">
<h5 class="calibre31"><span class="calibre"><img alt="image" src="assets/common1.png" class="calibre4"/></span> Exercise Solution</h5>
<p class="calibre7">A code sample and its output are shown below, but we’ve left some blanks in the output. See if you can fill them in.</p>
<figure class="informal"><div class="figure">
<img alt="image" src="assets/f0378-01.png" class="calibre4"/>
<h6 class="calibre5"/>
</div></figure>
</div></aside>
</div></section>
</div></section></body></html>