<html><head></head><body><section data-pdf-bookmark="Chapter 6. Secured gRPC" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_06">&#13;
<h1><span class="label">Chapter 6. </span>Secured gRPC</h1>&#13;
&#13;
&#13;
<p><a data-primary="security" data-seealso="authentication" data-type="indexterm" id="ix_ch06-asciidoc0"/>gRPC-based applications communicate with each other remotely over the network. This requires each gRPC application to expose its entry point to others who need to communicate with it. From a security point of view, this is not a good thing. The more entry points we have, the broader the attack surface, and the higher the risk of being attacked. Therefore, securing communication and securing the entry points is essential for any real-world use case. Every gRPC application must be able to handle encrypted messages, encrypt all internode communications, and authenticate and sign all messages, etc.</p>&#13;
&#13;
<p>In this chapter, we’ll cover a set of security fundamentals and patterns to address the challenge we face in enabling application-level security. In simple terms, we are going to explore how we can secure communication channels between microservices and authenticate and control access by users.</p>&#13;
&#13;
<p>So let’s start with securing the communication channel.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authenticating a gRPC Channel with TLS" data-type="sect1"><div class="sect1" id="ch_06_sec_01">&#13;
<h1>Authenticating a gRPC Channel with TLS</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="TLS for authenticating a gRPC channel" data-type="indexterm" id="ix_ch06-asciidoc1"/><a data-primary="security" data-secondary="authenticating a gRPC channel with TLS" data-type="indexterm" id="ix_ch06-asciidoc2"/><a data-primary="TLS (Transport Level Security)" data-secondary="authenticating a gRPC channel with" data-type="indexterm" id="ix_ch06-asciidoc3"/><em>Transport Level Security</em> (TLS) aims to provide privacy and data integrity between two communicating applications. Here, it’s about providing a secure connection between gRPC client and server applications. According to the <a href="https://oreil.ly/n4iIE">Transport Level Security Protocol Specification</a>, when the connection between a client and a server is secure, it should have one or more of the following properties:</p>&#13;
<dl>&#13;
<dt>The connection is private</dt>&#13;
<dd>&#13;
<p><a data-primary="cryptography, symmetric" data-type="indexterm" id="idm46536637163592"/><a data-primary="symmetric cryptography" data-type="indexterm" id="idm46536637162888"/>Symmetric cryptography is used for data encryption. It is a type of encryption where only one key (a secret key) is used to both encrypt and decrypt. These keys are generated uniquely for each connection based on a shared secret that was negotiated at the start of the session.</p>&#13;
</dd>&#13;
<dt>The connection is reliable</dt>&#13;
<dd>&#13;
<p>This occurs because each message includes a message integrity check to prevent undetected loss or alteration of the data during transmission.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>So it is important to send data through a secure connection. Securing gRPC connections with TLS is not a difficult task, because this authentication mechanism is built into the gRPC library. It also promotes the use of TLS to authenticate and encrypt exchanges.</p>&#13;
&#13;
<p>How, then, do we enable transport-level security in gRPC connections? Secure data transfer between a client and server can be implemented as either one way or two way (this is also known as mutual TLS, or mTLS). In the following sections, we’ll discuss how to enable security in each of these ways.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling a One-Way Secured Connection" data-type="sect2"><div class="sect2" id="idm46536637158536">&#13;
<h2>Enabling a One-Way Secured Connection</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="enabling a one-way secured connection" data-type="indexterm" id="ix_ch06-asciidoc4"/><a data-primary="one-way connection" data-secondary="enabling with TLS" data-type="indexterm" id="ix_ch06-asciidoc5"/><a data-primary="TLS (Transport Level Security)" data-secondary="enabling a one-way secured connection" data-type="indexterm" id="ix_ch06-asciidoc6"/>In a one-way connection, only the client validates the server to ensure that it receives data from the intended server. When establishing the connection between the client and the server, the server shares its public certificate with the client, who then validates the received certificate. <a data-primary="CA (certificate authority)" data-type="indexterm" id="idm46536636918968"/><a data-primary="certificate authority (CA)" data-type="indexterm" id="idm46536636918280"/>This is done through a certificate authority (CA), for CA-signed certificates. Once the certificate is validated, the client sends the data encrypted using the secret key.</p>&#13;
&#13;
<p>The CA is a trusted entity that manages and issues security certificates and public keys that are used for secure communication in a public network. Certificates signed or issued by this trusted entity are known as CA-signed certificates.</p>&#13;
&#13;
<p>To enable TLS, first we need to create the following certificates and keys:</p>&#13;
<dl>&#13;
<dt><code>server.key</code></dt>&#13;
<dd>&#13;
<p><a data-primary="RSA Key" data-type="indexterm" id="idm46536636914712"/>A private RSA key to sign and authenticate the public key.</p>&#13;
</dd>&#13;
<dt><code>server.pem/server.crt</code></dt>&#13;
<dd>&#13;
<p>Self-signed X.509 public keys for distribution.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The acronym <em>RSA</em> stands for the names of three inventors: Rivest, Shamir, and Adleman. RSA is one of the most popular public-key cryptosystems, being widely used in secure data transmission. In RSA, a public key (that can be known by everyone) is used to encrypt data. A private key is then used to decrypt data. The idea is that messages encrypted with the public key can only be decrypted in a reasonable amount of time by using the private key.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="OpenSSL tool" data-type="indexterm" id="idm46536636909896"/>To generate the keys, we can use the OpenSSL tool, which is an open source toolkit for the TLS and <a data-primary="Secure Socket Layer (SSL)" data-type="indexterm" id="idm46536636908952"/><a data-primary="SSL (Secure Socket Layer)" data-type="indexterm" id="idm46536636908264"/>Secure Socket Layer (SSL) protocols. It has support for generating private keys with different sizes and pass phrases, public certificates, etc. There are other tools like <a href="https://mkcert.dev">mkcert</a> and <a href="https://oreil.ly/Mu4Q6">certstrap</a>, which can also be used to generate the keys and certificates easily.</p>&#13;
&#13;
<p>We won’t describe here how to generate keys that are self-signed certificates, as step-by-step details on generating those keys and certificates are described in the README file in the source code repository.</p>&#13;
&#13;
<p>Assume we created both a private key and public certificate. Let’s use them and secure communication between the gRPC server and client for our online product management system discussed in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch01.html#grpc_ch_01">1</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.html#ch_02">2</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling a one-way secured connection in a gRPC server" data-type="sect3"><div class="sect3" id="idm46536637096472">&#13;
<h3>Enabling a one-way secured connection in a gRPC server</h3>&#13;
&#13;
<p><a data-primary="one-way connection" data-secondary="enabling secured connection in gRPC server" data-type="indexterm" id="idm46536637095192"/><a data-primary="server" data-secondary="enabling a one-way secured connection" data-type="indexterm" id="idm46536637094248"/>This is the simplest way to encrypt communication between client and server. Here the server needs to be initialized with a public/private key pair. We are going to explain how it is done using our gRPC Go server.</p>&#13;
&#13;
<p>To enable a secured Go server, let’s update the main function of the server implementation, as shown in <a data-type="xref" href="#EX6-1">Example 6-1</a>.</p>&#13;
<div data-type="example" id="EX6-1">&#13;
<h5><span class="label">Example 6-1. </span>gRPC secured server implementation for hosting ProductInfo service</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"crypto/tls"</code><code>&#13;
</code><code>  </code><code class="s">"errors"</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">port</code><code> </code><code class="p">=</code><code> </code><code class="s">":50051"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code>  </code><code class="nx">keyFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.key"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">cert</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">tls</code><code class="p">.</code><code class="nx">LoadX509KeyPair</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code class="nx">keyFile</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-1" id="co_secured_grpc_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load key pair: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Creds</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewServerTLSFromCert</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">cert</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-2" id="co_secured_grpc_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-3" id="co_secured_grpc_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-4" id="co_secured_grpc_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-5" id="co_secured_grpc_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO1-6" id="co_secured_grpc_CO1-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-1" id="callout_secured_grpc_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Read and parse a public/private key pair and create a certificate to enable TLS.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-2" id="callout_secured_grpc_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Enable TLS for all incoming connections by adding certificates as TLS server <span class="keep-together">credentials.</span></p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-3" id="callout_secured_grpc_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Create a new gRPC server instance by passing TLS server credentials.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-4" id="callout_secured_grpc_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Register the implemented service to the newly created gRPC server by calling generated APIs.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-5" id="callout_secured_grpc_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Create a TCP listener on the port (50051).</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO1-6" id="callout_secured_grpc_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Bind the gRPC server to the listener and start listening to incoming messages on the port (50051).</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now we have modified the server to accept requests from clients who can verify the server certificate. Let’s modify our client code to talk with this server.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling a one-way secured connection in a gRPC client" data-type="sect3"><div class="sect3" id="idm46536636582968">&#13;
<h3>Enabling a one-way secured connection in a gRPC client</h3>&#13;
&#13;
<p><a data-primary="client" data-secondary="enabling a one-way secured connection" data-type="indexterm" id="idm46536636581848"/><a data-primary="one-way connection" data-secondary="enabling secured connection in gRPC client" data-type="indexterm" id="idm46536636581000"/>In order to get the client connected, the client needs to have the server’s self-certified public key. We can modify our Go client code to connect with the server as shown in <a data-type="xref" href="#EX6-2">Example 6-2</a>.</p>&#13;
<div data-type="example" id="EX6-2">&#13;
<h5><span class="label">Example 6-2. </span>gRPC secured client application</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code>  </code><code class="nx">hostname</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost&#13;
  crtFile = "</code><code class="nx">server</code><code class="p">.</code><code class="nx">crt</code><code class="s">"&#13;
)&#13;
&#13;
func main() {&#13;
  creds, err := credentials.NewClientTLSFromFile(crtFile, hostname) </code><a class="co" href="#callout_secured_grpc_CO2-1" id="co_secured_grpc_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="s">&#13;
  if err != nil {&#13;
     log.Fatalf("</code><code class="nx">failed</code><code> </code><code class="nx">to</code><code> </code><code class="nx">load</code><code> </code><code class="nx">credentials</code><code class="p">:</code><code> </code><code class="o">%</code><code class="nx">v</code><code class="s">", err)&#13;
  }&#13;
  opts := []grpc.DialOption{&#13;
     grpc.WithTransportCredentials(creds), </code><a class="co" href="#callout_secured_grpc_CO2-2" id="co_secured_grpc_CO2-2"><img alt="2" src="assets/2.png"/></a><code class="s">&#13;
  }&#13;
&#13;
  conn, err := grpc.Dial(address, opts...) </code><a class="co" href="#callout_secured_grpc_CO2-3" id="co_secured_grpc_CO2-3"><img alt="3" src="assets/3.png"/></a><code class="s">&#13;
  if err != nil {&#13;
     log.Fatalf("</code><code class="nx">did</code><code> </code><code class="nx">not</code><code> </code><code class="nx">connect</code><code class="p">:</code><code> </code><code class="o">%</code><code class="nx">v</code><code class="err">"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO2-5" id="co_secured_grpc_CO2-4"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO2-4" id="co_secured_grpc_CO2-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
&#13;
  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip RPC method invocation.&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO2-1" id="callout_secured_grpc_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Read and parse a public certificate and create a certificate to enable TLS.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO2-2" id="callout_secured_grpc_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Add transport credentials as a <code>DialOption</code>.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO2-3" id="callout_secured_grpc_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Set up a secure connection with the server, passing dial options.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO2-5" id="callout_secured_grpc_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Pass the connection and create a stub. This stub instance contains all the remote methods to invoke the server.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO2-4" id="callout_secured_grpc_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Close the connection when everything is done.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This is a fairly straightforward process. We only need to add three lines and modify one from the original code. First, we create a credential object from the server public key file, then pass the transport credentials into the gRPC dialer. This will initiate the TLS handshake every time the client sets up a connection between the server.</p>&#13;
&#13;
<p>In one-way TLS, we only authenticate server identity. Let’s authenticate both parties (the client and the server) in the next section.<a data-startref="ix_ch06-asciidoc6" data-type="indexterm" id="idm46536636438680"/><a data-startref="ix_ch06-asciidoc5" data-type="indexterm" id="idm46536636438072"/><a data-startref="ix_ch06-asciidoc4" data-type="indexterm" id="idm46536636437464"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling an mTLS Secured Connection" data-type="sect2"><div class="sect2" id="idm46536637157976">&#13;
<h2>Enabling an mTLS Secured Connection</h2>&#13;
&#13;
<p><a data-primary="mTLS (mutual TLS)" data-secondary="enabling an mTLS secured connection" data-type="indexterm" id="ix_ch06-asciidoc7"/><a data-primary="TLS (Transport Level Security)" data-secondary="enabling an mTLS secured connection" data-type="indexterm" id="ix_ch06-asciidoc8"/>The main intent of an mTLS connection between client and server is to have control of clients who connect to the server. Unlike a one-way TLS connection, the server is configured to accept connections from a limited group of verified clients. Here both parties share their public certificates with each other and validate the other party. The basic flow of connection is as follows:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Client sends a request to access protected information from the server.</p>&#13;
</li>&#13;
<li>&#13;
<p>The server sends its X.509 certificate to the client.</p>&#13;
</li>&#13;
<li>&#13;
<p>Client validates the received certificate through a CA for CA-signed certificates.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the verification is successful, the client sends its certificate to the server.</p>&#13;
</li>&#13;
<li>&#13;
<p>Server also verifies the client certificate through the CA.</p>&#13;
</li>&#13;
<li>&#13;
<p>Once it is successful, the server gives permission to access protected data.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>To enable mTLS in our example, we need to figure out how to deal with client and server certificates. We need to create a CA with self-signed certificates, we need to create certificate-signing requests for both client and server, and we need to sign them using our CA. As in the previous one-way secured connection, we can use the OpenSSL tool to generate keys and certificates.</p>&#13;
&#13;
<p>Assume we have all the required certificates to enable mTLS for client-server communication. If you generated them correctly, you will have the following keys and certificates created in your workspace:</p>&#13;
<dl>&#13;
<dt>server.key</dt>&#13;
<dd>&#13;
<p>Private RSA key of the server.</p>&#13;
</dd>&#13;
<dt>server.crt</dt>&#13;
<dd>&#13;
<p>Public certificate of the server.</p>&#13;
</dd>&#13;
<dt>client.key</dt>&#13;
<dd>&#13;
<p>Private RSA key of the client.</p>&#13;
</dd>&#13;
<dt>client.crt</dt>&#13;
<dd>&#13;
<p>Public certificate of the client.</p>&#13;
</dd>&#13;
<dt>ca.crt</dt>&#13;
<dd>&#13;
<p>Public certificate of a CA used to sign all public certificates.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Let’s first modify the server code of our example to create X.509 key pairs directly and create a certificate pool based on the CA public key.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling mTLS in a gRPC server" data-type="sect3"><div class="sect3" id="idm46536636419448">&#13;
<h3>Enabling mTLS in a gRPC server</h3>&#13;
&#13;
<p><a data-primary="mTLS (mutual TLS)" data-secondary="enabling in a gRPC server" data-type="indexterm" id="ix_ch06-asciidoc9"/><a data-primary="server" data-secondary="enabling mTLS in" data-type="indexterm" id="ix_ch06-asciidoc10"/>To enable mTLS in the Go server, let’s update the main function of the server implementation as shown in <a data-type="xref" href="#EX6-3">Example 6-3</a>.</p>&#13;
<div data-type="example" id="EX6-3">&#13;
<h5><span class="label">Example 6-3. </span>gRPC secured server implementation for hosting ProductInfo service in Go</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"crypto/tls"</code><code>&#13;
</code><code>  </code><code class="s">"crypto/x509"</code><code>&#13;
</code><code>  </code><code class="s">"errors"</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"io/ioutil"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">port</code><code> </code><code class="p">=</code><code> </code><code class="s">":50051"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code>  </code><code class="nx">keyFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.key"</code><code>&#13;
</code><code>  </code><code class="nx">caFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"ca.crt"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">certificate</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">tls</code><code class="p">.</code><code class="nx">LoadX509KeyPair</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">keyFile</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-1" id="co_secured_grpc_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load key pair: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">certPool</code><code> </code><code class="o">:=</code><code> </code><code class="nx">x509</code><code class="p">.</code><code class="nx">NewCertPool</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-2" id="co_secured_grpc_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">ca</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">ioutil</code><code class="p">.</code><code class="nx">ReadFile</code><code class="p">(</code><code class="nx">caFile</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"could not read ca certificate: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">certPool</code><code class="p">.</code><code class="nx">AppendCertsFromPEM</code><code class="p">(</code><code class="nx">ca</code><code class="p">)</code><code class="p">;</code><code> </code><code class="p">!</code><code class="nx">ok</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-3" id="co_secured_grpc_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to append ca certificate"</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="c1">// Enable TLS for all incoming connections.&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Creds</code><code class="p">(</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-4" id="co_secured_grpc_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
        </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewTLS</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">tls</code><code class="p">.</code><code class="nx">Config</code><code> </code><code class="p">{</code><code>&#13;
</code><code>           </code><code class="nx">ClientAuth</code><code class="p">:</code><code>   </code><code class="nx">tls</code><code class="p">.</code><code class="nx">RequireAndVerifyClientCert</code><code class="p">,</code><code>&#13;
</code><code>           </code><code class="nx">Certificates</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">tls</code><code class="p">.</code><code class="nx">Certificate</code><code class="p">{</code><code class="nx">certificate</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>           </code><code class="nx">ClientCAs</code><code class="p">:</code><code>    </code><code class="nx">certPool</code><code class="p">,</code><code>&#13;
</code><code>           </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-5" id="co_secured_grpc_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-6" id="co_secured_grpc_CO3-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-7" id="co_secured_grpc_CO3-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO3-8" id="co_secured_grpc_CO3-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-1" id="callout_secured_grpc_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create X.509 key pairs directly from the server certificate and key.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-2" id="callout_secured_grpc_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create a certificate pool from the CA.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-3" id="callout_secured_grpc_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Append the client certificates from the CA to the certificate pool.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-4" id="callout_secured_grpc_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Enable TLS for all incoming connections by creating TLS credentials.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-5" id="callout_secured_grpc_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Create a new gRPC server instance by passing TLS server credentials.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-6" id="callout_secured_grpc_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Register the gRPC service to the newly created gRPC server by calling generated APIs.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-7" id="callout_secured_grpc_CO3-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Create a TCP listener on the port (50051).</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO3-8" id="callout_secured_grpc_CO3-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Bind the gRPC server to the listener and start listening to the incoming messages on the port (50051).</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now we have modified the server to accept requests from verified clients. Let’s modify our client code to talk with this server.<a data-startref="ix_ch06-asciidoc10" data-type="indexterm" id="idm46536636367096"/><a data-startref="ix_ch06-asciidoc9" data-type="indexterm" id="idm46536636388152"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling mTLS in a gRPC client" data-type="sect3"><div class="sect3" id="idm46536636387352">&#13;
<h3>Enabling mTLS in a gRPC client</h3>&#13;
&#13;
<p><a data-primary="client" data-secondary="enabling mTLS in" data-type="indexterm" id="ix_ch06-asciidoc11"/><a data-primary="mTLS (mutual TLS)" data-secondary="enabling in a gRPC client" data-type="indexterm" id="ix_ch06-asciidoc12"/>In order to get the client connected, the client needs to follow similar steps as the server. We can modify our Go client code as shown in <a data-type="xref" href="#EX6-4">Example 6-4</a>.</p>&#13;
<div data-type="example" id="EX6-4">&#13;
<h5><span class="label">Example 6-4. </span>gRPC secured client application in Go</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"crypto/tls"</code><code>&#13;
</code><code>  </code><code class="s">"crypto/x509"</code><code>&#13;
</code><code>  </code><code class="s">"io/ioutil"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code>  </code><code class="nx">hostname</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"client.crt"</code><code>&#13;
</code><code>  </code><code class="nx">keyFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"client.key"</code><code>&#13;
</code><code>  </code><code class="nx">caFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"ca.crt"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">certificate</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">tls</code><code class="p">.</code><code class="nx">LoadX509KeyPair</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">keyFile</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-1" id="co_secured_grpc_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"could not load client key pair: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">certPool</code><code> </code><code class="o">:=</code><code> </code><code class="nx">x509</code><code class="p">.</code><code class="nx">NewCertPool</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-2" id="co_secured_grpc_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">ca</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">ioutil</code><code class="p">.</code><code class="nx">ReadFile</code><code class="p">(</code><code class="nx">caFile</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"could not read ca certificate: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">certPool</code><code class="p">.</code><code class="nx">AppendCertsFromPEM</code><code class="p">(</code><code class="nx">ca</code><code class="p">)</code><code class="p">;</code><code> </code><code class="p">!</code><code class="nx">ok</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-3" id="co_secured_grpc_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to append ca certs"</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithTransportCredentials</code><code class="p">(</code><code> </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewTLS</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">tls</code><code class="p">.</code><code class="nx">Config</code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-4" id="co_secured_grpc_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
        </code><code class="nx">ServerName</code><code class="p">:</code><code>   </code><code class="nx">hostname</code><code class="p">,</code><code> </code><code class="c1">// NOTE: this is required!&#13;
</code><code>        </code><code class="nx">Certificates</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">tls</code><code class="p">.</code><code class="nx">Certificate</code><code class="p">{</code><code class="nx">certificate</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">RootCAs</code><code class="p">:</code><code>      </code><code class="nx">certPool</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="p">}</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-5" id="co_secured_grpc_CO4-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><a class="co" href="#callout_secured_grpc_CO4-7" id="co_secured_grpc_CO4-6"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO4-6" id="co_secured_grpc_CO4-7"><img alt="6" src="assets/6.png"/></a><code>&#13;
&#13;
  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip RPC method invocation.&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-1" id="callout_secured_grpc_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create X.509 key pairs directly from the server certificate and key.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-2" id="callout_secured_grpc_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create a certificate pool from the CA.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-3" id="callout_secured_grpc_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Append the client certificates from the CA to the certificate pool.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-4" id="callout_secured_grpc_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Add transport credentials as connection options. Here the <code>ServerName</code> must be equal to the <code>Common Name</code> on the certificate.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-5" id="callout_secured_grpc_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Set up a secure connection with the server, passing options.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-7" id="callout_secured_grpc_CO4-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Pass the connection and create a stub. This stub instance contains all the remote methods to invoke the server.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO4-6" id="callout_secured_grpc_CO4-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Close the connection when everything is done.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now we have secured the communication channel between the client and server of the gRPC application using both basic one-way TLS and mTLS.<a data-startref="ix_ch06-asciidoc12" data-type="indexterm" id="idm46536635591800"/><a data-startref="ix_ch06-asciidoc11" data-type="indexterm" id="idm46536635591096"/> The next step is to enable authentication on a per-call basis, which means credentials are attached to the call. Each client call has authentication credentials and the server side checks the credentials of the call and makes a decision whether to allow the client to call or deny<a data-startref="ix_ch06-asciidoc8" data-type="indexterm" id="idm46536635589992"/><a data-startref="ix_ch06-asciidoc7" data-type="indexterm" id="idm46536635589320"/>.<a data-startref="ix_ch06-asciidoc3" data-type="indexterm" id="idm46536635588520"/><a data-startref="ix_ch06-asciidoc2" data-type="indexterm" id="idm46536635587816"/><a data-startref="ix_ch06-asciidoc1" data-type="indexterm" id="idm46536635587144"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authenticating gRPC Calls" data-type="sect1"><div class="sect1" id="ch_06_sec_02">&#13;
<h1>Authenticating gRPC Calls</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="authenticating gRPC calls" data-type="indexterm" id="ix_ch06-asciidoc13"/><a data-primary="calls, authenticating" data-type="indexterm" id="ix_ch06-asciidoc14"/><a data-primary="security" data-secondary="authenticating gRPC calls" data-type="indexterm" id="ix_ch06-asciidoc15"/>gRPC is designed to use serious authentication mechanisms. In the previous section, we covered how to encrypt data exchanged between the client and server using TLS. Now, we’re going to talk about how to verify the identity of the caller and apply access control using different call credential techniques like token-based authentication, etc.</p>&#13;
&#13;
<p>In order to facilitate verification of the caller, gRPC provides the capability for the client to inject his or her credentials (like username and password) on every call. The gRPC server has the ability to intercept a request from the client and check these credentials for every incoming call.</p>&#13;
&#13;
<p>First, we will review a simple authentication scenario to explain how authentication works per client call.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Basic Authentication" data-type="sect2"><div class="sect2" id="idm46536635579656">&#13;
<h2>Using Basic Authentication</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="basic" data-type="indexterm" id="ix_ch06-asciidoc16"/><a data-primary="basic authentication" data-type="indexterm" id="ix_ch06-asciidoc17"/><a data-primary="calls, authenticating" data-secondary="using basic authentication" data-type="indexterm" id="ix_ch06-asciidoc18"/><em>Basic authentication</em> is the simplest authentication mechanism. In this mechanism, the client sends requests with the <code>Authorization</code> header with a value that starts with the word <code>Basic</code> followed by a space and a base64-encoded string <code>username:password</code>. For example, if the username is <code>admin</code> and the password is <code>admin</code>, the header value looks like this:</p>&#13;
&#13;
<pre data-type="programlisting">Authorization: Basic YWRtaW46YWRtaW4=</pre>&#13;
&#13;
<p><a data-primary="username/password authentication" data-type="indexterm" id="idm46536635571000"/>In general, gRPC doesn’t encourage us to use a username/password for authenticating to services. This is because a username/password doesn’t have control in time as opposed to other tokens (JSON Web Tokens [JWTs], OAuth2 access tokens). This means when we generate a token, we can specify how long it is valid. But for a username/password, we cannot specify a validity period. It is valid until we change the password. If you need to enable basic authentication in your application, it’s advised that you share basic credentials in a secure connection between client and server. We pick basic authentication because it is easier to explain how authentication works in gRPC.</p>&#13;
&#13;
<p>Let’s first discuss how to inject user credentials (in basic authentication) into the call. Since there is no built-in support for basic authentication in gRPC, we need to add it as custom credentials to the client context. In Go, we can easily do this by defining a credential struct and implementing the <code>PerRPCCredentials</code> interface as shown in <a data-type="xref" href="#EX6-5">Example 6-5</a>.</p>&#13;
<div data-type="example" id="EX6-5">&#13;
<h5><span class="label">Example 6-5. </span>Implement PerRPCCredentials interface to pass custom credentials</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code> </code><code class="nx">basicAuth</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO5-1" id="co_secured_grpc_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="nx">username</code><code> </code><code class="kt">string</code><code>&#13;
</code><code>  </code><code class="nx">password</code><code> </code><code class="kt">string</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">b</code><code> </code><code class="nx">basicAuth</code><code class="p">)</code><code> </code><code class="nx">GetRequestMetadata</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="nx">in</code><code> </code><code class="o">...</code><code class="kt">string</code><code class="p">)</code><code>  </code><code class="p">(</code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO5-2" id="co_secured_grpc_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">auth</code><code> </code><code class="o">:=</code><code> </code><code class="nx">b</code><code class="p">.</code><code class="nx">username</code><code> </code><code class="o">+</code><code> </code><code class="s">":"</code><code> </code><code class="o">+</code><code> </code><code class="nx">b</code><code class="p">.</code><code class="nx">password</code><code>&#13;
</code><code>  </code><code class="nx">enc</code><code> </code><code class="o">:=</code><code> </code><code class="nx">base64</code><code class="p">.</code><code class="nx">StdEncoding</code><code class="p">.</code><code class="nx">EncodeToString</code><code class="p">(</code><code class="p">[</code><code class="p">]</code><code class="nb">byte</code><code class="p">(</code><code class="nx">auth</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="s">"authorization"</code><code class="p">:</code><code> </code><code class="s">"Basic "</code><code> </code><code class="o">+</code><code> </code><code class="nx">enc</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">b</code><code> </code><code class="nx">basicAuth</code><code class="p">)</code><code> </code><code class="nx">RequireTransportSecurity</code><code class="p">(</code><code class="p">)</code><code> </code><code class="kt">bool</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO5-3" id="co_secured_grpc_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
  </code><code class="k">return</code><code> </code><code class="kc">true</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO5-1" id="callout_secured_grpc_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Define a struct to hold the collection on fields you want to inject in your RPC calls (in our case, it is user credentials like username and password).</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO5-2" id="callout_secured_grpc_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Implement the <code>GetRequestMetadata</code> method and convert user credentials to request metadata. In our case, “Authorization” is the key and the value is “Basic” followed by base64 (&lt;username&gt;:&lt;password&gt;).</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO5-3" id="callout_secured_grpc_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Specify whether channel security is required to pass these credentials. As mentioned earlier, it is advisable to use channel security.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Once we implement a credentials object, we need to initiate it with valid credentials and pass it when creating the connection as shown in <a data-type="xref" href="#EX6-6">Example 6-6</a>.</p>&#13;
<div data-type="example" id="EX6-6">&#13;
<h5><span class="label">Example 6-6. </span>gRPC secured client application with basic authentication</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code>  </code><code class="nx">hostname</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">creds</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewClientTLSFromFile</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">hostname</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load credentials: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">auth</code><code> </code><code class="o">:=</code><code> </code><code class="nx">basicAuth</code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO6-1" id="co_secured_grpc_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">username</code><code class="p">:</code><code> </code><code class="s">"admin"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">password</code><code class="p">:</code><code> </code><code class="s">"admin"</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithPerRPCCredentials</code><code class="p">(</code><code class="nx">auth</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO6-2" id="co_secured_grpc_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithTransportCredentials</code><code class="p">(</code><code class="nx">creds</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip RPC method invocation.&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO6-1" id="callout_secured_grpc_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Initialize the <code>auth</code> variable with valid user credentials (username and password). The <code>auth</code> variable holds the values we are going to use.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO6-2" id="callout_secured_grpc_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Pass the <code>auth</code> variable to the <code>grpc.WithPerRPCCredentials</code> function. The <code>grpc.WithPerRPCCredentials()</code> function takes an interface as a parameter. Since we define our authentication structure to comply with the interface, we can pass our variable.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now the client is pushing extra metadata during its calls to the server, but the server does not care. So we need to tell the server to check metadata. <a data-primary="metadata" data-secondary="basic authentication and" data-type="indexterm" id="idm46536635439288"/>Let’s update our server to read the metadata as shown in <a data-type="xref" href="#EX6-7">Example 6-7</a>.</p>&#13;
<div data-type="example" id="EX6-7">&#13;
<h5><span class="label">Example 6-7. </span>gRPC secured server with basic user credential validation</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"context"</code><code>&#13;
</code><code>  </code><code class="s">"crypto/tls"</code><code>&#13;
</code><code>  </code><code class="s">"encoding/base64"</code><code>&#13;
</code><code>  </code><code class="s">"errors"</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/codes"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/metadata"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/status"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net"</code><code>&#13;
</code><code>  </code><code class="s">"path/filepath"</code><code>&#13;
</code><code>  </code><code class="s">"strings"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">port</code><code> </code><code class="p">=</code><code> </code><code class="s">":50051"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code>  </code><code class="nx">keyFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.key"</code><code>&#13;
</code><code>  </code><code class="nx">errMissingMetadata</code><code> </code><code class="p">=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">InvalidArgument</code><code class="p">,</code><code> </code><code class="s">"missing metadata"</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">errInvalidToken</code><code>    </code><code class="p">=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">Unauthenticated</code><code class="p">,</code><code> </code><code class="s">"invalid credentials"</code><code class="p">)</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">type</code><code> </code><code class="nx">server</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">productMap</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">cert</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">tls</code><code class="p">.</code><code class="nx">LoadX509KeyPair</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">keyFile</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load key pair: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="c1">// Enable TLS for all incoming connections.&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Creds</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewServerTLSFromCert</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">cert</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryInterceptor</code><code class="p">(</code><code class="nx">ensureValidBasicCredentials</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO7-1" id="co_secured_grpc_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">valid</code><code class="p">(</code><code class="nx">authorization</code><code> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">)</code><code> </code><code class="kt">bool</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="nx">authorization</code><code class="p">)</code><code> </code><code class="p">&lt;</code><code> </code><code class="mi">1</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">false</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">token</code><code> </code><code class="o">:=</code><code> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">TrimPrefix</code><code class="p">(</code><code class="nx">authorization</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s">"Basic "</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="nx">token</code><code> </code><code class="o">==</code><code> </code><code class="nx">base64</code><code class="p">.</code><code class="nx">StdEncoding</code><code class="p">.</code><code class="nx">EncodeToString</code><code class="p">(</code><code class="p">[</code><code class="p">]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"admin:admin"</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">ensureValidBasicCredentials</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">req</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">info</code><code>&#13;
</code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryServerInfo</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="nx">handler</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryHandler</code><code class="p">)</code><code> </code><code class="p">(</code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO7-2" id="co_secured_grpc_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">md</code><code class="p">,</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">FromIncomingContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO7-3" id="co_secured_grpc_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
  </code><code class="k">if</code><code> </code><code class="p">!</code><code class="nx">ok</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">errMissingMetadata</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="p">!</code><code class="nx">valid</code><code class="p">(</code><code class="nx">md</code><code class="p">[</code><code class="s">"authorization"</code><code class="p">]</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">errInvalidToken</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="c1">// Continue execution of handler after ensuring a valid token.&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="nx">handler</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO7-1" id="callout_secured_grpc_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Add a new server option (<code>grpc.ServerOption</code>) with the TLS server certificate. <code>grpc.UnaryInterceptor</code> is a function where we add an interceptor to intercept all requests from the client. We pass a reference to a function (<code>ensureValidBasicCredentials</code>) so the interceptor passes all client requests to that function.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO7-2" id="callout_secured_grpc_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Define a function called <code>ensureValidBasicCredentials</code> to validate caller identity. Here, the <code>context.Context</code> object contains the metadata we need and that will exist during the lifetime of the request.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO7-3" id="callout_secured_grpc_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Extract the metadata from the context, get the value of the <code>authentication</code>, and validate the credentials. The keys within <code>metadata.MD</code> are normalized to lowercase. So we need to check the value for the lowercase key.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now the server is validating client identity in each call. This is a very simple example. You can have complex authentication logic inside the server interceptor to validate client identity.<a data-startref="ix_ch06-asciidoc18" data-type="indexterm" id="idm46536634688856"/><a data-startref="ix_ch06-asciidoc17" data-type="indexterm" id="idm46536634688152"/><a data-startref="ix_ch06-asciidoc16" data-type="indexterm" id="idm46536634575944"/></p>&#13;
&#13;
<p>Since you have a basic understanding of how client authentication works, per request, let’s talk about commonly used and recommended token-based authentication (OAuth 2.0).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using OAuth 2.0" data-type="sect2"><div class="sect2" id="idm46536635579032">&#13;
<h2>Using OAuth 2.0</h2>&#13;
&#13;
<p><a href="https://oauth.net/2">OAuth 2.0</a> is<a data-primary="authentication" data-secondary="OAuth 2.0 for" data-type="indexterm" id="ix_ch06-asciidoc19"/><a data-primary="calls, authenticating" data-secondary="using OAuth 2.0" data-type="indexterm" id="ix_ch06-asciidoc20"/><a data-primary="OAuth 2.0" data-type="indexterm" id="ix_ch06-asciidoc21"/> a framework for access delegation. It allows users to grant limited access to services on their behalf, rather than giving them total access like with a username and password. Here we are not going to discuss OAuth 2.0 in detail. It is helpful if you have some basic knowledge about how OAuth 2.0 works to enable it in your application.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In the OAuth 2.0 flow, there are four main characters: the client, the authorization server, the resource server, and the resource owner. <a data-primary="client" data-secondary="OAuth 2.0 flow" data-type="indexterm" id="idm46536633959880"/>The <em>client</em> wants to access the resource in a resource server. <a data-primary="authorization server" data-type="indexterm" id="idm46536633958360"/>To access the resource, the client needs to get a token (which is an arbitrary string) from the <em>authorization server</em>. This token must be of a proper length and should not be predictable. <a data-primary="resource server" data-type="indexterm" id="idm46536634685304"/>Once the client receives the token, the client can send a request to the <em>resource server</em> with the token. The resource server then talks to the corresponding authorization server and validates the token. <a data-primary="resource owner" data-type="indexterm" id="idm46536634683960"/>If it is validated by this <em>resource owner</em>, the client can access the resource.</p>&#13;
</div>&#13;
&#13;
<p>gRPC has built-in support to enable OAuth 2.0 in a gRPC application. Let’s first discuss how to inject a token into the call. Since we don’t have an authorization server in our example, we are going to hardcode an arbitrary string for the token value. <a data-type="xref" href="#EX6-8">Example 6-8</a> illustrates how to add an OAuth token to a client request.</p>&#13;
<div data-type="example" id="EX6-8">&#13;
<h5><span class="label">Example 6-8. </span>gRPC secured client application with OAuth token in Go</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials/oauth"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"golang.org/x/oauth2"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">address</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost:50051"</code><code>&#13;
</code><code>  </code><code class="nx">hostname</code><code> </code><code class="p">=</code><code> </code><code class="s">"localhost"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">auth</code><code> </code><code class="o">:=</code><code> </code><code class="nx">oauth</code><code class="p">.</code><code class="nx">NewOauthAccess</code><code class="p">(</code><code class="nx">fetchToken</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO8-1" id="co_secured_grpc_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
  </code><code class="nx">creds</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewClientTLSFromFile</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">hostname</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load credentials: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithPerRPCCredentials</code><code class="p">(</code><code class="nx">auth</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO8-2" id="co_secured_grpc_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithTransportCredentials</code><code class="p">(</code><code class="nx">creds</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">defer</code><code> </code><code class="nx">conn</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">c</code><code> </code><code class="o">:=</code><code> </code><code class="nx">pb</code><code class="p">.</code><code class="nx">NewProductInfoClient</code><code class="p">(</code><code class="nx">conn</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip RPC method invocation.&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">fetchToken</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code class="nx">oauth2</code><code class="p">.</code><code class="nx">Token</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="o">&amp;</code><code class="nx">oauth2</code><code class="p">.</code><code class="nx">Token</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">AccessToken</code><code class="p">:</code><code> </code><code class="s">"some-secret-token"</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO8-1" id="callout_secured_grpc_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Set up the credentials for the connection. We need to provide an OAuth2 token value to create the credentials. Here we use a hardcoded string value for the token.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO8-2" id="callout_secured_grpc_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Configure gRPC dial options to apply a single OAuth token for all RPC calls on the same connection. If you want to apply an OAuth token per call, then you need to configure the gRPC call with <code>CallOption</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Note that we also enable channel security because OAuth requires the underlying transport to be secure. Inside gRPC, the provided token is prefixed with the token type and attached to the metadata with the key <code>authorization</code>.</p>&#13;
&#13;
<p>In the server, we add a similar interceptor to check and validate the client token that comes with the request as shown in <a data-type="xref" href="#EX6-9">Example 6-9</a>.</p>&#13;
<div data-type="example" id="EX6-9">&#13;
<h5><span class="label">Example 6-9. </span>gRPC secured server with OAuth user token validation</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">package</code><code> </code><code class="nx">main</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="s">"context"</code><code>&#13;
</code><code>  </code><code class="s">"crypto/tls"</code><code>&#13;
</code><code>  </code><code class="s">"errors"</code><code>&#13;
</code><code>  </code><code class="s">"log"</code><code>&#13;
</code><code>  </code><code class="s">"net"</code><code>&#13;
</code><code>  </code><code class="s">"strings"</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code> </code><code class="s">"productinfo/server/ecommerce"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/codes"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/credentials"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/metadata"</code><code>&#13;
</code><code>  </code><code class="s">"google.golang.org/grpc/status"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// server is used to implement ecommerce/product_info.&#13;
</code><code class="kd">type</code><code> </code><code class="nx">server</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">productMap</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="o">*</code><code class="nx">pb</code><code class="p">.</code><code class="nx">Product</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">var</code><code> </code><code class="p">(</code><code>&#13;
</code><code>  </code><code class="nx">port</code><code> </code><code class="p">=</code><code> </code><code class="s">":50051"</code><code>&#13;
</code><code>  </code><code class="nx">crtFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.crt"</code><code>&#13;
</code><code>  </code><code class="nx">keyFile</code><code> </code><code class="p">=</code><code> </code><code class="s">"server.key"</code><code>&#13;
</code><code>  </code><code class="nx">errMissingMetadata</code><code> </code><code class="p">=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">InvalidArgument</code><code class="p">,</code><code> </code><code class="s">"missing metadata"</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">errInvalidToken</code><code>    </code><code class="p">=</code><code> </code><code class="nx">status</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="nx">codes</code><code class="p">.</code><code class="nx">Unauthenticated</code><code class="p">,</code><code> </code><code class="s">"invalid token"</code><code class="p">)</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">cert</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">tls</code><code class="p">.</code><code class="nx">LoadX509KeyPair</code><code class="p">(</code><code class="nx">crtFile</code><code class="p">,</code><code> </code><code class="nx">keyFile</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load key pair: %s"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerOption</code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Creds</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewServerTLSFromCert</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">cert</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryInterceptor</code><code class="p">(</code><code class="nx">ensureValidToken</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO9-1" id="co_secured_grpc_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">s</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="nx">pb</code><code class="p">.</code><code class="nx">RegisterProductInfoServer</code><code class="p">(</code><code class="nx">s</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">server</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="nx">lis</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">net</code><code class="p">.</code><code class="nx">Listen</code><code class="p">(</code><code class="s">"tcp"</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to listen: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code><code class="nx">lis</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to serve: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">valid</code><code class="p">(</code><code class="nx">authorization</code><code> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">)</code><code> </code><code class="kt">bool</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="nx">authorization</code><code class="p">)</code><code> </code><code class="p">&lt;</code><code> </code><code class="mi">1</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">false</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="nx">token</code><code> </code><code class="o">:=</code><code> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">TrimPrefix</code><code class="p">(</code><code class="nx">authorization</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s">"Bearer "</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="nx">token</code><code> </code><code class="o">==</code><code> </code><code class="s">"some-secret-token"</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">ensureValidToken</code><code class="p">(</code><code class="nx">ctx</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code> </code><code class="nx">req</code><code> </code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">info</code><code> </code><code class="o">*</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryServerInfo</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="nx">handler</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">UnaryHandler</code><code class="p">)</code><code> </code><code class="p">(</code><code class="kd">interface</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_secured_grpc_CO9-2" id="co_secured_grpc_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">md</code><code class="p">,</code><code> </code><code class="nx">ok</code><code> </code><code class="o">:=</code><code> </code><code class="nx">metadata</code><code class="p">.</code><code class="nx">FromIncomingContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="p">!</code><code class="nx">ok</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">errMissingMetadata</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">if</code><code> </code><code class="p">!</code><code class="nx">valid</code><code class="p">(</code><code class="nx">md</code><code class="p">[</code><code class="s">"authorization"</code><code class="p">]</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>     </code><code class="k">return</code><code> </code><code class="kc">nil</code><code class="p">,</code><code> </code><code class="nx">errInvalidToken</code><code>&#13;
</code><code>  </code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="k">return</code><code> </code><code class="nx">handler</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO9-1" id="callout_secured_grpc_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Add the new server option (<code>grpc.ServerOption</code>) along with the TLS server certificate. With the <code>grpc.UnaryInterceptor</code> function, we add an interceptor to intercept all requests from the client.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO9-2" id="callout_secured_grpc_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Define a function called <code>ensureValidToken</code>  to validate the token. If the token is missing or invalid, the interceptor blocks the execution and gives an error. Otherwise, the interceptor invokes the next handler passing the context and interface.</p></dd>&#13;
</dl>&#13;
&#13;
<p>It is possible to configure token validation for all RPCs using an interceptor. A server may configure either a <code>grpc.UnaryInterceptor</code> or a <code>grpc.StreamInterceptor</code> depending on the service type.<a data-startref="ix_ch06-asciidoc21" data-type="indexterm" id="idm46536633274568"/><a data-startref="ix_ch06-asciidoc20" data-type="indexterm" id="idm46536633747496"/><a data-startref="ix_ch06-asciidoc19" data-type="indexterm" id="idm46536633746824"/></p>&#13;
&#13;
<p>Similar to OAuth 2.0 authentication, gRPC also supports JSON Web Token (JWT)-based authentication. In the next section, we’ll discuss what changes we need to make to enable JWT-based authentication.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using JWT" data-type="sect2"><div class="sect2" id="idm46536634574104">&#13;
<h2>Using JWT</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="JWT for" data-type="indexterm" id="idm46536633676792"/><a data-primary="calls, authenticating" data-secondary="using JWT" data-type="indexterm" id="idm46536633675816"/><a data-primary="JWT (JSON Web Token)" data-type="indexterm" id="idm46536633674872"/>JWT defines a container to transport identity information between the client and server. A signed JWT can be used as a self-contained access token, which means the resource server doesn’t need to talk to the authentication server to validate the client token. It can validate the token by validating the signature. The client requests access from the authentication server, which verifies the client’s credentials, creates a JWT, and sends it to the client. The client application with JWT allows access to resources.</p>&#13;
&#13;
<p>gRPC has built-in support for JWT. If you have the JWT file from the authentication server, you need to pass that token file and create JWT credentials.&#13;
The code snippet in <a data-type="xref" href="#EX6-10">Example 6-10</a> illustrates how to create JWT credentials from the JWT token file (<em>token.json</em>) and pass them as <code>DialOptions</code> in a Go client application.</p>&#13;
<div data-type="example" id="EX6-10">&#13;
<h5><span class="label">Example 6-10. </span>Setting up a connection using a JWT in a Go client application</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">jwtCreds</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">oauth</code><code class="p">.</code><code class="nx">NewJWTAccessFromFile</code><code class="p">(</code><code class="err">“</code><code class="nx">token</code><code class="p">.</code><code class="nx">json</code><code class="err">”</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO10-1" id="co_secured_grpc_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Failed to create JWT credentials: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">creds</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewClientTLSFromFile</code><code class="p">(</code><code class="s">"server.crt"</code><code class="p">,</code><code>&#13;
</code><code>     </code><code class="s">"localhost"</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"failed to load credentials: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithPerRPCCredentials</code><code class="p">(</code><code class="nx">jwtCreds</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="c1">// transport credentials.&#13;
</code><code>  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithTransportCredentials</code><code class="p">(</code><code class="nx">creds</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO10-2" id="co_secured_grpc_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// Set up a connection to the server.&#13;
</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>  </code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip Stub generation and RPC method invocation.</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO10-1" id="callout_secured_grpc_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Call <code>oauth.NewJWTAccessFromFile</code> to initialize a <code>credentials.PerRPCCredentials</code>. We need to provide a valid token file to create the credentials.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO10-2" id="callout_secured_grpc_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Configure a gRPC dial with <code>DialOption WithPerRPCCredentials</code> to apply a JWT token for all RPC calls on the same connection.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In addition to these authentication techniques, we can add any authentication mechanism by extending RPC credentials on the client side and adding a new interceptor on the server side. gRPC also provides special built-in support for calling gRPC services deployed in Google Cloud. in the next section, we’ll discuss how to call those services.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Google Token-Based Authentication" data-type="sect2"><div class="sect2" id="idm46536633585368">&#13;
<h2>Using Google Token-Based Authentication</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="Google token-based" data-type="indexterm" id="idm46536633584152"/><a data-primary="calls, authenticating" data-secondary="using Google token-based authentication" data-type="indexterm" id="idm46536633583288"/><a data-primary="ESP (Extensible Service Proxy)" data-type="indexterm" id="idm46536633711448"/><a data-primary="Google Cloud Platform, authentication for using services on" data-type="indexterm" id="idm46536633710760"/>Identifying the users and deciding whether to let them use the services deployed on the Google Cloud Platform is controlled by the Extensible Service Proxy (ESP). ESP supports multiple authentication methods, including Firebase, Auth0, and Google ID tokens. <a data-primary="JWT (JSON Web Token)" data-type="indexterm" id="idm46536633709720"/>In each case, the client needs to provide a valid JWT in their requests. In order to generate authenticating JWTs, we must create a service account for each deployed service.</p>&#13;
&#13;
<p>Once we have the JWT token for the service, we can call the service method by sending the token along with the request. We can create the channel passing the credentials as shown in <a data-type="xref" href="#EX6-11">Example 6-11</a>.</p>&#13;
<div data-type="example" id="EX6-11">&#13;
<h5><span class="label">Example 6-11. </span>Setting up a connection with a Google endpoint in a Go client application</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">perRPC</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">oauth</code><code class="p">.</code><code class="nx">NewServiceAccountFromFile</code><code class="p">(</code><code class="s">"service-account.json"</code><code class="p">,</code><code> </code><code class="nx">scope</code><code class="p">)</code><code> </code><a class="co" href="#callout_secured_grpc_CO11-1" id="co_secured_grpc_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"Failed to create JWT credentials: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">pool</code><code class="p">,</code><code> </code><code class="nx">_</code><code> </code><code class="o">:=</code><code> </code><code class="nx">x509</code><code class="p">.</code><code class="nx">SystemCertPool</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="nx">creds</code><code> </code><code class="o">:=</code><code> </code><code class="nx">credentials</code><code class="p">.</code><code class="nx">NewClientTLSFromCert</code><code class="p">(</code><code class="nx">pool</code><code class="p">,</code><code> </code><code class="s">""</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nx">opts</code><code> </code><code class="o">:=</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">grpc</code><code class="p">.</code><code class="nx">DialOption</code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithPerRPCCredentials</code><code class="p">(</code><code class="nx">perRPC</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">WithTransportCredentials</code><code class="p">(</code><code class="nx">creds</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_secured_grpc_CO11-2" id="co_secured_grpc_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">conn</code><code class="p">,</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Dial</code><code class="p">(</code><code class="nx">address</code><code class="p">,</code><code> </code><code class="nx">opts</code><code class="o">...</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatalf</code><code class="p">(</code><code class="s">"did not connect: %v"</code><code class="p">,</code><code> </code><code class="nx">err</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="o">...</code><code class="p">.</code><code> </code><code class="c1">// Skip Stub generation and RPC method invocation.</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_secured_grpc_CO11-1" id="callout_secured_grpc_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Call <code>oauth.NewServiceAccountFromFile</code> to initialize  <code>credentials.PerRPCCredentials</code>. We need to provide a valid token file to create the credentials.</p></dd>&#13;
<dt><a class="co" href="#co_secured_grpc_CO11-2" id="callout_secured_grpc_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Similar to authentication mechanisms discussed earlier, we configure a gRPC dial with <code>DialOption WithPerRPCCredentials</code> to apply the authentication token as metadata for all RPC calls on the same connection.<a data-startref="ix_ch06-asciidoc15" data-type="indexterm" id="idm46536633763000"/><a data-startref="ix_ch06-asciidoc14" data-type="indexterm" id="idm46536633762328"/><a data-startref="ix_ch06-asciidoc13" data-type="indexterm" id="idm46536633205496"/></p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch_06_sec_03">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>When building a production-ready gRPC application, it is essential to have at least minimum security requirements for the gRPC application to ensure secure communication between the client and server. The gRPC library is designed to work with different kinds of authentication mechanisms and capable of extending support by adding a custom authentication mechanism. This makes it easy to safely use gRPC to talk to other systems.</p>&#13;
&#13;
<p>There are two types of credential supports in gRPC, channel and call. Channel credentials are attached to the channels such as TLS, etc. Call credentials are attached to the call, such as OAuth 2.0 tokens, basic authentication, etc. We even can apply both credential types to the gRPC application. For example, we can have TLS enable the connection between client and server and also attach credentials to each RPC call made on the connection.</p>&#13;
&#13;
<p>In this chapter, you learned how to enable both credential types to your gRPC application. In the next chapter, we’ll expand on the concepts and technologies you’ve learned to build and run real-world gRPC applications in production. We’ll also discuss how to write test cases for service and client applications, how to deploy an application on Docker and Kubernetes, and how to observe the system when it runs in production.<a data-startref="ix_ch06-asciidoc0" data-type="indexterm" id="idm46536633546792"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>