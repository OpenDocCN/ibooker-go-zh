<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 15. Writing Tests"><div class="chapter" id="unique_chapter_id_15">
<h1><span class="label">Chapter 15. </span>Writing Tests</h1>


<p>Since  the 2000s, the widespread adoption<a data-type="indexterm" data-primary="standard library" data-secondary="testing package" data-seealso="testing" id="id2794"/><a data-type="indexterm" data-primary="testing" data-secondary="about" id="id2795"/> of automated testing has probably done more to improve code quality than any other software engineering technique. As a language and ecosystem focused on improving software quality, it’s not surprising that Go includes testing support as part of its standard library. Go makes it so easy to test your code, there’s no excuse to not do it.</p>

<p>In this chapter, you’ll see how to test Go code, group tests into unit and integration tests, examine code coverage, write benchmarks, and learn how to check code for concurrency issues by using the Go data race detector. Along the way, I’ll discuss how to write code that is testable and why this improves our code quality.</p>






<section data-type="sect1" data-pdf-bookmark="Understanding the Basics of Testing"><div class="sect1" id="id187">
<h1>Understanding the Basics of Testing</h1>

<p>Go’s testing support has two parts: libraries and tooling.<a data-type="indexterm" data-primary="testing" data-secondary="basics of" id="ch15-bas"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" id="ch15-test"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" id="ch15-test2"/> The <code>testing</code> package in the standard library provides the types and functions to write tests, while the <code>go test</code> tool that’s bundled with Go runs your tests and generates reports. Unlike many other languages, Go places its tests in the same directory and the same package as the production code. Since tests are located in the same package, they are able to access and test unexported functions and variables. You’ll see in a bit how to write tests that ensure that you are testing only a public API.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Complete code samples for this chapter are found in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2796"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2797"/></p>
</div>

<p>Let’s write a simple function and then a test to make sure the function works. In the <em>sample_code/adder</em> directory, in the file <em>adder.go</em>, you have the following:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">addNumbers</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code><code class="w"> </code><code class="nx">y</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">x</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">x</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The corresponding test is in <em>adder_test.go</em>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">Test_addNumbers</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">addNumbers</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">5</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"incorrect result: expected 5, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Every test is written in a file whose name ends with <em>_test.go</em>. If you are writing tests against <em>foo.go</em>, place your tests in a file named <em>foo_test.go</em>.</p>

<p>Test functions start with the word <code>Test</code> and take in a single parameter of type 
<span class="keep-together"><code>*testing.T</code>.</span> By convention, this parameter is named <code>t</code>. Test functions do not return any values. The name of the test (apart from starting with the word “Test”) is meant to document what you are testing, so pick something that explains what you are testing. When writing unit tests for individual functions, the convention is to name the unit test <code>Test</code> followed by the name of the function. When testing unexported functions, some people use an underscore between the word <code>Test</code> and the name of the function.</p>

<p>Also note that you use standard Go code to call the code being tested and to validate that the responses are as expected. When there’s an incorrect result, you report the error with the <code>t.Error</code> method, which works like the <code>fmt.Print</code> function. You’ll see other error-reporting methods in a bit.</p>

<p>You’ve just seen the library portion of Go’s test support. Now let’s take a look at the tooling. Just as <code>go build</code> builds a binary and <code>go run</code> runs a program, the command <code>go test</code> runs the test functions in the current directory:</p>
<pre data-type="programlisting">
$ <strong>go test</strong>
--- FAIL: Test_addNumbers (0.00s)
    adder_test.go:8: incorrect result: expected 5, got 4
FAIL
exit status 1
FAIL    test_examples/adder     0.006s
</pre>

<p>It looks like you found a bug in your code. Taking a second look at <code>addNumbers</code>, you see that you are adding <code>x</code> to <code>x</code>, not <code>x</code> to <code>y</code>. Let’s change the code and rerun the test to verify that the bug is fixed:</p>
<pre data-type="programlisting">
$ <strong>go test</strong>
PASS
ok      test_examples/adder     0.006s
</pre>

<p>The <code>go test</code> command allows you to specify which packages to test. Using <code>./...</code>  for the package name specifies that you want to run tests in the current directory and all subdirectories of the current directory. Include a <code>-v</code> flag to get verbose testing output.<a data-type="indexterm" data-startref="ch15-bas" id="id2798"/><a data-type="indexterm" data-startref="ch15-test" id="id2799"/><a data-type="indexterm" data-startref="ch15-test2" id="id2800"/></p>








<section data-type="sect2" data-pdf-bookmark="Reporting Test Failures"><div class="sect2" id="id291">
<h2>Reporting Test Failures</h2>

<p>There are several methods on <code>*testing.T</code> for <a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="reporting test failures" id="id2801"/>reporting test failures. You’ve already seen <code>Error</code>, which builds a failure description string out of a comma-separated list of values.</p>

<p>If you’d rather use a <code>Printf</code>-style formatting string to generate your message, use the <code>Errorf</code> method instead:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"incorrect result: expected %d, got %d"</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/></pre>

<p>While <code>Error</code> and <code>Errorf</code> mark a test as failed, the test function continues running. If you think a test function should stop processing as soon as a failure is found, use the <code>Fatal</code> and <code>Fatalf</code> methods. The <code>Fatal</code> method works like <code>Error</code>, and the <code>Fatalf</code> method works like <code>Errorf</code>. The difference is that the test function exits immediately after the test failure message is generated. Note that this doesn’t exit <em>all</em> tests; any remaining test functions will execute after the current test function exits.</p>

<p>When should you use <code>Fatal</code>/<code>Fatalf</code> and when should you use <code>Error</code>/<code>Errorf</code>? If the failure of a check in a test means that further checks in the same test function will always fail or cause the test to panic, use <code>Fatal</code> or <code>Fatalf</code>. If you are testing several independent items (such as validating fields in a struct), then use <code>Error</code> or <code>Errorf</code> so you can report many problems at once. This makes it easier to fix multiple problems without rerunning your tests over and over.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Setting Up and Tearing Down"><div class="sect2" id="id188">
<h2>Setting Up and Tearing Down</h2>

<p>Sometimes you have some common state<a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="test setup and teardown" id="ch15-tear"/> that you want to set up before any tests run and remove when testing is complete. Use a <code>TestMain</code> function to manage this state and run your tests:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code><code class="w"> </code><code class="nx">testTime</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Time</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestMain</code><code class="p">(</code><code class="nx">m</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">M</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Set up stuff for tests here"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">testTime</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">exitVal</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">m</code><code class="p">.</code><code class="nx">Run</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Clean up stuff after tests here"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">os</code><code class="p">.</code><code class="nx">Exit</code><code class="p">(</code><code class="nx">exitVal</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestFirst</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"TestFirst uses stuff set up in TestMain"</code><code class="p">,</code><code class="w"> </code><code class="nx">testTime</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestSecond</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"TestSecond also uses stuff set up in TestMain"</code><code class="p">,</code><code class="w"> </code><code class="nx">testTime</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Both <code>TestFirst</code> and <code>TestSecond</code> refer to the package-level variable <code>testTime</code>. Assume that it needs to be initialized in order for the tests to run properly. You declare a function called <code>TestMain</code> with a parameter of type <code>*testing.M</code>. <a data-type="indexterm" data-primary="go commands" data-secondary="go test" id="id2802"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" id="id2803"/>If there’s a function named <code>TestMain</code> in a package, <code>go test</code> calls it instead of the test functions. It is the responsibility of the <code>TestMain</code> function to set up any state that’s necessary to make the tests in the package run correctly.</p>

<p>Once the state is configured, the <code>TestMain</code> function calls the <code>Run</code> method on <code>*testing.M</code>. This runs the test functions in the package. The <code>Run</code> method returns the exit code; <code>0</code> indicates that all tests passed. Finally, the <code>TestMain</code> function must call <code>os.Exit</code> with the exit code returned from <code>Run</code>.</p>

<p>Running <code>go test</code> on this produces the output:</p>
<pre data-type="programlisting">
$ <strong>go test</strong>
Set up stuff for tests here
TestFirst uses stuff set up in TestMain 2020-09-01 21:42:36.231508 -0400 EDT
    m=+0.000244286
TestSecond also uses stuff set up in TestMain 2020-09-01 21:42:36.231508 -0400
    EDT m=+0.000244286
PASS
Clean up stuff after tests here
ok      test_examples/testmain  0.006s
</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Be aware that <code>TestMain</code> is invoked once, not before and after each individual test. Also be aware that you can have only one <code>TestMain</code> per package.</p>
</div>

<p><code>TestMain</code> is useful in two common situations:</p>

<ul>
<li>
<p>When you need to set up data in an external repository, such as a database</p>
</li>
<li>
<p>When the code being tested depends on package-level variables that need to be initialized</p>
</li>
</ul>

<p>As mentioned before (and will be again!), you should avoid package-level variables in your programs. They make it hard to understand how data flows through your program. If you are using <code>TestMain</code> for this reason, consider refactoring your code.</p>

<p>The <code>Cleanup</code> method on <code>*testing.T</code> is used to clean up temporary resources created for a single test. This method has a single parameter, a function with no input parameters or return values. The function runs when the test completes. For simple tests, you can achieve the same result by using a <code>defer</code> statement, but <code>Cleanup</code> is useful when tests rely on helper functions to set up sample data, as you see in <a data-type="xref" href="#EX15_1">Example 15-1</a>. It’s fine to call <code>Cleanup</code> multiple times. Just like <code>defer</code>, the functions are invoked in last-added, first-called order.</p>
<div id="EX15_1" data-type="example">
<h5><span class="label">Example 15-1. </span>Using <code>t.Cleanup</code></h5>

<pre data-type="programlisting" data-code-language="go"><code class="c1">// createFile is a helper function called from multiple tests</code><code class="w"/>
<code class="kd">func</code><code class="w"> </code><code class="nx">createFile</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="nx">_</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">f</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">os</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="s">"tempFile"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="s">""</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">defer</code><code class="w"> </code><code class="kd">func</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">Join</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="nx">f</code><code class="p">.</code><code class="nx">Close</code><code class="p">())</code><code class="w"/>
<code class="w">    </code><code class="p">}()</code><code class="w"/>
<code class="w">    </code><code class="c1">// write some data to f</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Cleanup</code><code class="p">(</code><code class="kd">func</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">os</code><code class="p">.</code><code class="nx">Remove</code><code class="p">(</code><code class="nx">f</code><code class="p">.</code><code class="nx">Name</code><code class="p">())</code><code class="w"/>
<code class="w">    </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">f</code><code class="p">.</code><code class="nx">Name</code><code class="p">(),</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestFileProcessing</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fName</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">createFile</code><code class="p">(</code><code class="nx">t</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="c1">// do testing, don't worry about cleanup</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre></div>

<p>If your test uses temporary files, you can avoid writing cleanup code by taking advantage of the <code>TempDir</code> method on <code>*testing.T</code>. This method creates a new temporary directory every time it is invoked and returns the full path of the directory. It also registers a handler with <code>Cleanup</code> to delete the directory and its contents when the test has completed. You can use it to rewrite the previous example:<a data-type="indexterm" data-startref="ch15-tear" id="id2804"/></p>

<pre data-type="programlisting" data-code-language="go"><code class="c1">// createFile is a helper function called from multiple tests</code><code class="w"/>
<code class="kd">func</code><code class="w"> </code><code class="nx">createFile</code><code class="p">(</code><code class="nx">tempDir</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="nx">_</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">f</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">os</code><code class="p">.</code><code class="nx">CreateTemp</code><code class="p">(</code><code class="nx">tempDir</code><code class="p">,</code><code class="w"> </code><code class="s">"tempFile"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="s">""</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">defer</code><code class="w"> </code><code class="kd">func</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">Join</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="nx">f</code><code class="p">.</code><code class="nx">Close</code><code class="p">())</code><code class="w"/>
<code class="w">    </code><code class="p">}()</code><code class="w"/>
<code class="w">    </code><code class="c1">// write some data to f</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">f</code><code class="p">.</code><code class="nx">Name</code><code class="p">(),</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestFileProcessing</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">tempDir</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">t</code><code class="p">.</code><code class="nx">TempDir</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">fName</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">createFile</code><code class="p">(</code><code class="nx">tempDir</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="c1">// do testing, don't worry about cleanup</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Testing with Environment Variables"><div class="sect2" id="id269">
<h2>Testing with Environment Variables</h2>

<p>It’s a common (and very good) practice<a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="environment variables in testing" id="id2805"/><a data-type="indexterm" data-primary="environment variables" data-secondary="testing using" id="id2806"/> to configure applications with environment variables.  To help you test your environment-variable–parsing code, Go provides a helper method on <code>testing.T</code>. Call <code>t.Setenv()</code> to register a value for an environment variable for your test. Behind the scenes, it calls <code>Cleanup</code> to revert the environment variable to its previous state when the test exits:</p>

<pre data-type="programlisting" data-code-language="go"><code class="c1">// assume ProcessEnvVars is a function that processes environment variables</code><code class="w"/>
<code class="c1">// and returns a struct with an OutputFormat field</code><code class="w"/>
<code class="kd">func</code><code class="w"> </code><code class="nx">TestEnvVarProcess</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Setenv</code><code class="p">(</code><code class="s">"OUTPUT_FORMAT"</code><code class="p">,</code><code class="w"> </code><code class="s">"JSON"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">cfg</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">ProcessEnvVars</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">cfg</code><code class="p">.</code><code class="nx">OutputFormat</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">"JSON"</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"OutputFormat not set correctly"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="c1">// value of OUTPUT_FORMAT is reset when the test function exits</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>While it is good to use environment variables to configure your application, it is also good to make sure that most of your code is entirely unaware of them. Be sure to copy the values of environment variables into configuration structs before your program starts its work, in your <code>main</code> function or soon afterward. Doing so makes it easier to reuse and test code, since <em>how</em> the code is configured has been abstracted away from <em>what</em> the code is doing.</p>

<p>Rather than writing this code yourself, you should strongly consider using a third-party configuration library, like <a href="https://oreil.ly/-RUA-">Viper</a> or <a href="https://oreil.ly/rhGYk">envconfig</a>. Also, look at <a href="https://oreil.ly/sN2Sp">GoDotEnv</a> as a way to store environment variables in <em>.env</em> files for development or continuous integration machines.</p>
</div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Storing Sample Test Data"><div class="sect2" id="id189">
<h2>Storing Sample Test Data</h2>

<p>As <code>go test</code> walks your source code tree,<a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="storing sample test data" id="id2807"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="storing sample test data" id="id2808"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="storing sample test data" id="id2809"/> it uses the current package directory as the current working directory. If you want to use sample data to test functions in a package, create a subdirectory named <em>testdata</em> to hold your files. Go reserves this directory name as a place to hold test files. When reading from <em>testdata</em>, always use a relative file reference. Since <code>go test</code> changes the current working directory to the current package, each package accesses its own <em>testdata</em> via a relative file path.</p>
<div data-type="tip"><h6>Tip</h6>
<p>The <a href="https://oreil.ly/lV_KJ"><code>text</code> package</a> in the <em>sample_code</em> directory of the Chapter 15 repository demonstrates how to use <em>testdata</em>.<a data-type="indexterm" data-primary="testing" data-secondary="text package and using test data" id="id2810"/><a data-type="indexterm" data-primary="text package and using test data" id="id2811"/><a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_ooo123"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_o1o2"/></p>
</div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Caching Test Results"><div class="sect2" id="id292">
<h2>Caching Test Results</h2>

<p>Just as you learned in <a data-type="xref" href="ch10.html#unique_chapter_id_10">Chapter 10</a> that <a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="caching test results" id="id2812"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="caching test results" id="id2813"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="caching test results" id="id2814"/>Go caches compiled packages if they haven’t changed, Go also caches test results when running tests across multiple packages if they have passed and their code hasn’t changed. The tests are recompiled and rerun if you change any file in the package or in the <em>testdata</em> directory. You can also force tests to always run if you pass the flag <code>-count=1</code> to <code>go test</code>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Testing Your Public API"><div class="sect2" id="public_api_test">
<h2>Testing Your Public API</h2>

<p>The tests that you’ve written are in<a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="testing your public API" id="id2815"/><a data-type="indexterm" data-primary="APIs" data-secondary="testing your public API" id="id2816"/> the same package as the production code. This allows you to test both exported and unexported functions.</p>

<p>If you want to test just the public API of your package, Go has a convention for specifying this. You still keep your test source code in the same directory as the production source code, but you use <code>packagename_test</code> for the package name. Let’s redo the initial test case, using an exported function instead. You can find the code in the <em>sample_code/pubadder</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>. If you have the following function in the <code>pubadder</code> package</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">AddNumbers</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code><code class="w"> </code><code class="nx">y</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">x</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">y</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>then you can test it as public API by using the following code in a file in the <code>pubadder</code> package named <em>adder_public_test.go</em>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kn">package</code><code class="w"> </code><code class="nx">pubadder_test</code><code class="w"/>

<code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w"/>
<code class="w">    </code><code class="s">"github.com/learning-go-book-2e/ch15/sample_code/pubadder"</code><code class="w"/>
<code class="w">    </code><code class="s">"testing"</code><code class="w"/>
<code class="p">)</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">TestAddNumbers</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">pubadder</code><code class="p">.</code><code class="nx">AddNumbers</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">5</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"incorrect result: expected 5, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Notice that the package name for the test file is <code>pubadder_test</code>. You have to import <code>github.com/learning-go-book-2e/ch15/sample_code/pubadder</code> even though the files are in the same directory. To follow the convention for naming tests, the test function name matches the name of the 
<span class="keep-together"><code>AddNumbers</code></span> function. Also note that you use <code>pubadder.AddNumbers</code>, since you are calling an exported function in a different package.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If you are typing this code in by hand, you’ll need to create a module with a <em>go.mod</em> file that has the module declaration:</p>

<pre data-type="programlisting">module github.com/learning-go-book-2e/ch15</pre>

<p>and that puts the source code in the <em>sample_code/pubadder</em> directory within the module.</p>
</div>

<p>Just as you can call exported functions from within a package, you can test your public API from a test that is in the same package as your source code. The advantage of using the <code>_test</code> suffix in the package name is that it lets you treat your tested package as a “black box.” You are forced to interact with it only via its exported functions, methods, types, constants, and variables. Also be aware that you can have test source files with both package names intermixed in the same source directory.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Using go-cmp to Compare Test Results"><div class="sect2" id="id190">
<h2>Using go-cmp to Compare Test Results</h2>

<p>Writing<a data-type="indexterm" data-primary="testing" data-secondary="basics of" data-tertiary="go-cmp to compare test results" id="ch15-cmp"/><a data-type="indexterm" data-primary="go-cmp to compare test results" id="ch15-cmp2"/><a data-type="indexterm" data-primary="comparison operators" data-secondary="test results compared with go-cmp" id="ch15-cmp3"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="go-cmp to compare results" id="ch15-cmp4"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="go-cmp to compare results" id="ch15-cmp5"/> a thorough comparison of a compound type’s two instances can be verbose. While you can use <code>reflect.DeepEqual</code> to compare structs, maps, and slices, there’s a better way. Google released a third-party module called <a href="https://oreil.ly/9bWJf"><code>go-cmp</code></a> that does the comparison for you and returns a detailed description of what does not match. Let’s see how it works by defining a simple <code>struct</code> and a factory function that populates it. You can find this code in the <em>sample_code/cmp</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>:<a data-type="indexterm" data-startref="ix_ooo123" id="id2817"/><a data-type="indexterm" data-startref="ix_o1o2" id="id2818"/></p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">Person</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">Name</code><code class="w">      </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">Age</code><code class="w">       </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="nx">DateAdded</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Time</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">CreatePerson</code><code class="p">(</code><code class="nx">name</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">age</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="nx">Person</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">Person</code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">Name</code><code class="p">:</code><code class="w">      </code><code class="nx">name</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">Age</code><code class="p">:</code><code class="w">       </code><code class="nx">age</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">DateAdded</code><code class="p">:</code><code class="w"> </code><code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">(),</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p class="pagebreak-before">In your test file, you need to import <code>github.com/google/go-cmp/cmp</code>, and your test function looks like this:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestCreatePerson</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">expected</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">Person</code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="s">"Dennis"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">Age</code><code class="p">:</code><code class="w">  </code><code class="mi">37</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">CreatePerson</code><code class="p">(</code><code class="s">"Dennis"</code><code class="p">,</code><code class="w"> </code><code class="mi">37</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">expected</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The <code>cmp.Diff</code> function takes in the expected output and the output that was returned by the function that you’re testing. It returns a string that describes any mismatches between the two inputs. If the inputs match, it returns an empty string. You assign the output of the <code>cmp.Diff</code> function to a variable called <code>diff</code> and then check whether <code>diff</code> is an empty string. If it is not, an error occurred.</p>

<p>When you build and run the test, you’ll see the output that <code>go-cmp</code> generates when two struct instances don’t match:</p>
<pre data-type="programlisting">
$ <strong>go test</strong>
--- FAIL: TestCreatePerson (0.00s)
    ch13_cmp_test.go:16:   ch13_cmp.Person{
              Name:      "Dennis",
              Age:       37,
        -     DateAdded: s"0001-01-01 00:00:00 +0000 UTC",
        +     DateAdded: s"2020-03-01 22:53:58.087229 -0500 EST m=+0.001242842",
          }

FAIL
FAIL    ch13_cmp    0.006s
</pre>

<p>The lines with a <code>-</code> and <code>+</code> indicate the fields whose values differ. The test failed because the dates didn’t match. This is a problem because you can’t control what date is assigned by the <code>CreatePerson</code> function. You have to ignore the <code>DateAdded</code> field. You do that by specifying a comparator function. Declare the function as a local variable in your test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">comparer</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Comparer</code><code class="p">(</code><code class="kd">func</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code><code class="w"> </code><code class="nx">y</code><code class="w"> </code><code class="nx">Person</code><code class="p">)</code><code class="w"> </code><code class="kt">bool</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">x</code><code class="p">.</code><code class="nx">Name</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="nx">y</code><code class="p">.</code><code class="nx">Name</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="nx">x</code><code class="p">.</code><code class="nx">Age</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="nx">y</code><code class="p">.</code><code class="nx">Age</code><code class="w"/>
<code class="p">})</code><code class="w"/></pre>

<p>Pass a function to the <code>cmp.Comparer</code> function to create a customer comparator. The function that’s passed in must have two parameters of the same type and return a <code>bool</code>. It also must be symmetric (the order of the parameters doesn’t matter), deterministic (it always returns the same value for the same inputs), and pure (it must not modify its parameters). In your implementation, you are comparing the <code>Name</code> and <code>Age</code> fields and ignoring the <code>DateAdded</code> field.</p>

<p>Then change your call to <code>cmp.Diff</code> to include <code>comparer</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">expected</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">comparer</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>This is only a quick preview of the most useful features in <code>go-cmp</code>. Check its <a href="https://oreil.ly/rmiWO">documentation</a> to learn more about how to control what is compared and the output 
<span class="keep-together">format.</span><a data-type="indexterm" data-startref="ch15-cmp" id="id2819"/><a data-type="indexterm" data-startref="ch15-cmp2" id="id2820"/><a data-type="indexterm" data-startref="ch15-cmp3" id="id2821"/><a data-type="indexterm" data-startref="ch15-cmp4" id="id2822"/><a data-type="indexterm" data-startref="ch15-cmp5" id="id2823"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Running Table Tests"><div class="sect1" id="id191">
<h1>Running Table Tests</h1>

<p>Most of the time, it takes more<a data-type="indexterm" data-primary="testing" data-secondary="table tests" id="ch15-tbl"/><a data-type="indexterm" data-primary="table tests" id="ch15-tbl2"/> than a single test case to validate that a function is working correctly. You could write multiple test functions to validate your function or multiple tests within the same function, but you’ll find that a great deal of the testing logic is repetitive. You set up supporting data and functions, specify inputs, check the outputs, and compare to see if they match your expectations.</p>

<p>Rather than writing this over and over, you can take advantage of a pattern called <em>table tests</em>. Let’s take a look at a sample. You can find this code in the <em>sample_code/table</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2824"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2825"/> Assume you have the following function in the <code>table</code> package:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">DoMath</code><code class="p">(</code><code class="nx">num1</code><code class="p">,</code><code class="w"> </code><code class="nx">num2</code><code class="w"> </code><code class="kt">int</code><code class="p">,</code><code class="w"> </code><code class="nx">op</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">switch</code><code class="w"> </code><code class="nx">op</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"+"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">num1</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">num2</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"-"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">num1</code><code class="w"> </code><code class="o">-</code><code class="w"> </code><code class="nx">num2</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"*"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">num1</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">num2</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"/"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">num2</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"division by zero"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">num1</code><code class="w"> </code><code class="o">/</code><code class="w"> </code><code class="nx">num2</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">default</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unknown operator %s"</code><code class="p">,</code><code class="w"> </code><code class="nx">op</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>To test this function, you need to check the different branches, trying out inputs that return valid results, as well as inputs that trigger errors. You could write code like this, but it’s very repetitive:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestDoMath</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">DoMath</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"+"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">4</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"Should have been 4, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"Should have been nil error, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">result2</code><code class="p">,</code><code class="w"> </code><code class="nx">err2</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">DoMath</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"-"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">result2</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"Should have been 0, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">result2</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err2</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"Should have been nil error, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">err2</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="c1">// and so on...</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Let’s replace this repetition with a table test. First, you declare a slice of anonymous structs. The struct contains fields for the name of the test, the input parameters, and the return values. Each entry in the slice represents another test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">name</code><code class="w">     </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">num1</code><code class="w">     </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="nx">num2</code><code class="w">     </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="nx">op</code><code class="w">       </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">expected</code><code class="w"> </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="nx">errMsg</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="p">}{</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"addition"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"+"</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"subtraction"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"-"</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"multiplication"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"*"</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"division"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"/"</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"bad_division"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="s">"/"</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="s">`division by zero`</code><code class="p">},</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Next, loop over each test case in <code>data</code>, invoking the <code>Run</code> method each time. This is the line that does the magic. You pass two parameters to <code>Run</code>, a name for the subtest and a function with a single parameter of type <code>*testing.T</code>. Inside the function, you call <code>DoMath</code> by using the fields of the current entry in <code>data</code>, using the same logic over and over. When you run these tests, you’ll see that not only do they pass, but when you use the <code>-v</code> flag, each subtest also now has a name:</p>

<pre data-type="programlisting" data-code-language="go"><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">DoMath</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">num1</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">num2</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">op</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">expected</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"Expected %d, got %d"</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">expected</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"Expected error message `%s`, got `%s`"</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="p">,</code><code class="w"> </code><code class="nx">errMsg</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">})</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<div data-type="tip"><h6>Tip</h6>
<p>Comparing error messages can be fragile, because there may not be any compatibility guarantees on the message text. The function that you are testing uses <code>errors.New</code> and <code>fmt.Errorf</code> to make errors, so the only option is to compare the messages. If an error has a custom type or a named sentinel error, use <code>errors.Is</code> or <code>errors.As</code> to check that the correct error is returned.<a data-type="indexterm" data-startref="ch15-tbl" id="id2826"/><a data-type="indexterm" data-startref="ch15-tbl2" id="id2827"/></p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Running Tests Concurrently"><div class="sect1" id="id192">
<h1>Running Tests Concurrently</h1>

<p>By default, unit tests are run sequentially.<a data-type="indexterm" data-primary="testing" data-secondary="running tests concurrently" id="ch15-conc"/> Since each unit test is supposed to be independent from every other unit test, they make ideal candidates for concurrency. To make a unit test run concurrently with other tests, call the <code>Parallel</code> method on <code>*testing.T</code> as the first line in your test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestMyCode</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Parallel</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="c1">// rest of test goes here</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Parallel tests run concurrently with other tests marked as parallel.</p>

<p>The advantage of parallel tests is that it can speed up long-running test suites. There are some disadvantages, though. If you have multiple tests that rely on the same shared mutable state, do not mark them as parallel, because you will get inconsistent results. (But after all of my warnings, you don’t have any shared mutable state in your application, right?) Also be aware that your test will panic if you mark it as parallel and use the <code>Setenv</code> method in your test function.</p>

<p>Be careful when running table tests in parallel. When table tests run in parallel, it’s just as you saw in <a data-type="xref" href="ch12.html#shared_var_goroutine">“Goroutines, for Loops, and Varying Variables”</a>, where you launched multiple goroutines within a <code>for</code> loop. If you run this example using Go 1.21 or earlier (or on Go 1.22 or later with the Go version set to 1.21 or earlier in the <code>go</code> directive in the <em>go.mod</em> file), a reference to the variable <code>d</code> is shared by all the parallel tests, so they all see the same value:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestParallelTable</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">name</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">input</code><code class="w">  </code><code class="kt">int</code><code class="w"/>
<code class="w">        </code><code class="nx">output</code><code class="w"> </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="p">}{</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"a"</code><code class="p">,</code><code class="w"> </code><code class="mi">10</code><code class="p">,</code><code class="w"> </code><code class="mi">20</code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"b"</code><code class="p">,</code><code class="w"> </code><code class="mi">30</code><code class="p">,</code><code class="w"> </code><code class="mi">40</code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"c"</code><code class="p">,</code><code class="w"> </code><code class="mi">50</code><code class="p">,</code><code class="w"> </code><code class="mi">60</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Parallel</code><code class="p">()</code><code class="w"/>
<code class="w">            </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">input</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">toTest</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">input</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">out</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"didn't match"</code><code class="p">,</code><code class="w"> </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You can run this code on <a href="https://oreil.ly/b0S4n">The Go Playground</a> or in the <em>sample_code/parallel</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_oo123"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_oo1oo2"/> Take a look at the output and you’ll see that you test the last value in the table test three times:</p>

<pre data-type="programlisting">=== CONT  TestParallelTable/a
50 60
=== CONT  TestParallelTable/c
50 60
=== CONT  TestParallelTable/b
50 60</pre>

<p>This problem is common enough that Go 1.20 added a <code>go vet</code> check for this problem. When you run <code>go vet</code> on this code, you get the message <code>loop variable d captured by func literal</code> on each line where <code>d</code> is captured.</p>

<p>The <code>for</code> loop changes in Go 1.22 or later resolve this issue. If you cannot use Go 1.22, you can avoid this bug by shadowing <code>d</code> within the <code>for</code> loop before invoking <code>t.Run</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="c1">// THIS IS THE LINE THAT SHADOWS d!</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Parallel</code><code class="p">()</code><code class="w"/>
<code class="w">            </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">input</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">toTest</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">input</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">out</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"didn't match"</code><code class="p">,</code><code class="w"> </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">output</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>

<p>Now that you have a way to run lots of tests, you’ll learn about code coverage to find out what your tests are testing.<a data-type="indexterm" data-startref="ch15-conc" id="id2828"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Checking Your Code Coverage"><div class="sect1" id="id193">
<h1>Checking Your Code Coverage</h1>

<p>Code coverage is a very useful tool<a data-type="indexterm" data-primary="testing" data-secondary="code coverage" id="ch15-cov"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="code coverage" id="ch15-cov2"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="code coverage" id="ch15-cov3"/> for knowing whether you’ve missed any obvious cases. However, reaching 100% code coverage doesn’t guarantee that there aren’t bugs in your code for some inputs. First you’ll see how <code>go test</code> displays code coverage and then you’ll look at the limitations of relying on code coverage alone.</p>

<p>Adding the <code>-cover</code> flag to the <code>go test</code> command calculates coverage information and includes a summary in the test output. If you include a second flag 
<span class="keep-together"><code>-coverprofile</code>,</span> you can save the coverage information to a file. Let’s go back to the <em>sample_code/table</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a> and gather code coverage information:<a data-type="indexterm" data-startref="ix_oo123" id="id2829"/><a data-type="indexterm" data-startref="ix_oo1oo2" id="id2830"/></p>
<pre data-type="programlisting">
$ <strong>go test -v -cover -coverprofile=c.out</strong>
</pre>

<p>If you run your table test with code coverage, the test output now includes a line that indicates the amount of test code coverage, 87.5%. That’s good to know, but it’d be more useful if you could see what you missed. The <code>cover</code> tool included with Go generates an HTML representation of your source code with that information:</p>
<pre data-type="programlisting">
$ <strong>go tool cover -html=c.out</strong>
</pre>

<p>When you run it, your web browser should open and show you a page that looks like <a data-type="xref" href="#initial_code_coverage">Figure 15-1</a>.</p>

<p>Every file that’s tested appears in the combo box in the upper left. The source code is in one of three colors. Gray is used for lines of code that aren’t testable, green is used for code that’s been covered by a test, and red is used for code that hasn’t been tested. (The reliance on color is unfortunate for readers of the print edition and those who have red-green color blindness. If you are unable to see the colors, the lighter gray is the covered lines.) From looking at this, you can see that you didn’t write a test to cover the default case, when a bad operator is passed to your function. Add that case to your slice of test cases:</p>

<pre data-type="programlisting" data-code-language="go"><code class="p">{</code><code class="s">"bad_op"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="s">"?"</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="s">`unknown operator ?`</code><code class="p">},</code><code class="w"/></pre>

<p>When you rerun <code>go test -v -cover -coverprofile=c.out</code> and <code>go tool cover</code> 
<span class="keep-together"><code>-html=c.out</code>,</span> you see in <a data-type="xref" href="#final_code_coverage">Figure 15-2</a> that the final line is covered and you have 100% test code coverage.</p>

<figure class="width-80"><div id="initial_code_coverage" class="figure">
<img src="assets/lgo2_1501.png" alt="Initial Code Coverage" width="1257" height="1015"/>
<h6><span class="label">Figure 15-1. </span>Initial code coverage</h6>
</div></figure>

<figure class="width-80"><div id="final_code_coverage" class="figure">
<img src="assets/lgo2_1502.png" alt="Final Code Coverage" width="1262" height="1025"/>
<h6><span class="label">Figure 15-2. </span>Final code coverage</h6>
</div></figure>

<p>Code coverage is a great thing, but it’s not enough. There’s actually a bug in your code, even though you have 100% coverage. Have you noticed it? If not, add another test case and rerun your tests:</p>

<pre data-type="programlisting" data-code-language="go"><code class="p">{</code><code class="s">"another_mult"</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="s">"*"</code><code class="p">,</code><code class="w"> </code><code class="mi">6</code><code class="p">,</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/></pre>

<p>You should see the error:</p>

<pre data-type="programlisting">table_test.go:57: Expected 6, got 5</pre>

<p>Your case for multiplication has a typo. It adds the numbers together instead of multiplying them. (Beware the dangers of copy-and-paste coding!) Fix the code, rerun <code>go test -v -cover -coverprofile=c.out</code> and <code>go tool cover -html=c.out</code>, and you’ll see that the tests pass again.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Code coverage is necessary but not sufficient. You can have 100% code coverage and still have bugs in your code!<a data-type="indexterm" data-startref="ch15-cov" id="id2831"/><a data-type="indexterm" data-startref="ch15-cov2" id="id2832"/><a data-type="indexterm" data-startref="ch15-cov3" id="id2833"/></p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Fuzzing"><div class="sect1" id="id194">
<h1>Fuzzing</h1>

<p>One of the most important lessons<a data-type="indexterm" data-primary="testing" data-secondary="fuzzing" id="ch15-fuzz"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="fuzzing" id="ch15-fuzz2"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="fuzzing" id="ch15-fuzz3"/><a data-type="indexterm" data-primary="fuzzing" id="ch15-fuzz4"/> that every developer eventually learns is that all data is suspect. No matter how well specified a data format is, you will eventually have to process input that doesn’t match what you expect. This doesn’t happen for only malicious reasons. Data can be corrupted in transit, in storage, and even in memory. Programs that process data might have bugs, and specifications for data formats always have corner cases that can be interpreted differently by different developers.</p>

<p>Even when developers do the work of writing good unit tests, it’s impossible to think of everything. As you’ve seen, even 100% unit test code coverage is no guarantee that your code is bug free. You need to supplement unit tests with generated data that could break your program in ways you didn’t anticipate. That’s where fuzzing helps.</p>

<p><em>Fuzzing</em> is a technique for generating random data and submitting it to code to see whether it properly handles unexpected input. The developer can provide a <em>seed corpus</em> or set of known good data, and the fuzzer uses that as a basis for generating bad input. Let’s see how to use the fuzzing support in Go’s testing tools to discover additional test cases.</p>

<p>Assume that you are writing a program to processes data files. You can find the code for this example <a href="https://oreil.ly/7dx6i">on GitHub</a>. You are sending a list of strings but want to efficiently allocate memory, so the number of strings in a file is sent as the first line, while the remaining lines are the lines of text. Here’s the sample function for processing this data:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">ParseData</code><code class="p">(</code><code class="nx">r</code><code class="w"> </code><code class="nx">io</code><code class="p">.</code><code class="nx">Reader</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">s</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">bufio</code><code class="p">.</code><code class="nx">NewScanner</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">!</code><code class="nx">s</code><code class="p">.</code><code class="nx">Scan</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"empty"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">countStr</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Text</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">count</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">strconv</code><code class="p">.</code><code class="nx">Atoi</code><code class="p">(</code><code class="nx">countStr</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">out</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nb">make</code><code class="p">([]</code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">count</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="nx">count</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">hasLine</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Scan</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">!</code><code class="nx">hasLine</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"too few lines"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">line</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">s</code><code class="p">.</code><code class="nx">Text</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="nx">out</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nb">append</code><code class="p">(</code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">line</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You use a <code>bufio.Scanner</code> to read line-by-line from an <code>io.Reader</code>. If there’s no data to be read, an error is returned. You then read the first line and attempt to convert it to an int named <code>count</code>. If you can’t, an error is returned. Next, you allocate the memory for your slice of strings, and read <code>count</code> number of lines from the scanner. If there aren’t enough lines, an error is returned. If all goes well, you return the lines you read.</p>

<p>A unit test has already been written to validate the code:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestParseData</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">name</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">in</code><code class="w">     </code><code class="p">[]</code><code class="kt">byte</code><code class="w"/>
<code class="w">        </code><code class="nx">out</code><code class="w">    </code><code class="p">[]</code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">errMsg</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="p">}{</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">name</code><code class="p">:</code><code class="w">   </code><code class="s">"simple"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">in</code><code class="p">:</code><code class="w">     </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"3\nhello\ngoodbye\ngreetings\n"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">:</code><code class="w">    </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"hello"</code><code class="p">,</code><code class="w"> </code><code class="s">"goodbye"</code><code class="p">,</code><code class="w"> </code><code class="s">"greetings"</code><code class="p">},</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">name</code><code class="p">:</code><code class="w">   </code><code class="s">"empty_error"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">in</code><code class="p">:</code><code class="w">     </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">""</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">:</code><code class="w">    </code><code class="kc">nil</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="p">:</code><code class="w"> </code><code class="s">"empty"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">name</code><code class="p">:</code><code class="w">   </code><code class="s">"zero"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">in</code><code class="p">:</code><code class="w">     </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"0\n"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">:</code><code class="w">    </code><code class="p">[]</code><code class="kt">string</code><code class="p">{},</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">name</code><code class="p">:</code><code class="w">   </code><code class="s">"number_error"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">in</code><code class="p">:</code><code class="w">     </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"asdf\nhello\ngoodbye\ngreetings\n"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">:</code><code class="w">    </code><code class="kc">nil</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="p">:</code><code class="w"> </code><code class="s">`strconv.Atoi: parsing "asdf": invalid syntax`</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">name</code><code class="p">:</code><code class="w">   </code><code class="s">"line_count_error"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">in</code><code class="p">:</code><code class="w">     </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"4\nhello\ngoodbye\ngreetings\n"</code><code class="p">),</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">:</code><code class="w">    </code><code class="kc">nil</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="p">:</code><code class="w"> </code><code class="s">"too few lines"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">r</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">bytes</code><code class="p">.</code><code class="nx">NewReader</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">in</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">ParseData</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="kd">var</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">errMsg</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">()</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">out</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="p">,</code><code class="w"> </code><code class="nx">errMsg</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The unit test has 100% line coverage for <code>ParseData</code>, handling all its error cases. You might think the code is ready for production, but let’s see if fuzzing can help you discover errors that you hadn’t considered.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Be aware that fuzzing uses a lot of resources. A fuzz test can allocate (or attempt to allocate) many gigabytes of memory and might write several gigabytes of data to your local disk. If you are running something else on the same machine at the same time as a fuzz test, don’t be surprised if it slows down.</p>
</div>

<p>You start by writing a fuzz test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">FuzzParseData</code><code class="p">(</code><code class="nx">f</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">F</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">testcases</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[][]</code><code class="kt">byte</code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"3\nhello\ngoodbye\ngreetings\n"</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="p">[]</code><code class="nb">byte</code><code class="p">(</code><code class="s">"0\n"</code><code class="p">),</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">tc</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">testcases</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">f</code><code class="p">.</code><code class="nx">Add</code><code class="p">(</code><code class="nx">tc</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">f</code><code class="p">.</code><code class="nx">Fuzz</code><code class="p">(</code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">,</code><code class="w"> </code><code class="nx">in</code><code class="w"> </code><code class="p">[]</code><code class="kt">byte</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">r</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">bytes</code><code class="p">.</code><code class="nx">NewReader</code><code class="p">(</code><code class="nx">in</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">ParseData</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Skip</code><code class="p">(</code><code class="s">"handled error"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">roundTrip</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">ToData</code><code class="p">(</code><code class="nx">out</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">rtr</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">bytes</code><code class="p">.</code><code class="nx">NewReader</code><code class="p">(</code><code class="nx">roundTrip</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">out2</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">ParseData</code><code class="p">(</code><code class="nx">rtr</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">out2</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">})</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>A fuzz test looks similar to a standard unit test. The function name starts with <code>Fuzz</code>, the only parameter is of type <code>*testing.F</code>, and it has no return values.</p>

<p>Next, you set up a seed corpus, which is composed of one or more sets of sample data. The data can run successfully, error out, or even panic. The important things are that you know how your program behaves when this data is provided and that this behavior is accounted for by your fuzz test. These samples are mutated by the fuzzer to generate bad inputs. This example uses only a single field of data for each entry (a slice of bytes), but you can have as many fields as needed. The fields in a corpus entry are currently limited to only certain types:</p>

<ul>
<li>
<p>Any integer type (including unsigned types, <code>rune</code>, and <code>byte</code>)</p>
</li>
<li>
<p>Any floating-point type</p>
</li>
<li>
<p><code>bool</code></p>
</li>
<li>
<p><code>string</code></p>
</li>
<li>
<p><code>[]byte</code></p>
</li>
</ul>

<p>Each entry in the corpus is passed to the <code>Add</code> method on the <code>*testing.F</code> instance. In the example, you have a slice of bytes for each entry:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">f</code><code class="p">.</code><code class="nx">Add</code><code class="p">(</code><code class="nx">tc</code><code class="p">)</code><code class="w"/></pre>

<p>If the function being fuzzed needed an <code>int</code> and a <code>string</code>, the call to <code>Add</code> would look like this:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">f</code><code class="p">.</code><code class="nx">Add</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="s">"some text"</code><code class="p">)</code><code class="w"/></pre>

<p>It’s a runtime error to pass a value of an invalid type to <code>Add</code>.</p>

<p>Next you call the <code>Fuzz</code> method on your <code>*testing.F</code> instance. This looks a bit like a call to <code>Run</code> when writing a table test in a standard unit test. <code>Fuzz</code> takes in a single parameter, a function whose first parameter is of type <code>*testing.T</code> and whose remaining parameters exactly match the types, order, and count of the values that were passed in to <code>Add</code>. This also specifies the type of data generated by the fuzzing engine during fuzzing. There’s no way for the Go compiler to enforce this constraint, so it’s a runtime error if the convention is not followed.</p>

<p>Finally, let’s look at the body of the fuzz target. Remember, fuzzing is used to find cases where bad input is not handled correctly. Since the input is randomly generated, you can’t write tests that have knowledge of what the output should be. Instead, you have to use test conditions that will be true for all inputs. In the case of <code>ParseData</code>, you can check for two things:</p>

<ul>
<li>
<p>Does the code return an error for bad input, or does it panic?</p>
</li>
<li>
<p>If you convert the slice of strings back to a slice of bytes and re-parse it, do you get the same result?</p>
</li>
</ul>

<p>Let’s see what happens when you run the fuzz test:</p>
<pre data-type="programlisting">
$ <strong>go test -fuzz=FuzzParseData</strong>
fuzz: elapsed: 0s, gathering baseline coverage: 0/243 completed
fuzz: elapsed: 0s, gathering baseline coverage: 243/243 completed,
    now fuzzing with 8 workers
fuzz: minimizing 289-byte failing input file
fuzz: elapsed: 3s, minimizing
fuzz: elapsed: 6s, minimizing
fuzz: elapsed: 9s, minimizing
fuzz: elapsed: 10s, minimizing
--- FAIL: FuzzParseData (10.48s)
    fuzzing process hung or terminated unexpectedly while minimizing: EOF
    Failing input written to testdata/fuzz/FuzzParseData/
        fedbaf01dc50bf41b40d7449657cdc9af9868b1be0421c98b2910071de9be3df
    To re-run:
    go test -run=FuzzParseData/
        fedbaf01dc50bf41b40d7449657cdc9af9868b1be0421c98b2910071de9be3df
FAIL
exit status 1
FAIL    file_parser     10.594s
</pre>

<p>If you don’t specify the <code>-fuzz</code> flag, your fuzz tests will be treated like unit tests and will be run against the seed corpus. Only a single fuzz test can be fuzzed at a time.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you want to get the full experience, delete the contents of the <em>testdata/fuzz/FuzzParseData</em> directory. This will cause the fuzzer to generate new seed corpus entries. Since the fuzzer generates random input, your samples might be different from the ones shown. The different entries will likely produce similar errors, though maybe not in the same order.</p>
</div>

<p>The fuzz test runs for several seconds and then fails. In this case, the <code>go</code> command reports that it has crashed. You don’t want programs that crash, so let’s look at the input that was generated. Every time a test case fails, the fuzzer writes it to the <em>testdata/fuzz/TESTNAME</em> subdirectory in the same package as the failed test, adding a new entry to the seed corpus. The new seed corpus entry in the file now becomes a new unit test, one that was automatically generated by the fuzzer. It is run anytime <code>go test</code> runs the <code>FuzzParseData</code> function, and acts as a regression test once you fix your bug.</p>

<p>Here are the contents of the file:</p>

<pre data-type="programlisting">go test fuzz v1
[]byte("300000000000")</pre>

<p>The first line is a header to indicate that this is test data for a fuzz test. The subsequent lines have the data that caused the failure.</p>

<p>The failure message tells you how to isolate this failing case when you rerun the test:</p>
<pre data-type="programlisting">
$ <strong>go test -run=FuzzParseData/
    fedbaf01dc50bf41b40d7449657cdc9af9868b1be0421c98b2910071de9be3df</strong>
signal: killed
FAIL    file_parser     15.046s
</pre>

<p>The problem is that you are trying to allocate a slice with the capacity to hold 300,000,000,000 strings. That requires quite a bit more RAM than my computer (and probably yours) has. You need to limit the number of expected text elements to a reasonable number. Set the maximum number of rows to 1,000 by adding the following code to <code>ParseData</code> after you parse the number of expected rows:</p>

<pre data-type="programlisting" data-code-language="go"><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">count</code><code class="w"> </code><code class="p">&gt;</code><code class="w"> </code><code class="mi">1000</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"too many"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>

<p>Run the fuzzer again to see whether it finds any more errors:</p>
<pre data-type="programlisting">
$ <strong>go test -fuzz=FuzzParseData</strong>
fuzz: elapsed: 0s, gathering baseline coverage: 0/245 completed
fuzz: elapsed: 0s, gathering baseline coverage: 245/245 completed,
    now fuzzing with 8 workers
fuzz: minimizing 29-byte failing input file
fuzz: elapsed: 2s, minimizing
--- FAIL: FuzzParseData (2.20s)
    --- FAIL: FuzzParseData (0.00s)
        testing.go:1356: panic: runtime error: makeslice: cap out of range
            goroutine 23027 [running]:
            runtime/debug.Stack()
                /usr/local/go/src/runtime/debug/stack.go:24 +0x104
            testing.tRunner.func1()
                /usr/local/go/src/testing/testing.go:1356 +0x258
            panic({0x1003f9920, 0x10042a260})
                /usr/local/go/src/runtime/panic.go:884 +0x204
            file_parser.ParseData({0x10042a7c8, 0x14006c39bc0})
                file_parser/file_parser.go:24 +0x254
[...]
    Failing input written to testdata/fuzz/FuzzParseData/
        03f81b404ad91d092a482ad1ccb4a457800599ab826ec8dae47b49c01c38f7b1
    To re-run:
    go test -run=FuzzParseData/
        03f81b404ad91d092a482ad1ccb4a457800599ab826ec8dae47b49c01c38f7b1
FAIL
exit status 1
FAIL    file_parser     2.434s
</pre>

<p>This time you get a fuzz result that produces a panic. Looking at the file generated by <code>go fuzz</code>, you see this:</p>

<pre data-type="programlisting">go test fuzz v1
[]byte("-1")</pre>

<p>The line that’s generating the panic is shown here:</p>

<pre data-type="programlisting" data-code-language="go"><code class="w">    </code><code class="nx">out</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nb">make</code><code class="p">([]</code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">count</code><code class="p">)</code><code class="w"/></pre>

<p>You are trying to create a slice with negative capacity, which panics. Add another condition to your code to look for negative numbers:</p>

<pre data-type="programlisting" data-code-language="go"><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">count</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"no negative numbers"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>

<p>Run your fuzzer again, and it generates another error:</p>
<pre data-type="programlisting">
$ <strong>go test -fuzz=FuzzParseData</strong>
fuzz: elapsed: 0s, gathering baseline coverage: 0/246 completed
fuzz: elapsed: 0s, gathering baseline coverage: 246/246 completed,
    now fuzzing with 8 workers
fuzz: elapsed: 3s, execs: 288734 (96241/sec), new interesting: 0 (total: 246)
fuzz: elapsed: 6s, execs: 418803 (43354/sec), new interesting: 0 (total: 246)
fuzz: minimizing 34-byte failing input file
fuzz: elapsed: 7s, minimizing
--- FAIL: FuzzParseData (7.43s)
    --- FAIL: FuzzParseData (0.00s)
        file_parser_test.go:89:   []string{
            -   "\r",
            +   "",
              }

    Failing input written to testdata/fuzz/FuzzParseData/
        b605c41104bf41a21309a13e90cfc6f30ecf133a2382759f2abc34d41b45ae79
    To re-run:
    go test -run=FuzzParseData/
        b605c41104bf41a21309a13e90cfc6f30ecf133a2382759f2abc34d41b45ae79
FAIL
exit status 1
FAIL    file_parser     7.558s
</pre>

<p>Looking at the file it created, you are generating blank lines with only <code>\r</code> (return) characters. Blank lines are not what you expect in your input, so add some code to the loop that reads lines of text from the <code>Scanner</code>. You’ll check whether a line consists only of whitespace characters. If it does, return an error:</p>

<pre data-type="programlisting" data-code-language="go"><code class="w">        </code><code class="nx">line</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">TrimSpace</code><code class="p">(</code><code class="nx">line</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">line</code><code class="p">)</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"blank line"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/></pre>

<p>Run your fuzzer yet again:</p>
<pre data-type="programlisting">
$ <strong>go test -fuzz=FuzzParseData</strong>
fuzz: elapsed: 0s, gathering baseline coverage: 0/247 completed
fuzz: elapsed: 0s, gathering baseline coverage: 247/247 completed,
    now fuzzing with 8 workers
fuzz: elapsed: 3s, execs: 391018 (130318/sec), new interesting: 2 (total: 249)
fuzz: elapsed: 6s, execs: 556939 (55303/sec), new interesting: 2 (total: 249)
fuzz: elapsed: 9s, execs: 622126 (21734/sec), new interesting: 2 (total: 249)
[...]
fuzz: elapsed: 2m0s, execs: 2829569 (0/sec), new interesting: 16 (total: 263)
fuzz: elapsed: 2m3s, execs: 2829569 (0/sec), new interesting: 16 (total: 263)
^Cfuzz: elapsed: 2m4s, execs: 2829569 (0/sec), new interesting: 16 (total: 263)
PASS
ok      file_parser     123.662s
</pre>

<p>After a few minutes, no more errors are found, so hit Ctrl-C to end fuzzing.</p>

<p>Just because the fuzzer didn’t find additional issues doesn’t mean that the code is now bug free. However, fuzzing allowed you to automatically find some significant oversights in the original code. Writing fuzz tests takes practice, as they require a slightly different mindset than writing unit tests. Once you get the hang of them, they become an essential tool for validating how your code handles unexpected user input.<a data-type="indexterm" data-startref="ch15-fuzz" id="id2834"/><a data-type="indexterm" data-startref="ch15-fuzz2" id="id2835"/><a data-type="indexterm" data-startref="ch15-fuzz3" id="id2836"/><a data-type="indexterm" data-startref="ch15-fuzz4" id="id2837"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using Benchmarks"><div class="sect1" id="benchmarking">
<h1>Using Benchmarks</h1>

<p>Determining how fast (or slow) code<a data-type="indexterm" data-primary="testing" data-secondary="benchmarks" id="ch15-bench"/> runs is surprisingly difficult. Rather than trying to figure it out yourself, you should use the benchmarking support that’s built into Go’s testing framework. Let’s explore it with a function in the <em>sample_code/bench</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>:<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2838"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2839"/></p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">FileLen</code><code class="p">(</code><code class="nx">f</code><code class="w"> </code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nx">bufsize</code><code class="w"> </code><code class="kt">int</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">file</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">os</code><code class="p">.</code><code class="nx">Open</code><code class="p">(</code><code class="nx">f</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">defer</code><code class="w"> </code><code class="nx">file</code><code class="p">.</code><code class="nx">Close</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">count</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">buf</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nb">make</code><code class="p">([]</code><code class="kt">byte</code><code class="p">,</code><code class="w"> </code><code class="nx">bufsize</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">num</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">file</code><code class="p">.</code><code class="nx">Read</code><code class="p">(</code><code class="nx">buf</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">count</code><code class="w"> </code><code class="o">+=</code><code class="w"> </code><code class="nx">num</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">break</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">count</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>This function counts the number of characters in a file. It takes in two parameters, the name of the file and the size of the buffer that you are using to read the file (you’ll see the reason for the second parameter in a moment).</p>

<p>Before seeing how fast it is, you should test your library to make sure that it works (it does). Here’s a simple test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestFileLen</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">FileLen</code><code class="p">(</code><code class="s">"testdata/data.txt"</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">65204</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"Expected 65204, got"</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Now you can see how long it takes your file-length function to run. Your goal is to find out what size buffer you should use to read from the file.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Before you spend time going down an optimization rabbit hole, be sure that you need to optimize. If your program is already fast enough to meet your responsiveness requirements and is using an acceptable amount of memory, your time is better spent on adding features and fixing bugs. Your business requirements determine what “fast enough” and “acceptable amount of memory” mean.</p>
</div>

<p>In Go, <em>benchmarks</em> are functions in your test files that start with the word <code>Benchmark</code> and take in a single parameter of type <code>*testing.B</code>. This type includes all the functionality of a <code>*testing.T</code> as well as additional support for benchmarking. Let’s start by looking at a benchmark that uses a buffer size of 1 byte:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">var</code><code class="w"> </code><code class="nx">blackhole</code><code class="w"> </code><code class="kt">int</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="nx">BenchmarkFileLen1</code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">B</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">N</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">FileLen</code><code class="p">(</code><code class="s">"testdata/data.txt"</code><code class="p">,</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">b</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">blackhole</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">result</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The <code>blackhole</code> package-level variable is interesting. You write the results from 
<span class="keep-together"><code>FileLen</code></span> to this package-level variable to make sure that the compiler doesn’t get too clever and decide to optimize away the call to <code>FileLen</code>, ruining your benchmark.</p>

<p>Every Go benchmark must have a loop that iterates from 0 to <code>b.<em>N</em></code>. The testing framework calls your benchmark functions over and over with larger and larger values for <code><em>N</em></code> until it is sure that the timing results are accurate. You’ll see this in the output in a moment.</p>

<p>You run a benchmark by passing<a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="benchmarks" id="id2840"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="benchmarks" id="id2841"/><a data-type="indexterm" data-primary="benchmarks" id="id2842"/> the <code>-bench</code> flag to <code>go test</code>. This flag expects a regular expression to describe the name of the benchmarks to run. Use <code>-bench=.</code> to run all benchmarks. A second flag, <code>-benchmem</code>, includes memory allocation information in the benchmark output. All tests are run before the benchmarks, so you can benchmark code only when tests pass.</p>

<p>Here’s the output for the benchmark on my 
<span class="keep-together">computer:</span></p>

<pre data-type="programlisting">BenchmarkFileLen1-12  25  47201025 ns/op  65342 B/op  65208 allocs/op</pre>

<p>Running a benchmark with memory allocation information produces output with five columns. Here’s what each one means:</p>
<dl>
<dt>BenchmarkFileLen1-12</dt>
<dd>
<p>The name of the benchmark, a hyphen, and the value of <code>GOMAXPROCS</code> for the benchmark.</p>
</dd>
<dt>25</dt>
<dd>
<p>The number of times that the test ran to produce a stable result.</p>
</dd>
<dt>47201025 ns/op</dt>
<dd>
<p>The amount of time it took to run a single pass of this benchmark, in nanoseconds (there are 1,000,000,000 nanoseconds in a second).</p>
</dd>
<dt>65342 B/op</dt>
<dd>
<p>The number of bytes allocated during a single pass of the benchmark.</p>
</dd>
<dt>65208 allocs/op</dt>
<dd>
<p>The number of times bytes had to be allocated from the heap during a single pass of the benchmark. This will always be less than or equal to the number of bytes allocated.</p>
</dd>
</dl>

<p>Now that you have results for a buffer of 1 byte, let’s see what the results look like when you use buffers of different sizes:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">BenchmarkFileLen</code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">B</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">v</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="p">[]</code><code class="kt">int</code><code class="p">{</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">10</code><code class="p">,</code><code class="w"> </code><code class="mi">100</code><code class="p">,</code><code class="w"> </code><code class="mi">1000</code><code class="p">,</code><code class="w"> </code><code class="mi">10000</code><code class="p">,</code><code class="w"> </code><code class="mi">100000</code><code class="p">}</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">b</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"FileLen-%d"</code><code class="p">,</code><code class="w"> </code><code class="nx">v</code><code class="p">),</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">b</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">B</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="nx">b</code><code class="p">.</code><code class="nx">N</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">FileLen</code><code class="p">(</code><code class="s">"testdata/data.txt"</code><code class="p">,</code><code class="w"> </code><code class="nx">v</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                    </code><code class="nx">b</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">                </code><code class="p">}</code><code class="w"/>
<code class="w">                </code><code class="nx">blackhole</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">result</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Just as you launched table tests using <code>t.Run</code>, you’re using <code>b.Run</code> to launch benchmarks that vary based only on input. Here are the results of this benchmark on my 
<span class="keep-together">computer:</span></p>
<pre data-type="programlisting" data-code-language="go" class="no-indent small">
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">1</code><code class="o">-</code><code class="mi">12</code><code class="w">          </code><code class="mi">25</code><code class="w">  </code><code class="mi">47828842</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">65342</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">65208</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">10</code><code class="o">-</code><code class="mi">12</code><code class="w">        </code><code class="mi">230</code><code class="w">   </code><code class="mi">5136839</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">104488</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">6525</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">100</code><code class="o">-</code><code class="mi">12</code><code class="w">      </code><code class="mi">2246</code><code class="w">    </code><code class="mi">509619</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">73384</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">    </code><code class="mi">657</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">1000</code><code class="o">-</code><code class="mi">12</code><code class="w">    </code><code class="mi">16491</code><code class="w">     </code><code class="mi">71281</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">68744</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">     </code><code class="mi">70</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">10000</code><code class="o">-</code><code class="mi">12</code><code class="w">   </code><code class="mi">42468</code><code class="w">     </code><code class="mi">26600</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">82056</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">     </code><code class="mi">11</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">100000</code><code class="o">-</code><code class="mi">12</code><code class="w">  </code><code class="mi">36700</code><code class="w">     </code><code class="mi">30473</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">213128</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">      </code><code class="mi">5</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
</pre>

<p>These results aren’t surprising; as you increase the size of the buffer, you make fewer allocations and your code runs faster, until the buffer is bigger than the file. When the buffer is bigger than the size of the file, extra allocations slow the output. If you expect files of roughly this size, a buffer of 10,000 bytes would work best.</p>

<p>But you can make a change that improves the numbers more. You are reallocating the buffer every time you get the next set of bytes from the file. That’s unnecessary. If you move the byte slice allocation before the loop and rerun your benchmark, you see an improvement:</p>
<pre data-type="programlisting" data-code-language="go" class="no-indent">
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">1</code><code class="o">-</code><code class="mi">12</code><code class="w">          </code><code class="mi">25</code><code class="w">  </code><code class="mi">46167597</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">     </code><code class="mi">137</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">10</code><code class="o">-</code><code class="mi">12</code><code class="w">        </code><code class="mi">261</code><code class="w">   </code><code class="mi">4592019</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">     </code><code class="mi">152</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">100</code><code class="o">-</code><code class="mi">12</code><code class="w">      </code><code class="mi">2518</code><code class="w">    </code><code class="mi">478838</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">     </code><code class="mi">248</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">1000</code><code class="o">-</code><code class="mi">12</code><code class="w">    </code><code class="mi">20059</code><code class="w">     </code><code class="mi">60150</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">    </code><code class="mi">1160</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">10000</code><code class="o">-</code><code class="mi">12</code><code class="w">   </code><code class="mi">62992</code><code class="w">     </code><code class="mi">19000</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">   </code><code class="mi">10376</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
<code class="nx">BenchmarkFileLen</code><code class="o">/</code><code class="nx">FileLen</code><code class="o">-</code><code class="mi">100000</code><code class="o">-</code><code class="mi">12</code><code class="w">  </code><code class="mi">51928</code><code class="w">     </code><code class="mi">21275</code><code class="w"> </code><code class="nx">ns</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">106632</code><code class="w"> </code><code class="nx">B</code><code class="o">/</code><code class="nx">op</code><code class="w">  </code><code class="mi">4</code><code class="w"> </code><code class="nx">allocs</code><code class="o">/</code><code class="nx">op</code><code class="w"/>
</pre>

<p>The number of allocations are now consistent and small, just four allocations for every buffer size. What is interesting is that you now can make trade-offs. If you are tight on memory, you can use a smaller buffer size and save memory at the expense of performance.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id2843">
<h1>Profiling Your Go Code</h1>
<p>If benchmarking reveals that you<a data-type="indexterm" data-primary="testing" data-secondary="benchmarks" data-tertiary="profiling your code" id="id2844"/> have a performance or memory problem, the next step is figuring out exactly what the problem is. Go includes profiling tools that gather CPU and memory usage data from a running program as well as tools that help you visualize and interpret the generated data. You can even expose a web service endpoint to gather profiling information remotely from a running Go service.</p>

<p>Discussing the profiler is a topic that’s beyond the scope of this book. Many great resources are available online. <a data-type="indexterm" data-primary="resources online" data-secondary="pprof code profiler" id="id2845"/><a data-type="indexterm" data-primary="pprof code profiler" id="id2846"/>A good starting point is the blog post <a href="https://oreil.ly/HHe9c">“Profiling Go Programs with pprof”</a> by Julia Evans.<a data-type="indexterm" data-startref="ch15-bench" id="id2847"/></p>
</div></aside>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using Stubs in Go"><div class="sect1" id="test_stubs">
<h1>Using Stubs in Go</h1>

<p>So far, you’ve written tests for functions<a data-type="indexterm" data-primary="testing" data-secondary="stubs" id="ch15-stub"/> that didn’t depend on other code. This is not typical, as most code is filled with dependencies. As you saw in <a data-type="xref" href="ch07.html#unique_chapter_id_07">Chapter 7</a>, Go allows you to abstract function calls in two ways: defining a function type and defining an interface. These abstractions help you write not only modular production code but also unit tests.</p>
<div data-type="tip"><h6>Tip</h6>
<p>When your code depends on abstractions, it’s easier to write unit tests!</p>
</div>

<p>Let’s take a look at an example in the <em>sample_code/solver</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2848"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2849"/> You define a type called <code>Processor</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">Processor</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">Solver</code><code class="w"> </code><code class="nx">MathSolver</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>It has a field of type <code>MathSolver</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">MathSolver</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">Resolve</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">expression</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">float64</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You’ll implement and test <code>MathSolver</code> in a bit.</p>

<p><code>Processor</code> also has a method that reads an expression from an <code>io.Reader</code> and returns the calculated value:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">p</code><code class="w"> </code><code class="nx">Processor</code><code class="p">)</code><code class="w"> </code><code class="nx">ProcessExpression</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">r</code><code class="w"> </code><code class="nx">io</code><code class="p">.</code><code class="nx">Reader</code><code class="p">)</code><code class="w"/>
<code class="w">                                    </code><code class="p">(</code><code class="kt">float64</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">curExpression</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">readToNewLine</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">curExpression</code><code class="p">)</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"no expression to read"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">answer</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">p</code><code class="p">.</code><code class="nx">Solver</code><code class="p">.</code><code class="nx">Resolve</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">curExpression</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">answer</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Let’s write the code to test <code>ProcessExpression</code>. First, you need a simple implementation of the <code>Resolve</code> method to write your test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">MathSolverStub</code><code class="w"> </code><code class="kd">struct</code><code class="p">{}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">ms</code><code class="w"> </code><code class="nx">MathSolverStub</code><code class="p">)</code><code class="w"> </code><code class="nx">Resolve</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">expr</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"/>
<code class="w">                                </code><code class="p">(</code><code class="kt">float64</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">switch</code><code class="w"> </code><code class="nx">expr</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"2 + 2 * 10"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">22</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"( 2 + 2 ) * 10"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">40</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"( 2 + 2 * 10"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"invalid expression: ( 2 + 2 * 10"</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Next, you write a unit test that uses this stub (production code should test the error messages too, but for the sake of brevity, you’ll leave those out):</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestProcessorProcessExpression</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">p</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">Processor</code><code class="p">{</code><code class="nx">MathSolverStub</code><code class="p">{}}</code><code class="w"/>
<code class="w">    </code><code class="nx">in</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">strings</code><code class="p">.</code><code class="nx">NewReader</code><code class="p">(</code><code class="s">`2 + 2 * 10</code>
<code class="s">( 2 + 2 ) * 10</code>
<code class="s">( 2 + 2 * 10`</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kt">float64</code><code class="p">{</code><code class="mi">22</code><code class="p">,</code><code class="w"> </code><code class="mi">40</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">hasErr</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kt">bool</code><code class="p">{</code><code class="kc">false</code><code class="p">,</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">p</code><code class="p">.</code><code class="nx">ProcessExpression</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(),</code><code class="w"> </code><code class="nx">in</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="p">!</code><code class="nx">hasErr</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"Expected result %f, got %f"</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You can then run your test and see that everything works.</p>

<p>While most Go interfaces specify only one or two methods, this isn’t always the case. You sometimes find yourself with an interface that has many methods. Let’s take a look at the code in the <em>sample_code/stub</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>.<a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2850"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="id2851"/> Assume you have an interface that looks like this:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">Entities</code><code class="w"> </code><code class="kd">interface</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">GetUser</code><code class="p">(</code><code class="nx">id</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="nx">User</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">GetPets</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">GetChildren</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Person</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">GetFriends</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Person</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">SaveUser</code><code class="p">(</code><code class="nx">user</code><code class="w"> </code><code class="nx">User</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>There are two patterns for testing code that depends on large interfaces. The first is to embed the interface in a struct. Embedding an interface in a struct automatically defines all the interface’s methods on the struct. It doesn’t provide any implementations of those methods, so you need to implement the methods that you care about for the current test. Let’s assume that <code>Logic</code> is a struct that has a field of type 
<span class="keep-together"><code>Entities</code>:</span></p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">Logic</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">Entities</code><code class="w"> </code><code class="nx">Entities</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Assume you want to test this method:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">l</code><code class="w"> </code><code class="nx">Logic</code><code class="p">)</code><code class="w"> </code><code class="nx">GetPetNames</code><code class="p">(</code><code class="nx">userId</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">pets</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">l</code><code class="p">.</code><code class="nx">Entities</code><code class="p">.</code><code class="nx">GetPets</code><code class="p">(</code><code class="nx">userId</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">out</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nb">make</code><code class="p">([]</code><code class="kt">string</code><code class="p">,</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">pets</code><code class="p">))</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">p</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">pets</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">out</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nb">append</code><code class="p">(</code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="nx">p</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">out</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>This method uses only one of the methods declared on <code>Entities</code>: <code>GetPets</code>. Rather than creating a stub that implements every single method on <code>Entities</code> just to test <code>GetPets</code>, you can write a stub struct that implements only the method you need to test this method:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">GetPetNamesStub</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">Entities</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">ps</code><code class="w"> </code><code class="nx">GetPetNamesStub</code><code class="p">)</code><code class="w"> </code><code class="nx">GetPets</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">switch</code><code class="w"> </code><code class="nx">userID</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"1"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="p">[]</code><code class="nx">Pet</code><code class="p">{{</code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="s">"Bubbles"</code><code class="p">}},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">case</code><code class="w"> </code><code class="s">"2"</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="p">[]</code><code class="nx">Pet</code><code class="p">{{</code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="s">"Stampy"</code><code class="p">},</code><code class="w"> </code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="s">"Snowball II"</code><code class="p">}},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">    </code><code class="k">default</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"invalid id: %s"</code><code class="p">,</code><code class="w"> </code><code class="nx">userID</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You then write your unit test, with your stub injected into <code>Logic</code>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestLogicGetPetNames</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">name</code><code class="w">     </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">userID</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">petNames</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="p">}{</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"case1"</code><code class="p">,</code><code class="w"> </code><code class="s">"1"</code><code class="p">,</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"Bubbles"</code><code class="p">}},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"case2"</code><code class="p">,</code><code class="w"> </code><code class="s">"2"</code><code class="p">,</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"Stampy"</code><code class="p">,</code><code class="w"> </code><code class="s">"Snowball II"</code><code class="p">}},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"case3"</code><code class="p">,</code><code class="w"> </code><code class="s">"3"</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">l</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">Logic</code><code class="p">{</code><code class="nx">GetPetNamesStub</code><code class="p">{}}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">petNames</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">l</code><code class="p">.</code><code class="nx">GetPetNames</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">userID</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">petNames</code><code class="p">,</code><code class="w"> </code><code class="nx">petNames</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>(By the way, the <code>GetPetNames</code> method has a bug. Did you see it? Even simple methods can sometimes have bugs.)</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>If you embed an interface in a stub struct, make sure you provide an implementation for every method that’s called during your test! If you call an unimplemented method, your tests will panic.</p>
</div>

<p>If you need to implement only one or two methods in an interface for a single test, this technique works well. The drawback comes when you need to call the same method in different tests with different inputs and outputs. When that happens, you need to either include every possible result for every test within the same implementation or reimplement the struct for each test. This quickly becomes difficult to understand and maintain. A better solution is to create a stub struct that proxies method calls to function fields. For each method defined on <code>Entities</code>, you define a function field with a matching signature on your stub struct:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">EntitiesStub</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">getUser</code><code class="w">     </code><code class="kd">func</code><code class="p">(</code><code class="nx">id</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="nx">User</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">getPets</code><code class="w">     </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">getChildren</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Person</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">getFriends</code><code class="w">  </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Person</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="nx">saveUser</code><code class="w">    </code><code class="kd">func</code><code class="p">(</code><code class="nx">user</code><code class="w"> </code><code class="nx">User</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You then make <code>EntitiesStub</code> meet the <code>Entities</code> interface by defining the methods. In each method, you invoke the associated function field. For example:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">es</code><code class="w"> </code><code class="nx">EntitiesStub</code><code class="p">)</code><code class="w"> </code><code class="nx">GetUser</code><code class="p">(</code><code class="nx">id</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="nx">User</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">es</code><code class="p">.</code><code class="nx">getUser</code><code class="p">(</code><code class="nx">id</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">es</code><code class="w"> </code><code class="nx">EntitiesStub</code><code class="p">)</code><code class="w"> </code><code class="nx">GetPets</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">es</code><code class="p">.</code><code class="nx">getPets</code><code class="p">(</code><code class="nx">userID</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Once you create this stub, you can supply different implementations of different methods in different test cases via the fields in the data struct for a table test:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestLogicGetPetNames</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">name</code><code class="w">     </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">getPets</code><code class="w">  </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">userID</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">petNames</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="nx">errMsg</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="p">}{</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"case1"</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="p">[]</code><code class="nx">Pet</code><code class="p">{{</code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="s">"Bubbles"</code><code class="p">}},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"> </code><code class="s">"1"</code><code class="p">,</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"Bubbles"</code><code class="p">},</code><code class="w"> </code><code class="s">""</code><code class="p">},</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="s">"case2"</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">userID</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">([]</code><code class="nx">Pet</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="s">"invalid id: 3"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">},</code><code class="w"> </code><code class="s">"3"</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="p">,</code><code class="w"> </code><code class="s">"invalid id: 3"</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">l</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">Logic</code><code class="p">{}</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">l</code><code class="p">.</code><code class="nx">Entities</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">EntitiesStub</code><code class="p">{</code><code class="nx">getPets</code><code class="p">:</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">getPets</code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="nx">petNames</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">l</code><code class="p">.</code><code class="nx">GetPetNames</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">userID</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cmp</code><code class="p">.</code><code class="nx">Diff</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">petNames</code><code class="p">,</code><code class="w"> </code><code class="nx">petNames</code><code class="p">);</code><code class="w"> </code><code class="nx">diff</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="s">""</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">diff</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="kd">var</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">errMsg</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">()</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"Expected error `%s`, got `%s`"</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="p">,</code><code class="w"> </code><code class="nx">errMsg</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">})</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>You add a field of function type to <code>data</code>’s anonymous struct. In each test case, you specify a function that returns the data that <code>GetPets</code> would return. When you write your test stubs this way, it’s clear what the stubs should return for each test case. As each test runs, you instantiate a new <code>EntitiesStub</code> and assign the <code>getPets</code> function field in your test data to the <code>getPets</code> function field in <code>EntitiesStub</code>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id2852">
<h1>Mocks and Stubs</h1>
<p>The terms <em>mock</em> and <em>stub</em> are often used interchangeably,<a data-type="indexterm" data-primary="testing" data-secondary="stubs" data-tertiary="mocks versus" id="id2853"/><a data-type="indexterm" data-primary="Fowler, Martin" id="id2854"/><a data-type="indexterm" data-primary="resources online" data-secondary="mocks covered in blog post" id="id2855"/> but they are actually two different concepts. Martin Fowler, a respected voice on all things related to software development, wrote a <a href="https://oreil.ly/nDkF5">blog post</a> on mocks that, among other things, covers the difference between mocks and stubs. In short, a <em>stub</em> returns a canned value for a given input, whereas a <em>mock</em> validates that a set of calls happen in the expected order with the expected inputs.</p>

<p>You used stubs in the examples to return canned values to a given response. You can write your own mocks by hand, or you can use a third-party library to generate them. The two most popular options are the <a href="https://oreil.ly/_EjoS">gomock</a> library from Google and the <a href="https://oreil.ly/AfDGD">testify</a> library from Stretchr, Inc.<a data-type="indexterm" data-startref="ch15-stub" id="id2856"/></p>
</div></aside>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using httptest"><div class="sect1" id="httptest">
<h1>Using httptest</h1>

<p>It can be difficult to write tests for a function<a data-type="indexterm" data-primary="testing" data-secondary="httptest" id="ch15-http"/><a data-type="indexterm" data-primary="net/http package" data-secondary="testing via httptest" id="ch15-http2"/> that calls an HTTP service. Traditionally, this became an integration test, requiring you to stand up a test instance of the service that the function calls. The Go standard library includes the <a href="https://oreil.ly/0c_MX"><code>net/http/httptest</code></a> package to make it easier to stub HTTP services. Let’s go back to the <em>sample_code/solver</em> directory in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a> <a data-type="indexterm" data-primary="book supplemental material URL" data-secondary="code repository" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_oo1234"/><a data-type="indexterm" data-primary="resources online" data-secondary="book supplemental material" data-tertiary="Chapter 15" data-tertiary-sortas="ooo" id="ix_oo123oo"/>and provide an implementation of <code>MathSolver</code> that calls an HTTP service to evaluate expressions:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">RemoteSolver</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">MathServerURL</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">Client</code><code class="w">        </code><code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Client</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">rs</code><code class="w"> </code><code class="nx">RemoteSolver</code><code class="p">)</code><code class="w"> </code><code class="nx">Resolve</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">expression</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"/>
<code class="w">                              </code><code class="p">(</code><code class="kt">float64</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">req</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">NewRequestWithContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">MethodGet</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nx">rs</code><code class="p">.</code><code class="nx">MathServerURL</code><code class="o">+</code><code class="s">"?expression="</code><code class="o">+</code><code class="nx">url</code><code class="p">.</code><code class="nx">QueryEscape</code><code class="p">(</code><code class="nx">expression</code><code class="p">),</code><code class="w"/>
<code class="w">        </code><code class="kc">nil</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">resp</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">rs</code><code class="p">.</code><code class="nx">Client</code><code class="p">.</code><code class="nx">Do</code><code class="p">(</code><code class="nx">req</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">defer</code><code class="w"> </code><code class="nx">resp</code><code class="p">.</code><code class="nx">Body</code><code class="p">.</code><code class="nx">Close</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="nx">contents</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">io</code><code class="p">.</code><code class="nx">ReadAll</code><code class="p">(</code><code class="nx">resp</code><code class="p">.</code><code class="nx">Body</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">resp</code><code class="p">.</code><code class="nx">StatusCode</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">New</code><code class="p">(</code><code class="nb">string</code><code class="p">(</code><code class="nx">contents</code><code class="p">))</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">strconv</code><code class="p">.</code><code class="nx">ParseFloat</code><code class="p">(</code><code class="nb">string</code><code class="p">(</code><code class="nx">contents</code><code class="p">),</code><code class="w"> </code><code class="mi">64</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>Now let’s see how to use the <code>httptest</code> library to test this code without standing up a server. The code is in the <code>TestRemoteSolver_Resolve</code> function in <em>sample_code/solver/remote_solver_test.go</em> in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>, but here are the highlights. First, you want to make sure that the data that’s passed into the function arrives on the server. So in your test function, you define a type called <code>info</code> to hold your input and output and a variable called <code>io</code> that is assigned the current input and output:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">type</code><code class="w"> </code><code class="nx">info</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">expression</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">code</code><code class="w">       </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="nx">body</code><code class="w">       </code><code class="kt">string</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="nx">io</code><code class="w"> </code><code class="nx">info</code><code class="w"/></pre>

<p>Next, you set up your fake remote server and use it to configure an instance of 
<span class="keep-together"><code>RemoteSolver</code>:</span></p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">server</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">httptest</code><code class="p">.</code><code class="nx">NewServer</code><code class="p">(</code><code class="w"/>
<code class="w">    </code><code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="kd">func</code><code class="p">(</code><code class="nx">rw</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code><code class="w"> </code><code class="nx">req</code><code class="w"> </code><code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">expression</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">req</code><code class="p">.</code><code class="nx">URL</code><code class="p">.</code><code class="nx">Query</code><code class="p">().</code><code class="nx">Get</code><code class="p">(</code><code class="s">"expression"</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">expression</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">io</code><code class="p">.</code><code class="nx">expression</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">rw</code><code class="p">.</code><code class="nx">WriteHeader</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusBadRequest</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Fprintf</code><code class="p">(</code><code class="nx">rw</code><code class="p">,</code><code class="w"> </code><code class="s">"expected expression '%s', got '%s'"</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="nx">io</code><code class="p">.</code><code class="nx">expression</code><code class="p">,</code><code class="w"> </code><code class="nx">expression</code><code class="p">)</code><code class="w"/>
<code class="w">            </code><code class="k">return</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="nx">rw</code><code class="p">.</code><code class="nx">WriteHeader</code><code class="p">(</code><code class="nx">io</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="nx">rw</code><code class="p">.</code><code class="nx">Write</code><code class="p">([]</code><code class="nb">byte</code><code class="p">(</code><code class="nx">io</code><code class="p">.</code><code class="nx">body</code><code class="p">))</code><code class="w"/>
<code class="w">    </code><code class="p">}))</code><code class="w"/>
<code class="k">defer</code><code class="w"> </code><code class="nx">server</code><code class="p">.</code><code class="nx">Close</code><code class="p">()</code><code class="w"/>
<code class="nx">rs</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">RemoteSolver</code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">MathServerURL</code><code class="p">:</code><code class="w"> </code><code class="nx">server</code><code class="p">.</code><code class="nx">URL</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nx">Client</code><code class="p">:</code><code class="w">        </code><code class="nx">server</code><code class="p">.</code><code class="nx">Client</code><code class="p">(),</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The <code>httptest.NewServer</code> function creates and starts an HTTP server on a random unused port. You need to provide an <code>http.Handler</code> implementation to process the request. Since this is a server, you must close it when the test completes. The <code>server</code> instance has its URL specified in the <code>URL</code> field of the <code>server</code> instance and a preconfigured <code>http.Client</code> for communicating with the test server. You pass these into 
<span class="keep-together"><code>RemoteSolver</code>.</span></p>

<p>The rest of the function works like every other table test that you’ve seen:</p>

<pre data-type="programlisting" data-code-language="go"><code class="nx">data</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">name</code><code class="w">   </code><code class="kt">string</code><code class="w"/>
<code class="w">    </code><code class="nx">io</code><code class="w">     </code><code class="nx">info</code><code class="w"/>
<code class="w">    </code><code class="nx">result</code><code class="w"> </code><code class="kt">float64</code><code class="w"/>
<code class="p">}{</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="s">"case1"</code><code class="p">,</code><code class="w"> </code><code class="nx">info</code><code class="p">{</code><code class="s">"2 + 2 * 10"</code><code class="p">,</code><code class="w"> </code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code><code class="w"> </code><code class="s">"22"</code><code class="p">},</code><code class="w"> </code><code class="mi">22</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="c1">// remaining cases</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">data</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Run</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="kd">func</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">io</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">io</code><code class="w"/>
<code class="w">        </code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">rs</code><code class="p">.</code><code class="nx">Resolve</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(),</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">io</code><code class="p">.</code><code class="nx">expression</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">result</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">result</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"io `%f`, got `%f`"</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">result</code><code class="p">,</code><code class="w"> </code><code class="nx">result</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="kt">string</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">errMsg</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">errMsg</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nx">t</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"io error `%s`, got `%s`"</code><code class="p">,</code><code class="w"> </code><code class="nx">d</code><code class="p">.</code><code class="nx">errMsg</code><code class="p">,</code><code class="w"> </code><code class="nx">errMsg</code><code class="p">)</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">})</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>The interesting thing to note is that the variable <code>io</code> has been captured by two closures: the one for the stub server and the one for running each test. You write to it in one closure and read it in the other. This is a bad idea in production code, but it works well in test code within a single function.<a data-type="indexterm" data-startref="ch15-http" id="id2857"/><a data-type="indexterm" data-startref="ch15-http2" id="id2858"/></p>
</div></section>






<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Using Integration Tests and Build Tags"><div class="sect1" id="test_build_tag">
<h1>Using Integration Tests and Build Tags</h1>

<p>Even though <code>httptest</code> provides a way<a data-type="indexterm" data-primary="testing" data-secondary="integration tests and build tags" id="id2859"/><a data-type="indexterm" data-primary="build tags" data-secondary="integration tests and" id="id2860"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="integration tests" id="id2861"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="integration tests" id="id2862"/><a data-type="indexterm" data-primary="integration tests" id="id2863"/> to avoid testing against external services, you should still write <em>integration tests</em>, automated tests that connect to other services. These validate that your understanding of the service’s API is correct. The challenge is figuring out how to group your automated tests; you want to run integration tests only when the support environment is present. Also, integration tests tend to be slower than unit tests, so they are usually run less frequently.</p>

<p>In <a data-type="xref" href="ch11.html#build_tags">“Using Build Tags”</a>, I covered build tags, which are used by the Go compiler to control when a file is compiled. While they are primarily intended to allow developers to write code that’s intended only for a specific operating system, CPU, or Go version, you can take advantage of the ability to specify custom build tags to control when integration tests are compiled and run.</p>

<p>Let’s try this out with the math-solving project. Use <a href="https://oreil.ly/5FWcb">Docker</a> to download a server implementation with  <code>docker pull jonbodner/math-server</code> and then run the server locally on port 8080 with <code>docker run -p 8080:8080</code> 
<span class="keep-together"><code>jonbodner/math-server</code>.</span></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you don’t have Docker installed or if you want to build the code for yourself, you can find it on <a href="https://oreil.ly/yjMzc">GitHub</a>.</p>
</div>

<p>You need to write an integration test to make sure that your <code>Resolve</code> method properly communicates with the math server. The <em>sample_code/solver/remote_solver_integration_test.go</em> file in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a> has a complete test in the <code>TestRemoteSolver_ResolveIntegration</code> function. The test looks like every other table test that you’ve written. The interesting thing is the first line of the file, separated from the package declaration by a newline:</p>

<pre data-type="programlisting" data-code-language="go"><code class="c1">//go:build integration</code><code class="w"/></pre>

<p>To run your integration test alongside the other tests you’ve written, use this:</p>
<pre data-type="programlisting">
$ <strong>go test -tags integration -v ./...</strong>
</pre>

<p>You should be aware that some people in the Go community prefer to use environment variables rather than build tags to create groups of integration tests. Peter Bourgon describes the concept in a blog post with the unsubtle title <a href="https://oreil.ly/BXSnu">“Don’t Use Build Tags for Integration Tests”</a>. His argument is that it’s hard to find out what build tags to set in order to run integration tests. An explicit check for an environment variable in each integration test, combined with a detailed message in a <code>t.Skip</code> method call, makes it clear that tests aren’t being run and how to run them. In the end, it’s a trade-off between verbosity and discoverability. Feel free to use either technique.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id2864">
<h1>Using the -short Flag</h1>
<p>Yet another way to group tests<a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="-short flag" data-tertiary-sortas="short flag" id="id2865"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="-short flag" data-tertiary-sortas="short flag" id="id2866"/> is to use <code>go test</code> with the <code>-short</code> flag. If you want to skip over tests that take a long time, label your slow tests by placing the following code at the start of the test function:</p>

<pre data-type="programlisting" data-code-language="go"><code class="k">if</code><code class="w"> </code><code class="nx">testing</code><code class="p">.</code><code class="nx">Short</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">t</code><code class="p">.</code><code class="nx">Skip</code><code class="p">(</code><code class="s">"skipping test in short mode."</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>When you want to run only short tests, pass the <code>-short</code> flag to <code>go test</code>.</p>

<p>There are a few problems with the <code>-short</code> flag. If you use it, there are only two levels of testing: short tests and all tests. By using build tags, you can group your integration tests, specifying which service they need in order to run. Another argument against using the <code>-short</code> flag to indicate integration tests is philosophical. Build tags indicate a dependency, while the <code>-short</code> flag is meant to indicate only that you don’t want to run tests that take a long time. Those are different concepts. Finally, I find the <code>-short</code> flag unintuitive. You should run short tests all the time. It makes more sense to require a flag to <em>include</em> long-running tests, not to <em>exclude</em> them.</p>
</div></aside>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Finding Concurrency Problems with the &#10;Data Race Detector"><div class="sect1" id="race_checker">
<h1>Finding Concurrency Problems with the 
<span class="keep-together">Data Race Detector</span></h1>

<p>Even with Go’s built-in support for concurrency,<a data-type="indexterm" data-primary="concurrency" data-secondary="data race detector" id="id2867"/><a data-type="indexterm" data-primary="data race detector" id="id2868"/><a data-type="indexterm" data-primary="testing" data-secondary="concurrency problems" id="id2869"/><a data-type="indexterm" data-primary="testing" data-secondary="data race detector" id="id2870"/><a data-type="indexterm" data-primary="testing" data-secondary="race checker" id="id2871"/><a data-type="indexterm" data-primary="race checker" id="id2872"/><a data-type="indexterm" data-primary="go commands" data-secondary="go test" data-tertiary="data race detector" id="id2873"/><a data-type="indexterm" data-primary="testing" data-secondary="go test" data-tertiary="data race detector" id="id2874"/> bugs still happen. It’s easy to accidentally reference a variable from two different goroutines without acquiring a lock. The computer science term for this is a <em>data race</em>. To help find these sorts of bugs, Go includes a <em>race checker</em>. It isn’t guaranteed to find every single data race in your code, but if it finds one, you should put proper locks around what it finds.</p>

<p>Look at a simple example in the file <em>sample_code/race/race.go</em> in the <a href="https://oreil.ly/PNRJx">Chapter 15 repository</a>:<a data-type="indexterm" data-startref="ix_oo1234" id="id2875"/><a data-type="indexterm" data-startref="ix_oo123oo" id="id2876"/></p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">getCounter</code><code class="p">()</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">counter</code><code class="w"> </code><code class="kt">int</code><code class="w"/>
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">wg</code><code class="w"> </code><code class="nx">sync</code><code class="p">.</code><code class="nx">WaitGroup</code><code class="w"/>
<code class="w">    </code><code class="nx">wg</code><code class="p">.</code><code class="nx">Add</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="mi">5</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">go</code><code class="w"> </code><code class="kd">func</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="k">for</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="p">&lt;</code><code class="w"> </code><code class="mi">1000</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nx">counter</code><code class="o">++</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">            </code><code class="nx">wg</code><code class="p">.</code><code class="nx">Done</code><code class="p">()</code><code class="w"/>
<code class="w">        </code><code class="p">}()</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="nx">wg</code><code class="p">.</code><code class="nx">Wait</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">counter</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>This code launches five goroutines, has each of them update a shared <code>counter</code> variable 1,000 times, and then returns the result. You’d expect it to be 5,000, so let’s verify this with a unit test in <em>sample_code/race/race_test.go</em>:</p>

<pre data-type="programlisting" data-code-language="go"><code class="kd">func</code><code class="w"> </code><code class="nx">TestGetCounter</code><code class="p">(</code><code class="nx">t</code><code class="w"> </code><code class="o">*</code><code class="nx">testing</code><code class="p">.</code><code class="nx">T</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">counter</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">getCounter</code><code class="p">()</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">counter</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="mi">5000</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nx">t</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="s">"unexpected counter:"</code><code class="p">,</code><code class="w"> </code><code class="nx">counter</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>

<p>If you run <code>go test</code> a few times, you’ll see that sometimes it passes, but most of the time it fails with an error message like this:</p>

<pre data-type="programlisting">unexpected counter: 3673</pre>

<p>The problem is that there’s a data race in the code. In a program this simple, the cause is obvious: multiple goroutines are trying to update <code>counter</code> simultaneously, and some of their updates are lost. In more complicated programs, these sorts of races are harder to see. Let’s see what the data race detector does. Use the flag <code>-race</code> with <code>go test</code> to enable it:</p>
<pre data-type="programlisting">
$ <strong>go test -race</strong>
==================
WARNING: DATA RACE
Read at 0x00c000128070 by goroutine 10:
  test_examples/race.getCounter.func1()
      test_examples/race/race.go:12 +0x45

Previous write at 0x00c000128070 by goroutine 8:
  test_examples/race.getCounter.func1()
      test_examples/race/race.go:12 +0x5b
</pre>

<p>The traces make it clear that the line <code>counter++</code> is the source of your problems.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Some people try to fix race conditions by inserting “sleeps” into their code, trying to space out access to the variable that’s being accessed by multiple goroutines. <em>This is a bad idea</em>.  Doing so might eliminate the problem in some cases, but the code is still wrong and will fail in some situations.</p>
</div>

<p>You can also use the <code>-race</code> flag when you build your programs. This creates a binary that includes the data race detector and that reports any races it finds to the console. This allows you to find data races in code that doesn’t have tests.</p>

<p class="pagebreak-before">If the data race detector is so useful, why isn’t it enabled all the time for testing and production? A binary with <code>-race</code> enabled runs approximately 10 times slower than a normal binary. That isn’t a problem for test suites that take a second to run, but for large test suites that take several minutes, a 10× slowdown reduces productivity.</p>

<p>For more information on the data race detector,<a data-type="indexterm" data-primary="resources online" data-secondary="data race detector documentation" id="id2877"/><a data-type="indexterm" data-primary="data race detector" data-secondary="documentation URL" id="id2878"/> check out its <a href="https://oreil.ly/0uLcW">official documentation</a>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Exercises"><div class="sect1" id="id358">
<h1>Exercises</h1>

<p>Now that you’ve learned about writing tests and using the code-quality tools included with Go, complete these exercises to apply that knowledge to a sample 
<span class="keep-together">application.</span></p>
<ol>
<li>
<p><a href="https://oreil.ly/5b_xI">Download the Simple Web App program</a>. Write unit tests for the program and get as close to 100% code coverage as you can. If you find any bugs, fix them.</p>
</li>
<li>
<p>Use the race detector to find a concurrency problem in the program and fix it.</p>
</li>
<li>
<p>Write a fuzz test against the <code>parser</code> function and fix any problems that you find.</p>
</li>

</ol>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Wrapping Up"><div class="sect1" id="id359">
<h1>Wrapping Up</h1>

<p>In this chapter, you’ve learned how to write tests and improve code quality by using Go’s built-in support for testing, code coverage, benchmarking, fuzzing, and data race checking. In the next chapter, you’re going to explore some Go features that allow you to break the rules: the <code>unsafe</code> package, reflection, and <code>cgo</code>.</p>
</div></section>
</div></section></div>
</div>
</body></html>